{"version":3,"file":"dayReportCreate-e3c483e9.js","sources":["../../src/views/po/elec/produce/dayReportCreate.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <div class=\"process-box\">\n        <!-- 标题 -->\n        <div class=\"header-box\">\n          <BillTitle :options=\"billTitleOptions\" />\n          <WfApproveBox\n            @save=\"onSave\"\n            @submit=\"onSubmit\"\n            :processStatus=\"formState.status\"\n            :processInstanceId=\"formState.processInstanceId\"\n          />\n        </div>\n        <!-- 表单内容 -->\n        <div class=\"content\"\n          ><a-form\n            ref=\"dayReportFormRef\"\n            :model=\"formState\"\n            name=\"dayReportForm\"\n            :scrollToFirstError=\"true\"\n          >\n            <a-card title=\"基本信息\" :bordered=\"false\">\n              <a-row :gutter=\"32\">\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"电站名称\"\n                    name=\"stationName\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input disabled v-model:value=\"formState.stationName\" style=\"width: 100%\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"分期\"\n                    name=\"periodName\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input disabled v-model:value=\"formState.periodName\" />\n                  </a-form-item>\n                </a-col>\n\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"日报日期\"\n                    name=\"reportDay\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请选择日期' }]\"\n                  >\n                    <a-date-picker\n                      v-model:value=\"formState.reportDay\"\n                      style=\"min-width: 100%\"\n                      @change=\"changeReportDay\"\n                      :disabled=\"iProcess\"\n                      value-format=\"YYYY-MM-DD\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"日发电量(kWh)\"\n                    name=\"genElec\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[\n                      {\n                        required: true,\n                        message: '请输入日发电量',\n                      },\n                    ]\"\n                  >\n                    <a-input-number\n                      @change=\"changeDayGen\"\n                      :disabled=\"iProcess\"\n                      v-model:value=\"formState.genElec\"\n                      maxlength=\"20\"\n                    />\n                  </a-form-item>\n                </a-col>\n\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"上网电量(kWh)\"\n                    name=\"onlineElec\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入上网电量' }]\"\n                  >\n                    <a-input-number\n                      @change=\"changeOnline\"\n                      :disabled=\"iProcess\"\n                      v-model:value=\"formState.onlineElec\"\n                      maxlength=\"20\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"外接厂用电(kWh)\"\n                    name=\"facUsed\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入外接电源厂用电' }]\"\n                  >\n                    <a-input-number\n                      @change=\"changeFacUsed\"\n                      :disabled=\"iProcess\"\n                      v-model:value=\"formState.facUsed\"\n                      maxlength=\"20\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"下网电量(kWh)\"\n                    name=\"offlineElec\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入下网电量' }]\"\n                  >\n                    <a-input-number\n                      @change=\"changeOffline\"\n                      :disabled=\"iProcess\"\n                      v-model:value=\"formState.offlineElec\"\n                      maxlength=\"20\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"理论发电(kWh)\"\n                    name=\"theoElec\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input-number disabled v-model:value=\"formState.theoElec\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"总损失电量(kWh)\"\n                    name=\"totalLoss\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input-number disabled v-model:value=\"formState.totalLoss\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"最大负荷(MW)\"\n                    name=\"maxLoad\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[\n                      {\n                        message: '请输入最大负荷',\n                        pattern: /^(\\d{1,4})(.\\d{1,2})?$/,\n                      },\n                    ]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.maxLoad\" />\n                  </a-form-item>\n                </a-col>\n\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"利用小时数(h)\"\n                    name=\"validHours\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input disabled v-model:value=\"formState.validHours\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"厂用电率\"\n                    name=\"facRatio\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input disabled v-model:value=\"formState.facRatio\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"系统效率(%)\"\n                    name=\"sysEfficiency\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                  >\n                    <a-input disabled v-model:value=\"formState.sysEfficiency\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"今日辐照(kj/㎡)\"\n                    name=\"radiation\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[\n                      {\n                        required: true,\n                        message: '请输入今日辐照',\n                      },\n                    ]\"\n                  >\n                    <a-input-number\n                      :disabled=\"iProcess\"\n                      @change=\"changeRadiation\"\n                      v-model:value=\"formState.radiation\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"24\" class=\"textarea-item\">\n                  <a-form-item\n                    label=\"设备运行动态\"\n                    name=\"deviceInfo\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 2 }\"\n                  >\n                    <a-textarea\n                      :rows=\"10\"\n                      v-model:value=\"formState.deviceInfo\"\n                      placeholder=\"2000字以内\"\n                      :disabled=\"iProcess\"\n                      :maxlength=\"2000\"\n                      show-count\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"24\" class=\"textarea-item\">\n                  <a-form-item\n                    label=\"生产动态\"\n                    name=\"prodInfo\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 2 }\"\n                  >\n                    <a-textarea\n                      :rows=\"10\"\n                      v-model:value=\"formState.prodInfo\"\n                      placeholder=\"2000字以内\"\n                      :maxlength=\"2000\"\n                      show-count\n                      :disabled=\"iProcess\"\n                    />\n                  </a-form-item>\n                </a-col>\n              </a-row>\n            </a-card>\n            <a-card title=\"天气信息\" :bordered=\"false\">\n              <a-row :gutter=\"32\">\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"今日天气\"\n                    name=\"dayWeather\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入今日天气' }]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.dayWeather\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"最高气温(℃)\"\n                    name=\"maxTemp\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入最高气温' }]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.maxTemp\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"最低气温(℃)\"\n                    name=\"minTemp\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入最低气温' }]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.minTemp\" />\n                  </a-form-item> </a-col\n                ><a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"平均温度(℃)\"\n                    name=\"avgTemp\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入平均温度' }]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.avgTemp\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"最大风速(m/s)\"\n                    name=\"maxWind\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[\n                      {\n                        required: true,\n                        message: '请输入最大风速',\n                      },\n                    ]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.maxWind\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"最小风速(m/s)\"\n                    name=\"minWind\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入最小风速' }]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.minWind\" />\n                  </a-form-item>\n                </a-col>\n                <a-col v-show=\"true\" :span=\"12\">\n                  <a-form-item\n                    label=\"平均风速(m/s)\"\n                    name=\"avgWind\"\n                    labelAlign=\"right\"\n                    :labelCol=\"{ span: 4 }\"\n                    :rules=\"[{ required: true, message: '请输入平均风速' }]\"\n                  >\n                    <a-input :disabled=\"iProcess\" v-model:value=\"formState.avgWind\" />\n                  </a-form-item>\n                </a-col>\n              </a-row>\n            </a-card>\n          </a-form>\n          <div class=\"form-subtitle-box\">\n            <div class=\"title-left\">损失电量</div>\n            <div class=\"title-right\">\n              <a-button v-if=\"!iProcess\" type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"addLossData\"\n                >添加</a-button\n              >\n              <a-button\n                v-if=\"!iProcess\"\n                class=\"red-btn\"\n                :preIcon=\"IconEnum.DELETE\"\n                @click=\"delLossData\"\n                >删除</a-button\n              >\n            </div>\n          </div>\n          <div style=\"margin: 0 16px 10px\">\n            <a-table\n              :columns=\"lossCloumns\"\n              :data-source=\"lossList\"\n              :pagination=\"false\"\n              size=\"small\"\n              bordered\n              :row-selection=\"{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange }\"\n              :scroll=\"{ x: 480, y: 620 }\"\n            >\n              <template #bodyCell=\"{ column, text, record }\">\n                <template v-if=\"column.dataIndex === 'reason'\">\n                  <a-input\n                    v-model:value=\"record[column.dataIndex]\"\n                    maxlength=\"300\"\n                    style=\"margin: -5px 0\"\n                    :disabled=\"iProcess\"\n                  />\n                </template>\n                <template v-if=\"column.dataIndex === 'lossElec'\">\n                  <a-input-number\n                    @change=\"callossElec\"\n                    v-model:value=\"record.lossElec\"\n                    maxlength=\"20\"\n                    :formatter=\"limitNumber\"\n                    :parser=\"limitNumber\"\n                    :min=\"0\"\n                    :disabled=\"iProcess\"\n                  />\n                </template>\n                <template v-if=\"column.dataIndex === 'lossTypeCodeText'\">\n                  <TreeBox\n                    v-model:value=\"record.lossTypeCode\"\n                    vmode=\"label\"\n                    :tfields=\"{ key: 'id', value: 'lossTypeCode', title: 'name' }\"\n                    :data=\"treeData\"\n                    @select=\"treeBoxSelect\"\n                    :disabled=\"iProcess\"\n                    twidth=\"400px\"\n                  />\n                </template>\n                <template v-if=\"column.dataIndex === 'equipmentName'\">\n                  <SearchBox\n                    v-model:value=\"record.equipmentName\"\n                    :columns=\"deviceBoxColumns\"\n                    :data=\"searchBoxData\"\n                    :vfield=\"'name'\"\n                    :pagination=\"false\"\n                    twidth=\"600px\"\n                    style=\"width: 100%\"\n                    :disabled=\"iProcess\"\n                    @clear=\"handleBoxClear(record)\"\n                    @select=\"(element) => tableBoxSelect(record, element)\"\n                  />\n                </template>\n                <template v-if=\"['startTime', 'endTime'].includes(column.dataIndex)\">\n                  <a-date-picker\n                    v-model:value=\"record[column.dataIndex]\"\n                    show-time\n                    format=\"YYYY-MM-DD HH:mm:ss\"\n                    value-format=\"YYYY-MM-DD HH:mm:ss\"\n                    :disabled=\"iProcess\"\n                  />\n                </template>\n                <template v-if=\"column.dataIndex === 'bizFileId'\">\n                  <UploadBox\n                    :tname=\"record.tname\"\n                    :disabled=\"iProcess\"\n                    :vmode=\"'box'\"\n                    :width=\"800\"\n                    :height=\"550\"\n                    :maxCount=\"20\"\n                    :maxSize=\"100 * 1024 * 1024\"\n                    :application=\"`po`\"\n                    :module=\"`dayreportloss`\"\n                    :bizId=\"record[column.dataIndex]\"\n                  />\n                </template>\n              </template>\n            </a-table>\n          </div>\n        </div>\n      </div>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { computed, onMounted, reactive, ref, unref, UnwrapRef } from 'vue';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { useRouter } from 'vue-router';\n  import { IconEnum } from '@/enums/appEnum';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import { message, FormInstance } from 'ant-design-vue';\n  import * as EquipmentApi from '@/api/po/equipment';\n  import { buildShortUUID } from '@/utils/uuid';\n  import { MsgManager } from '@/message/MsgManager';\n  import { PageWrapper } from '/@/components/Page';\n  import {\n    getLossCloumns,\n    getLossList,\n    deleteLossData,\n    insertDayReport,\n    getDayReport,\n    getLossTypeTree,\n    getPeriod,\n  } from './index';\n  import { assign } from 'lodash-es';\n  import SearchBox from '@/components/Framework/Combox/SearchBox.vue';\n  import TreeBox from '@/components/Framework/Combox/TreeBox.vue';\n  import { useTabs } from '/@/hooks/web/useTabs';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import * as FileApi from '@/api/infra/file';\n  import { SysMessage } from '/@/hooks/web/useMessage';\n  import { closeCurrentTab } from '@/utils/route';\n  import { scrollToInValidField } from '@/utils/formUtils';\n  import { Memory } from '@/router/index';\n  import * as OutboundApi from '@/api/po/equipment/outbound';\n\n  const iProcess = ref<boolean>(false);\n  const { t } = useI18n();\n  const router = useRouter();\n  const { currentRoute } = router;\n  const route = unref(currentRoute);\n  const query = Memory.getInstance().getQuery(); // route.query;\n  const deviceBoxColumns = ref([\n    { title: '编码', dataIndex: 'code', key: 'code', fixed: 'center', minWidth: 100 },\n    { title: '设备名称', dataIndex: 'name', key: 'name', fixed: 'center', minWidth: 100 },\n    {\n      title: '供应商名称',\n      dataIndex: 'supplierName',\n      key: 'supplierName',\n      fixed: 'left',\n      minWidth: 100,\n    },\n    { title: '生产厂家', dataIndex: 'factoryName', key: 'factoryName', minWidth: 150 },\n  ]);\n  interface FormState {}\n  const treeData = ref([]);\n  const searchBoxData = ref([]);\n\n  const processInstanceId = ref(null);\n  const lossCloumns = getLossCloumns();\n  const lossList = ref([]);\n  const dayReportFormRef = ref<FormInstance>();\n  const formState: UnwrapRef<FormState> = reactive({ status: 0 });\n\n  function tableBoxSelect(record: any, element: any) {\n    record.equipmentName = element.record.name;\n    record.equipmentId = element.record.key;\n    record.supplierId = element.record.supplierId;\n    record.supplierName = element.record.supplierName;\n    record.factoryId = element.record.factoryId;\n    record.factoryName = element.record.factoryName;\n  }\n\n  const billTitleOptions = reactive<any>({});\n  billTitleOptions.subject = '生产日报';\n  billTitleOptions.infoItems = [];\n\n  //-------------------------------------------------------指标计算-------------------------------------------------------------\n  // 计算理论发电量\n  function calTheoElec() {\n    let connectCapacity = formState.connectCapacity > 0 ? formState.connectCapacity : 0;\n    let radiation = formState.radiation > 0 ? formState.radiation : 0;\n    formState.theoElec = decimal((connectCapacity * radiation) / 3.6, 2);\n  }\n  // 计算利用小时数\n  function calValidHours() {\n    let genElec = formState.genElec > 0 ? formState.genElec : 0;\n    if (formState.connectCapacity > 0) {\n      formState.validHours = decimal(genElec / 1000 / formState.connectCapacity, 2);\n    }\n  }\n  // 计算系统效率\n  function calSysEfficiency() {\n    let onlineElec = formState.onlineElec > 0 ? formState.onlineElec : 0;\n    if (formState.theoElec > 0) {\n      let sysEfficiency = onlineElec / formState.theoElec;\n      formState.sysEfficiency = decimal(sysEfficiency * 100, 2);\n    } else {\n      formState.sysEfficiency = 0;\n    }\n  }\n  // 计算综合厂用电率\n  function calFacRatio() {\n    let facUsed = formState.facUsed > 0 ? formState.facUsed : 0;\n    let offlineElec = formState.offlineElec > 0 ? formState.offlineElec : 0;\n    if (formState.genElec > 0) {\n      let facRatio = (facUsed + offlineElec) / formState.genElec;\n      formState.facRatio = decimal(facRatio * 100, 2);\n    } else if (facUsed + offlineElec > 0) {\n      formState.facRatio = 100;\n    } else {\n      formState.facRatio = 0;\n    }\n  }\n  function decimal(num, v) {\n    let vv = Math.pow(10, v);\n    return Math.round(num * vv) / vv;\n  }\n  //-------------------------------------------------------表单事件绑定-------------------------------------------------------------\n  // 日期选择后更新并网容量，加载损失电量数据\n  function changeReportDay() {\n    // 查询并网容量\n  }\n\n  // 日辐照修改事件\n  function changeRadiation() {\n    calTheoElec();\n    calSysEfficiency();\n  }\n  // 日发电量修改事件\n  function changeDayGen() {\n    calValidHours();\n    calFacRatio();\n  }\n  // 上网电量修改事件\n  function changeOnline() {\n    calSysEfficiency();\n  }\n  // 外接厂用电量修改事件\n  function changeFacUsed() {\n    calFacRatio();\n  }\n  // 下网电量修改事件\n  function changeOffline() {\n    calFacRatio();\n  }\n\n  //-------------------------------------------------------损失电量相关-------------------------------------------------------------\n\n  type Key = string | number;\n  const state = reactive<{\n    selectedRowKeys: Key[];\n    loading: boolean;\n  }>({\n    selectedRowKeys: [], // Check here to configure the default column\n    loading: false,\n  });\n  const hasSelected = computed(() => state.selectedRowKeys.length > 0);\n  const start = () => {\n    state.loading = true;\n    // ajax request after empty completing\n    setTimeout(() => {\n      state.loading = false;\n      state.selectedRowKeys = [];\n    }, 1000);\n  };\n  const onSelectChange = (selectedRowKeys: Key[]) => {\n    console.log('selectedRowKeys changed: ', selectedRowKeys);\n    state.selectedRowKeys = selectedRowKeys;\n  };\n\n  /* 限制数字输入框只能输入整数 */\n  const limitNumber = (value) => {\n    if (typeof value === 'string') {\n      return !isNaN(Number(value)) ? value.replace(/^(0+)|[^\\d]/g, '') : '';\n    } else if (typeof value === 'number') {\n      return !isNaN(value) ? String(value).replace(/^(0+)|[^\\d]/g, '') : '';\n    } else {\n      return '';\n    }\n  };\n  // 新增损失电量\n  function addLossData() {\n    //\n    let bizFileId = buildShortUUID();\n    let count = lossList.value.length + 1;\n    let newModel = {\n      id: '',\n      key: count,\n      code: '',\n      name: '',\n      editable: true,\n      bizFileId: bizFileId,\n      tname: '上传',\n    };\n    lossList.value.unshift(newModel);\n  }\n\n  // 损失类型数据\n  const loadTreeData = async () => {\n    let res = await getLossTypeTree();\n    treeData.value = res;\n    return res;\n  };\n\n  // 树选择事件\n  function treeBoxSelect(record: any, node: any) {\n    record.lossTypeCode = node.record.lossTypeCode;\n    // treeData.value.filter(item.)\n  }\n\n  // 加载设备下拉框数据\n  const loadDeviceInfo = async () => {\n    let res = await EquipmentApi.getEquipmentPage({ periodId: formState.periodId });\n    searchBoxData.value = res.list;\n    return res;\n  };\n\n  // 删除损失电量\n  const delLossData = async () => {\n    console.info(state.selectedRowKeys);\n    let delLossIds = [];\n    lossList.value.map((item) => {\n      if (state.selectedRowKeys.includes(item.key) && item.id != '') {\n        delLossIds.push(item.id);\n      }\n    });\n    if (delLossIds.length > 0) {\n      await deleteLossData(delLossIds);\n      await loadLossList();\n    } else {\n      let list = [];\n      lossList.value.forEach((item) => {\n        if (!state.selectedRowKeys.includes(item.key)) {\n          list.push(item);\n        }\n      });\n      lossList.value = list;\n    }\n\n    // 汇总损失总量数据\n    callossElec();\n  };\n  // 加载日报损失电量\n  const loadLossList = async () => {\n    if (formState.reportDay == null) {\n      return;\n    }\n    formState.requestType = 'day';\n    let data = await getLossList(formState);\n    for (let i = 0; i < data.result.length; i++) {\n      data.result[i].key = i;\n      let filelist = [];\n      filelist = await FileApi.getFiles({ bizId: data.result[i].bizFileId });\n      data.result[i].tname = filelist.length > 0 ? '查看' : '上传';\n    }\n    lossList.value = data.result;\n  };\n\n  // 汇总损失电量到日报表单\n  function callossElec() {\n    let sumLossElec = 0;\n    lossList.value.forEach((element) => {\n      sumLossElec = sumLossElec + element.lossElec;\n    });\n    formState.totalLoss = sumLossElec;\n  }\n\n  //-------------------------------------------------------流程相关操作-------------------------------------------------------------\n\n  const onSave = () => {\n    doSave(0);\n  };\n\n  const onSubmit = () => {\n    doSave(1);\n  };\n\n  const doSave = (status: number) => {\n    const formInstance = dayReportFormRef.value;\n    formInstance\n      .validateFields()\n      .then(() => {\n        let param = {};\n        Object.assign(param, formState);\n        param.status = status;\n        param.lossData = lossList.value;\n        insertDayReport(param)\n          .then((data) => {\n            debugger;\n            SysMessage.getInstance().success(t('common.saveSuccessText'));\n            formState.id = data.result;\n            if (status === 1) {\n              setTimeout(function () {\n                MsgManager.getInstance().sendMsg('day-report', { key: 'day' });\n                closeCurrentTab();\n              }, 200);\n            }\n            // 加载损失电量数据\n            loadLossList();\n          })\n          .catch(() => {\n            formState.status = 0;\n          });\n      })\n      .catch((fields) => {});\n  };\n  // 填充电站分期数据\n  const loadPeriodData = async () => {\n    let res = await getDayReport('');\n    loadBizBaseInfo(res);\n    formState.billCode = res.billCode;\n    formState.fillinDate = res.fillinDate;\n    formState.stationId = query.stationId;\n    formState.stationName = query.stationName;\n    formState.periodId = query.periodId;\n    formState.periodName = query.periodName;\n    formState.stationOrganId = query.organId;\n    formState.stationOrganName = query.organName;\n    getPeriodInfo();\n  };\n  const loadBizBaseInfo = async (res: any) => {\n    let { billCode, fillinDate, personMemberName, deptName } = res;\n    Object.assign(billTitleOptions, { billCode, fillinDate, personMemberName, deptName });\n  };\n  const loadBizData = async () => {\n    let res = await getDayReport(formState.id);\n    // 填充业务数据\n    iProcess.value = res.status > 0;\n    loadBizBaseInfo(res);\n    assign(formState, res);\n    if (!formState.processInstanceId) {\n      formState.processInstanceId = query.processInstanceId;\n    }\n    // 加载损失类型树\n    await loadTreeData();\n    // 加载设备列表数据\n    await loadDeviceInfo();\n    // 加载损失电量数据\n    loadLossList();\n  };\n\n  // 获取分期的并网容量\n  const getPeriodInfo = async () => {\n    let period = await getPeriod(formState.periodId);\n    formState.connectCapacity = period.connectCapacity;\n    return period.connectCapacity;\n  };\n\n  // 处理SearchBox的Clear事件\n  const handleBoxClear = (record) => {\n    console.info(record);\n    record.supplierId = null;\n    record.supplierName = null;\n    record.factoryId = null;\n    record.factoryName = null;\n  };\n\n  onMounted(async () => {\n    assign(formState, query);\n    if (query.id) {\n      formState.id = query.id;\n      await loadBizData();\n    } else if (query.processInstanceId) {\n      processInstanceId.value = query.processInstanceId as unknown as string;\n      formState.processInstanceId = query.processInstanceId as unknown as string;\n      ProcessInstanceApi.getProcessInstance(formState.processInstanceId).then(async (res) => {\n        if (res != null) {\n          formState.id = res.businessKey;\n        }\n        await loadBizData();\n      });\n    } else {\n      // 初始化数据\n      loadPeriodData();\n      // 加载损失类型树\n      loadTreeData();\n      // 加载设备列表数据\n      loadDeviceInfo();\n    }\n  });\n</script>\n<style lang=\"less\">\n  .theme1 {\n    .form-subtitle-box {\n      .title-left {\n        color: rgb(255 255 255 / 85%);\n      }\n    }\n  }\n\n  .theme3 {\n    .form-subtitle-box {\n      .title-left {\n        color: rgb(0 0 0 / 85%);\n      }\n    }\n  }\n</style>\n<style lang=\"less\" scoped>\n  .form-subtitle-box {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 6px;\n    padding: 9px 16px 0;\n\n    .title-left {\n      display: flex;\n      align-items: center;\n      font-size: 14px;\n      font-weight: 500;\n      line-height: 28px;\n\n      &::before {\n        content: '';\n        display: inline-block;\n        width: 3px;\n        height: 16px;\n        margin-right: 10px;\n        background-color: #1890ff;\n      }\n    }\n\n    .title-right {\n      :deep(.ant-btn) {\n        height: 28px;\n        margin-right: 10px;\n        padding: 3px 13px;\n        font-size: 12px;\n\n        &:last-child {\n          margin-right: 0;\n        }\n      }\n    }\n  }\n\n  .fix-detail-page {\n    :deep(&.vben-page-wrapper-content.detail-content) {\n      margin: 0;\n    }\n  }\n</style>\n"],"names":["iProcess","ref","t","useI18n","router","useRouter","currentRoute","unref","query","Memory","deviceBoxColumns","treeData","searchBoxData","processInstanceId","lossCloumns","getLossCloumns","lossList","dayReportFormRef","formState","reactive","tableBoxSelect","record","element","billTitleOptions","calTheoElec","connectCapacity","radiation","decimal","calValidHours","genElec","calSysEfficiency","onlineElec","sysEfficiency","calFacRatio","facUsed","offlineElec","facRatio","num","v","vv","changeReportDay","changeRadiation","changeDayGen","changeOnline","changeFacUsed","changeOffline","state","computed","onSelectChange","selectedRowKeys","limitNumber","value","addLossData","bizFileId","buildShortUUID","newModel","loadTreeData","__async","res","getLossTypeTree","treeBoxSelect","node","loadDeviceInfo","EquipmentApi.getEquipmentPage","delLossData","delLossIds","item","deleteLossData","loadLossList","list","callossElec","data","getLossList","i","filelist","FileApi.getFiles","sumLossElec","onSave","doSave","onSubmit","status","param","insertDayReport","SysMessage","MsgManager","closeCurrentTab","fields","loadPeriodData","getDayReport","loadBizBaseInfo","getPeriodInfo","billCode","fillinDate","personMemberName","deptName","loadBizData","assign","period","getPeriod","handleBoxClear","onMounted","ProcessInstanceApi.getProcessInstance"],"mappings":"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"}