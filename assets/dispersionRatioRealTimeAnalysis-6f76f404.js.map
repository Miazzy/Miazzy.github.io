{"version":3,"file":"dispersionRatioRealTimeAnalysis-6f76f404.js","sources":["../../src/views/monitor/realTimeAnalysis/dispersionRatioRealTimeAnalysis.vue"],"sourcesContent":["<!--\n * @Description: 实时分析-离散率实时分析\n * @Date: 2023-10-23 17:31:10\n * @LastEditTime: 2023-11-10 09:59:49\n * @FilePath: \\ygwl-framework\\src\\views\\monitor\\realTimeAnalysis\\dispersionRatioRealTimeAnalysis.vue\n-->\n<template>\n  <div class=\"real-time-analysis\">\n    <a-row class=\"real-time-analysis-row\" type=\"flex\" :wrap=\"false\">\n      <a-col flex=\"298px\">\n        <CommonTree\n          :toolbar=\"true\"\n          :canEdit=\"false\"\n          :canAdd=\"false\"\n          :canDelete=\"false\"\n          :isShowOperationBtns=\"false\"\n          class=\"fit-common-tree\"\n          title=\"电站组织\"\n          :value=\"stationTreeData\"\n          :fieldNames=\"{ key: 'id', title: 'name' }\"\n          @select=\"handleSelect\"\n          :selectedKeys=\"selectedKeys\"\n          :expandedKeys=\"expandedKeys\"\n        />\n      </a-col>\n      <a-col flex=\"auto\">\n        <div class=\"right-box\">\n          <div class=\"right-row-box\">\n            <div class=\"box-header\"> 离散率分布 </div>\n            <div class=\"box-content\">\n              <div class=\"chart-box\">\n                <div id=\"customerChart\" class=\"chart-element\" v-show=\"isDisplayChart\">\n                  <NtgaleChart\n                    id=\"omChart\"\n                    :width=\"800\"\n                    :height=\"350\"\n                    :data=\"dispersionRatioPieData.pieData\"\n                    showLabel\n                    :roseType=\"false\"\n                    :radius=\"[0, 120]\"\n                  />\n                </div>\n                <div v-show=\"!isDisplayChart\" class=\"chart-element\">\n                  <a-empty :image=\"emptyImage\" />\n                </div>\n              </div>\n            </div>\n          </div>\n          <div class=\"right-row-box\">\n            <div class=\"data-table-box\">\n              <!-- <div class=\"table-title-box\">\n                <div class=\"left-box\">\n                  <div class=\"select-box\">\n                    <div class=\"select-label-box\">区域：</div>\n                    <a-select v-model:value=\"area\" mode=\"multiple\" allow-clear  style=\"min-width: 206px\" placeholder=\"选择区域\" :options=\"areaOptions\" :max-tag-count=\"2\" showArrow\n                      @change=\"handleAreaChange\"></a-select>\n                  </div>\n                  <div class=\"select-box\">\n                    <div class=\"select-label-box\">类型：</div>\n                    <a-select v-model:value=\"type\" mode=\"multiple\" allow-clear style=\"min-width: 206px\" placeholder=\"选择类型\" :options=\"typeOptions\" showArrow @change=\"handleTypeChange\"></a-select>\n                  </div>  \n                </div>\n                <div class=\"right-box\">\n                  \n                  <div class=\"divider\"></div>\n                </div>\n              </div> -->\n              <div class=\"table-title-line\"></div>\n              <BasicTable @register=\"registerTable\">\n                <template #tableTitle>\n                  <div class=\"select-box\">\n                    <div class=\"select-label-box\">区域</div>\n                    <a-select\n                      v-model:value=\"area\"\n                      allow-clear\n                      mode=\"multiple\"\n                      style=\"min-width: 256px\"\n                      placeholder=\"选择区域\"\n                      :options=\"areaOptions\"\n                      :max-tag-count=\"2\"\n                      showArrow\n                      @change=\"handleAreaChange\"\n                    />\n                  </div>\n                  <div class=\"select-box\">\n                    <div class=\"select-label-box\">设备类型</div>\n                    <a-select\n                      v-model:value=\"deviceType\"\n                      allow-clear\n                      style=\"min-width: 256px\"\n                      placeholder=\"选择设备类型\"\n                      :options=\"typeOptions\"\n                      showArrow\n                      @change=\"handleTypeChange\"\n                    />\n                  </div>\n                </template>\n                <template #toolbar>\n                  <div style=\"margin-top: -7px; padding-left: 8px\">\n                    <a-button @click=\"resetForm\"> 重置 </a-button>\n                    <a-button\n                      class=\"yellow-btn\"\n                      style=\"margin-left: 8px\"\n                      @click=\"exportData\"\n                      :preIcon=\"IconEnum.EXPORT\"\n                    >\n                      导出\n                    </a-button>\n                  </div>\n                </template>\n                <template #bodyCell=\"{ column, record }\">\n                  <template v-if=\"column.key === 'status'\">\n                    <span class=\"status-icon\" :class=\"statusMap[record.status]\"></span>\n                  </template>\n                </template>\n              </BasicTable>\n            </div>\n          </div>\n        </div>\n      </a-col>\n    </a-row>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\n  import { ref, onMounted, reactive, computed } from 'vue';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import { TreeItem } from '/@/components/Tree';\n  import { BasicTable, useTable, TableAction, BasicColumn } from '/@/components/Table';\n  import Icon from '@/components/Icon/Icon.vue';\n  import type { SelectProps } from 'ant-design-vue';\n  import NtgaleChart from '/@/components/Framework/Chart/NtgaleChart.vue';\n  import {\n    getStationTree,\n    getAreas,\n    getDispersionRatioRealData,\n    getDispersionRatioStat,\n    exportDispersionRatio,\n  } from '../monitorApi.ts';\n  import { jsonToSheetXlsx } from '/@/components/Excel';\n  import { Empty } from 'ant-design-vue';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { exportExcelFile } from '@/utils/file/download';\n\n  const { createConfirm } = useMessage();\n\n  const stationTreeData = ref<TreeItem[]>([]);\n  const selectedStationId = ref('');\n  const emptyImage = Empty.PRESENTED_IMAGE_SIMPLE;\n  const selectedKeys = computed(() => {\n    return [selectedStationId.value];\n  });\n  const expandedKeys = ref([]);\n\n  // 查询电站树数据\n  async function queryDeptTreeList() {\n    let result = await getStationTree();\n    stationTreeData.value = result;\n    setTimeout(() => {\n      expandedKeys.value = [result[0].id, result[0].children[0].id];\n      selectedKeys.value = [result[0].children[0].id];\n      selectedStationId.value = result[0].children[0].id;\n      setPagination({ current: 1 });\n      getAreaList();\n      dispersionRatioStat();\n      reload();\n    }, 500);\n  }\n  // 左侧树状菜单选中事件\n  async function handleSelect(nodes = {}) {\n    selectedStationId.value = null;\n    if (nodes.id != null && nodes.nodeKindId == 'station') {\n      selectedStationId.value = nodes.powerStationId;\n      setPagination({ current: 1 });\n      getAreaList();\n      dispersionRatioStat();\n    }\n  }\n\n  // 选择区域\n  const area = ref([]);\n  const areaOptions = ref<SelectProps['options']>([]);\n  const handleAreaChange = (value: string[]) => {\n    console.log(`selected ${value}`);\n    area.value = value;\n    setPagination({ current: 1 });\n    reload();\n  };\n\n  // 获取区域列表数据\n  const getAreaList = async () => {\n    area.value = [];\n    let res = await getAreas({ stationId: selectedStationId.value });\n    if (res?.length) {\n      let temp = [];\n      res.forEach((element) => {\n        temp.push({ value: element.id, label: element.name });\n      });\n      if (area.value.length == 0) {\n        area.value.push(res[0].id);\n      }\n\n      areaOptions.value = temp;\n\n      reload();\n    }\n  };\n\n  // 选择类型\n  const deviceType = ref('StringFormation');\n  const typeOptions = ref<SelectProps['options']>([\n    {\n      value: 'StringFormation',\n      label: '组串式逆变器',\n    },\n    {\n      value: 'Concentrate',\n      label: '直流汇流箱',\n    },\n  ]);\n\n  // 重置\n  function resetForm() {\n    area.value = '';\n    deviceType.value = '';\n  }\n\n  // 导出\n  function exportData() {\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要导出所有记录？',\n      async onOk() {\n        let param = {\n          stationId: selectedStationId.value,\n          areaIds: area.value,\n          deviceType: deviceType.value,\n        };\n        param.fileName = '离散率数据';\n        param.excelList = columns.value;\n        await exportDispersionRatio(param).then((res) => {\n          exportExcelFile(res?.data, param.fileName);\n        });\n        // let header = {};\n        // columns.value.forEach((item) => {\n        //   if (item.children != null) {\n        //     item.children.forEach((element) => {\n        //       header[element.dataIndex] = element.title;\n        //     });\n        //   } else {\n        //     header[item.dataIndex] = item.title;\n        //   }\n        // });\n\n        // let exportDataList = [];\n        // tableData.value.forEach((element) => {\n        //   let temp = {};\n        //   for (let k in header) {\n        //     temp[k] = element[k];\n        //   }\n        //   exportDataList.push(temp);\n        // });\n\n        // jsonToSheetXlsx({\n        //   data: exportDataList,\n        //   header: header,\n        //   filename: '离散率实时数据.xlsx',\n        // });\n      },\n    });\n  }\n\n  // 损失分布\n  const dispersionRatioPieData = ref({\n    pieData: [],\n  });\n\n  const dispersionRatioStat = async () => {\n    let param = {\n      stationId: selectedStationId.value,\n      // areaId: area.value,\n      deviceType: deviceType.value,\n    };\n    let data = await getDispersionRatioStat(param);\n    if (data) {\n      dispersionRatioPieData.value.pieData = data;\n    }\n  };\n\n  const handleTypeChange = (value: string[]) => {\n    setPagination({ current: 1 });\n    reload();\n  };\n\n  const isDisplayChart = computed(\n    () => dispersionRatioPieData.value.pieData && dispersionRatioPieData.value.pieData.length,\n  );\n\n  const columns: BasicColumn[] = ref([]);\n  const showColumns = ref([]); // 展示字段\n  const getColumns = async () => {\n    // 数据表格\n    let preColumns = [];\n    if (showColumns.value.length > 0) {\n      showColumns.value.forEach((item) => {\n        let columnItem = {\n          title: item.name + item.unit,\n          dataIndex: item.code,\n          width: 120,\n        };\n        if (item.subColumn?.length > 0) {\n          let childrenF = [];\n          item.subColumn.forEach((element) => {\n            let parentItem = {\n              title: element.name + item.unit,\n              dataIndex: element.code,\n              width: 120,\n            };\n            if (element.subColumn?.length > 0) {\n              let children = [];\n              element.subColumn.forEach((son) => {\n                let sonItem = {\n                  title: son.name + item.unit,\n                  dataIndex: son.code,\n                  width: 120,\n                };\n                children.push(sonItem);\n              });\n              parentItem.children = children;\n            }\n            childrenF.push(parentItem);\n          });\n          columnItem.children = childrenF;\n        }\n        preColumns.push(columnItem);\n      });\n      columns.value = preColumns;\n    }\n  };\n\n  const statusMap = {\n    normal: 'green',\n    alarm: 'red',\n    interrupt: 'grey',\n    halt: 'white',\n  };\n  const tableData = ref([]);\n  const loadDataList = async () => {\n    if (selectedStationId.value == '') {\n      return;\n    }\n\n    const paginationRef = getPaginationRef() as any;\n    let param = {\n      stationId: selectedStationId.value,\n      areaIds: area.value,\n      deviceType: deviceType.value,\n      pageNo: paginationRef.current,\n      pageSize: paginationRef.pageSize,\n    };\n    let res = await getDispersionRatioRealData(param);\n    showColumns.value = res.columns;\n    await getColumns();\n    if (res) {\n      let dataList = [];\n      res.page.list.forEach((item) => {\n        if (item.serials != null) {\n          let serMap = item.serials;\n          for (let k in item.serials) {\n            item['serials_' + k] = serMap[k];\n          }\n          dataList.push(item);\n        }\n      });\n      tableData.value = dataList;\n    }\n    return res.page;\n  };\n  const [registerTable, { reload, getPaginationRef, setPagination }] = useTable({\n    api: loadDataList,\n    columns,\n    bordered: true,\n    pagination: { pageSize: 20, pageSizeOptions: ['20', '50', '100', '200'] },\n  });\n\n  onMounted(async () => {\n    await queryDeptTreeList();\n  });\n</script>\n\n<style lang=\"less\">\n  @import '../style/themes.less';\n</style>\n\n<style lang=\"less\" scoped>\n  .real-time-analysis {\n    height: 100%;\n    padding: 10px;\n\n    .real-time-analysis-row {\n      height: 100%;\n    }\n\n    .fit-common-tree {\n      height: 100%;\n      margin: 0 !important;\n      border: none !important;\n    }\n\n    .right-box {\n      height: 100%;\n      padding-left: 10px;\n\n      .box-content {\n        .chart-box {\n          .chart-element {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 350px;\n          }\n        }\n      }\n\n      .right-row-box {\n        width: 100%;\n        height: calc(50% - 5px);\n        min-height: 350px;\n        margin-bottom: 10px;\n        border-radius: 2px;\n\n        &:last-child {\n          margin-bottom: 0;\n        }\n\n        .box-header {\n          height: 48px;\n          padding: 0 16px;\n          font-size: 14px;\n          line-height: 47px;\n        }\n\n        .data-table-box {\n          position: relative;\n\n          :deep(.vben-basic-table .ant-table-wrapper) {\n            padding: 7px 16px 8px;\n          }\n\n          :deep(.vben-basic-title.vben-basic-table-title) {\n            padding-left: 0;\n            font-size: 14px;\n          }\n\n          :deep(.ant-table-title) {\n            position: relative;\n            margin-bottom: 10px;\n          }\n\n          :deep(.table-settings) {\n            padding: 7px 0 1px;\n          }\n\n          :deep(.vben-basic-table-header__toolbar > .table-settings) {\n            margin-right: 0;\n          }\n\n          :deep(.table-settings > span:last-child) {\n            margin-right: 0;\n          }\n\n          .select-box {\n            display: flex;\n            align-items: center;\n            margin-right: 20px;\n\n            &:last-child {\n              margin-right: 0;\n            }\n\n            .select-label-box {\n              margin-right: 14px;\n              font-size: 14px;\n            }\n          }\n\n          .status-icon {\n            display: inline-block;\n            width: 12px;\n            height: 12px;\n            border-radius: 50%;\n\n            &.green {\n              background-color: #52c41a;\n            }\n\n            &.red {\n              background-color: #ff4d4f;\n            }\n\n            &.grey {\n              background-color: #999;\n            }\n\n            &.white {\n              background-color: #f5f4f4;\n            }\n          }\n\n          .table-title-line {\n            position: absolute;\n            z-index: 1;\n            top: 45px;\n            left: 0;\n            width: 100%;\n            height: 1px;\n            opacity: 0.85;\n          }\n        }\n      }\n    }\n  }\n</style>\n"],"names":["createConfirm","useMessage","stationTreeData","ref","selectedStationId","emptyImage","Empty","selectedKeys","computed","expandedKeys","queryDeptTreeList","__async","result","getStationTree","setPagination","getAreaList","dispersionRatioStat","reload","handleSelect","nodes","area","areaOptions","handleAreaChange","value","res","getAreas","temp","element","deviceType","typeOptions","resetForm","exportData","param","columns","exportDispersionRatio","exportExcelFile","dispersionRatioPieData","data","getDispersionRatioStat","handleTypeChange","isDisplayChart","showColumns","getColumns","preColumns","item","columnItem","_a","childrenF","parentItem","children","son","sonItem","statusMap","tableData","loadDataList","paginationRef","getPaginationRef","getDispersionRatioRealData","dataList","serMap","k","registerTable","useTable","onMounted"],"mappings":"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"}