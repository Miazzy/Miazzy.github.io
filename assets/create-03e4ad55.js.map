{"version":3,"file":"create-03e4ad55.js","sources":["../../src/views/po/ticket/secondworkticket/create.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <a-spin :spinning=\"formState.spinning\" tip=\"Loading...\">\n        <div class=\"process-box\">\n          <!-- 标题和操作按钮 -->\n          <div class=\"header-box\">\n            <BillTitle :options=\"billTitleOption\" />\n            <WfApproveBox\n              @save=\"onSave\"\n              @submit=\"onSubmit\"\n              @before=\"onBefore\"\n              :processInstanceId=\"formState.processInstanceId\"\n              :processStatus=\"formState.status\"\n              :mode=\"getApproveBoxMode\"\n              :businessStatus=\"businessStatus\"\n              :listenMessage=\"listenMessage\"\n            />\n            <CustomPrint\n              v-if=\"formState.status == 2\"\n              path=\"secondWorkTicket\"\n              :params=\"{\n                base: formState,\n                recordDetails: recordDataSource,\n              }\"\n            />\n          </div>\n          <!-- 表单内容 -->\n          <div class=\"content\">\n            <a-form ref=\"formRef\" :model=\"formState\" labelAlign=\"right\" autocomplete=\"off\">\n              <a-card title=\"基本信息\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"stationName\"\n                      label=\"电站名称\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                    >\n                      <a-input v-model:value=\"formState.stationName\" disabled />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"ticketNumber\"\n                      label=\"工作票号\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                    >\n                      <a-input v-model:value=\"formState.ticketNumber\" disabled />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"headName\"\n                      label=\"工作负责人\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-input v-model:value=\"formState.headName\" disabled />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"teamsIds\"\n                      label=\"班组成员(内)\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.teamsIds\"\n                        show-search\n                        allow-clear\n                        mode=\"multiple\"\n                        style=\"width: 100%\"\n                        :options=\"stationPersonOptions\"\n                        @change=\"handleChangeTeams\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"outTeams\"\n                      label=\"班组成员(外)\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-input\n                        v-model:value=\"formState.outTeams\"\n                        :maxlength=\"256\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"subject\"\n                      label=\"电站设备名称\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入电站设备名称' }]\"\n                    >\n                      <a-input\n                        v-model:value=\"formState.subject\"\n                        :maxlength=\"100\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"startTime\"\n                      label=\"计划工作开始时间\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入计划工作开始时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.startTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"endTime\"\n                      label=\"计划工作结束时间\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入计划工作结束时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.endTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"workCondition\"\n                      label=\"工作条件\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-textarea\n                        v-model:value=\"formState.workCondition\"\n                        show-count\n                        :rows=\"4\"\n                        :maxlength=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row>\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"attention\"\n                      label=\"注意事项(安全措施)\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入注意事项(安全措施)' }]\"\n                    >\n                      <a-textarea\n                        v-model:value=\"formState.attention\"\n                        show-count\n                        :rows=\"4\"\n                        :maxlength=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n\n              <a-card :bordered=\"false\">\n                <BasicTable title=\"工作任务\" @register=\"registerRecordTable\">\n                  <template v-if=\"!disabledInput\" #toolbar>\n                    <a-button\n                      type=\"primary\"\n                      :preIcon=\"IconEnum.ADD\"\n                      @click=\"handleAddItem('Record')\"\n                    >\n                      {{ t('common.action.create') }}\n                    </a-button>\n                  </template>\n\n                  <template #bodyCell=\"{ column, record }\">\n                    <template v-if=\"column.dataIndex === 'title'\">\n                      <a-input\n                        v-model:value=\"record[column.dataIndex]\"\n                        :maxlength=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </template>\n                    <template v-if=\"column.dataIndex === 'content'\">\n                      <a-input\n                        v-model:value=\"record[column.dataIndex]\"\n                        :maxlength=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </template>\n                    <template v-if=\"column.dataIndex === 'action'\">\n                      <TableAction\n                        :actions=\"[\n                          {\n                            tooltip: '删除',\n                            color: 'error',\n                            icon: 'ant-design:delete-outlined',\n                            ifShow: !disabledInput,\n                            onClick: handleDeleteItem.bind(null, record, 'Record'),\n                          },\n                        ]\"\n                      />\n                    </template>\n                  </template>\n                </BasicTable>\n              </a-card>\n\n              <a-card v-if=\"process.stationMember.show\" title=\"执行归档\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"performHeadId\"\n                      label=\"执行负责人\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请选择执行负责人' }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.performHeadId\"\n                        show-search\n                        allow-clear\n                        style=\"width: 100%\"\n                        :options=\"stationPersonOptions\"\n                        @change=\"handleChangePerformHeadName\"\n                        :disabled=\"process.stationMember.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"licensorId\"\n                      label=\"工作许可人\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请选择工作许可人' }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.licensorId\"\n                        show-search\n                        allow-clear\n                        style=\"width: 100%\"\n                        :options=\"stationPersonOptions\"\n                        @change=\"handleChangeLicensorName\"\n                        :disabled=\"process.stationMember.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"performTeamIds\"\n                      label=\"执行班组\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请选择执行班组' }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.performTeamIds\"\n                        show-search\n                        allow-clear\n                        mode=\"multiple\"\n                        style=\"width: 100%\"\n                        :options=\"stationPersonOptions\"\n                        @change=\"handleChangePerformTeam\"\n                        :disabled=\"process.stationMember.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"opstartTime\"\n                      label=\"实际工作开始时间\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入实际工作开始时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.opstartTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"process.stationMember.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"opendTime\"\n                      label=\"实际工作结束时间\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入实际工作结束时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.opendTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"process.stationMember.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"performRemarks\"\n                      label=\"归档说明\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-textarea\n                        v-model:value=\"formState.performRemarks\"\n                        show-count\n                        :rows=\"4\"\n                        :maxlength=\"1000\"\n                        :disabled=\"process.stationMember.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <UploadBox\n                  :width=\"800\"\n                  :height=\"550\"\n                  :maxCount=\"20\"\n                  :maxSize=\"100 * 1024 * 1024\"\n                  :application=\"`po`\"\n                  :module=\"`secondworkticket`\"\n                  :vmode=\"process.stationMember.disabled ? `view` : `box`\"\n                  :bizId=\"formState.bizFileId\"\n                />\n              </a-card>\n\n              <a-card v-if=\"process.manager.show\" title=\"合格性检查\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"result\"\n                      label=\"检查结论\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请选择检查结论' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.result\"\n                        :type=\"`inspection_conclusion`\"\n                        :disabled=\"process.manager.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"checkTime\"\n                      label=\"检查时间\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: true, message: '请输入检查时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.checkTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"process.manager.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"illustrate\"\n                      label=\"验证说明\"\n                      :labelCol=\"{ class: 'detail-label-8' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-textarea\n                        v-model:value=\"formState.illustrate\"\n                        show-count\n                        :rows=\"4\"\n                        :maxlength=\"1000\"\n                        :disabled=\"process.manager.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n            </a-form>\n          </div>\n        </div>\n      </a-spin>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, reactive, ref, UnwrapRef, toRaw, computed } from 'vue';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useUserStore } from '/@/store/modules/user';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { ValidateErrorEntity } from 'ant-design-vue/es/form/interface';\n  import type { SelectProps } from 'ant-design-vue';\n  import { FormInstance } from 'ant-design-vue';\n  import { SysMessage } from '@/hooks/web/useMessage';\n  import { BasicTable, useTable, TableAction, EditRecordRow } from '/@/components/Table';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import DictSelectBox from '@/components/Framework/Combox/DictSelectBox.vue';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import { buildShortUUID } from '@/utils/uuid';\n  import {\n    recordColumns,\n    getRecordList,\n    saveData,\n    getData,\n    getOrg,\n    getStationPerson,\n    detailTableProps,\n  } from './secondWorkTicket.data';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { assign } from 'lodash-es';\n  import { trim } from 'xe-utils';\n  import { closeCurrentTab } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n  import { Memory } from '@/router/index';\n  import CustomPrint from '../components/CustomPrint.vue';\n\n  const { t } = useI18n();\n  const userStore = useUserStore();\n  const userInfo = toRaw(userStore.getUserInfo);\n  const query = Memory.getInstance().getQuery(); // route.query;\n  const formRef = ref<FormInstance>();\n  const formState: UnwrapRef<any> = reactive({ spinning: false, status: 0 });\n  const stationPersonOptions = ref<SelectProps['options']>([]) as any;\n  const billTitleOption = reactive<any>({ subject: '电气第二种工作票申请' });\n  const disabledInput = ref<boolean>(true);\n  const process = reactive({\n    // 站长/值长节点\n    head: {\n      show: false,\n      disabled: true,\n    },\n    // 站内成员节点\n    stationMember: {\n      show: false,\n      disabled: true,\n    },\n    // 经理节点\n    manager: {\n      show: false,\n      disabled: true,\n    },\n  });\n\n  const businessStatus = ref<string>('');\n  const listenMessage = ref(query.processInstanceId ? undefined : 'second-work-ticket');\n  const getApproveBoxMode = computed(() => {\n    return !process.stationMember.disabled || !process.manager.disabled ? 'before' : 'default';\n  });\n  const onBefore = (flowData, beforeOperationType) => {\n    const action = beforeOperationType.replace('before', '').toLowerCase();\n    onSubmit(flowData, action);\n  };\n  const validateProcessForm = (formData, flowData, action) => {\n    if (action !== 'agree') {\n      return true;\n    }\n    // 过程数据校验\n    if (!process.stationMember.disabled) {\n      if (!compareDate(formData.opendTime, formData.opstartTime)) {\n        error('请确认实际工作开始时间和结束时间。');\n        return false;\n      }\n    }\n    return true;\n  };\n\n  const onSave = () => {\n    doSave('save', 0);\n  };\n\n  const onSubmit = async (flowData, action) => {\n    const value = formRef.value;\n    if (!value) {\n      return;\n    }\n    // 校验表单数据\n    if (action === 'submit' || action === 'agree') {\n      let pass = true;\n      await value.validateFields().catch((errorObj: ValidateErrorEntity<any>) => {\n        console.log('onSubmit=》error', errorObj);\n        const errorFields = errorObj.errorFields;\n        // 表单滚动到第一个报错处(antd),解决form中scrollToFirstError配置无效\n        document\n          .querySelector('.ant-form-item-has-error')\n          ?.scrollIntoView({ behavior: 'smooth', block: 'center' });\n        if (errorFields && errorFields.length > 0) {\n          error(errorFields[0].errors[0]);\n          pass = false;\n          return;\n        }\n      });\n      if (!pass) {\n        return;\n      }\n      const formData = toRaw(formState) as any;\n      if (!compareDate(formData.endTime, formData.startTime)) {\n        error('请确认计划工作开始时间和结束时间。');\n        return;\n      }\n      if (!validateProcessForm(formData, flowData, action)) {\n        return;\n      }\n    }\n    const status = action ? null : 1;\n    doSave(action, status);\n  };\n\n  const doSave = async (action, status) => {\n    formState.spinning = true;\n    try {\n      await saveBiz(action, status);\n    } catch (error) {\n      formState.spinning = false;\n      console.log('error', error);\n    }\n  };\n\n  const saveBiz = async (action, status) => {\n    convertStr(['Id', 'Name']);\n    const formData = toRaw(formState) as any;\n    if (status != null && status > -1) {\n      formData.status = status;\n    }\n\n    // 工作任务\n    const recordData = getDataSource('Record');\n    if (status === 1) {\n      recordData.forEach((item) => {\n        if (!trim(item.title)) {\n          const message = '工作任务，工作地点及设备名称不能为空';\n          error(message);\n          throw new Error(message);\n        }\n        if (!trim(item.content)) {\n          const message = '工作任务，工作内容不能为空';\n          error(message);\n          throw new Error(message);\n        }\n      });\n    }\n    formData.recordList = recordData;\n    await saveData(formData)\n      .then((res) => {\n        formState.id = res.result;\n        if (status === 1) {\n          disabledInput.value = true;\n        }\n        formState.spinning = false;\n        businessStatus.value = action;\n        if (status === 0 || status === 1) {\n          success('操作成功');\n        }\n        reloadBizTable(status);\n      })\n      .catch(() => {\n        formState.spinning = false;\n      });\n  };\n\n  const reloadBizTable = (status: number) => {\n    if (status === 0 || status === 1) {\n      setTimeout(() => {\n        if (status === 1) {\n          closeCurrentTab();\n        }\n        MsgManager.getInstance().sendMsg('second-work-ticket', {});\n      }, 200);\n    }\n  };\n\n  const compareDate = (d1, d2) => {\n    let date1 = new Date(Date.parse(d1));\n    let date2 = new Date(Date.parse(d2));\n    return date1 > date2;\n  };\n\n  const error = (content) => {\n    formState.spinning = false;\n    SysMessage.getInstance().error(content);\n  };\n\n  const success = (content) => {\n    SysMessage.getInstance().success(content);\n  };\n\n  const initNodeAuth = (node: string) => {\n    const processVariable = { ...formState.processVariable };\n    const isCurrentNodeAuth =\n      processVariable.taskDefinitionKey === node &&\n      processVariable.assigneeId.indexOf(userInfo.userId) > -1 &&\n      processVariable.status === 1;\n    const type = node.replace('Node', '');\n    process[type].disabled = !isCurrentNodeAuth;\n  };\n\n  // 处理任务实列节点是否显示\n  const handleTaskInstanceNode = () => {\n    const taskInstances = formState.taskInstances;\n    if (taskInstances?.length) {\n      taskInstances.forEach((item) => {\n        if (item.taskDefinitionKey === 'headNode') {\n          process.head.show = true;\n        }\n        if (item.taskDefinitionKey === 'stationMemberNode') {\n          process.stationMember.show = true;\n        }\n        if (item.taskDefinitionKey === 'managerNode') {\n          process.manager.show = true;\n        }\n      });\n    }\n    // 通过、不通过、终止业务节点全部显示\n    if (formState.status === 2 || formState.status === 3 || formState.status === 5) {\n      process.head.show = true;\n      process.stationMember.show = true;\n      process.manager.show = true;\n    }\n  };\n\n  const isEdit = () => {\n    // 站长/值长节点\n    initNodeAuth('headNode');\n    // 站内成员节点\n    initNodeAuth('stationMemberNode');\n    // 经理节点\n    initNodeAuth('managerNode');\n    // 申请节点\n    const isApply =\n      (formState.status === 0 || formState.status === 6) &&\n      (!formState.personMemberId || formState.personMemberId.indexOf(userInfo.userId) > -1);\n    disabledInput.value = !isApply;\n    // 处理任务实列节点是否显示\n    handleTaskInstanceNode();\n  };\n\n  const getRecordable = async () => {\n    const res = await getData({ id: query.id });\n    if (res.result) {\n      assign(formState, res.result);\n      formState.status = Number(formState.status);\n      convertArr(['Id', 'Name']);\n      disabledInput.value = formState.status != 0;\n      formState.processInstanceId = formState.processVariable?.processInstanceId;\n      if (!formState.processInstanceId) {\n        formState.processInstanceId = query.processInstanceId;\n      }\n      const { billCode, fillinDate, personMemberName, deptName } = res.result;\n      Object.assign(billTitleOption, { billCode, fillinDate, personMemberName, deptName });\n\n      isEdit();\n    }\n  };\n\n  const getDetailQueryParam = async (paramObj) => {\n    const id = await getBizParamId();\n    return { ticketId: paramObj.ticketId ? paramObj.ticketId : id };\n  };\n\n  const recordDataSource = ref<any[]>();\n  const [registerRecordTable, { setProps: setRecordProps, getDataSource: getRecordDataSource }] =\n    useTable(\n      assign(\n        {\n          dataSource: recordDataSource,\n          columns: recordColumns,\n        },\n        detailTableProps,\n      ),\n    );\n\n  const initTableData = async () => {\n    const param = await getDetailQueryParam({});\n    const dataObj = await getRecordList(param);\n    recordDataSource.value = dataObj.result;\n  };\n\n  function handleAddItem(type: string) {\n    const addRow: EditRecordRow = {};\n    pushItemRow(addRow, type);\n  }\n\n  function getDataSource(type) {\n    if (type === 'Record') {\n      return getRecordDataSource();\n    }\n    return [];\n  }\n\n  function pushItemRow(addRow: EditRecordRow, type: string) {\n    const data = getDataSource(type);\n    data.push(addRowOption(addRow));\n  }\n\n  function addRowOption(addRow: EditRecordRow) {\n    addRow.editable = true;\n    addRow.isNew = true;\n    addRow.key = `${Date.now()}`;\n    return addRow;\n  }\n\n  function handleDeleteItem(record, type) {\n    const data = getDataSource(type);\n    let index = data.indexOf(record);\n    if (index !== -1) {\n      data.splice(index, 1);\n    }\n  }\n\n  function handleChangeTeams(value: string, option) {\n    formState.teamsNames = option.map((item) => item.label);\n  }\n\n  function handleChangePerformHeadName(value: string, option) {\n    formState.performHeadName = option.label;\n  }\n\n  function handleChangeLicensorName(value: string, option) {\n    formState.licensorName = option.label;\n  }\n\n  function handleChangePerformTeam(value: string, option) {\n    formState.performTeamNames = option.map((item) => item.label);\n  }\n\n  function initStationPersonOptions() {\n    getStationPerson('?stationId=' + formState.stationId).then((res) => {\n      if (res.result && res.result.length > 0) {\n        res.result.forEach((item) => {\n          stationPersonOptions.value.push({ value: item.userId, label: item.name });\n        });\n      }\n    });\n  }\n\n  function convertStr(suffixs: Array<string>) {\n    suffixs.forEach((suffix) => {\n      const fields = ref<Array<string>>(['teams', 'performTeam']);\n      fields.value.forEach((item) => {\n        const value = formState[item + suffix + 's'];\n        if (value && value.length > 0) {\n          formState[item + suffix] = value.join(',');\n        }\n      });\n    });\n  }\n\n  function convertArr(suffixs: Array<string>) {\n    suffixs.forEach((suffix) => {\n      const fields = ref<Array<string>>(['teams', 'performTeam']);\n      fields.value.forEach((item) => {\n        const value = formState[item + suffix];\n        if (value) {\n          formState[item + suffix + 's'] = value.split(',');\n        }\n      });\n    });\n  }\n\n  const initUserOrg = async () => {\n    const res = await getOrg({});\n    if (res.result && res.result.user) {\n      formState.headId = res.result.user.id;\n      formState.headName = res.result.user.name;\n    }\n  };\n\n  const getBizParamId = async () => {\n    let id = query.id;\n    if (!id && query.processInstanceId) {\n      const processInstance = (await ProcessInstanceApi.getProcessInstance(\n        query.processInstanceId as string,\n      )) as any;\n      const businessKey = processInstance.businessKey;\n      query.id = businessKey;\n      id = businessKey;\n    }\n    return id;\n  };\n\n  const getActionColumn = (ifShow) => {\n    return {\n      width: 80,\n      title: '操作',\n      dataIndex: 'action',\n      ifShow: ifShow,\n    };\n  };\n\n  const setTableProps = () => {\n    setRecordProps({\n      actionColumn: getActionColumn(!disabledInput.value),\n    });\n  };\n\n  onMounted(async () => {\n    query.id = await getBizParamId();\n    await getRecordable();\n    if (!query.id) {\n      assign(formState, query);\n      disabledInput.value = false;\n      formState.bizFileId = buildShortUUID();\n      await initUserOrg();\n    }\n    setTableProps();\n    initStationPersonOptions();\n    initTableData();\n  });\n</script>\n<style lang=\"less\" scoped>\n  @import '/@/design/biz/bizForm.less';\n</style>\n"],"names":["t","useI18n","userStore","useUserStore","userInfo","toRaw","query","Memory","formRef","ref","formState","reactive","stationPersonOptions","billTitleOption","disabledInput","process","businessStatus","listenMessage","getApproveBoxMode","computed","onBefore","flowData","beforeOperationType","action","onSubmit","validateProcessForm","formData","compareDate","error","onSave","doSave","__async","value","pass","errorObj","errorFields","_a","status","saveBiz","convertStr","recordData","getDataSource","item","trim","message","saveData","res","success","reloadBizTable","closeCurrentTab","MsgManager","d1","d2","date1","date2","content","SysMessage","initNodeAuth","node","processVariable","__spreadValues","isCurrentNodeAuth","type","handleTaskInstanceNode","taskInstances","isEdit","isApply","getRecordable","getData","assign","convertArr","billCode","fillinDate","personMemberName","deptName","getDetailQueryParam","paramObj","id","getBizParamId","recordDataSource","registerRecordTable","setRecordProps","getRecordDataSource","useTable","recordColumns","detailTableProps","initTableData","param","dataObj","getRecordList","handleAddItem","pushItemRow","addRow","addRowOption","handleDeleteItem","record","data","index","handleChangeTeams","option","handleChangePerformHeadName","handleChangeLicensorName","handleChangePerformTeam","initStationPersonOptions","getStationPerson","suffixs","suffix","initUserOrg","getOrg","businessKey","ProcessInstanceApi.getProcessInstance","getActionColumn","ifShow","setTableProps","onMounted","buildShortUUID"],"mappings":"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"}