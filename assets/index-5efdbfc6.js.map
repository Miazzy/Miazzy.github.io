{"version":3,"file":"index-5efdbfc6.js","sources":["../../src/views/po/assess/filling/index.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <CommonTree\n      title=\"电站组织\"\n      @select=\"handleSelect\"\n      :value=\"treeData\"\n      class=\"left-tree-layout\"\n      :toolbar=\"true\"\n      :canEdit=\"false\"\n      :canAdd=\"false\"\n      :canDelete=\"false\"\n      :isShowOperationBtns=\"false\"\n      :fieldNames=\"{ key: 'id', title: 'name' }\"\n    />\n    <div class=\"right-table-layout\">\n      <BasicTable\n        @register=\"registerTable\"\n        class=\"fix-basic-table\"\n        @resize-column=\"(w, col) => (col.width = w)\"\n        @row-db-click=\"(record) => handleView(record)\"\n        @selection-change=\"handleSelectionChange\"\n      >\n        <template #toolbar>\n          <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleCreate\">{{\n            t('common.action.create')\n          }}</a-button>\n          <a-button\n            :disabled=\"disabledBtn\"\n            class=\"red-btn\"\n            :preIcon=\"IconEnum.DELETE\"\n            @click=\"handleDelete\"\n            >{{ t('common.delText') }}</a-button\n          >\n          <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExport\">{{\n            t('common.action.export')\n          }}</a-button>\n        </template>\n      </BasicTable>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, reactive, ref } from 'vue';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { IconEnum } from '@/enums/appEnum';\n  import { BasicTable, useTable, SorterResult } from '/@/components/Table';\n  import { TreeItem } from '/@/components/Tree';\n  import { PageWrapper } from '/@/components/Page';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import { exportExcelFile } from '@/utils/file/download';\n  import * as CommonUtil from '/@/utils/common';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { getTreeList, getPage, getData, exportExcel, columns, searchForm } from './filling.data';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '/@/message/MsgManager';\n  import { assign } from 'lodash-es';\n\n  const { t } = useI18n();\n  const message = useMessage();\n  const treeData = ref<TreeItem[]>([]);\n  const searchInfo = reactive<any>({});\n  const checkedNode = reactive<any>({});\n  const disabledBtn = ref<boolean>(true);\n\n  const getParam = (isPage: boolean) => {\n    const form = getForm();\n    const query = {} as any;\n    assign(query, form.getFieldsValue(), searchInfo);\n    if (isPage) {\n      const paginationRef = getPaginationRef() as any;\n      query.pageNo = paginationRef.current;\n      query.pageSize = paginationRef.pageSize;\n    }\n    if (!searchInfo.sortField) {\n      query.sortField = 'fillinDate';\n      query.sortOrder = 'desc';\n    }\n    return query;\n  };\n\n  const getPageByParam = async () => {\n    const param = getParam(true);\n    const pageList = await getPage(param);\n    return pageList.result;\n  };\n\n  const tableTitle = ref<string>('细则填报');\n  const [\n    registerTable,\n    { reload, getForm, getPaginationRef, getSelectRows, clearSelectedRowKeys },\n  ] = useTable({\n    title: tableTitle,\n    api: getPageByParam,\n    columns: columns(),\n    useSearchForm: true,\n    formConfig: searchForm,\n    bordered: true,\n    rowSelection: {\n      type: 'radio',\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      const sortOrder = sortInfo.order?.replace('end', '');\n      searchInfo.sortOrder = sortOrder;\n      searchInfo.sortField = sortOrder ? sortInfo.field : undefined;\n    },\n    showTableSetting: true,\n    tableSetting: { fullScreen: true },\n    showIndexColumn: true,\n  });\n\n  function handleCreate() {\n    if (!checkedNode.stationId) {\n      message.error('请选择电站组织');\n      return;\n    }\n    addTabPage(\n      `/po/assess/filling/create?stationId=${checkedNode.stationId}&stationName=${checkedNode.stationName}&stationOrganId=${checkedNode.stationOrganId}&stationOrganName=${checkedNode.stationOrganName}`,\n      getTabPageName(),\n    );\n  }\n\n  function checkSelectData() {\n    const rows = getSelectRows();\n    if (rows.length == 0) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return rows[0];\n  }\n\n  const handleDelete = async () => {\n    const record = checkSelectData();\n    if (!record) {\n      return;\n    }\n    await message.delConfirm();\n    if (record.status != 0) {\n      message.error(t('common.message.delNotDraftMessage'));\n      return;\n    }\n    const res = await getData({ id: record.id });\n    await ProcessInstanceApi.deleteProcessInstance(res.result?.processInstanceId);\n    message.success(t('common.delSuccess'));\n    clearSelectedRowKeys();\n    reload();\n  };\n\n  function handleView(record: any) {\n    CommonUtil.toFlowPage(record.id, tableTitle.value);\n  }\n\n  const getTabPageName = (record?: any) => {\n    const name = tableTitle.value;\n    if (!record?.id) {\n      return `${t('common.action.create')}${name}`;\n    }\n    if (record?.status === 0) {\n      return `${t('common.action.edit')}${name}`;\n    }\n    if (record?.status === 1 || record?.status === 6) {\n      return `审批${name}`;\n    }\n    return `查看${name}`;\n  };\n\n  // 查询左侧树数据\n  async function queryTreeList() {\n    const typeList = await getTreeList({});\n    treeData.value = typeList.result as unknown[] as TreeItem[];\n  }\n\n  // 左侧树选中事件\n  function handleSelect(node) {\n    searchInfo.stationOrganId = null;\n    searchInfo.stationId = null;\n    checkedNode.stationId = '';\n    checkedNode.stationName = '';\n    checkedNode.stationOrganId = '';\n    checkedNode.stationOrganName = '';\n\n    if (node) {\n      if (node.nodeKindId === 'org') {\n        searchInfo.stationOrganId = node.id;\n      }\n      if (node.nodeKindId === 'station') {\n        searchInfo.stationId = node.powerStationId;\n        checkedNode.stationId = node.powerStationId;\n        checkedNode.stationName = node.powerStationName;\n        checkedNode.stationOrganId = node.organId;\n        checkedNode.stationOrganName = node.organName;\n      }\n    }\n    reload();\n  }\n\n  function handleExport() {\n    message.createConfirm({\n      title: t('common.message.confirmTitle'),\n      iconType: 'warning',\n      content: t('common.message.exportMessage'),\n      async onOk() {\n        const query = getParam(false);\n        query.filename = `${tableTitle.value}.xls`;\n        query.excelList = columns();\n        await exportExcel(query).then((res) => {\n          exportExcelFile(res?.data, query.filename);\n        });\n        message.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n\n  function handleSelectionChange({ rows }) {\n    disabledBtn.value = rows.length === 0;\n  }\n\n  // 启动执行代码\n  onMounted(() => {\n    queryTreeList();\n\n    MsgManager.getInstance().listen('assess-filling', reload);\n  });\n</script>\n<style lang=\"less\" scoped>\n  @import '/@/design/biz/bizList.less';\n</style>\n"],"names":["t","useI18n","message","useMessage","treeData","ref","searchInfo","reactive","checkedNode","disabledBtn","getParam","isPage","form","getForm","query","assign","paginationRef","getPaginationRef","getPageByParam","__async","param","getPage","tableTitle","registerTable","reload","getSelectRows","clearSelectedRowKeys","useTable","columns","searchForm","sortInfo","sortOrder","_a","handleCreate","addTabPage","getTabPageName","checkSelectData","rows","handleDelete","record","res","getData","ProcessInstanceApi.deleteProcessInstance","handleView","CommonUtil.toFlowPage","name","queryTreeList","typeList","getTreeList","handleSelect","node","handleExport","exportExcel","exportExcelFile","handleSelectionChange","onMounted","MsgManager"],"mappings":"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"}