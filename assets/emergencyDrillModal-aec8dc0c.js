var Te=Object.defineProperty;var Q=Object.getOwnPropertySymbols;var Ce=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable;var W=(g,m,d)=>m in g?Te(g,m,{enumerable:!0,configurable:!0,writable:!0,value:d}):g[m]=d,J=(g,m)=>{for(var d in m||(m={}))Ce.call(m,d)&&W(g,d,m[d]);if(Q)for(var d of Q(m))De.call(m,d)&&W(g,d,m[d]);return g};var f=(g,m,d)=>new Promise((Y,e)=>{var E=_=>{try{B(d.next(_))}catch(S){e(S)}},R=_=>{try{B(d.throw(_))}catch(S){e(S)}},B=_=>_.done?Y(_.value):Promise.resolve(_.value).then(E,R);B((d=d.apply(g,m)).next())});import{d as Ne,k as v,r as Z,J as Pe,ax as ke,u as k,K as Me,o as Se,al as b,Z as w,_ as Ue,f as n,aa as o,$ as z,a9 as T,ac as x,v as C,A as D,E as Ye,ad as Be,q as Fe}from"./vue-71d1abb3.js";import{d as qe,h as ze,a as G,i as Re,j as Ae,s as Ee,k as Le}from"./emergencyDrill-efa8fbef.js";import{W as Oe}from"./WfApproveBox-a3448232.js";import{a0 as $e,b as He,ak as Ke,av as Ve,a7 as je,aC as Qe,aB as We,bP as Je}from"./index.js";import{B as Ze}from"./BillTitle-d17ab3e4.js";import{B as Ge}from"./BasicTable-0434a334.js";import{T as Xe}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as X}from"./useTable-109483b3.js";import{a2 as A,P as et}from"./antd-15ac76ed.js";import{_ as ee}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{T as tt}from"./index-aadc7f51.js";import{_ as at}from"./UploadTable.vue_vue_type_script_setup_true_lang-5478923e.js";import{a as M}from"./assign-37f1c13d.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./useRender-21ce56fb.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./OrganDialog-dd1023ce.js";import"./Dialog-0a006d82.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";const nt={class:"load"},st={class:"process-box"},lt={class:"header-box"},ot={class:"content"},it={style:{margin:"10px 0 0 20px"}},rt={style:{margin:"5px 16px 20px 10px"}},Kt=Ne({__name:"emergencyDrillModal",setup(g){const m=v(),d=v([]),Y=v(!0),e=Z({spinning:!1}),E=$e(),R=Pe(E.getUserInfo),B=v(),{t:_}=He(),S=v(),L=v([]),p=v(!0),F=Z({});F.subject="应急预案演练",F.infoItems=[];const te=ke(),{currentRoute:ae}=te;k(ae);const I=Ke.getInstance().getQuery();function ne(a,t){e.commanderName=t.value,e.commanderId=t.lable}function se(a,t){}function le(){Re("?stationId="+e.stationId).then(a=>{a.result&&a.result.length>0&&a.result.forEach(t=>{L.value.push({value:t.name,lable:t.userId})})})}const $=v(),oe=()=>f(this,null,function*(){const a=yield Ae({orgId:e.stationOrganId,orgKindIds:"ogn,dpt,pos,psm",showPosition:!0,status:1});B.value=H(a.result)});function H(a){const t=[];for(let i=0;i<a.length;i++){const l=a[i],u={label:l.name,value:l.id,disabled:l.orgKindId!=="psm"};l.children&&l.children.length>0&&(u.children=H(l.children)),t.push(u)}return t}function K(a){const t=v([]);let i=0,l=!0;if(et(O()).forEach(r=>{const c=v({});let U=[],N=[];if(Array.isArray(r.innerPersonNames))if(r.innerPersonNames.forEach(y=>{y.option!=null&&(U.push(y.option.value),N.push(y.option.lable))}),U.length>0){let y=U.join(","),q=N.join(",");r.innerPersonNames=y,r.innerPersonIds=q}else{let y=r.innerPersonNames.join(","),q=r.innerPersonIds.join(",");r.innerPersonNames=y,r.innerPersonIds=q}r.count!=null?i=i+r.count:l=!1,M(c.value,r),t.value.push(c.value)}),!l){A.warning("请添加参加成员明细人数。");return}if(i==0){A.warning("请添加参加成员明细。");return}e.dtlList=t.value,e.spinning=!0,e.totalCount=i;try{a=a||0,$.value.validateFields().then(()=>{e.status=a,Ee(e).then(r=>{e.id=r,G({id:r}).then(c=>{M(e,c.result)}),A.success(a==1?"提交成功。":"保存成功"),je.getInstance().sendMsg("emergencydrill",{}),a==1&&(p.value=!0,Qe())})})}catch(r){console.log("error",r)}finally{e.spinning=!1}}const[ie,{getDataSource:O}]=X(M({dataSource:S,columns:qe},ze)),re=()=>f(this,null,function*(){S.value=yield de({})}),de=a=>f(this,null,function*(){const t=yield ue(a),i=yield Le(t);return i.result.forEach(l=>{l.innerPersonNames?l.innerPersonNames=l.innerPersonNames.split(","):l.innerPersonNames=[],l.innerPersonIds?l.innerPersonIds=l.innerPersonIds.split(","):l.innerPersonIds=[]}),i.result}),ue=a=>f(this,null,function*(){const t=yield V();return{emergencyDrillId:a.emergencyDrillId?a.id:t+""}});function me(){pe({})}function pe(a){O().push(ce(a))}function ce(a){return a.editable=!0,a.isNew=!0,a.key=`${Date.now()}`,a}function fe(a){const t=O();let i=t.indexOf(a);i!==-1&&t.splice(i,1)}function ve(){let a=!0;if(R.orgs.forEach(t=>{t.id==e.personMemberId&&(a=!0)}),e.personMemberId!=null&&!a){A.warning("只有创建人可提交。");return}K(1)}function be(){K(0)}M(e,{processInstanceId:"",id:"",billCode:"",fillinDate:"",organId:"",organName:"",deptId:"",deptName:"",positionId:"",positionName:"",personMemberId:"",personMemberName:"",fullId:"",status:0,bizFileId:"",subject:"",finishedDate:"",name:"",drillType:"",drillMode:"",commanderId:"",commanderName:"",startTime:"",endTime:"",totalCount:"",content:""});const V=()=>f(this,null,function*(){let a=I.id;if(!a&&I.processInstanceId){const i=(yield We(I.processInstanceId)).businessKey;I.id=i,a=i}return a}),ge=()=>f(this,null,function*(){p.value=e.status!=0,F.title="应急预案演练",e.processInstanceId=I.processInstanceId;let{billCode:a,fillinDate:t,personMemberName:i,deptName:l}=e;M(F,{billCode:a,fillinDate:t,personMemberName:i,deptName:l})}),Ie=()=>f(this,null,function*(){Je().then(a=>{e.bizFileId=a,j()})}),_e=v([]),j=()=>f(this,null,function*(){ye(e.bizFileId)}),ye=a=>{const t=["应急预案演练"],i=["emergencyDrill"],l={fileKindId:"",filetype:"",bizId:a,maxCount:20,maxSize:20971520,required:!1,readonly:!0},u=[];for(let r=0;r<1;r++){let c=J({},l);c.fileKindId=i[r],c.filetype=t[r],c.readonly=p.value,u.push(c)}d.value=u};X({columns:[{title:"附件类型",dataIndex:"fileType",align:"left",width:150},{title:"附件",dataIndex:"bizFileId",align:"left",width:600}],pagination:!1,showIndexColumn:!1,showTableSetting:!1,tableSetting:{fullScreen:!0},dataSource:_e});const he=()=>f(this,null,function*(){I.id=yield V(),yield G({id:I.id}).then(a=>{I.id?(M(e,a.result),e.status==0&&e.personMemberId.substring(0,32)!=R.userId&&(e.status=10)):(M(e,I),e.spinning=!1,e.status=0,e.billCode=a.result.billCode,e.personMemberName=a.result.personMemberName,e.fillinDate=a.result.fillinDate,e.deptName=a.result.deptName),e.status==1&&(p.value=!0)}),I.id||(p.value=!1),yield ge(),le(),re(),oe(),e.bizFileId==null||e.bizFileId==null||e.bizFileId==""?Ie():j()});return Me(()=>{Y.value=!1,Fe(()=>{Y.value=!0})}),Se(()=>f(this,null,function*(){he()})),(a,t)=>{const i=b("a-input"),l=b("a-form-item"),u=b("a-col"),r=b("a-row"),c=b("a-select"),U=b("a-date-picker"),N=b("a-card"),y=b("a-button"),q=b("a-input-number"),we=b("a-form"),xe=b("a-spin");return w(),Ue("div",nt,[n(xe,{spinning:e.spinning,tip:"Loading..."},{default:o(()=>[z("div",st,[z("div",lt,[n(Ze,{options:F},null,8,["options"]),e.status!=10?(w(),T(Oe,{key:0,onSave:be,onSubmit:ve,processInstanceId:e.processInstanceId,processStatus:e.status},null,8,["processInstanceId","processStatus"])):x("",!0)]),z("div",ot,[n(we,{ref_key:"formRef",ref:$,model:e,labelAlign:"right",autocomplete:"off"},{default:o(()=>[n(N,{title:"基本信息",bordered:!1},{default:o(()=>[n(r,{gutter:24},{default:o(()=>[C(n(u,{span:12},{default:o(()=>[n(l,{name:"stationName",label:"电站名称",labelCol:{span:6},rules:[{required:!0,message:"请输入电站名称"}]},{default:o(()=>[n(i,{disabled:"",value:e.stationName,"onUpdate:value":t[0]||(t[0]=s=>e.stationName=s),placeholder:"请输入电站名称"},null,8,["value"]),x("",!0)]),_:1})]),_:1},512),[[D,!0]]),C(n(u,{span:12},{default:o(()=>[n(l,{name:"name",label:"主题",labelCol:{span:6},rules:[{required:!0,message:"请输入主题"}]},{default:o(()=>[n(i,{value:e.name,"onUpdate:value":t[2]||(t[2]=s=>e.name=s),placeholder:"请输入主题",disabled:e.status!=0},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1}),n(r,{gutter:24},{default:o(()=>[C(n(u,{span:12},{default:o(()=>[n(l,{name:"drillType",label:"演练类型",labelCol:{span:6},rules:[{required:!0,message:"请选择演练类型"}]},{default:o(()=>[n(ee,{type:"EmergencyDrillType",onChange:t[3]||(t[3]=s=>"()=> detailFormState.drillType = value"),value:e.drillType,"onUpdate:value":t[4]||(t[4]=s=>e.drillType=s),style:{width:"100%"},disabled:e.status!=0},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]]),C(n(u,{span:12},{default:o(()=>[n(l,{name:"drillMode",label:"演练方式",labelCol:{span:6},rules:[{required:!0,message:"请选择演练方式"}]},{default:o(()=>[n(ee,{type:"EmergencyDrillMode",onChange:t[5]||(t[5]=s=>"()=> detailFormState.drillMode = value"),value:e.drillMode,"onUpdate:value":t[6]||(t[6]=s=>e.drillMode=s),style:{width:"100%"},disabled:e.status!=0},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1}),n(r,{gutter:24},{default:o(()=>[C(n(u,{span:12},{default:o(()=>[n(l,{name:"commanderName",label:"指挥人",labelCol:{span:6},rules:[{required:!0,message:"请选择指挥人"}]},{default:o(()=>[n(c,{value:e.commanderName,"onUpdate:value":t[7]||(t[7]=s=>e.commanderName=s),"show-search":"","allow-clear":"",style:{width:"100%"},placeholder:"请选择操作人",options:L.value,onChange:ne,disabled:p.value},null,8,["value","options","disabled"])]),_:1})]),_:1},512),[[D,!0]]),C(n(u,{span:12},{default:o(()=>[n(l,{name:"startTime",label:"开始时间",labelCol:{span:6},rules:[{required:!0,message:"请选择开始时间"}]},{default:o(()=>[n(U,{value:e.startTime,"onUpdate:value":t[8]||(t[8]=s=>e.startTime=s),format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:00","show-time":"",style:{width:"100%"},disabled:e.status!=0},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1}),n(r,{gutter:24},{default:o(()=>[C(n(u,{span:12},{default:o(()=>[n(l,{name:"endTime",label:"结束时间",labelCol:{span:6},rules:[{required:!0,message:"请选择结束时间"}]},{default:o(()=>[n(U,{value:e.endTime,"onUpdate:value":t[9]||(t[9]=s=>e.endTime=s),format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:00","show-time":"",style:{width:"100%"},disabled:e.status!=0},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]]),C(n(u,{span:12},{default:o(()=>[n(l,{name:"totalCount",label:"参加总人数",labelCol:{span:6},rules:[{required:!0,message:"参加总人数"}]},{default:o(()=>[n(i,{disabled:"",value:e.totalCount,"onUpdate:value":t[10]||(t[10]=s=>e.totalCount=s)},null,8,["value"])]),_:1})]),_:1},512),[[D,!0]])]),_:1})]),_:1}),n(N,{bordered:!1},{default:o(()=>[n(k(Ge),{title:"参加成员",onRegister:k(ie)},{toolbar:o(()=>[p.value?x("",!0):(w(),T(y,{key:0,type:"primary",preIcon:k(Ve).ADD,onClick:t[11]||(t[11]=s=>me())},{default:o(()=>[Ye(Be(k(_)("common.action.create")),1)]),_:1},8,["preIcon"]))]),bodyCell:o(({column:s,record:h})=>[s.dataIndex==="roleName"?(w(),T(i,{key:0,value:h[s.dataIndex],"onUpdate:value":P=>h[s.dataIndex]=P,maxLength:1e3,disabled:p.value},null,8,["value","onUpdate:value","disabled"])):x("",!0),s.dataIndex==="innerPersonNames"?(w(),T(c,{key:1,value:h[s.dataIndex],"onUpdate:value":P=>h[s.dataIndex]=P,"show-search":"","allow-clear":"",mode:"multiple",style:{width:"100%"},options:L.value,onChange:se,disabled:p.value,labelInValue:""},null,8,["value","onUpdate:value","options","disabled"])):x("",!0),s.dataIndex==="outerPersonNames"?(w(),T(i,{key:2,value:h[s.dataIndex],"onUpdate:value":P=>h[s.dataIndex]=P,maxLength:1e3,disabled:p.value},null,8,["value","onUpdate:value","disabled"])):x("",!0),s.dataIndex==="count"?(w(),T(q,{key:3,value:h[s.dataIndex],"onUpdate:value":P=>h[s.dataIndex]=P,maxLength:1e3,disabled:p.value,max:999,min:0,precision:0},null,8,["value","onUpdate:value","disabled"])):x("",!0),s.dataIndex==="action"?(w(),T(k(Xe),{key:4,actions:[{tooltip:"删除",color:"error",icon:"ant-design:delete-outlined",ifShow:!p.value,onClick:fe.bind(null,h)}]},null,8,["actions"])):x("",!0)]),_:1},8,["onRegister"]),n(N,{title:"演练过程",bordered:!1},{default:o(()=>[z("div",it,[Y.value?(w(),T(k(tt),{key:0,modelValue:e.content,"onUpdate:modelValue":t[12]||(t[12]=s=>e.content=s),width:"calc(100% - 17px)",height:300,maxChars:5e3,disabled:e.status!=0},null,8,["modelValue","width","disabled"])):x("",!0)])]),_:1})]),_:1}),n(N,{title:"上传附件",bordered:!1},{default:o(()=>[z("div",rt,[n(at,{ref_key:"uploadTable",ref:m,rows:d.value,colwidths:["15%","70%","15%"],application:"po",module:"emergencyDrill",mode:e.status==0?"normal":"view"},null,8,["rows","mode"])])]),_:1})]),_:1},8,["model"])])])]),_:1},8,["spinning"])])}}});export{Kt as default};
//# sourceMappingURL=emergencyDrillModal-aec8dc0c.js.map
