var p=(t,r,s)=>new Promise((u,f)=>{var n=m=>{try{w(s.next(m))}catch(g){f(g)}},S=m=>{try{w(s.throw(m))}catch(g){f(g)}},w=m=>m.done?u(m.value):Promise.resolve(m.value).then(n,S);w((s=s.apply(t,r)).next())});import{n as te,d as ae,k as _,r as ne,al as v,Z as M,a9 as U,aa as o,f as l,v as C,A as I,u as h,ag as le,E as se,ad as oe,ac as ie,a7 as re}from"./vue-71d1abb3.js";import{a5 as y,au as ue,b as de,av as N,at as T,_ as ce}from"./index.js";import{B as me}from"./BasicTable-0434a334.js";import{T as pe}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as fe}from"./useTable-109483b3.js";import{b7 as be,P as ge}from"./antd-15ac76ed.js";import{a as he,B as ye}from"./index-316f6ffb.js";import{_ as P}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{x as xe}from"./index-66d20ba6.js";import{a as _e}from"./assign-37f1c13d.js";const We="/admin-api/baseset/index-storehouse/import-excel?_t="+new Date().getTime(),ve=t=>y.post({url:"/baseset/index-storehouse/create",params:t},{}),Ce=t=>y.put({url:"/baseset/index-storehouse/update",params:t},{}),Ie=t=>t.id?Ce(t):ve(t),we=(t,r)=>y.put({url:`/baseset/index-storehouse/update-status?id=${t}&status=${r}`},{}),Ve=t=>y.delete({url:`/baseset/index-storehouse/delete?id=${t}`},{}),Te=t=>y.get({url:`/baseset/index-storehouse/get?id=${t}`},{isOnlyResult:!0}),je=t=>y.get({url:"/baseset/index-storehouse/page",params:t},{isOnlyResult:!0}),De=t=>y.get({url:`/baseset/index-storehouse/detail/list?indexStorehouseId=${t}`},{isOnlyResult:!0}),Se="/baseset/index-storehouse/table-page",ke="/baseset/index-storehouse/table-column-page",Ke=t=>y.post({url:"/baseset/index-storehouse/export-excel-template",params:t,responseType:"blob"},{isOnlyResult:!0}),Ze=[{title:"指标类型",dataIndex:"indexType",headAlign:"center",align:"left",fixed:"left",width:120,sorter:!0,resizable:!0},{title:"数据源类型",dataIndex:"dataSourceType",width:100,sorter:!0,resizable:!0,customRender:({record:t})=>t.dataSourceTypeText},{title:"指标名称",dataIndex:"name",headAlign:"center",align:"left",width:200,sorter:!0,resizable:!0},{title:"指标单位",dataIndex:"unitName",width:100,sorter:!0,resizable:!0},{title:"数据粒度",dataIndex:"dataGranularity",width:100,sorter:!0,resizable:!0,customRender:({record:t})=>t.dataGranularityText},{title:"表达式",dataIndex:"expression",headAlign:"center",align:"left",width:200,sorter:!0,resizable:!0},{title:"表达式描述",dataIndex:"expressionZh",headAlign:"center",align:"left",width:200,resizable:!0},{title:"保留小数位",dataIndex:"retainDecimal",headAlign:"center",align:"right",width:100,sorter:!0,resizable:!0},{title:"状态",dataIndex:"status",width:80,sorter:!0,resizable:!0,customRender:({record:t})=>(Reflect.has(t,"pendingStatus")||(t.pendingStatus=!1),te(be,{checked:t.status===1,checkedChildren:"禁用",unCheckedChildren:"启用",loading:t.pendingStatus,onChange:r=>p(void 0,null,function*(){t.pendingStatus=!0;const s=r?1:0,u=ue();we(t.id,s).then(()=>{t.status=s,u.success("已成功修改指标库状态")}).catch(()=>{u.error("修改指标库状态失败")}).finally(()=>{t.pendingStatus=!1})})}))},{title:"创建时间",dataIndex:"createTime",width:150,sorter:!0,resizable:!0}],$=t=>p(void 0,null,function*(){return t?"":"不能为空"}),Re=t=>[{title:"字段标识",dataIndex:"fieldIdentify",width:80,resizable:!0},{title:"数据表",dataIndex:"tableName",headAlign:"center",align:"left",width:240,resizable:!0,editRow:!0,editComponent:"SearchBox",editComponentProps:({record:r})=>({api:Se,apiParamFunc:()=>p(void 0,null,function*(){return{tableSchemaType:t.value,type:"index"}}),searchKey:"keyword",vfield:"tableName",pagination:!0,columns:[{title:"名称",dataIndex:"tableName",key:"tableName",minWidth:100},{title:"注释",dataIndex:"tableComment",key:"tableComment",minWidth:140}],onChange:(s,u)=>{var f;u&&(r.tableComment=(f=u.record)==null?void 0:f.tableComment,r.fieldName="",r.fieldComment="")}}),editRule:$},{title:"数据表描述",dataIndex:"tableComment",headAlign:"center",align:"left",width:200,resizable:!0,editRow:!0,editComponent:"Input",editComponentProps:{maxlength:64}},{title:"字段名",dataIndex:"fieldName",headAlign:"center",align:"left",width:220,resizable:!0,editRow:!0,editComponent:"SearchBox",editComponentProps:({record:r})=>({api:ke,apiParamFunc:()=>p(void 0,null,function*(){const s=r.tableName||"-null-";return{tableSchemaType:t.value,tableName:s,dataType:"number"}}),searchKey:"keyword",vfield:"columnName",pagination:!0,columns:[{title:"名称",dataIndex:"columnName",key:"columnName",minWidth:100},{title:"注释",dataIndex:"columnComment",key:"columnComment",minWidth:120}],onChange:(s,u)=>{var f;u&&(r.fieldComment=(f=u.record)==null?void 0:f.columnComment)}}),editRule:$},{title:"字段名描述",dataIndex:"fieldComment",headAlign:"center",align:"left",width:150,resizable:!0,editRow:!0,editComponent:"Input",editComponentProps:{maxlength:64},editRule:$},{title:"单位换算",dataIndex:"unitConversion",width:120,resizable:!0,editRow:!0,editComponent:"InputNumber",editComponentProps:{min:1,max:1e8,step:1e3,precision:0}}],He={baseColProps:{span:8},labelWidth:120,autoAdvancedLine:1,schemas:[{label:"指标名称",field:"name",component:"Input"},{label:"状态",field:"status",component:"DictSelectBox",componentProps:{type:"enable_or_disable"}}]},ze=ae({name:"DetailModal",__name:"DetailModal",emits:["success","register"],setup(t,{emit:r}){const s=_(!1),u=_(),f=_(),n=ne({}),S=_(),w=_(!1),m=_([]),g=_(""),{t:D}=de(),A=()=>{let e=n.id?D("common.action.update"):D("common.action.create");return s.value&&(e="查看"),e},[O,{setModalProps:k,closeModal:E}]=he(e=>p(this,null,function*(){if(K(),n.id=e.record.id,n.folderId=e.record.folderId,n.indexType=e.record.indexType,s.value=e.record.isReadOnly,S.value=A(),m.value=[],k({confirmLoading:!1}),w.value=!!(e!=null&&e.isUpdate),h(w)){const a=yield Te(e.record.id);B(a.dataSourceType),_e(n,a)}F(n.id)})),F=e=>p(this,null,function*(){m.value=yield De(e)}),[L,{getDataSource:R,setTableData:q}]=fe({dataSource:m,columns:Re(g),useSearchForm:!1,showTableSetting:!1,pagination:!1,bordered:!0,canResize:!1,actionColumn:{width:100,title:D("common.operate"),dataIndex:"action",fixed:"right",ifShow:()=>!s.value}});function G(e,a){a.width=e}function W(){return p(this,null,function*(){if(!n.dataSourceType){T.getInstance().error("请选择数据源类型");return}const e=R(),a={editable:!0,isNew:!0,key:Date.now(),fieldIdentify:`f${e.length+1}`};e.push(a)})}function V(){const e=R();if(e.length==0)return T.getInstance().error(`请${D("common.action.create")}明细信息`),!1;const a=[];let x=[];for(let d=0;d<e.length;d++){const c=e[d];if(!c.tableName)return T.getInstance().error("数据表不能为空"),!1;if(!c.fieldName)return T.getInstance().error("字段名不能为空"),!1;if(!c.fieldComment)return T.getInstance().error("字段名描述不能为空"),!1;x.push(c.dataGranularity);const b=ge(c.editValueRefs);b.fieldIdentify=c.fieldIdentify,b.sort=d+1,a.push(b)}return a}function j(){return p(this,null,function*(){try{const e=u.value;e&&e.validateFields().then(()=>p(this,null,function*(){n.detailList=V(),n.detailList&&(n.name=xe.trim(n.name),n.status=1,k({confirmLoading:!0}),Ie(n).then(()=>{const a=A();T.getInstance().success(a+"成功"),E(),r("success")}).catch(()=>{k({confirmLoading:!1})}))}))}finally{k({confirmLoading:!1})}})}function K(){var e;(e=u.value)==null||e.resetFields()}function Z(e){return[{label:"",icon:N.EDIT,onClick:H.bind(null,e)},{label:"",icon:N.DELETE,danger:!0,popConfirm:{title:"是否确认删除",confirm:J.bind(null,e)}}]}function H(e){var a;(a=e.onEdit)==null||a.call(e,!0)}const J=e=>p(this,null,function*(){const a=R(),x=a.findIndex(d=>d.key===e.key);a.splice(x,1)}),B=e=>{g.value="",e==="biz_table"?g.value="bizTable":e==="data_warehouse"&&(g.value="dataWarehouse")},Q=e=>{B(e),q([])};return(e,a)=>{const x=v("a-input"),d=v("a-form-item"),c=v("a-col"),b=v("a-row"),X=v("a-button"),Y=v("a-input-number"),ee=v("a-form");return M(),U(h(ye),re(e.$attrs,{title:`${S.value}指标库`,width:920,maskClosable:!1,keyboard:!1,showOkBtn:!s.value,showCancelBtn:!s.value,canFullscreen:!1,onRegister:h(O),onOk:j}),{default:o(()=>[l(ee,{ref_key:"modalFormRef",ref:u,model:n,autocomplete:"off"},{default:o(()=>[l(b,{gutter:32},{default:o(()=>[C(l(c,{span:12},{default:o(()=>[l(d,{label:"指标类型",name:"indexType",labelCol:{class:"detail-label"},rules:[{required:!1}]},{default:o(()=>[l(x,{value:n.indexType,"onUpdate:value":a[0]||(a[0]=i=>n.indexType=i),disabled:!0},null,8,["value"])]),_:1})]),_:1},512),[[I,!0]]),C(l(c,{span:12},{default:o(()=>[l(d,{label:"数据源类型",name:"dataSourceType",labelCol:{class:"detail-label"},rules:[{required:!0}]},{default:o(()=>[l(P,{value:n.dataSourceType,"onUpdate:value":a[1]||(a[1]=i=>n.dataSourceType=i),type:"data_source_type",disabled:s.value,onChange:Q},null,8,["value","disabled"])]),_:1})]),_:1},512),[[I,!0]])]),_:1}),l(b,{gutter:32},{default:o(()=>[C(l(c,{span:12},{default:o(()=>[l(d,{label:"指标名称",name:"name",labelCol:{class:"detail-label"},rules:[{required:!0}]},{default:o(()=>[l(x,{value:n.name,"onUpdate:value":a[2]||(a[2]=i=>n.name=i),maxlength:20,disabled:s.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[I,!0]]),C(l(c,{span:12},{default:o(()=>[l(d,{label:"指标单位",name:"unitId",labelCol:{class:"detail-label"},rules:[{required:!1}]},{default:o(()=>[l(P,{value:n.unitId,"onUpdate:value":a[3]||(a[3]=i=>n.unitId=i),type:"index_storehouse_unit",disabled:s.value,onChange:a[4]||(a[4]=(i,z)=>{n.unitName=z.label})},null,8,["value","disabled"])]),_:1})]),_:1},512),[[I,!0]])]),_:1}),l(b,{gutter:32},{default:o(()=>[C(l(c,{span:12},{default:o(()=>[l(d,{label:"数据粒度",name:"dataGranularity",labelCol:{class:"detail-label"},rules:[{required:!1}]},{default:o(()=>[l(P,{value:n.dataGranularity,"onUpdate:value":a[5]||(a[5]=i=>n.dataGranularity=i),type:"data_granularity",disabled:s.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[I,!0]])]),_:1}),l(b,{gutter:32},{default:o(()=>[l(h(me),{class:"modal-table modal-table-top",ref_key:"modalTableRef",ref:f,onRegister:h(L),onResizeColumn:G},le({_:2},[s.value?void 0:{name:"toolbar",fn:o(()=>[l(X,{type:"primary",preIcon:h(N).ADD,onClick:W},{default:o(()=>[se(oe(h(D)("common.action.create")),1)]),_:1},8,["preIcon"])]),key:"0"},s.value?void 0:{name:"bodyCell",fn:o(({column:i,record:z})=>[i.key==="action"?(M(),U(h(pe),{key:0,actions:Z(z)},null,8,["actions"])):ie("",!0)]),key:"1"}]),1032,["onRegister"])]),_:1}),l(b,{gutter:32},{default:o(()=>[C(l(c,{span:12},{default:o(()=>[l(d,{label:"表达式",name:"expression",labelCol:{class:"detail-label"},rules:[{required:!1}]},{default:o(()=>[l(x,{value:n.expression,"onUpdate:value":a[6]||(a[6]=i=>n.expression=i),maxlength:64,disabled:s.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[I,!0]]),C(l(c,{span:12},{default:o(()=>[l(d,{label:"保留小数位",name:"retainDecimal",labelCol:{class:"detail-label"},rules:[{required:!0}]},{default:o(()=>[l(Y,{value:n.retainDecimal,"onUpdate:value":a[7]||(a[7]=i=>n.retainDecimal=i),min:0,max:10,step:1,precision:0,disabled:s.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[I,!0]])]),_:1})]),_:1},8,["model"])]),_:1},16,["title","showOkBtn","showCancelBtn","onRegister"])}}});const Ne=ce(ze,[["__scopeId","data-v-031764e5"]]),Je=Object.freeze(Object.defineProperty({__proto__:null,default:Ne},Symbol.toStringTag,{value:"Module"}));export{Ne as D,Je as a,Ze as c,Ve as d,Ke as e,je as g,We as i,He as s,we as u};
//# sourceMappingURL=DetailModal-e402d25c.js.map
