{"version":3,"file":"index-2984e63f.js","sources":["../../src/views/po/integrated/assessmentevaluation/monthly/index.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <!-- 数据表格 -->\n    <BasicTable\n      class=\"fix-basic-table\"\n      @register=\"registerTable\"\n      :searchInfo=\"searchInfo\"\n      @selection-change=\"handleSelectChange\"\n      @resize-column=\"(w, col) => (col.width = w)\"\n      @row-db-click=\"(record) => handleReadOnlyView(record)\"\n    >\n      <template #toolbar>\n        <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleAdd\">\n          {{ t('common.action.create') }}</a-button\n        >\n        <a-button\n          class=\"red-btn\"\n          :disabled=\"selectedRowId == ''\"\n          :preIcon=\"IconEnum.DELETE\"\n          @click=\"handleDelete\"\n        >\n          {{ t('common.delText') }}</a-button\n        >\n        <a-button\n          class=\"green-btn\"\n          :preIcon=\"IconEnum.ENABLE\"\n          :disabled=\"selectedRowId == ''\"\n          @click=\"handleUpdate(1)\"\n          >启用</a-button\n        >\n        <a-button\n          class=\"grey-btn\"\n          :preIcon=\"IconEnum.DISABLE\"\n          :disabled=\"selectedRowId == ''\"\n          @click=\"handleUpdate(0)\"\n          >禁用</a-button\n        >\n        <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExport\"\n          >导出</a-button\n        >\n      </template>\n      <template #bodyCell=\"{ column, text, record }\">\n        <template v-if=\"column.dataIndex === 'businessStatusText'\">\n          <span style=\"color: #30ca5a\" v-if=\"text == '有效'\">有效</span>\n          <span style=\"color: #929292\" v-if=\"text == '无效'\">无效</span>\n        </template>\n      </template>\n    </BasicTable>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, reactive, ref } from 'vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { ElMessageBox } from 'element-plus';\n  import { BasicTable, useTable, TableAction } from '/@/components/Table';\n  import { useRouter } from 'vue-router';\n  import { PageWrapper } from '/@/components/Page';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { cancelProcessInstance } from '@/api/bpm/processInstance';\n  import { message } from 'ant-design-vue';\n  import { columns, getDataList, searchFormSchema, exportExcel, updateStatus } from './monthly.ts';\n  import { exportExcelFile } from '@/utils/file/download';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '/@/message/MsgManager';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import * as CommonUtil from '/@/utils/common';\n\n  const router = useRouter();\n\n  let selectedRow = reactive({});\n  let selectedRowId = ref('');\n  const { createConfirm, createMessage } = useMessage();\n  const { t } = useI18n();\n  const searchInfo = reactive({});\n  const loadDataList = async () => {\n    const paginationRef = getPaginationRef() as any;\n    let formData = getForm().getFieldsValue();\n    formData.pageNo = paginationRef.current;\n    formData.pageSize = paginationRef.pageSize;\n    formData.sortField = searchInfo.sortField;\n    formData.sortOrder = searchInfo.sortOrder;\n    let pageList = await getDataList(formData);\n    return pageList;\n  };\n  const [registerTable, { reload, getForm, getSelectRows, getPaginationRef }] = useTable({\n    title: '月度评价',\n    api: loadDataList,\n    rowKey: 'id',\n    columns,\n    useSearchForm: true,\n    showTableSetting: true,\n    bordered: true,\n    pagination: { pageSize: 20, pageSizeOptions: ['20', '50', '100', '200'] },\n    handleSearchInfoFn(info) {\n      return info;\n    },\n    formConfig: {\n      labelWidth: 120,\n      actionColOptions: { span: 24 },\n      autoAdvancedLine: 1,\n      baseColProps: { span: 7 },\n      schemas: searchFormSchema,\n      autoSubmitOnEnter: true,\n      noHideBtnFlag: true,\n    },\n    rowSelection: {\n      type: 'radio',\n      fixed: true,\n      onSelect: onSelect,\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        searchInfo.sortField = sortInfo.field;\n        searchInfo.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n        searchInfo.sortField = '';\n        searchInfo.sortOrder = '';\n      }\n    },\n  });\n\n  function onSelect(record, selected) {\n    if (selected) {\n      selectedRowId.value = record.id;\n      selectedRow = record;\n    } else {\n      selectedRowId.value = '';\n      selectedRow = null;\n    }\n  }\n  function handleSelectChange({ keys, rows }) {\n    if (rows && rows.length > 0) {\n      const record = rows[0];\n      selectedRowId.value = record.id;\n      selectedRow = record;\n    } else {\n      selectedRowId.value = '';\n      selectedRow = null;\n    }\n  }\n\n  //---------------------------------操作按钮---------------------------------------\n  // 新增\n  const handleAdd = async () => {\n    // router.push('/po/integrated/assessmentevaluation/monthly/create');\n    addTabPage('/po/integrated/assessmentevaluation/monthly/create', '添加月度评价');\n  };\n\n  // 启用/禁用\n  const handleUpdate = async (status: number) => {\n    if (selectedRow.status == 2 || selectedRow.status == 3 || selectedRow.status == 5) {\n      createConfirm({\n        title: '禁用',\n        iconType: 'danger',\n        content: '确认禁用此数据？',\n        async onOk() {\n          let param = { id: selectedRowId.value, businessStatus: status };\n          updateStatus(param).then(() => {\n            message.success('已禁用。');\n            reload();\n          });\n        },\n      });\n    } else {\n      message.error('请先完成流程审批。');\n      return;\n    }\n  };\n\n  // 导出\n  async function handleExport() {\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: t('common.message.exportMessage'),\n      async onOk() {\n        await exportExcel(getForm().getFieldsValue()).then((res) => {\n          exportExcelFile(res?.data, '月度评价.xls');\n        });\n        createMessage.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n\n  function handleReadOnlyView(record: any) {\n    CommonUtil.toFlowPage(record.id);\n  }\n\n  //获取表格选择数据\n  function checkSelectData() {\n    const selectRows = getSelectRows();\n    if (selectRows.length == 0) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return selectRows[0] as any;\n  }\n  //删除\n  async function handleDelete() {\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: t('common.message.delMessage'),\n      async onOk() {\n        const row = checkSelectData();\n        if (!row.id) {\n          return;\n        }\n        // const res = await getTemplate({ id: row.id });\n        if (row.status != 0) {\n          message.error('非草稿状态不能删除。');\n          return;\n        }\n        // 发起取消\n        await ProcessInstanceApi.deleteProcessInstance(row.processInstanceId);\n        message.success('已删除。');\n        reload();\n      },\n    });\n  }\n\n  // 启动执行代码\n  onMounted(async () => {\n    MsgManager.getInstance().listen('monthly-evaluation', reload);\n  });\n</script>\n<style lang=\"less\" scoped>\n  :deep(.ant-picker) {\n    width: 100%;\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n</style>\n"],"names":["useRouter","selectedRow","reactive","selectedRowId","ref","createConfirm","createMessage","useMessage","t","useI18n","searchInfo","loadDataList","__async","paginationRef","getPaginationRef","formData","getForm","getDataList","registerTable","reload","getSelectRows","useTable","columns","info","searchFormSchema","onSelect","sortInfo","record","selected","handleSelectChange","keys","rows","handleAdd","addTabPage","handleUpdate","status","param","updateStatus","message","handleExport","exportExcel","res","exportExcelFile","handleReadOnlyView","CommonUtil.toFlowPage","checkSelectData","selectRows","handleDelete","row","ProcessInstanceApi.deleteProcessInstance","onMounted","MsgManager"],"mappings":"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"}