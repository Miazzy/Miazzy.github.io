var v=(q,T,S)=>new Promise((O,u)=>{var M=f=>{try{I(S.next(f))}catch(D){u(D)}},t=f=>{try{I(S.throw(f))}catch(D){u(D)}},I=f=>f.done?O(f.value):Promise.resolve(f.value).then(M,t);I((S=S.apply(q,T)).next())});import{d as ze,J,k as _,r as j,o as Pe,al as c,Z as g,a9 as b,aa as o,$ as P,f as n,v as x,A as h,u as y,ag as Re,ac as w,E as Q,ad as X}from"./vue-71d1abb3.js";import{b as Oe,a0 as Be,ak as Ee,aD as je,av as Z,aC as Fe,a7 as qe,at as F,aB as Ae,_ as Ye}from"./index.js";import{D as Ke}from"./Dialog-0a006d82.js";import{B as G}from"./BasicTable-0434a334.js";import{T as Ve}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as ee}from"./useTable-109483b3.js";import"./antd-15ac76ed.js";import{B as Le}from"./BillTitle-d17ab3e4.js";import{U as We}from"./UploadBox-636ecf02.js";import{W as He}from"./WfApproveBox-a3448232.js";import{d as $e,a as Je,f as ae,v as Qe,h as Xe,i as Ze,j as Ge,k as ea,m as aa,g as ta}from"./template.data-3d5e7289.js";import{x as U}from"./index-66d20ba6.js";import{a as R}from"./assign-37f1c13d.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useRender-21ce56fb.js";const sa={class:"load"},na={class:"process-box"},la={class:"header-box"},oa={class:"content"},ia=ze({__name:"create",setup(q){const{t:T}=Oe(),S=Be(),O=J(S.getUserInfo),u=Ee.getInstance().getQuery();console.log(111,u);const M=_(),t=j({spinning:!1,status:0,listenMessage:u.processInstanceId?void 0:"assess-template"}),I=_(!1),f=_([]),D=_([]),A=j({subject:"细则模板申请"}),B=j({}),r=_(!0),te=()=>{Y(0)},se=()=>{const a=M.value;a&&a.validateFields().then(()=>{const e=C();if(e.length===0){N(`请${T("common.action.create")}项目明细`);return}for(let s=0;s<e.length;s++){const i=e[s];if(!U.trim(i.assessIndexKind)){N("项目明细，类别不能为空");return}if(!U.trim(i.assessIndexName)){N("项目明细，类型不能为空");return}if(!U.trim(i.assessDetail)){N("项目明细，分项不能为空");return}if(!U.trim(i.indexId)||!U.trim(i.indexName)||!U.trim(i.indexSort)){N("项目明细，细则指标不能为空");return}if(!i.sort){N("项目明细，排序不能为空");return}}Y(1)}).catch(e=>{var i;console.log("onSubmit=》error",e);const s=e.errorFields;if((i=document.querySelector(".ant-form-item-has-error"))==null||i.scrollIntoView({behavior:"smooth",block:"center"}),s&&s.length>0){N(s[0].errors[0]);return}})},Y=a=>v(this,null,function*(){t.spinning=!0;try{yield ne(a)}catch(e){t.spinning=!1,console.log("error",e)}}),ne=a=>v(this,null,function*(){ye(["Id","Name"]);const e=J(t);e.status=a,e.detailList=C(),yield $e(e).then(s=>{t.id=s.result,a===0?V():a===1&&(r.value=!0),t.spinning=!1,(a===0||a===1)&&oe("操作成功"),le(a)}).catch(()=>{t.spinning=!1})}),le=a=>{(a===0||a===1)&&setTimeout(()=>{a===1&&Fe(),qe.getInstance().sendMsg("assess-template",{})},200)},N=a=>{t.spinning=!1,F.getInstance().error(a)},oe=a=>{F.getInstance().success(a)},ie=()=>{const a=t.status===0&&(!t.personMemberId||t.personMemberId.indexOf(O.userId)>-1);r.value=!a},re=()=>v(this,null,function*(){const a=yield Je({id:u.id});if(a.result){R(t,a.result),t.status=Number(t.status),t.processInstanceId||(t.processInstanceId=u.processInstanceId);const{billCode:e,fillinDate:s,personMemberName:i,deptName:d}=a.result;Object.assign(A,{billCode:e,fillinDate:s,personMemberName:i,deptName:d}),we(["Id","Name"]),ie()}}),K=_(),[de,{setProps:ue,getDataSource:C}]=ee({dataSource:K,columns:Ge,pagination:!1,striped:!1,bordered:!0,canResize:!1}),V=()=>v(this,null,function*(){const a=yield ae({templateId:t.id});K.value=a.result}),ce=()=>v(this,null,function*(){const a=me(),e={stationId:t.stationId,status:2,pageNo:a.current,pageSize:a.pageSize,sortField:"fillinDate",sortOrder:"desc"};return R(e,B),(yield ta(e)).result}),[pe,{getPaginationRef:me,getSelectRows:fe}]=ee({api:ce,columns:ea,pagination:!0,striped:!1,useSearchForm:!0,formConfig:aa,handleSearchInfoFn(a){return R(B,a),a},showTableSetting:!1,bordered:!0,showIndexColumn:!0,canResize:!0,rowSelection:{type:"radio"}});function ve(){const a=fe();if(a.length==0){F.getInstance().error("请选择细则模板");return}ae({templateId:a[0].id}).then(e=>{L(e.result),I.value=!1})}function ge(){const e=C().length+1;L([{assessIndexKind:"",assessIndexName:"",assessDetail:"",indexId:"",indexName:"",indexType:"",indexSort:0,sort:e}])}function L(a){const e=C();a.forEach(s=>{const i={assessIndexKind:s.assessIndexKind,assessIndexName:s.assessIndexName,assessDetail:s.assessDetail,indexId:s.indexId,indexName:s.indexName,indexType:s.indexType,indexSort:s.indexSort,sort:s.sort,isNew:!0,key:`${Date.now()}`};e.push(i)})}function be(a){const e=C();let s=e.indexOf(a);s!==-1&&e.splice(s,1)}const Ie=(a,e)=>v(this,null,function*(){t.periodIds=e.map(s=>s.lable);try{yield Qe({id:t.id,stationId:t.stationId,periodId:t.periodIds.join(",")})}catch(s){t.periodIds=[],t.periodNames=[]}});function _e(a,e,s){s.indexId=e==null?void 0:e.lable,s.indexType=e==null?void 0:e.type,s.indexSort=e==null?void 0:e.sort}function xe(){Xe({stationId:t.stationId}).then(a=>{a.result&&a.result.length>0&&a.result.forEach(e=>{f.value.push({value:e.name,lable:e.id})})})}function he(){Ze({}).then(a=>{a.result&&a.result.length>0&&a.result.forEach(e=>{D.value.push({value:e.name,lable:e.id,sort:e.sort,type:e.type})})})}function ye(a){a.forEach(e=>{_(["period"]).value.forEach(i=>{const d=t[i+e+"s"];d&&d.length>0&&(t[i+e]=d.join(","))})})}function we(a){a.forEach(e=>{_(["period"]).value.forEach(i=>{const d=t[i+e];d&&(t[i+e+"s"]=d.split(","))})})}function Ne(){I.value=!0}const Se=()=>v(this,null,function*(){let a=u.id;if(!a&&u.processInstanceId){const s=(yield Ae(u.processInstanceId)).businessKey;u.id=s,a=s}return a});function De(){ue({actionColumn:{width:80,title:"操作",dataIndex:"action",ifShow:!r.value}})}return Pe(()=>v(this,null,function*(){u.id=yield Se(),yield re(),u.id||(R(t,u),r.value=!1,t.bizFileId=je()),xe(),he(),V(),De()})),(a,e)=>{const s=c("a-input"),i=c("a-form-item"),d=c("a-col"),W=c("a-select"),k=c("a-row"),Ue=c("a-date-picker"),H=c("a-input-number"),z=c("a-textarea"),E=c("a-card"),$=c("a-button"),Ce=c("a-form"),ke=c("a-spin"),Te=c("PageWrapper");return g(),b(Te,{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:o(()=>[P("div",sa,[n(ke,{spinning:t.spinning,tip:"Loading..."},{default:o(()=>[P("div",na,[P("div",la,[n(Le,{options:A},null,8,["options"]),n(He,{onSave:te,onSubmit:se,processInstanceId:t.processInstanceId,processStatus:t.status,listenMessage:t.listenMessage},null,8,["processInstanceId","processStatus","listenMessage"])]),P("div",oa,[n(Ce,{ref_key:"formRef",ref:M,model:t,labelAlign:"right",autocomplete:"off"},{default:o(()=>[n(E,{title:"基本信息",bordered:!1},{default:o(()=>[n(k,{gutter:32},{default:o(()=>[x(n(d,{span:12},{default:o(()=>[n(i,{name:"stationName",label:"电站名称",labelCol:{class:"detail-label"}},{default:o(()=>[n(s,{value:t.stationName,"onUpdate:value":e[0]||(e[0]=l=>t.stationName=l),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[h,!0]]),x(n(d,{span:12},{default:o(()=>[n(i,{name:"periodNames",label:"期数",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请选择期数"}]},{default:o(()=>[n(W,{value:t.periodNames,"onUpdate:value":e[1]||(e[1]=l=>t.periodNames=l),"show-search":"","allow-clear":"",mode:"multiple",style:{width:"100%"},options:f.value,onChange:Ie,disabled:r.value},null,8,["value","options","disabled"])]),_:1})]),_:1},512),[[h,!0]])]),_:1}),n(k,{gutter:32},{default:o(()=>[x(n(d,{span:12},{default:o(()=>[n(i,{name:"regulatoryUnitName",label:"监管单位",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入监管单位"}]},{default:o(()=>[n(s,{value:t.regulatoryUnitName,"onUpdate:value":e[2]||(e[2]=l=>t.regulatoryUnitName=l),maxlength:50,disabled:r.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[h,!0]]),x(n(d,{span:12},{default:o(()=>[n(i,{name:"assessmentUnitName",label:"考核单位",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入考核单位"}]},{default:o(()=>[n(s,{value:t.assessmentUnitName,"onUpdate:value":e[3]||(e[3]=l=>t.assessmentUnitName=l),maxlength:100,disabled:r.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[h,!0]])]),_:1}),n(k,{gutter:32},{default:o(()=>[x(n(d,{span:12},{default:o(()=>[n(i,{name:"effectiveDate",label:"考核生效时间",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入考核生效时间"}]},{default:o(()=>[n(Ue,{value:t.effectiveDate,"onUpdate:value":e[4]||(e[4]=l=>t.effectiveDate=l),picker:"month",format:"YYYY-MM","value-format":"YYYY-MM",style:"width: 100%",maxlength:7,disabled:r.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[h,!0]]),x(n(d,{span:12},{default:o(()=>[n(i,{name:"desulfurizationPrice",label:"脱硫电价(元)",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入脱硫电价(元)"}]},{default:o(()=>[n(H,{value:t.desulfurizationPrice,"onUpdate:value":e[5]||(e[5]=l=>t.desulfurizationPrice=l),min:1e-4,max:999.9999,precision:4,disabled:r.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[h,!0]])]),_:1}),n(k,{gutter:32},{default:o(()=>[x(n(d,{span:24},{default:o(()=>[n(i,{name:"subject",label:"主题",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入主题"}]},{default:o(()=>[n(s,{value:t.subject,"onUpdate:value":e[6]||(e[6]=l=>t.subject=l),maxlength:100,disabled:r.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[h,!0]])]),_:1}),n(k,{gutter:32},{default:o(()=>[x(n(d,{span:24},{default:o(()=>[n(i,{name:"remark",label:"设置说明",labelCol:{class:"detail-label"}},{default:o(()=>[n(z,{value:t.remark,"onUpdate:value":e[7]||(e[7]=l=>t.remark=l),"show-count":"",rows:4,maxlength:1e3,disabled:r.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[h,!0]])]),_:1})]),_:1}),n(E,{bordered:!1},{default:o(()=>[n(y(G),{title:"项目明细",onRegister:y(de)},Re({bodyCell:o(({column:l,record:p})=>[l.dataIndex==="assessIndexKind"?(g(),b(z,{key:0,value:p[l.dataIndex],"onUpdate:value":m=>p[l.dataIndex]=m,"auto-size":"",maxlength:100,disabled:r.value},null,8,["value","onUpdate:value","disabled"])):w("",!0),l.dataIndex==="assessIndexName"?(g(),b(z,{key:1,value:p[l.dataIndex],"onUpdate:value":m=>p[l.dataIndex]=m,"auto-size":"",maxlength:100,disabled:r.value},null,8,["value","onUpdate:value","disabled"])):w("",!0),l.dataIndex==="assessDetail"?(g(),b(z,{key:2,value:p[l.dataIndex],"onUpdate:value":m=>p[l.dataIndex]=m,"auto-size":"",maxlength:1024,disabled:r.value},null,8,["value","onUpdate:value","disabled"])):w("",!0),l.dataIndex==="indexName"?(g(),b(W,{key:3,value:p[l.dataIndex],"onUpdate:value":m=>p[l.dataIndex]=m,"show-search":"","allow-clear":"",style:{width:"100%","text-align":"left"},options:D.value,onChange:(m,Me)=>_e(m,Me,p),disabled:r.value},null,8,["value","onUpdate:value","options","onChange","disabled"])):w("",!0),l.dataIndex==="sort"?(g(),b(H,{key:4,value:p[l.dataIndex],"onUpdate:value":m=>p[l.dataIndex]=m,class:"input-center",min:1,max:1e3,step:1,precision:0,disabled:r.value},null,8,["value","onUpdate:value","disabled"])):w("",!0),l.dataIndex==="action"?(g(),b(y(Ve),{key:5,actions:[{tooltip:"删除",color:"error",icon:"ant-design:delete-outlined",ifShow:!r.value,onClick:be.bind(null,p)}]},null,8,["actions"])):w("",!0)]),_:2},[r.value?void 0:{name:"toolbar",fn:o(()=>[r.value?w("",!0):(g(),b($,{key:0,type:"primary",preIcon:y(Z).ADD,onClick:ge},{default:o(()=>[Q(X(y(T)("common.action.create")),1)]),_:1},8,["preIcon"])),r.value?w("",!0):(g(),b($,{key:1,type:"primary",preIcon:y(Z).EXPORT,onClick:Ne},{default:o(()=>[Q(X("引用"))]),_:1},8,["preIcon"]))]),key:"0"}]),1032,["onRegister"])]),_:1}),n(E,{title:"附件资料",bordered:!1},{default:o(()=>[n(We,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"assessTemplate",vmode:t.status===0&&!r.value?"box":"view",bizId:t.bizFileId},null,8,["vmode","bizId"])]),_:1})]),_:1},8,["model"])])])]),_:1},8,["spinning"]),n(Ke,{visible:I.value,"onUpdate:visible":e[8]||(e[8]=l=>I.value=l),title:"细则模板",onOk:ve,height:600},{default:o(()=>[n(y(G),{class:"table-in-dialog",onRegister:y(pe),searchInfo:B,maxHeight:340},null,8,["onRegister","searchInfo"])]),_:1},8,["visible"])])]),_:1})}}});const Ya=Ye(ia,[["__scopeId","data-v-e97f5883"]]);export{Ya as default};
//# sourceMappingURL=create-ddbab9ad.js.map
