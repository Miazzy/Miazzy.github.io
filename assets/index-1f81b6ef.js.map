{"version":3,"file":"index-1f81b6ef.js","sources":["../../src/views/bpm/manage/task/operation/operation.data.ts","../../src/views/bpm/manage/task/operation/index.vue"],"sourcesContent":["import { assign, forEach } from 'min-dash';\nimport { useRender } from '@/components/Table';\n\nconst bpmProcessInstanceResult = [\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '1',\n    label: '正在处理',\n    colorType: 'primary',\n    cssClass: '',\n  },\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '2',\n    label: '通过',\n    colorType: 'success',\n    cssClass: '',\n  },\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '3',\n    label: '不通过',\n    colorType: 'danger',\n    cssClass: '',\n  },\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '4',\n    label: '打回',\n    colorType: 'info',\n    cssClass: '',\n  },\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '5',\n    label: '已取消',\n    colorType: 'info',\n    cssClass: '',\n  },\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '6',\n    label: '已取消',\n    colorType: 'info',\n    cssClass: '',\n  },\n  {\n    dictType: 'bpm_process_instance_result',\n    value: '7',\n    label: '已转办',\n    colorType: 'info',\n    cssClass: '',\n  },\n];\n\nexport const searchFormSchema: FormSchema[] = [\n  {\n    label: '单据编号',\n    field: 'businessCode',\n    component: 'Input',\n    required: true,\n    colProps: { span: 8 },\n  },\n];\n\nexport const columns: BasicColumn[] = [\n  {\n    title: '名称',\n    dataIndex: 'name',\n    width: 150,\n  },\n  {\n    title: '状态',\n    dataIndex: 'result',\n    width: 100,\n    customRender: ({ text }) => {\n      return getTypeObj('bpmProcessInstanceResult', text)['label'];\n      // return useRender.renderDict(text, 'bpmProcessInstanceStatus');\n    },\n  },\n  {\n    title: '主题',\n    dataIndex: 'description',\n    width: 200,\n  },\n  {\n    title: '执行人',\n    dataIndex: 'assigneeUserName',\n    width: 100,\n  },\n  {\n    title: '执行部门',\n    dataIndex: 'deptName',\n    width: 100,\n  },\n  {\n    title: '提交时间',\n    dataIndex: 'startTime',\n    width: 200,\n    customRender: ({ text }) => {\n      return useRender.renderDate(text);\n    },\n  },\n  {\n    title: '执行时间',\n    dataIndex: 'endTime',\n    width: 200,\n    customRender: ({ text }) => {\n      return useRender.renderDate(text);\n    },\n  },\n];\n\nexport const backColumns: BasicColumn[] = [\n  {\n    title: '名称',\n    dataIndex: 'name',\n    width: 150,\n  },\n];\n\nexport function getTypeObj(dictType: string, type: any) {\n  const obj = {};\n  if (dictType == 'bpmProcessInstanceResult') {\n    forEach(bpmProcessInstanceResult, function (def) {\n      if (def.value === type.toString()) {\n        assign(obj, def);\n      }\n    });\n  }\n  return obj;\n}\n","<script lang=\"ts\" setup>\n  import { reactive, ref, onMounted } from 'vue';\n  import { message } from 'ant-design-vue';\n  import { columns, searchFormSchema, backColumns } from './operation.data';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { IconEnum } from '@/enums/appEnum';\n  import { BasicTable, useTable, TableAction } from '@/components/Table';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { addTabPage } from '@/utils/route';\n  import * as TaskApi from '@/api/bpm/task';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import OrganDialog from '@/components/Framework/Modal/OrganDialog.vue';\n  import * as OrgApi from '@/api/sys/org';\n  import { TreeItem } from '/@/components/Tree';\n  import { PageWrapper } from '/@/components/Page';\n\n  defineOptions({ name: 'BpmTaskOperation' });\n\n  const { t } = useI18n();\n  const { createConfirm, createMessage } = useMessage();\n\n  const [registerTable, { reload, getSelectRows }] = useTable({\n    title: '流程任务维护',\n    api: TaskApi.GetHiTaskinst,\n    columns,\n    formConfig: { labelWidth: 120, schemas: searchFormSchema },\n    useSearchForm: true,\n    showTableSetting: true,\n    pagination: false,\n    bordered: true,\n    immediate: false,\n    rowKey: 'taskId',\n    rowSelection: {\n      type: 'checkbox',\n    },\n    actionColumn: {\n      width: 140,\n      title: t('common.operate'),\n      dataIndex: 'action',\n      fixed: 'right',\n    },\n  });\n\n  /** 查看详情 */\n  const handleDetail = (row) => {\n    addTabPage(`${row.formCustomViewPath}?processInstanceId=${row.processInstanceId}`);\n  };\n  const organVisible = ref(false);\n\n  const transfer = () => {\n    const rows = getSelectRows();\n    if (rows.length !== 1) {\n      message.warning('请选择一行数据。');\n      return;\n    }\n    if (rows[0].result !== 1) {\n      message.warning('此任务已处理，不能转办。');\n      return;\n    }\n    if (rows[0].taskDefinitionKey == 'Apply') {\n      message.warning('申请节点，不能转办。');\n      return;\n    }\n    organVisible.value = true;\n  };\n\n  const handleOrganCancel = () => {\n    organVisible.value = false; // 关闭弹框\n  };\n\n  const handleOrganConfirm = (nodeList) => {\n    if (nodeList.length !== 1) {\n      message.warning('请选择一个人员。');\n      return;\n    }\n    const rows = getSelectRows();\n    const params = {\n      id: rows[0].taskId,\n      assigneeUserId: getPersonId(nodeList[0].nodeId),\n    };\n    TaskApi.updateTaskAssignee(params)\n      .then(() => {\n        createMessage.success('操作成功。');\n        reload();\n      })\n      .then(() => {\n        organVisible.value = false; // 关闭弹框\n      });\n  };\n\n  const getPersonId = (personMemberId) => {\n    return personMemberId.split('@')[0];\n  };\n\n  const radioStyle = reactive({\n    display: 'block',\n    height: '30px',\n    lineHeight: '30px',\n  });\n  const formState = reactive({\n    backType: '',\n  });\n\n  const open = ref<boolean>(false);\n  const back = () => {\n    const rows = getSelectRows();\n    if (rows.length !== 1) {\n      message.warning('请选择一行数据。');\n      return;\n    }\n    if (rows[0].result !== 1) {\n      message.warning('此任务已处理，不能回退。');\n      return;\n    }\n    if (rows[0].taskDefinitionKey == 'Apply') {\n      message.warning('申请节点，不能回退。');\n      return;\n    }\n    open.value = true;\n    reloadBack();\n  };\n\n  const formRef = ref();\n  const handleOk = () => {\n    formRef.value\n      .validate()\n      .then(() => {\n        const rows = getBackSelectRows();\n        if (rows.length !== 1) {\n          message.warning('请选择一行数据。');\n          return;\n        }\n\n        const taskRows = getSelectRows();\n        const params = {\n          id: taskRows[0].taskId,\n          targetKey: rows[0].taskDefinitionKey,\n        };\n        if (formState.backType == 1) {\n          ProcessInstanceApi.backTask(params)\n            .then(() => {\n              createMessage.success('操作成功。');\n              reload();\n            })\n            .then(() => {\n              open.value = false; // 关闭弹框\n            });\n        } else {\n          ProcessInstanceApi.replenishTask(params)\n            .then(() => {\n              createMessage.success('操作成功。');\n              reload();\n            })\n            .then(() => {\n              open.value = false; // 关闭弹框\n            });\n        }\n      })\n      .catch((error) => {\n        console.log('onSubmit=》error', error);\n      });\n  };\n\n  const [registerBackTable, { reload: reloadBack, getSelectRows: getBackSelectRows }] = useTable({\n    api: ProcessInstanceApi.getFallbackNode,\n    rowKey: 'id',\n    columns: backColumns,\n    useSearchForm: false,\n    showTableSetting: false,\n    bordered: true,\n    pagination: false,\n    maxHeight: 300,\n    rowSelection: {\n      type: 'radio',\n    },\n    beforeFetch(info) {\n      const rows = getSelectRows();\n      info.taskId = rows[0].taskId;\n      return info;\n    },\n  });\n\n  const abort = () => {\n    const rows = getSelectRows();\n    if (rows.length !== 1) {\n      message.warning('请选择一行数据。');\n      return;\n    }\n    if (rows[0].result !== 1) {\n      message.warning('此任务已处理，不能终止。');\n      return;\n    }\n    const params = {\n      id: rows[0].taskId,\n      reason: '终止流程。',\n    };\n    createConfirm({\n      title: '确认操作',\n      iconType: 'warning',\n      content: '确定要终止选中数据吗？',\n      async onOk() {\n        ProcessInstanceApi.abortProcessInstance(params).then(() => {\n          createMessage.success('操作成功。');\n          reload();\n        });\n      },\n    });\n  };\n\n  const treeData = ref<TreeItem[]>([]); // 左侧电站树数据\n\n  // 查询左侧电站树数据\n  async function queryDeptTreeList() {\n    OrgApi.getListTree({\n      orgKindIds: 'ogn,dpt,pos,psm',\n      showPosition: false,\n      status: 1,\n      // fullId: '/HZ93a0bf6ab8dd83016ab8deaca70009.ogn',\n    }).then((res) => {\n      treeData.value = dig(res);\n    });\n  }\n\n  function dig(data) {\n    const list: TreeItem[] = [];\n    for (let i = 0; i < data.length; i++) {\n      const item = data[i];\n      const treeNode: TreeItem[][number] = {\n        code: item.code,\n        fullId: item.code,\n        name: item.name,\n        nodeId: item.id,\n        nodeName: item.name,\n        orgId: item.orgId,\n        parentId: item.parentId,\n        disabled: item.orgKindId === 'psm' ? false : true,\n      };\n\n      if (item.children && item.children.length > 0) {\n        treeNode.children = dig(item.children);\n      }\n\n      list.push(treeNode);\n    }\n    return list;\n  }\n\n  /** 初始化 **/\n  onMounted(() => {\n    queryDeptTreeList();\n  });\n</script>\n<template>\n <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <OrganDialog\n      :title=\"`组织人员`\"\n      v-model:visible=\"organVisible\"\n      @update:visible=\"organVisible = $event\"\n      :tdata=\"treeData\"\n      :tfields=\"{ key: 'nodeId', title: 'nodeName' }\"\n      :width=\"800\"\n      :height=\"600\"\n      @cancel=\"handleOrganCancel\"\n      @confirm=\"handleOrganConfirm\"\n    />\n\n    <a-modal v-model:visible=\"open\" title=\"回退确认\" @ok=\"handleOk\">\n      <!-- 数据表格 -->\n      <BasicTable @register=\"registerBackTable\" />\n      <a-form ref=\"formRef\" :model=\"formState\" autocomplete=\"off\" class=\"backType-form\">\n        <a-row :gutter=\"24\">\n          <a-col :span=\"24\">\n            <a-form-item name=\"backType\" :rules=\"[{ required: true, message: '请选择回退类型' }]\">\n              <a-radio-group v-model:value=\"formState.backType\">\n                <a-radio :style=\"radioStyle\" :value=\"1\"\n                  >回退：回退到指定节点，节点后面的审批人需重新审批。</a-radio\n                >\n                <a-radio :style=\"radioStyle\" :value=\"2\"\n                  >打回：仅修改文档，修改完成后回到本节点。</a-radio\n                >\n              </a-radio-group>\n            </a-form-item>\n          </a-col>\n        </a-row>\n      </a-form>\n    </a-modal>\n\n    <BasicTable @register=\"registerTable\" class=\"fix-basic-table\">\n      <template #toolbar>\n        <a-button type=\"primary\" @click=\"transfer\">转办</a-button>\n        <a-button type=\"primary\" @click=\"back\">回退</a-button>\n        <a-button type=\"primary\" @click=\"abort\">终止</a-button>\n      </template>\n      <template #bodyCell=\"{ column, record }\">\n        <template v-if=\"column.key === 'action'\">\n          <TableAction\n            :actions=\"[\n              {\n                icon: IconEnum.VIEW,\n                label: '详情',\n                onClick: handleDetail.bind(null, record),\n              },\n            ]\"\n          />\n        </template>\n      </template>\n    </BasicTable>\n  </PageWrapper>\n</template>\n<style lang=\"less\" scoped>\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n  .backType-form>.ant-row{\n    padding: 10px 16px;\n  }\n</style>"],"names":["bpmProcessInstanceResult","searchFormSchema","columns","text","getTypeObj","useRender","backColumns","dictType","type","obj","forEach","def","assign","t","useI18n","createConfirm","createMessage","useMessage","registerTable","reload","getSelectRows","useTable","TaskApi.GetHiTaskinst","handleDetail","row","addTabPage","organVisible","ref","transfer","rows","message","handleOrganCancel","handleOrganConfirm","nodeList","params","getPersonId","TaskApi.updateTaskAssignee","personMemberId","radioStyle","reactive","formState","open","back","reloadBack","formRef","handleOk","getBackSelectRows","ProcessInstanceApi.backTask","ProcessInstanceApi.replenishTask","error","registerBackTable","ProcessInstanceApi.getFallbackNode","info","abort","__async","ProcessInstanceApi.abortProcessInstance","treeData","queryDeptTreeList","OrgApi.getListTree","res","dig","data","list","i","item","treeNode","onMounted"],"mappings":"i7CAGA,MAAMA,GAA2B,CAC/B,CACE,SAAU,8BACV,MAAO,IACP,MAAO,OACP,UAAW,UACX,SAAU,EACZ,EACA,CACE,SAAU,8BACV,MAAO,IACP,MAAO,KACP,UAAW,UACX,SAAU,EACZ,EACA,CACE,SAAU,8BACV,MAAO,IACP,MAAO,MACP,UAAW,SACX,SAAU,EACZ,EACA,CACE,SAAU,8BACV,MAAO,IACP,MAAO,KACP,UAAW,OACX,SAAU,EACZ,EACA,CACE,SAAU,8BACV,MAAO,IACP,MAAO,MACP,UAAW,OACX,SAAU,EACZ,EACA,CACE,SAAU,8BACV,MAAO,IACP,MAAO,MACP,UAAW,OACX,SAAU,EACZ,EACA,CACE,SAAU,8BACV,MAAO,IACP,MAAO,MACP,UAAW,OACX,SAAU,EACZ,CACF,EAEaC,GAAiC,CAC5C,CACE,MAAO,OACP,MAAO,eACP,UAAW,QACX,SAAU,GACV,SAAU,CAAE,KAAM,CAAE,CACtB,CACF,EAEaC,GAAyB,CACpC,CACE,MAAO,KACP,UAAW,OACX,MAAO,GACT,EACA,CACE,MAAO,KACP,UAAW,SACX,MAAO,IACP,aAAc,CAAC,CAAE,KAAAC,KACRC,GAAW,2BAA4BD,CAAI,EAAE,KAGxD,EACA,CACE,MAAO,KACP,UAAW,cACX,MAAO,GACT,EACA,CACE,MAAO,MACP,UAAW,mBACX,MAAO,GACT,EACA,CACE,MAAO,OACP,UAAW,WACX,MAAO,GACT,EACA,CACE,MAAO,OACP,UAAW,YACX,MAAO,IACP,aAAc,CAAC,CAAE,KAAAA,KACRE,EAAU,WAAWF,CAAI,CAEpC,EACA,CACE,MAAO,OACP,UAAW,UACX,MAAO,IACP,aAAc,CAAC,CAAE,KAAAA,KACRE,EAAU,WAAWF,CAAI,CAEpC,CACF,EAEaG,GAA6B,CACxC,CACE,MAAO,KACP,UAAW,OACX,MAAO,GACT,CACF,EAEgB,SAAAF,GAAWG,EAAkBC,EAAW,CACtD,MAAMC,EAAM,CAAA,EACZ,OAAIF,GAAY,4BACNG,EAAAV,GAA0B,SAAUW,EAAK,CAC3CA,EAAI,QAAUH,EAAK,SAAA,GACrBI,GAAOH,EAAKE,CAAG,CACjB,CACD,EAEIF,CACT,8DCjHQ,KAAA,CAAE,EAAAI,GAAMC,KACR,CAAE,cAAAC,EAAe,cAAAC,CAAc,EAAIC,GAAW,EAE9C,CAACC,EAAe,CAAE,OAAAC,EAAQ,cAAAC,CAAe,CAAA,EAAIC,EAAS,CAC1D,MAAO,SACP,IAAKC,GACL,QAAApB,GACA,WAAY,CAAE,WAAY,IAAK,QAASD,EAAiB,EACzD,cAAe,GACf,iBAAkB,GAClB,WAAY,GACZ,SAAU,GACV,UAAW,GACX,OAAQ,SACR,aAAc,CACZ,KAAM,UACR,EACA,aAAc,CACZ,MAAO,IACP,MAAOY,EAAE,gBAAgB,EACzB,UAAW,SACX,MAAO,OACT,CAAA,CACD,EAGKU,EAAgBC,GAAQ,CAC5BC,GAAW,GAAGD,EAAI,kBAAkB,sBAAsBA,EAAI,iBAAiB,EAAE,CAAA,EAE7EE,EAAeC,EAAI,EAAK,EAExBC,EAAW,IAAM,CACrB,MAAMC,EAAOT,IACT,GAAAS,EAAK,SAAW,EAAG,CACrBC,EAAQ,QAAQ,UAAU,EAC1B,MACF,CACA,GAAID,EAAK,CAAC,EAAE,SAAW,EAAG,CACxBC,EAAQ,QAAQ,cAAc,EAC9B,MACF,CACA,GAAID,EAAK,CAAC,EAAE,mBAAqB,QAAS,CACxCC,EAAQ,QAAQ,YAAY,EAC5B,MACF,CACAJ,EAAa,MAAQ,EAAA,EAGjBK,EAAoB,IAAM,CAC9BL,EAAa,MAAQ,EAAA,EAGjBM,EAAsBC,GAAa,CACnC,GAAAA,EAAS,SAAW,EAAG,CACzBH,EAAQ,QAAQ,UAAU,EAC1B,MACF,CAEA,MAAMI,EAAS,CACb,GAFWd,IAEF,CAAC,EAAE,OACZ,eAAgBe,EAAYF,EAAS,CAAC,EAAE,MAAM,CAAA,EAEhDG,GAA2BF,CAAM,EAC9B,KAAK,IAAM,CACVlB,EAAc,QAAQ,OAAO,EACtBG,GAAA,CACR,EACA,KAAK,IAAM,CACVO,EAAa,MAAQ,EAAA,CACtB,CAAA,EAGCS,EAAeE,GACZA,EAAe,MAAM,GAAG,EAAE,CAAC,EAG9BC,EAAaC,EAAS,CAC1B,QAAS,QACT,OAAQ,OACR,WAAY,MAAA,CACb,EACKC,EAAYD,EAAS,CACzB,SAAU,EAAA,CACX,EAEKE,EAAOd,EAAa,EAAK,EACzBe,EAAO,IAAM,CACjB,MAAMb,EAAOT,IACT,GAAAS,EAAK,SAAW,EAAG,CACrBC,EAAQ,QAAQ,UAAU,EAC1B,MACF,CACA,GAAID,EAAK,CAAC,EAAE,SAAW,EAAG,CACxBC,EAAQ,QAAQ,cAAc,EAC9B,MACF,CACA,GAAID,EAAK,CAAC,EAAE,mBAAqB,QAAS,CACxCC,EAAQ,QAAQ,YAAY,EAC5B,MACF,CACAW,EAAK,MAAQ,GACFE,GAAA,EAGPC,EAAUjB,IACVkB,EAAW,IAAM,CACrBD,EAAQ,MACL,SACA,EAAA,KAAK,IAAM,CACV,MAAMf,EAAOiB,IACT,GAAAjB,EAAK,SAAW,EAAG,CACrBC,EAAQ,QAAQ,UAAU,EAC1B,MACF,CAGA,MAAMI,EAAS,CACb,GAFed,IAEF,CAAC,EAAE,OAChB,UAAWS,EAAK,CAAC,EAAE,iBAAA,EAEjBW,EAAU,UAAY,EACxBO,GAA4Bb,CAAM,EAC/B,KAAK,IAAM,CACVlB,EAAc,QAAQ,OAAO,EACtBG,GAAA,CACR,EACA,KAAK,IAAM,CACVsB,EAAK,MAAQ,EAAA,CACd,EAEHO,GAAiCd,CAAM,EACpC,KAAK,IAAM,CACVlB,EAAc,QAAQ,OAAO,EACtBG,GAAA,CACR,EACA,KAAK,IAAM,CACVsB,EAAK,MAAQ,EAAA,CACd,CACL,CACD,EACA,MAAOQ,GAAU,CACR,QAAA,IAAI,kBAAmBA,CAAK,CAAA,CACrC,CAAA,EAGC,CAACC,EAAmB,CAAE,OAAQP,EAAY,cAAeG,CAAA,CAAmB,EAAIzB,EAAS,CAC7F,IAAK8B,GACL,OAAQ,KACR,QAAS7C,GACT,cAAe,GACf,iBAAkB,GAClB,SAAU,GACV,WAAY,GACZ,UAAW,IACX,aAAc,CACZ,KAAM,OACR,EACA,YAAY8C,EAAM,CAChB,MAAMvB,EAAOT,IACR,OAAAgC,EAAA,OAASvB,EAAK,CAAC,EAAE,OACfuB,CACT,CAAA,CACD,EAEKC,EAAQ,IAAM,CAClB,MAAMxB,EAAOT,IACT,GAAAS,EAAK,SAAW,EAAG,CACrBC,EAAQ,QAAQ,UAAU,EAC1B,MACF,CACA,GAAID,EAAK,CAAC,EAAE,SAAW,EAAG,CACxBC,EAAQ,QAAQ,cAAc,EAC9B,MACF,CACA,MAAMI,EAAS,CACb,GAAIL,EAAK,CAAC,EAAE,OACZ,OAAQ,OAAA,EAEId,EAAA,CACZ,MAAO,OACP,SAAU,UACV,QAAS,cACH,MAAO,QAAAuC,EAAA,sBACXC,GAAwCrB,CAAM,EAAE,KAAK,IAAM,CACzDlB,EAAc,QAAQ,OAAO,EACtBG,GAAA,CACR,CACH,GAAA,CACD,CAAA,EAGGqC,EAAW7B,EAAgB,CAAA,CAAE,EAGnC,SAAe8B,GAAoB,QAAAH,EAAA,sBACjCI,GAAmB,CACjB,WAAY,kBACZ,aAAc,GACd,OAAQ,CAAA,CAET,EAAE,KAAMC,GAAQ,CACNH,EAAA,MAAQI,EAAID,CAAG,CAAA,CACzB,CACH,GAEA,SAASC,EAAIC,EAAM,CACjB,MAAMC,EAAmB,CAAA,EACzB,QAASC,EAAI,EAAGA,EAAIF,EAAK,OAAQE,IAAK,CAC9B,MAAAC,EAAOH,EAAKE,CAAC,EACbE,EAA+B,CACnC,KAAMD,EAAK,KACX,OAAQA,EAAK,KACb,KAAMA,EAAK,KACX,OAAQA,EAAK,GACb,SAAUA,EAAK,KACf,MAAOA,EAAK,MACZ,SAAUA,EAAK,SACf,SAAUA,EAAK,YAAc,KAAgB,EAG3CA,EAAK,UAAYA,EAAK,SAAS,OAAS,IACjCC,EAAA,SAAWL,EAAII,EAAK,QAAQ,GAGvCF,EAAK,KAAKG,CAAQ,CACpB,CACO,OAAAH,CACT,CAGA,OAAAI,GAAU,IAAM,CACIT,GAAA,CACnB"}