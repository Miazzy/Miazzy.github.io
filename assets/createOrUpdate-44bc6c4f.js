var S=(w,C,v)=>new Promise((h,n)=>{var I=i=>{try{_(v.next(i))}catch(p){n(p)}},k=i=>{try{_(v.throw(i))}catch(p){n(p)}},_=i=>i.done?h(i.value):Promise.resolve(i.value).then(I,k);_((v=v.apply(w,C)).next())});import{P as E}from"./index-20519caf.js";import{a0 as H,aj as V,aB as $,at as U,aC as z,a7 as J,_ as Z}from"./index.js";import{g as Q,a as X,b as ee,c as te,i as ae,d as se}from"./issueList-77ab7d2e.js";import{_ as le}from"./tplList.vue_vue_type_script_setup_true_lang-dec4eb24.js";import{B as oe}from"./BillTitle-d17ab3e4.js";import{W as ne}from"./WfApproveBox-a3448232.js";import{d as de,J as ie,r as K,e as re,k as m,o as ue,al as r,Z as pe,a9 as ce,aa as o,$ as g,f as s,u as me}from"./vue-71d1abb3.js";import"./useContentViewHeight-7f845167.js";import"./useWindowSizeFn-13b1b8a2.js";import"./antd-15ac76ed.js";import"./BasicTable-0434a334.js";import"./useForm-dea3ed18.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-f4fc48e6.js";import"./index-316f6ffb.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./Dialog-0a006d82.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./OrganDialog-dd1023ce.js";import"./uniqBy-92d3bc7f.js";import"./index-085d06c7.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useTable-109483b3.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";const fe={class:"load"},ve={class:"process-box"},Ie={class:"header-box"},_e={class:"content tab-model"},be={id:"more-tab-content",class:"tab-table-div"},ge=de({__name:"createOrUpdate",setup(w){const C=H(),v=ie(C.getUserInfo),h=K({subject:"专项检查下发"}),n=re(()=>e.status!=0||e.status==0&&e.personMemberId!=""&&e.personMemberId.substring(0,32)!=v.userId),I=m(!0),k=m(),_=m([]),i=m([]),p=m(null),c=m(null),M=m(""),f=m("tplChild"),j=a=>{p.value.reloadGrid({templateId:e.templateId}),c.value.reloadGrid({safeCheckIssueId:e.id,status:e.status,templateId:e.templateId,taskDate:e.taskDate,activeKey:f.value,disabledInput:n})},B=()=>{c.value.reloadGrid({safeCheckIssueId:e.id,status:e.status,templateId:e.templateId,taskDate:e.taskDate,activeKey:f.value,disabledInput:n}),f.value=="issueDtlChild"&&c.value.resetData()},O=(a,t)=>{e.templateId=a,e.templateName=t.label,e.checkType=t.checkType,f.value=="tplChild"?p.value.reloadGrid({templateId:e.templateId}):(c.value.reloadGrid({safeCheckIssueId:e.id,status:e.status,activeKey:f.value,templateId:e.templateId,taskDate:e.taskDate}),c.value.resetData())},q=(a,t)=>{e.issuedPersonId=a,e.issuedPersonName=t.label},G=a=>{console.log("同意",a)},F=a=>{console.log("保存",a),I.value=!1,e.status=0,P()},R=a=>{console.log("提交",a),I.value=!0,e.status=1;const t=k.value;t&&t.validateFields().then(()=>{if(c.value.getDataSource().length===0){U.getInstance().info("电站不能为空"),e.status=0;return}P()}).catch(u=>{console.log(u),e.status=0})};let{params:D}=V();const e=K({id:D.id||"",subject:"",checkType:"",templateId:"",templateName:"",checkPeriod:"",personMemberId:"",num:1,status:0,taskDate:null,issuedPersonId:null,issuedPersonName:"",billCode:"",fillinDate:"",spinning:!1,dtl:{}}),P=()=>{e.dtl=c.value.getDataSource(),e.spinning=!0,se(e).then(a=>{a.result!=""?(e.id=a.result,U.getInstance().success(e.status==1?"提交成功":"保存成功"),e.status==1&&setTimeout(()=>{z(),J.getInstance().sendMsg("safe-check-issue",{})},100)):(e.status=0,I.value=!1,U.getInstance().error("保存失败.")),e.spinning=!1}).catch(a=>{console.log(a),I.value=!1,e.status=0,e.spinning=!1})};return ue(()=>S(this,null,function*(){if(M.value=D.processInstanceId,!e.id&&D.processInstanceId){const a=yield $(D.processInstanceId);e.id=a.businessKey}Q({id:e.id}).then(a=>{let t=a.result;if(e.id){for(let y in t)e[y]=t[y];e.status=Number(e.status),p.value.reloadGrid({templateId:e.templateId})}else e.billCode=t.billCode,e.personMemberName=t.personMemberName,e.deptName=t.deptName,e.fillinDate=t.fillinDate;let{billCode:u,fillinDate:d,personMemberName:b,deptName:x}=t;Object.assign(h,{billCode:u,fillinDate:d,personMemberName:b,deptName:x})}).then(()=>{e.status==0?X({}).then(a=>{ee({deptId:a.result.org.deptId,orgKindIds:"psm"}).then(t=>{let u={};t.result.forEach(d=>{u[d.personId]=d.name});for(const d in u)i.value.push({label:u[d],value:d})})}):i.value.push({label:e.issuedPersonName,value:e.issuedPersonId})}),te({checkType:"2",status:2,bizStatus:1}).then(a=>{a.result.forEach(t=>{_.value.push({label:t.subject,value:t.id,checkType:t.checkType})})})})),(a,t)=>{const u=r("a-select"),d=r("a-form-item"),b=r("a-col"),x=r("a-input"),y=r("a-date-picker"),Y=r("a-row"),N=r("a-card"),A=r("a-form"),T=r("a-tab-pane"),L=r("a-tabs"),W=r("a-spin");return pe(),ce(me(E),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:o(()=>[g("div",fe,[s(W,{spinning:e.spinning,tip:"Loading..."},{default:o(()=>[g("div",ve,[g("div",Ie,[s(oe,{options:h},null,8,["options"]),s(ne,{onAgree:G,onSave:F,onSubmit:R,processStatus:e.status,processInstanceId:M.value,listenMessage:"safe-check-issue"},null,8,["processStatus","processInstanceId"])]),g("div",_e,[s(A,{model:e,name:"basic",ref_key:"formRef",ref:k,"label-col":{span:4},"wrapper-col":{span:20},autocomplete:"off",onFinish:P},{default:o(()=>[s(N,{title:"基本信息",bordered:!1},{default:o(()=>[s(Y,{gutter:32},{default:o(()=>[s(b,{span:12},{default:o(()=>[s(d,{label:"安全检查模板",name:"templateId",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"安全检查模板"}]},{default:o(()=>[s(u,{value:e.templateId,"onUpdate:value":t[0]||(t[0]=l=>e.templateId=l),allowClear:"",options:_.value,onChange:O,disabled:n.value},null,8,["value","options","disabled"])]),_:1})]),_:1}),s(b,{span:12},{default:o(()=>[s(d,{label:"主题",name:"subject",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"主题"}]},{default:o(()=>[s(x,{value:e.subject,"onUpdate:value":t[1]||(t[1]=l=>e.subject=l),disabled:n.value,maxlength:"128"},null,8,["value","disabled"])]),_:1})]),_:1}),s(b,{span:12},{default:o(()=>[s(d,{label:"任务日期",name:"taskDate",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"任务日期"}]},{default:o(()=>[s(y,{value:e.taskDate,"onUpdate:value":t[2]||(t[2]=l=>e.taskDate=l),valueFormat:"YYYY-MM-DD",style:{width:"100%"},disabled:n.value,onChange:B},null,8,["value","disabled"])]),_:1})]),_:1}),s(b,{span:12},{default:o(()=>[s(d,{label:"下发人",name:"issuedPersonId",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"下发人"}]},{default:o(()=>[s(u,{value:e.issuedPersonId,"onUpdate:value":t[3]||(t[3]=l=>e.issuedPersonId=l),"allow-clear":"",options:i.value,onChange:q,disabled:n.value},null,8,["value","options","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),s(N,{title:"",bordered:!1},{default:o(()=>[g("div",be,[s(L,{activeKey:f.value,"onUpdate:activeKey":t[8]||(t[8]=l=>f.value=l),onChange:j},{default:o(()=>[s(T,{key:"tplChild",tab:"检查项目"},{default:o(()=>[s(le,{ref_key:"tplChild",ref:p,disabledInput:n.value,"onUpdate:disabledInput":t[4]||(t[4]=l=>n.value=l)},null,8,["disabledInput"])]),_:1}),s(T,{key:"issueDtlChild",tab:"下发电站","force-render":""},{default:o(()=>[s(ae,{ref_key:"issueDtlChild",ref:c,disabledInput:n.value,"onUpdate:disabledInput":t[5]||(t[5]=l=>n.value=l),templateId:e.templateId,"onUpdate:templateId":t[6]||(t[6]=l=>e.templateId=l),taskDate:e.taskDate,"onUpdate:taskDate":t[7]||(t[7]=l=>e.taskDate=l)},null,8,["disabledInput","templateId","taskDate"])]),_:1})]),_:1},8,["activeKey"])])]),_:1})])])]),_:1},8,["spinning"])])]),_:1})}}});const et=Z(ge,[["__scopeId","data-v-d3dc84eb"]]);export{et as default};
//# sourceMappingURL=createOrUpdate-44bc6c4f.js.map
