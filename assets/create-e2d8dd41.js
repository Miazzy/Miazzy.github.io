var x=(c,I,d)=>new Promise((f,w)=>{var t=p=>{try{v(d.next(p))}catch(y){w(y)}},g=p=>{try{v(d.throw(p))}catch(y){w(y)}},v=p=>p.done?f(p.value):Promise.resolve(p.value).then(t,g);v((d=d.apply(c,I)).next())});import{d as se,aD as le,r as W,k as F,o as ie,al as r,Z as C,a9 as k,aa as s,$ as _,f as o,u as m,E as re,ac as T,J as de,aG as ue,aH as me}from"./vue-71d1abb3.js";import{a as D}from"./index.esm-c216ed00.js";import{b as pe,aB as ce,av as M,bP as fe,aC as ge,a7 as be,_ as he}from"./index.js";import{U as _e}from"./UploadBox-636ecf02.js";import{B as R}from"./BasicTable-0434a334.js";import{T as Ie}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as O}from"./useTable-109483b3.js";import{a2 as h}from"./antd-15ac76ed.js";import{_ as z}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{B as we}from"./BillTitle-d17ab3e4.js";import{W as ve}from"./WfApproveBox-a3448232.js";import{a as ye,c as xe,b as Ce}from"./index-38c223d1.js";import{a as ke,d as Ne}from"./index-cfbcaec7.js";import{b as Te}from"./index-5d738211.js";import{D as De}from"./Dialog-0a006d82.js";import{P as Se}from"./index-20519caf.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useContentViewHeight-7f845167.js";const Be=c=>(ue("data-v-18b8d3fb"),c=c(),me(),c),qe={class:"load"},We={class:"process-box"},Ee={class:"header-box"},Ue={class:"content"},Fe=Be(()=>_("div",{class:"customer_require"},"入库数量",-1)),Me=se({name:"WarehousingCreate",__name:"create",setup(c){const{t:I}=pe(),{query:d}=le(),f=W({});f.subject="设备入库";const w=F(),t=W({spinning:!1,processInstanceId:"",id:"",warehouseId:"",warehouseName:"",status:"",warehouseType:"",warehousingType:"",warehousingDate:"",remark:"",stationOrganId:"",stationOrganName:"",stationId:"",stationName:"",bizFileId:""}),g=F(!1),v=[{key:"fullName",title:"物料类别",dataIndex:"fullName",align:"center",width:160},{key:"code",title:"物料编码",dataIndex:"code",align:"center",width:120},{key:"name",title:"物料名称",dataIndex:"name",align:"center",width:120},{key:"unit",title:"单位",dataIndex:"unit",align:"center",width:120}],p={baseColProps:{lg:6,md:8},labelWidth:90,schemas:[{label:"物料编码",field:"code",component:"Input"},{label:"物料名称",field:"name",component:"Input"}]},[y,{reload:A,getSelectRows:P}]=O({api:Te,rowKey:"id",columns:v,useSearchForm:!0,formConfig:p,bordered:!0,pagination:!0,maxHeight:343,rowSelection:{type:"checkbox"},beforeFetch(e){return e.status=1,e}}),H=()=>{g.value=!0,A()},V=()=>{const e=P();if(e.length==0)return h.warning("请选择物料。"),!1;const a=N();for(let n=0;n<e.length;n++){if(a.filter(S=>S.materialId==e[n].id).length>0)return h.warning("物料：'"+e[n].name+"'已存在。"),!1;const i={materialId:e[n].id,materialCode:e[n].code,materialName:e[n].name,materialWholeName:e[n].fullName+"-"+e[n].name,materialCategoryId:e[n].materialCategoryId,materialCategoryName:e[n].fullName,unitId:e[n].unit,unitName:e[n].unitText,editable:!0,key:`${Date.now()}`};a.push(i)}g.value=!1},$=e=>{if(e.id)Ne(e.id).then(()=>{E(),h.success("操作成功。")});else{const a=N(),n=a.indexOf(e);n!==-1&&a.splice(n,1)}},j=[{title:"物料编码",dataIndex:"materialCode",width:160},{title:"物料",dataIndex:"materialName",width:160},{title:"物料全称",dataIndex:"materialWholeName",width:160},{title:"物料类别",dataIndex:"materialCategoryName",width:160},{slots:{title:"qty"},dataIndex:"qty",width:160},{title:"计量单位",dataIndex:"unitName",width:160},{title:"备注",dataIndex:"remark",width:160}],L=W({}),[Y,{reload:E,getDataSource:N}]=O({api:ke,pagination:!1,columns:j,formConfig:{labelWidth:120},useSearchForm:!1,bordered:!0,actionColumn:{width:140,title:I("common.operate"),dataIndex:"action",fixed:"right"},maxHeight:300,immediate:!1,beforeFetch(e){return e.warehousingId=t.id,D(e,L),e},showTableSetting:!1}),K=()=>x(this,null,function*(){fe().then(e=>{t.bizFileId=e})}),G=e=>e==null,J=()=>{U(0)},Q=()=>{w.value.validate().then(()=>{const e=N();if(e.length==0)return h.warning("请添加入库明细。"),!1;if(e.filter(n=>G(n.qty)||n.qty==0).length>0)return h.warning("请填写入库数量。"),!1;U(1)}).catch(e=>{console.log("error",e)})},U=e=>x(this,null,function*(){t.spinning=!0;try{const a=de(t);a.status=e,a.dtlList=N();const n=yield xe(a);t.id=n.result,h.success(e==1?"提交成功。":"保存成功"),e==1&&setTimeout(()=>{ge(),be.getInstance().sendMsg("warehousing-page",{})},1e3)}catch(a){console.log("error",a)}finally{t.spinning=!1}}),Z=()=>x(this,null,function*(){Ce(t.id).then(e=>{D(t,e),t.processInstanceId||(t.processInstanceId=d.processInstanceId);let{billCode:a,fillinDate:n,personMemberName:u,deptName:i}=e;Object.assign(f,{billCode:a,fillinDate:n,personMemberName:u,deptName:i}),E()})});return ie(()=>x(this,null,function*(){d.processInstanceId?(t.processInstanceId=d.processInstanceId,ce(d.processInstanceId).then(e=>{t.id=e.businessKey,Z()})):ye().then(e=>{D(t,e),D(t,d),K();let{billCode:a,fillinDate:n,personMemberName:u,deptName:i}=e;Object.assign(f,{billCode:a,fillinDate:n,personMemberName:u,deptName:i}),t.status=0})})),(e,a)=>{const n=r("a-input"),u=r("a-form-item"),i=r("a-col"),S=r("a-date-picker"),X=r("a-textarea"),ee=r("a-row"),B=r("a-card"),te=r("a-form"),ae=r("a-button"),ne=r("a-input-number"),oe=r("a-spin");return C(),k(m(Se),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:s(()=>[_("div",qe,[o(oe,{spinning:t.spinning,tip:"Loading..."},{default:s(()=>[_("div",We,[_("div",Ee,[o(we,{options:f},null,8,["options"]),o(ve,{onSave:J,onSubmit:Q,processInstanceId:t.processInstanceId,processStatus:t.status},null,8,["processInstanceId","processStatus"])]),_("div",Ue,[o(te,{ref_key:"formRef",ref:w,model:t,labelAlign:"right",autocomplete:"off",scrollToFirstError:!0},{default:s(()=>[o(B,{title:"基本信息",bordered:!1},{default:s(()=>[o(ee,{gutter:32},{default:s(()=>[o(i,{span:12},{default:s(()=>[o(u,{name:"warehouseName",label:"库房名称",labelCol:{span:4}},{default:s(()=>[o(n,{disabled:"",value:t.warehouseName,"onUpdate:value":a[0]||(a[0]=l=>t.warehouseName=l)},null,8,["value"])]),_:1})]),_:1}),o(i,{span:12},{default:s(()=>[o(u,{name:"warehouseType",label:"库房类型",labelCol:{span:4}},{default:s(()=>[o(z,{type:"warehouse_type",onChange:a[1]||(a[1]=l=>"()=> formState.warehouseType = value"),value:t.warehouseType,"onUpdate:value":a[2]||(a[2]=l=>t.warehouseType=l),style:{width:"100%"},disabled:""},null,8,["value"])]),_:1})]),_:1}),o(i,{span:12},{default:s(()=>[o(u,{name:"warehouseType",label:"入库类型",labelCol:{span:4},rules:[{required:!0,message:"请选择入库类型"}]},{default:s(()=>[o(z,{type:"warehousing_type",disabled:t.status!=0,onChange:a[3]||(a[3]=l=>"()=> formState.warehousingType = value"),value:t.warehousingType,"onUpdate:value":a[4]||(a[4]=l=>t.warehousingType=l),style:{width:"100%"}},null,8,["disabled","value"])]),_:1})]),_:1}),o(i,{span:12},{default:s(()=>[o(u,{label:"入库日期",name:"warehousingDate",labelAlign:"right",labelCol:{span:4},rules:[{required:!0,message:"请选择入库日期"}]},{default:s(()=>[o(S,{value:t.warehousingDate,"onUpdate:value":a[5]||(a[5]=l=>t.warehousingDate=l),style:{"min-width":"100%"},"value-format":"YYYY-MM-DD",disabled:t.status!=0},null,8,["value","disabled"])]),_:1})]),_:1}),o(i,{span:24,class:"textarea-item"},{default:s(()=>[o(u,{label:"说明",name:"remark",labelAlign:"right",labelCol:{span:2}},{default:s(()=>[o(X,{rows:5,value:t.remark,"onUpdate:value":a[6]||(a[6]=l=>t.remark=l),placeholder:"128字以内",maxlength:128,disabled:t.status!=0},null,8,["value","disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),o(B,{bordered:!1},{default:s(()=>[o(m(R),{title:"入库明细",onRegister:m(Y)},{toolbar:s(()=>[t.status===0?(C(),k(ae,{key:0,type:"primary",preIcon:m(M).ADD,onClick:H},{default:s(()=>[re(" 添加 ")]),_:1},8,["preIcon"])):T("",!0)]),qty:s(()=>[Fe]),bodyCell:s(({column:l,record:b})=>[l.dataIndex==="qty"?(C(),k(ne,{key:0,value:b[l.dataIndex],"onUpdate:value":q=>b[l.dataIndex]=q,min:0,max:b.balanceQty,disabled:t.status!=0,step:.1},null,8,["value","onUpdate:value","max","disabled"])):T("",!0),l.dataIndex==="remark"?(C(),k(n,{key:1,value:b[l.dataIndex],"onUpdate:value":q=>b[l.dataIndex]=q,disabled:t.status!=0,maxlength:256},null,8,["value","onUpdate:value","disabled"])):T("",!0),l.key==="action"?(C(),k(m(Ie),{key:2,actions:[{icon:m(M).DELETE,danger:!0,label:m(I)("common.delText"),ifShow:()=>t.status===0,popConfirm:{title:m(I)("common.message.delMessage"),placement:"left",confirm:$.bind(null,b)}}]},null,8,["actions"])):T("",!0)]),_:1},8,["onRegister"])]),_:1}),o(B,{title:"附件信息",bordered:!1},{default:s(()=>[o(_e,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"warehousing",vmode:t.status==0?"box":"view",bizId:t.bizFileId},null,8,["vmode","bizId"])]),_:1})]),_("div",null,[o(De,{visible:g.value,"onUpdate:visible":a[7]||(a[7]=l=>g.value=l),title:"选择物料",onOk:V,width:1e3,maskClosable:!1},{default:s(()=>[o(m(R),{onRegister:m(y),class:"table-in-dialog"},null,8,["onRegister"])]),_:1},8,["visible"])])])]),_:1},8,["spinning"])])]),_:1})}}});const _t=he(Me,[["__scopeId","data-v-18b8d3fb"]]);export{_t as default};
//# sourceMappingURL=create-e2d8dd41.js.map
