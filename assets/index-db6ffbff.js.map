{"version":3,"file":"index-db6ffbff.js","sources":["../../src/views/oa/info/query/index.ts","../../src/views/oa/info/query/index.vue"],"sourcesContent":["import { BasicColumn, FormSchema } from '@/components/Table';\nimport { defHttp } from '/@/utils/http/axios';\n\nenum Api {\n  getTreeTypeUrl = '/oa/infoKind/type/getTree',\n  getPage = '/oa/info-query/page',\n  getReadNotCountPage = '/oa/info-query/readNotCount',\n  updateCollection = '/oa/info-release-collection/cancelCollection?infoReleaseId=',\n}\n\nexport const getPage = (params) => {\n  return defHttp.get({ url: Api.getPage, params }, {});\n};\nexport const getReadNotCountPage = () => {\n  return defHttp.get({ url: Api.getReadNotCountPage }, { isOnlyResult: true });\n};\nexport const updateCollection = (infoReleaseId) => {\n  return defHttp.put({ url: Api.updateCollection + infoReleaseId }, {});\n};\n\n// 组织树数据\nexport const getTreeData = (params) => {\n  return defHttp.get({ url: Api.getTreeTypeUrl, params }, {});\n};\n\nexport const columns: BasicColumn[] = [\n  { title: '通知主题', dataIndex: 'subject',align: 'left',headAlign:'center', width: 120,sorter: true,resizable: true },\n  { title: '信息类型', dataIndex: 'infoKindName', width: 120,sorter: true,resizable: true },\n  { title: '所在部门', dataIndex: 'deptName',align: 'left',headAlign:'center', width: 120,sorter: true,resizable: true },\n  { title: '发布人', dataIndex: 'personMemberName',align: 'left',headAlign:'center', width: 120,sorter: true,resizable: true },\n  { title: '发布时间', dataIndex: 'finishedDate', width: 120,sorter: true,resizable: true },\n  { title: '阅读状态', dataIndex: 'readStatusText', width: 120,sorter: true,resizable: true },\n];\n\nexport const formSearchSchemas : FormSchema[] =[\n  { label: '信息主题', field: 'subject', component: 'Input', colProps: { span: 8 } },\n  {\n    label: '阅读状态',\n    field: 'readStatus',\n    component: 'DictSelectBox',\n    componentProps: {\n      type: 'read_status',\n    },\n    colProps: { span: 8 },\n  },\n  {\n    field: '[startPublishedDate, endPublishedDate]',\n    label: '发布时间',\n    component: 'RangePicker',\n    colProps: { span: 8 },\n    componentProps: {\n      format: 'YYYY-MM-DD',\n      valueFormat: 'YYYY-MM-DD',\n      placeholder: ['开始日期', '结束日期'],\n    },\n  },\n];\n  ","<template>\n  <PageWrapper dense contentFullHeight fixedHeight  contentClass=\"flex\" style=\"position: relative\">\n    <!-- 信息分类树 -->\n    <CommonTree\n      ref=\"treeRef\"\n      title=\"信息分类\"\n      @select=\"handleSelect\"\n      :value=\"treeData\"\n      class=\"left-tree-layout\"\n      :fieldNames=\"{ key: 'id', title: 'name' }\"\n    >\n    </CommonTree>\n\n    <div class=\"right-table-layout tab-model\">\n      <div class=\"tab-button-div\">\n        <BasicForm @register=\"formRegister\"/>\n       </div>\n      <div class=\"tab-table-div\" id=\"more-tab-content\">\n        <a-tabs v-model:activeKey=\"activeKey\" @change=\"switchTab\">\n          <a-tab-pane key=\"receiver\">\n            <template #tab>\n              <a-badge :count=\"notReadNum\" :offset=\"[16, -12]\" :numberStyle=\"{ transform: 'scale(0.8)' }\">\n                <span>我接收的</span>\n              </a-badge>\n            </template>\n            <BasicTable @register=\"receiverTable\" \n            class=\"fix-basic-table\"\n              @row-dbClick=\"dbReceiverClick\"\n              @resize-column=\"(w, col) => (col.width = w)\">\n            </BasicTable>\n          </a-tab-pane>\n          <a-tab-pane key=\"collection\">\n            <template #tab>\n              <span> 我收藏的 </span>\n            </template>\n            <BasicTable @register=\"collectionTable\" \n            class=\"fix-basic-table\"\n              @row-dbClick=\"dbCollectionClick\"\n              @resize-column=\"(w, col) => (col.width = w)\">\n              <template #toolbar>\n                <a-button type=\"primary\" v-if=\"activeKey == 'collection'\" @click=\"handleUpdateCollection\">\n                  {{ '取消收藏' }}\n                </a-button>\n              </template>\n            </BasicTable>\n          </a-tab-pane>\n        </a-tabs>\n      </div>\n    </div>\n\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n\n  import { PageWrapper } from '/@/components/Page';\n  import { onMounted, ref, unref } from 'vue';\n  import { TreeItem } from '/@/components/Tree';\n  import { message } from 'ant-design-vue';\n  import { SysMessage } from '/@/hooks/web/useMessage';\n  import { BasicTable, useTable, SorterResult } from '@/components/Table';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import { BasicForm, useForm } from '@/components/Form';\n  import { getTreeData, columns, getPage, updateCollection,getReadNotCountPage,formSearchSchemas } from './index';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '/@/message/MsgManager';\n\n  const treeData = ref<TreeItem[]>([]);\n  const activeKey = ref('receiver');\n  const notReadNum = ref(0);\n  const treeRef = ref();\n\n\n  const queryParam: any = ref({\n    pageNo: 1,\n    pageSize: 10,\n    sortField: 'finishedDate',\n    sortOrder: 'desc'\n  });\n\n\n\n  const getTree = () => {\n    const tree = unref(treeRef);\n    if (!tree) {\n      throw new Error('tree is null!');\n    }\n    return tree;\n  };\n\n  const switchTab=()=>{\n    debugger;\n    getReadNotCount();\n    query();\n  }\n  \n\n  function handleView(record) {\n    if(!record){\n      SysMessage.getInstance().success('请选择一行数据');\n      return;\n    }\n    let type=record.type === 'infoNotice'?'infoNotice':'officeDoc';\n    addTabPage(\n      `/oa/info/officedoc/view?bizId=${record.infoReleaseId}&module=`+type,\n      type=='infoNotice'?'查看通知':'查看公文'\n      \n    );\n  }\n  const query = () => {\n    if (activeKey.value === 'receiver') {\n      reload();\n    } else {\n      collectionReload();\n    }\n  };\n  function handleSelect(node) {\n    queryParam.value.infoKindId = '';\n    if (node) {\n      queryParam.value.infoKindId = node.id;\n    }\n    query();\n  }\n  const handleUpdateCollection = () => {\n    let rows = collectionGetRows();\n    updateCollection(rows[0].infoReleaseId).then((rsp) => {\n      if (rsp.code == 0) {\n        message.info('取消成功.');\n        collectionReload();\n      } else {\n        message.error('取消成功.原因:' + rsp.message);\n      }\n    });\n  };\n\n  const dbCollectionClick=(row)=>{\n    handleView(row);\n  }\n\n\n  const [formRegister, { resetFields, getFieldsValue }] = useForm({\n    labelWidth: 120,\n    baseColProps: { span: 8 },\n    actionColOptions: {\n      span: 24,\n    },\n \n    schemas: formSearchSchemas,\n    compact: true,\n\n    resetButtonOptions: {\n      onClick: async () => {\n        await resetFields();\n        query();\n      },\n    },\n    submitFunc: () => {\n      query();\n      return Promise.resolve();\n    },\n  });\n\n  const [\n    collectionTable,\n    {\n      reload: collectionReload,\n      getPaginationRef: collectionPageRef,\n      getSelectRows: collectionGetRows,\n    },\n  ] = useTable({\n    api: async () => {\n      const paginationRef = collectionPageRef() as any;\n      Object.assign(queryParam.value,getFieldsValue());\n      \n      queryParam.value.tabType = activeKey.value;\n      queryParam.value.pageNo = paginationRef.current;\n      queryParam.value.pageSize = paginationRef.pageSize;\n      let dataObj = await getPage(queryParam.value);\n      return dataObj.result;\n    },\n    columns,\n    bordered: true,\n    rowKey: 'infoReleaseId',\n    useSearchForm: false,\n    target: '#more-tab-content',\n    targetTabKey: 'collection',\n    targetTabValue: activeKey,\n    rowSelection: {\n      type: 'radio',\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        queryParam.value.sortField = sortInfo.field.replace('Text', '');\n        queryParam.value.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n          queryParam.value.sortField = 'finishedDate';\n          queryParam.value.sortOrder = 'desc';\n        }\n    },\n    handleSearchInfoFn(info) {\n      for (const key in info) {\n        queryParam.value[key] = info[key];\n      }\n    }\n  });\n\n  const dbReceiverClick=(record)=>{\n    handleView(record);\n  }\n  \n\n  const [receiverTable, { reload, getPaginationRef }] = useTable({\n    api: async () => {\n      const paginationRef = getPaginationRef() as any;\n      Object.assign(queryParam.value,getFieldsValue());\n      queryParam.value.tabType = activeKey.value;\n      queryParam.value.pageNo = paginationRef.current;\n      queryParam.value.pageSize = paginationRef.pageSize;\n      let dataObj = await getPage(queryParam.value);\n      getTree().loadBadge();\n      return dataObj.result;\n    },\n    columns,\n    bordered: true,\n    rowKey: 'infoReleaseId',\n    target: '#more-tab-content',\n    targetTabKey: 'receiver',\n    targetTabValue: activeKey,\n    useSearchForm: false,\n\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        queryParam.value.sortField = sortInfo.field.replace('Text', '');\n        queryParam.value.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n          queryParam.value.sortField = 'finishedDate';\n          queryParam.value.sortOrder = 'desc';\n        }\n    },\n    handleSearchInfoFn(info) {\n      for (const key in info) {\n        queryParam.value[key] = info[key];\n      }\n    },\n  });\n\n  const getReadNotCount=()=>{\n    let totalNum = 0;\n    getReadNotCountPage().then(rsp=>{\n        for (let i = 0; i < treeData.value.length; i++) {\n          treeData.value[i].badge='';\n        }\n        for(let key in rsp){\n          if(key === 'notype'){\n            continue;\n          }\n          totalNum += rsp[key].num;\n            for (let i = 0; i < treeData.value.length; i++) {\n              if (treeData.value[i].codePre == key) {\n                treeData.value[i].badge = rsp[key].num ;\n              }\n            }\n        }\n\n      // if(rsp['notype']){\n      //   for (let i = 0; i < treeData.value.length; i++) {\n      //     treeData.value[i].badge='';\n      //   }\n      // } else {\n      //   for(let key in rsp){\n      //     if(key === 'notype'){\n      //       continue;\n      //     }\n      //     totalNum += rsp[key].num;\n      //       for (let i = 0; i < treeData.value.length; i++) {\n      //         if (treeData.value[i].codePre == key) {\n      //           treeData.value[i].badge = rsp[key].num ;\n      //         }\n      //       }\n      //   }\n      // }\n      \n      notReadNum.value = totalNum;\n    })\n    \n      \n  }\n\n  onMounted(async () => {\n    let param = {};\n    let rs = await getTreeData(param);\n    // if (rs.result.length > 0) {\n    //   rs.result.forEach((e) => {\n    //     e['slots'] = { icon: 'icon' + e.codePre };\n    //   });\n    // }\n    MsgManager.getInstance().listen('info-query', () => {\n      console.log(\">>>>>>>>>>>>>>>>>>>>>>>>info-query\")\n      reload();\n      getReadNotCount();\n    });\n    treeData.value = rs.result;\n    getReadNotCount();\n    \n  });\n</script>\n\n<style lang=\"less\" >\n  :deep(.vben-basic-table-header__toolbar) {\n    margin-top: 8px;\n  }\n\n  .tab-model {\n    height: 100vh;\n    padding: 10px 10px 0;\n  }\n\n  .right-table-layout {\n    flex: 1;\n    width: calc(100% - 308px);\n  }\n\n  .left-tree-layout {\n    width: 298px;\n    border-radius: 2px;\n  }\n\n  .tab-button-div {\n    .ant-form {\n      margin-bottom: 10px;\n      padding: 12px 6px 4px 16px;\n    }\n\n    .vben-basic-form {\n      .ant-row .ant-col.ant-col-8 {\n        flex: 0 0 27.5%;\n        max-width: 27.5%;\n      }\n\n      .ant-col.ant-col-24 {\n        position: fixed;\n        right: 1rem;\n      }\n    }\n  }\n\n  .notReadNumCls {\n    display: inline-block;\n    width: 22px;\n    height: 20px;\n    border: 1px solid red;\n    border-radius: 16px;\n    color: red;\n    line-height: 1.3;\n    text-align: center;\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings) {\n      margin-right: 0;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n\n</style>\n"],"names":["getPage","params","defHttp","getReadNotCountPage","updateCollection","infoReleaseId","getTreeData","columns","formSearchSchemas","treeData","ref","activeKey","notReadNum","treeRef","queryParam","getTree","tree","unref","switchTab","getReadNotCount","query","handleView","record","SysMessage","type","addTabPage","reload","collectionReload","handleSelect","node","handleUpdateCollection","rows","collectionGetRows","rsp","message","dbCollectionClick","row","formRegister","resetFields","getFieldsValue","useForm","__async","collectionTable","collectionPageRef","useTable","paginationRef","sortInfo","info","key","dbReceiverClick","receiverTable","getPaginationRef","dataObj","totalNum","i","onMounted","rs","MsgManager"],"mappings":"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"}