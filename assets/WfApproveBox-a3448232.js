var H=(F,r,n)=>new Promise((S,y)=>{var _=l=>{try{b(n.next(l))}catch(f){y(f)}},w=l=>{try{b(n.throw(l))}catch(f){y(f)}},b=l=>l.done?S(l.value):Promise.resolve(l.value).then(_,w);b((n=n.apply(F,r)).next())});import{d as ye,k as v,r as pe,w as q,o as _e,Z as g,_ as C,F as Fe,ae as Ae,$ as T,ad as z,f as u,ac as h,a5 as Re,a6 as ve,a9 as M,u as d,J as G,al as $,ag as Be,aa as i,E as D,a7 as Ce,ax as Me,e as je,v as Oe,A as Ue}from"./vue-71d1abb3.js";import{a as ae}from"./index.esm-c216ed00.js";import{B as Ee,u as Ke}from"./index-fda2d66c.js";import{a0 as we,I as ge,_ as be,p as xe,bL as ke,at as c,bM as he,bN as Ie,a7 as j,bO as Ne,aC as ee,aB as Pe}from"./index.js";import{by as He,ai as W,aa as $e,a9 as ze,bu as se,aA as qe,aE as Te,a0 as We,a1 as Le}from"./antd-15ac76ed.js";import{B as Je}from"./BasicTable-0434a334.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as Ze}from"./useTable-109483b3.js";import{O as Ge}from"./OrganDialog-dd1023ce.js";import{e as Qe,f as Ve,h as De,r as Se,i as Xe}from"./index-c0893416.js";import{g as Ye}from"./index-33af41d1.js";import{r as es}from"./tree-fc0e156a.js";const ss={class:"approval-tab"},as={class:"flow-item-left"},ts={class:"circle-out"},ns={class:"circle-inner-text blue"},os={key:0,class:"status-icon green"},rs={key:1,class:"status-icon blue"},ls={class:"flow-item-right"},cs={class:"flow-row-1"},us={class:"node-name-text"},is={class:"node-time-text"},ds={class:"flow-row-2"},fs={class:"person-text"},ps={class:"flow-row-3"},vs={key:0,class:"comment-text"},gs=ye({__name:"ApprovalTab",props:{flowData:{type:Array},type:{type:String}},setup(F,{expose:r}){const n=F;v("");const S=we(),y=pe({1:{text:"正在处理",color:"#1890FF"},2:{text:"通过",color:"#25C28A"},3:{text:"不通过",color:"#FF4D4F"},4:{text:"打回",color:"#FF4D4F"},5:{text:"已终止",color:"#999"},6:{text:"已取消",color:"#999"},7:{text:"已转办",color:"#999"}}),_=v([]);function w(l){if(n.type==="track"){let f=[];l==null||l.forEach(t=>{f.unshift(t)}),_.value=f}else n.type==="approval"&&(_.value=l)}const b=l=>{var t;const f=G(S.getUserInfo);return((t=l==null?void 0:l.assigneeUser)==null?void 0:t.id)===(f==null?void 0:f.userId)&&(l==null?void 0:l.processInstanceStatus)===1};return r({innerFlowData:_}),q(()=>n.flowData,l=>{w(l)}),_e(()=>{w(n.flowData)}),(l,f)=>(g(),C("div",ss,[(g(!0),C(Fe,null,Ae(_.value,(t,p)=>{var A,k,x,K;return g(),C("div",{class:"flow-item",key:t.id},[T("div",as,[T("div",ts,[T("div",ns,z((A=t==null?void 0:t.assigneeUser)!=null&&A.name?(k=t==null?void 0:t.assigneeUser)==null?void 0:k.name.slice(-1):""),1),t.result&&t.result!==1?(g(),C("div",os,[u(ge,{class:"fit-status-icon",icon:"ant-design:check-outlined",color:"#fff",size:"8"})])):h("",!0),t.result&&t.result===1?(g(),C("div",rs,[u(ge,{class:"fit-status-icon",icon:"ic:round-edit",color:"#fff",size:"8"})])):h("",!0)]),p<F.flowData.length-1?(g(),C("div",{key:0,class:Re(["flow-vertical-line",t.result===1?"dashed":"solid"])},null,2)):h("",!0)]),T("div",ls,[T("div",cs,[T("span",us,z(t.name),1),T("span",is,z(t.endTime),1)]),T("div",ds,[T("span",fs,z(((x=t==null?void 0:t.assigneeUser)==null?void 0:x.deptName)+"－"+((K=t==null?void 0:t.assigneeUser)==null?void 0:K.name)),1),t.result&&y[t.result]?(g(),C("span",{key:0,class:"flow-status-text",style:ve({color:y[t.result].color})},"("+z(y[t.result].text)+")",5)):h("",!0)]),T("div",ps,[n.type!="approval"?(g(),C("div",vs,z(t.reason),1)):h("",!0),n.type==="approval"&&t.result===1&&b(t)?(g(),M(d(He),{key:1,class:"fit-comment-textarea",value:t.reason,"onUpdate:value":R=>t.reason=R,placeholder:"回复意见",maxlength:200,"auto-size":{minRows:5},bordered:!1},null,8,["value","onUpdate:value"])):h("",!0)])])])}),128))]))}});const me=be(gs,[["__scopeId","data-v-fb59e16d"]]),ys=ye({__name:"ApprovalDrawer",props:{flowData:{type:Array},processInstanceId:xe.string.def(""),isHandle:{type:Number,default:1},mode:{type:String,default:"default"},businessStatus:{type:String,default:""}},emits:["agree","reject","save","end","back","transfer","notice","collect","before"],setup(F,{emit:r}){const n=F,S=v(!1),y=v(!1),_=v([]),w=v(0),b=we(),l=G(b.getUserInfo),f=a=>{var e;return((e=a==null?void 0:a.assigneeUser)==null?void 0:e.id)===(l==null?void 0:l.userId)&&(a==null?void 0:a.processInstanceStatus)===1},t=v([]);q(()=>n.flowData,a=>{const e=[];a==null||a.forEach(s=>{s.result===1&&f(s)&&e.push(s)}),t.value=e,t.value[0]&&f(t.value[0])?k.value="1":k.value="2"});const p=v(),A=v(),k=v("1"),x=a=>{const{key:e}=a,{innerFlowData:s}=p.value;switch(e){case"1":re();break;case"2":X(2);break;case"3":X(3);break;case"4":r("collect",s);break;case"5":V();break}},K=pe({display:"block",height:"30px",lineHeight:"30px"}),R=pe({backType:""}),Q=v(),O=()=>{Q.value.validate().then(()=>{const a=J();if(a.length!==1){c.getInstance().warning("请选择一行数据。");return}const{innerFlowData:e}=p.value,s=m(e);if(!s.reason){c.getInstance().warning("请填写回复意见。");return}const o={id:s.id,targetKey:a[0].taskDefinitionKey,reason:s.reason};R.backType==1?n.mode==="default"?he(o).then(()=>{r("back",e),c.getInstance().success("操作成功。")}).then(()=>{y.value=!1}):n.mode==="before"&&r("before",t.value[0],"beforeBack"):n.mode==="default"?Ie(o).then(()=>{r("back",e),c.getInstance().success("操作成功。")}).then(()=>{y.value=!1}):n.mode==="before"&&r("before",t.value[0],"beforeReplenish")}).catch(a=>{console.log("onSubmit=》error",a)})},V=()=>{const{innerFlowData:a}=p.value,e=m(a);if(Object.keys(e).length===0){c.getInstance().warning("没有权限操作。");return}if(e.definitionKey=="Apply"){c.getInstance().warning("申请节点不能回退。");return}y.value=!0,ne()},te=[{title:"名称",dataIndex:"name",width:150}],[L,{reload:ne,getSelectRows:J}]=Ze({api:Ne,rowKey:"id",columns:te,useSearchForm:!1,showTableSetting:!1,bordered:!0,pagination:!1,maxHeight:300,rowSelection:{type:"radio"},beforeFetch(a){const{innerFlowData:e}=p.value,s=m(e);return a.taskId=s.id,a}});function B(){const{innerFlowData:a}=p.value;n.mode==="default"?r("agree",a):n.mode==="before"&&r("before",t.value[0],"beforeAgree"),j.getInstance().sendMsg("workflow-task-done",{}),j.getInstance().sendMsg("task-center-page",{})}function oe(){const{innerFlowData:a}=p.value;n.mode==="default"?r("reject",a):n.mode==="before"&&r("before",t.value[0],"beforeReject"),j.getInstance().sendMsg("workflow-task-done",{}),j.getInstance().sendMsg("task-center-page",{})}function re(){const{innerFlowData:a}=p.value,e=m(a);if(Object.keys(e).length===0){c.getInstance().warning("没有权限操作。");return}if(e.result==2){c.getInstance().warning("此任务已处理。");return}const s={id:e.id,reason:e.reason};We.confirm({title:()=>"确认操作",icon:()=>u(Le),content:()=>u("div",{style:"color:red;"},"确定要终止当前任务吗？"),onOk(){if(!e.reason){c.getInstance().warning("取消原因不能为空。");return}n.mode==="default"?(r("end",a),ke(s).then(()=>{w.value=0,r("onReload"),c.getInstance().success("操作成功。")})):n.mode==="before"&&r("before",t.value[0],"beforeEnd")},class:"test"})}q(()=>n.businessStatus,a=>{if(a==="end"){const{innerFlowData:e}=p.value,s=m(e),o={id:s.id,reason:s.reason};ke(o).then(()=>{w.value=0,r("onReload"),c.getInstance().success("操作成功。")})}else if(a==="back"){const e=J(),{innerFlowData:s}=p.value,o=m(s),I={id:o.id,targetKey:e[0].taskDefinitionKey,reason:o.reason};he(I).then(()=>{r("back",s),c.getInstance().success("操作成功。")}).then(()=>{y.value=!1})}else if(a==="replenish"){const e=J(),{innerFlowData:s}=p.value,o=m(s),I={id:o.id,targetKey:e[0].taskDefinitionKey,reason:o.reason};Ie(I).then(()=>{r("back",s),c.getInstance().success("操作成功。")}).then(()=>{y.value=!1})}});function X(a){w.value=a;const{innerFlowData:e}=p.value,s=m(e);if(s.definitionKey=="Apply"&&a==2){c.getInstance().warning("申请节点不能转办。");return}if(a==2&&s.result==2){c.getInstance().warning("此任务已处理。");return}S.value=!0,es(_,100)}function le(){return H(this,null,function*(){Ye({showPosition:!1,status:1}).then(a=>{const e=a;_.value=e})})}const Y=a=>a.split("@")[0],ce=a=>{const{innerFlowData:e}=p.value,s=m(e);if(a.length==0)return c.getInstance().warning("请选择人员。"),!1;if(w.value==2){if(s.result>1)return c.getInstance().warning("此任务已处理。"),!1;if(a.length>1)return c.getInstance().warning("只能选择一个人员。"),!1;if(a[0].orgKindId!="psm")return c.getInstance().warning("请选择人员。"),!1;const o={id:s.id,assigneeUserId:Y(a[0].value),reason:s.reason};Qe(o).then(()=>{w.value=0,r("onReload"),c.getInstance().success("操作成功。"),S.value=!1})}else if(w.value==3){const o=[];for(let N=0;N<a.length;N++){const fe=a[N];U(fe,o)}let ie=Array.from(new Set(o)).map(N=>({userId:N}));const de={id:s.id,processInstanceId:s.processInstance.id,ccToVos:ie};Ve(de).then(()=>{w.value=0,r("onReload"),c.getInstance().success("操作成功。"),S.value=!1})}},Z=()=>{w.value=0};function U(a,e){if(a.orgKindId==="psm"&&e.push(Y(a.id)),a.children&&a.children.length>0)for(let s=0;s<a.children.length;s++){const o=a.children[s];U(o,e)}}const m=a=>{const e={};return a.forEach(s=>{var o;((o=s==null?void 0:s.assigneeUser)==null?void 0:o.id)===(l==null?void 0:l.userId)&&ae(e,s)}),e},ue=()=>{setTimeout(()=>{window.scrollTo({top:0})},0)},E=()=>document.body;return _e(()=>{le()}),(a,e)=>{const s=$("a-radio"),o=$("a-radio-group"),I=$("a-form-item"),ie=$("a-col"),de=$("a-row"),N=$("a-form"),fe=$("a-modal");return g(),M(d(Ee),Ce({class:"test"},a.$attrs,{isDetail:!0,width:"33.33%",headerStyle:{display:"none"},drawerStyle:{boxShadow:"0px 1px 3px 0px #E9E9E9"},showFooter:t.value[0]&&f(t.value[0]),footerHeight:"64",onVisibleChange:ue,"get-container":E}),Be({default:i(()=>[u(Ge,{title:"组织人员",visible:S.value,"onUpdate:visible":e[0]||(e[0]=P=>S.value=P),tdata:_.value,tfields:{key:"id",title:"name"},width:800,height:600,onCancel:Z,onConfirm:ce},null,8,["visible","tdata"]),u(fe,{visible:y.value,"onUpdate:visible":e[2]||(e[2]=P=>y.value=P),title:"回退确认",onOk:O},{default:i(()=>[u(d(Je),{onRegister:d(L)},null,8,["onRegister"]),u(N,{ref_key:"formRef",ref:Q,model:R,autocomplete:"off",class:"backType-form"},{default:i(()=>[u(de,{gutter:24},{default:i(()=>[u(ie,{span:24},{default:i(()=>[u(I,{name:"backType",rules:[{required:!0,message:"请选择回退类型"}]},{default:i(()=>[u(o,{value:R.backType,"onUpdate:value":e[1]||(e[1]=P=>R.backType=P)},{default:i(()=>[u(s,{style:ve(K),value:1},{default:i(()=>[D("回退：回退到指定节点，节点后面的审批人需重新审批。")]),_:1},8,["style"]),u(s,{style:ve(K),value:2},{default:i(()=>[D("打回：仅修改文档，修改完成后回到本节点。")]),_:1},8,["style"])]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["visible"]),T("div",null,[u(d(qe),{class:"fit-approval-tab",activeKey:k.value,"onUpdate:activeKey":e[3]||(e[3]=P=>k.value=P)},{default:i(()=>[t.value[0]&&f(t.value[0])?(g(),M(d(Te),{key:"1",tab:"流程审批"},{default:i(()=>[u(me,{ref_key:"approvalTabRef",ref:A,flowData:t.value,type:"approval"},null,8,["flowData"])]),_:1})):h("",!0),u(d(Te),{key:"2",tab:"流程轨迹","force-render":""},{default:i(()=>[u(me,{ref_key:"trackTabRef",ref:p,flowData:F.flowData,type:"track"},null,8,["flowData"])]),_:1})]),_:1},8,["activeKey"])])]),_:2},[t.value[0]&&f(t.value[0])?{name:"footer",fn:i(()=>[n.isHandle==1?(g(),M(d(W),{key:0,class:"fit-footer-btn",type:"primary",onClick:B},{default:i(()=>[D("同意")]),_:1})):h("",!0),n.isHandle==1?(g(),M(d(W),{key:1,class:"fit-footer-btn",onClick:oe},{default:i(()=>[D("不同意")]),_:1})):h("",!0),u(d($e),null,{overlay:i(()=>[u(d(ze),{onClick:x},{default:i(()=>[u(d(se),{key:"5"},{default:i(()=>[D("回退")]),_:1}),u(d(se),{key:"1"},{default:i(()=>[D("终止")]),_:1}),u(d(se),{key:"2"},{default:i(()=>[D("转办")]),_:1}),u(d(se),{key:"3"},{default:i(()=>[D("知会")]),_:1})]),_:1})]),default:i(()=>[n.isHandle==1?(g(),M(d(W),{key:0,class:"fit-footer-btn"},{default:i(()=>[D(" 更多 "),u(ge,{icon:"ant-design:down-outlined",color:"#BFBFBF",size:"14"})]),_:1})):h("",!0)]),_:1})]),key:"0"}:void 0]),1040,["showFooter"])}}});const _s=be(ys,[["__scopeId","data-v-5e8edf62"]]),ws={class:"workflow-approve-box"},bs={class:"button-content",style:{}},ks=ye({__name:"WfApproveBox",props:{processInstanceId:xe.string.def(""),processStatus:{type:[Number,String],default:""},mode:{type:String,default:"default"},businessStatus:{type:String,default:""},listenMessage:{type:String,default:"workflow-task-done"}},emits:["agree","reject","save","end","back","transfer","notice","collect","submit","before"],setup(F,{emit:r}){const n=F,{currentRoute:S}=Me(),y=d(S),_=v(!0),w=we(),b=G(w.getUserInfo),[l,{openDrawer:f,closeDrawer:t}]=Ke(),p=v([]),A=v(null),k=v(),x=v("new");function K(){f(!0)}const R=je(()=>x.value==="new"),Q=e=>H(this,null,function*(){const s=V(G(e));if(!s.reason){c.getInstance().warning("请填写回复意见。");return}yield De({id:s.id,reason:s.reason}),c.getInstance().success("操作成功。"),U.value=2,yield O(),t(),ee(),B()}),O=()=>H(this,null,function*(){const e=yield Xe(A.value);if(!e){c.getInstance().error("查询不到流程信息！");return}const s=ue(e);Object.keys(s).length===0&&(U.value=0),p.value=e});function V(e){const s={};return e.forEach(o=>{var I;((I=o==null?void 0:o.assigneeUser)==null?void 0:I.id)===(b==null?void 0:b.userId)&&(o==null?void 0:o.result)===1&&ae(s,o)}),s}const te=e=>H(this,null,function*(){const s=V(G(e));yield Se({id:s.id,reason:s.reason}),c.getInstance().success("操作成功。"),yield O(),t(),ee(),B()}),L=()=>{O()},ne=e=>{r("flowSave",e)},J=()=>{r("save"),B()},B=()=>{j.getInstance().sendMsg("workbench-approval",{}),j.getInstance().sendMsg("task-center-page",{}),j.getInstance().sendMsg(n.listenMessage,{})},oe=e=>{L(),r("end",e),t(),B()},re=e=>{L(),r("back",e),t(),B()},X=e=>{r("transfer",e),t(),B()},le=e=>{r("notice",e)},Y=e=>{r("collect",e)},ce=e=>{r("submit",e),B()},Z=v(!1),U=v(1),m=()=>H(this,null,function*(){const e=yield Pe(A.value);if(!e){c.getInstance().error("查询不到流程信息！");return}e.startUser.id===b.userId&&(_.value=!1),U.value=e.status});function ue(e){const s={};return e.forEach(o=>{var I;((I=o==null?void 0:o.assigneeUser)==null?void 0:I.id)===(b==null?void 0:b.userId)&&ae(s,o)}),s}q(()=>n.processStatus,(e,s)=>{k.value=n.processStatus,e===0&&s===""?x.value="new":e!==0&&s===""||e!==0?x.value="view":e===0&&(x.value="new")},{immediate:!0}),q(()=>n.processInstanceId,(e,s)=>{n.processInstanceId&&(A.value=n.processInstanceId,O(),m(),Z.value=!0)});const E={},a=(e,s)=>{ae(E,e),r("before",E,s)};return q(()=>n.businessStatus,e=>H(this,null,function*(){e==="agree"?(yield De({id:E.id,reason:E.reason}),c.getInstance().success("操作成功。"),U.value=2,yield O(),t(),ee(),j.getInstance().sendMsg(n.listenMessage,{})):e==="reject"&&(yield Se({id:E.id,reason:E.reason}),c.getInstance().success("操作成功。"),yield O(),t(),ee(),j.getInstance().sendMsg(n.listenMessage,{}))})),_e(()=>{!y.query.processInstanceId&&!y.query.id&&(Z.value=!0,_.value=!1)}),(e,s)=>(g(),C("div",ws,[Oe(T("div",bs,[R.value&&!_.value&&!k.value?(g(),M(d(W),{key:0,onClick:ce,type:"primary"},{default:i(()=>[D("提交")]),_:1})):h("",!0),R.value&&!_.value&&!k.value?(g(),M(d(W),{key:1,onClick:J},{default:i(()=>[D("保存")]),_:1})):h("",!0),k.value&&k.value!==0?(g(),M(d(W),{key:2,onClick:K,type:"primary"},{default:i(()=>[D("审批")]),_:1})):h("",!0)],512),[[Ue,Z.value]]),u(_s,{onRegister:d(l),flowData:p.value,processInstanceId:A.value,isHandle:U.value,mode:n.mode,businessStatus:n.businessStatus,onAgree:Q,onReject:te,onSave:ne,onEnd:oe,onBack:re,onTransfer:X,onNotice:le,onCollect:Y,onOnReload:L,onBefore:a},null,8,["onRegister","flowData","processInstanceId","isHandle","mode","businessStatus"])]))}});const Os=be(ks,[["__scopeId","data-v-dd262d66"]]);export{Os as W};
//# sourceMappingURL=WfApproveBox-a3448232.js.map
