{"version":3,"file":"TicketTable-81dd11bc.js","sources":["../../src/views/po/workorder/TicketTable.vue"],"sourcesContent":["<template>\n  <BasicTable @register=\"registerTicketTable\">\n    <template #toolbar>\n      <a-dropdown v-if=\"!disabledProcessInput && currentActiveKey === '2'\">\n        <template #overlay>\n          <a-menu @click=\"handleMenuClickCreate\">\n            <a-menu-item v-for=\"(value, key) in ticketMap\" :key=\"key\">{{ value }}</a-menu-item>\n          </a-menu>\n        </template>\n        <a-button type=\"primary\">\n          {{ t('common.action.create') }}\n          <DownOutlined />\n        </a-button>\n      </a-dropdown>\n      <a-dropdown v-if=\"!disabledProcessInput && currentActiveKey === '2'\">\n        <template #overlay>\n          <a-menu @click=\"handleMenuClickAdd\">\n            <a-menu-item v-for=\"(value, key, index) in ticketMap\" :key=\"key\" :sort=\"index\">{{\n              value\n            }}</a-menu-item>\n          </a-menu>\n        </template>\n        <a-button type=\"primary\">\n          {{ '关联' }}\n          <DownOutlined />\n        </a-button>\n      </a-dropdown>\n    </template>\n    <template #bodyCell=\"{ column, record }\">\n      <template v-if=\"column.dataIndex === 'action'\">\n        <TableAction\n          :actions=\"[\n            {\n              tooltip: t('common.delText'),\n              color: 'error',\n              icon: 'ant-design:delete-outlined',\n              ifShow: !disabledProcessInput,\n              onClick: handleDeleteTicket.bind(null, record),\n            },\n          ]\"\n        />\n      </template>\n    </template>\n  </BasicTable>\n\n  <!-- 弹窗页面 -->\n  <Dialog\n    v-model:visible=\"ticketModal\"\n    :title=\"ticketTitle\"\n    @ok=\"handleOk\"\n    :height=\"520\"\n    force-render\n  >\n    <template v-if=\"ticketModal\">\n      <BasicTable\n        class=\"table-in-dialog\"\n        @register=\"registerModalTable\"\n        :searchInfo=\"searchInfo\"\n        :maxHeight=\"340\"\n      />\n    </template>\n  </Dialog>\n</template>\n<script lang=\"ts\" setup>\n  import { reactive, UnwrapRef, ref, onMounted, watch } from 'vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { SysMessage } from '@/hooks/web/useMessage';\n  import type { MenuProps } from 'ant-design-vue';\n  import { DownOutlined } from '@ant-design/icons-vue';\n  import Dialog from '@/components/Framework/Modal/Dialog.vue';\n  import { BasicTable, useTable, TableAction, EditRecordRow } from '/@/components/Table';\n  import {\n    ticketColumns,\n    getTicketModalColumns,\n    getTicketList,\n    getTicketPage,\n  } from './workorder.data';\n  import { addTabPage } from '@/utils/route';\n\n  const props = defineProps({\n    formState: {\n      type: Object as UnwrapRef<any>,\n      required: true,\n      default: function () {\n        return { fault: {} };\n      },\n    },\n    disabledProcessInput: Boolean,\n    activeKey: String,\n  });\n  const { t } = useI18n();\n  const ticketModal = ref<boolean>(false);\n  const ticketTitle = ref<string>();\n  const ticketDataSource = ref<any[]>();\n  const searchInfo = reactive<any>({});\n  const ticketMap = ref<any>({\n    operationticket: '操作票',\n    firstworkticket: '电气第一种工作票',\n    secondworkticket: '电气第二种工作票',\n  });\n  const workTicketSort = ref<any>(0);\n  const currentActiveKey = ref<string>(props.activeKey || '');\n\n  const [\n    registerTicketTable,\n    { getDataSource: getTicketDataSource, insertTableDataRecord, deleteTableDataRecord },\n  ] = useTable({\n    dataSource: ticketDataSource,\n    columns: ticketColumns,\n    pagination: false,\n    striped: false,\n    useSearchForm: false,\n    showTableSetting: false,\n    bordered: true,\n    showIndexColumn: true,\n    canResize: false,\n    target: '#more-tab-content',\n    targetTabKey: '2',\n    targetTabValue: currentActiveKey,\n    actionColumn: {\n      width: 80,\n      title: t('common.operate'),\n      dataIndex: 'action',\n      ifShow: !props.disabledProcessInput,\n    },\n  });\n\n  const initTableData = async () => {\n    const dataObj = await getTicketList({ orderId: props.formState.id });\n    ticketDataSource.value = dataObj.result;\n  };\n\n  const getTicketModalData = async () => {\n    const type = searchInfo.type;\n    if (props.formState.isInvoicing == 0 || !type) {\n      return [];\n    }\n    const paginationRef = getPaginationRef() as any;\n    const param = {\n      stationId: props.formState.stationId,\n      pageNo: paginationRef.current,\n      pageSize: paginationRef.pageSize,\n      sortField: 'fillinDate',\n      sortOrder: 'desc',\n    };\n    const dataObj = await getTicketPage(type, param);\n    return dataObj.result;\n  };\n\n  const [\n    registerModalTable,\n    { setColumns, getPaginationRef, getSelectRows, clearSelectedRowKeys, reload },\n  ] = useTable({\n    api: getTicketModalData,\n    pagination: true,\n    striped: false,\n    useSearchForm: false,\n    showTableSetting: false,\n    bordered: true,\n    showIndexColumn: true,\n    canResize: true,\n    rowSelection: {\n      type: 'checkbox',\n    },\n  });\n\n  const handleMenuClickCreate: MenuProps['onClick'] = (e) => {\n    const title = `${t('common.action.create')}${ticketMap.value[e.key]}`;\n    addTabPage(\n      `/po/ticket/${e.key}/create?stationId=${props.formState.stationId}&stationName=${props.formState.stationName}&stationOrganId=${props.formState.stationOrganId}&stationOrganName=${props.formState.stationOrganName}`,\n      title,\n    );\n  };\n\n  const handleMenuClickAdd: MenuProps['onClick'] = async (e) => {\n    ticketModal.value = true;\n    workTicketSort.value = e.item.sort + 1;\n    ticketTitle.value = `关联${ticketMap.value[e.key]}`;\n    const columns = await getTicketModalColumns(e.key);\n    setColumns(columns);\n    searchInfo.type = e.key;\n    reload();\n  };\n\n  function handleDeleteTicket(record) {\n    deleteTableDataRecord(record.key);\n  }\n\n  function handleOk() {\n    const rows = getSelectRows();\n    if (rows.length == 0) {\n      SysMessage.getInstance().warning('请选择关联数据');\n      return;\n    }\n    pushItemRows(rows);\n    clearSelectedRowKeys();\n    ticketModal.value = false;\n  }\n\n  function pushItemRows(rows: Array<any>) {\n    const addData: EditRecordRow[] = [];\n    const data = getTicketDataSource();\n    const sort = workTicketSort.value;\n    rows.forEach((item, index) => {\n      for (let i = 0; i < data.length; i++) {\n        if (data[i].workTicketId === item.id) {\n          return;\n        }\n      }\n      const addRow: EditRecordRow = {\n        workTicketId: item.id,\n        workTicketBillCode: item.billCode,\n        workTicketCode: item.ticketNumber,\n        checkResult: item.result,\n        checkResultText: item.resultText,\n        workTicketStatus: item.status,\n        workTicketStatusText: item.statusText,\n        workTicketSort: sort,\n        isNew: true,\n        key: `${index}_${Date.now()}`,\n      };\n      addData.push(addRow);\n    });\n    insertTableDataRecord(addData);\n  }\n\n  onMounted(async () => {\n    initTableData();\n  });\n\n  defineExpose({\n    getTicketDataSource,\n  });\n\n  watch(\n    () => props.activeKey,\n    (newValue) => {\n      currentActiveKey.value = newValue || '';\n    },\n  );\n</script>\n<style lang=\"less\" scoped>\n  .table-in-dialog {\n    :deep(.ant-table-wrapper) {\n      padding: 0;\n    }\n  }\n</style>\n"],"names":["t","useI18n","ticketModal","ref","ticketTitle","ticketDataSource","searchInfo","reactive","ticketMap","workTicketSort","currentActiveKey","props","registerTicketTable","getTicketDataSource","insertTableDataRecord","deleteTableDataRecord","useTable","ticketColumns","initTableData","__async","dataObj","getTicketList","getTicketModalData","type","paginationRef","getPaginationRef","param","getTicketPage","registerModalTable","setColumns","getSelectRows","clearSelectedRowKeys","reload","handleMenuClickCreate","title","addTabPage","handleMenuClickAdd","columns","getTicketModalColumns","handleDeleteTicket","record","handleOk","rows","SysMessage","pushItemRows","addData","data","sort","item","index","addRow","onMounted","__expose","watch","newValue"],"mappings":"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"}