var u=(a,c,g)=>new Promise((w,y)=>{var S=p=>{try{k(g.next(p))}catch(_){y(_)}},O=p=>{try{k(g.throw(p))}catch(_){y(_)}},k=p=>p.done?w(p.value):Promise.resolve(p.value).then(S,O);k((g=g.apply(a,c)).next())});import{r as B,d as We,k as n,e as je,o as Ve,al as b,Z as q,a9 as ne,aa as d,f as o,$ as $e,u as C,E,ac as ie,v as le,A as re,_ as He}from"./vue-71d1abb3.js";import{D as Me}from"./Dialog-0a006d82.js";import{B as qe}from"./BasicTable-0434a334.js";import{T as Xe}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as Ye}from"./useTable-109483b3.js";import{a2 as s}from"./antd-15ac76ed.js";import{a5 as x,b as Ze,au as Ge,a0 as Je,av as z,bY as L,_ as Qe}from"./index.js";import{P as et}from"./index-20519caf.js";import{C as tt}from"./CommonTree-c4ed7838.js";import"./index-74ac3212.js";import{x as oe}from"./index-66d20ba6.js";import{a as at}from"./assign-37f1c13d.js";import{j as nt}from"./Export2Excel-389a8fc9.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useContentViewHeight-7f845167.js";import"./index-3801a970.js";const it=a=>x.get({url:"/baseset/wiringdiagram/info/getTree",params:a},{}),lt=a=>x.get({url:"/baseset/wiringdiagram/info/get",params:a},{}),rt=a=>x.post({url:"/baseset/wiringdiagram/info/create",params:a},{}),ot=a=>x.put({url:"/baseset/wiringdiagram/info/update",params:a},{}),st=a=>a.id?ot(a):rt(a),dt=a=>x.delete({url:"/baseset/wiringdiagram/info/delete",params:a},{}),ut=a=>x.get({url:"/baseset/wiringdiagram/page",params:a},{}),ct=a=>x.post({url:"/baseset/wiringdiagram/create",params:a},{}),ft=a=>x.put({url:"/baseset/wiringdiagram/update",params:a},{}),mt=a=>a.id?ft(a):ct(a),pt=a=>x.delete({url:"/baseset/wiringdiagram/delete",params:a},{}),gt=a=>x.get({url:"/baseset/wiringdiagram/exportExcel",params:a},{});B({spinning:!1});B({id:"",createTime:""});const vt={class:"right-table-layout"},ht={key:0,class:"dialog-mask"},xt=We({__name:"wiringdiagram",setup(a){const c=n(),g=n(""),w=n({}),y=n(!1),S=n(!1),O=n(!0),k=n(),{t:p}=Ze(),{createConfirm:_}=Ge(),se=Je(),l=B({folderId:"test"}),X=n([]),A=n({typeId:"",fullName:"",id:"",name:"",nodeKindId:"",existChildNode:!1}),I=B({open:{type:n(!1),index:n(!1)},title:{type:n(""),index:n("")}}),K=n(!1),Y=n(!1),f=n([]),de=[{title:"esc",dataIndex:"esn",key:"esn",fixed:"left",minWidth:100},{title:"设备名称",dataIndex:"deviceName",key:"deviceName",fixed:"left",minWidth:100}],ue=[{title:"关联字段",dataIndex:"addressField",key:"addressField",fixed:"left",minWidth:100},{title:"字段描述",dataIndex:"addressDesc",key:"addressDesc",fixed:"left",minWidth:100}],Z={columns:de,pagination:!0,tfields:{key:"name"},vfield:"name"},G={columns:ue,pagination:!0,tfields:{key:"name"},vfield:"name"},J=[{title:"组件标记",dataIndex:"tag",width:80,editRow:!0,resizable:!0,sorter:!0,editRule:(e,t)=>u(this,null,function*(){if(!e)return"不能为空"}),editComponent:"Input"},{title:"组件绑定属性",dataIndex:"bindingProperties",width:100,editRow:!0,resizable:!0,sorter:!0,editComponent:"DictSelectBox",editComponentProps:{type:"bindingProperties"},editRule:(e,t)=>u(this,null,function*(){if(!e)return"不能为空"})},{title:"设备esn",dataIndex:"esn",width:100,editRow:!0,resizable:!0,sorter:!0,editComponent:"SearchBox",editComponentProps:{opkey:"SearchBox123",twidth:"600px",api:"/baseset/wiringdiagram/getDeviceEsnPage?name={name}&pageNo={current}&pageSize={pageSize}",apiParamFunc:()=>({folderId:w.value.folderId}),multiple:!1,callback:e=>{w.value.esn=e.record.esn,c.value.esn=e.record.esn,L("SearchBox12",G)}},editRule:(e,t)=>u(this,null,function*(){if(S.value&&!c.value.esn&&t.diagramDataType!="calculated")return"不能为空"})},{title:"关联字段",dataIndex:"associatedField",width:100,editRow:!0,resizable:!0,sorter:!0,editComponent:"SearchBox",editComponentProps:{opkey:"SearchBox12",twidth:"600px",api:"/baseset/wiringdiagram/getAddressFieldPage?name={name}&pageNo={current}&pageSize={pageSize}",apiParamFunc:()=>({esn:w.value.esn}),multiple:!1,callback:e=>{c.value.associatedField=e.record.addressField,c.value.descriptionField=e.record.addressDesc}},editRule:(e,t)=>u(this,null,function*(){if(S.value&&!c.value.associatedField&&t.diagramDataType!="calculated")return"不能为空"})},{title:"字段描述",resizable:!0,sorter:!0,dataIndex:"descriptionField",width:100},{title:"数据类型",dataIndex:"diagramDataType",width:100,editRow:!0,editComponent:"DictSelectBox",resizable:!0,sorter:!0,editComponentProps:{type:"diagramDataType"},editRule:(e,t)=>u(this,null,function*(){if(!e)return"不能为空"})}],i=B({id:"",name:"",fullId:"",code:"",fullName:"",parentId:"",checkItem:"",description:"",parentName:"",parentFullId:"",parentFullName:"",readOnly:!1}),Q=n(),U=n(),ce=n(),v=n([]),fe=()=>u(this,null,function*(){let e=yield ut(l);return v.value=e.result,v.value}),W={authorization:"Bearer "+se.getToken,folderId:"",infoType:"",version:"4.5.4"};function me(){if(k.value=[],A.value.nodeKindId!="wiringDiagramType"){s.error("请选择接线图节点导入"),O.value=!0;return}_({title:p("common.message.confirmTitle"),iconType:"warning",content:"导入后原数据会被覆盖，是否导入配置？",onOk(){return u(this,null,function*(){O.value=!1,y.value=!0,W.folderId=A.value.id})}})}const pe=e=>{e.file.status,e.file.status==="done"?(s.success(`${e.file.name} file uploaded successfully`),F(),y.value=!1):e.file.status==="error"&&s.error(`${e.file.name} file upload failed.`)};function ge(){y.value=!1}const ve={baseColProps:{lg:6,md:8},labelWidth:90,schemas:[{label:"主题",field:"subject",component:"Input"}]},[he,{reload:F,getPaginationRef:xe,getDataSource:ye}]=Ye({title:"接线图",api:()=>u(this,null,function*(){const e=xe();return l.pageNo=e.current,l.pageSize=e.pageSize,yield fe()}),columns:J,useSearchForm:!1,showIndexColumn:!1,formConfig:ve,showTableSetting:!0,resizeHeightOffset:33,pagination:!0,canResize:!0,bordered:!0,rowKey:"id",actionColumn:{width:80,title:"操作",dataIndex:"action"},rowSelection:{type:"checkbox",selectedRowKeys:f,onSelect:be,onSelectAll:we},sortFn:e=>{e.order?(l.sortField=e.field,l.sortOrder=e.order.replace("end","")):(l.sortField=null,l.sortOrder=null)}}),Ie=je(()=>f.value.length>0);function be(e,t){t?f.value=[...f.value,e.id]:f.value=f.value.filter(r=>r!==e.id)}function we(e,t,r){const N=r.map(T=>T.id);e?f.value=[...f.value,...N]:f.value=f.value.filter(T=>!N.includes(T))}function ee(){return u(this,null,function*(){const e=yield it({});X.value=e.result})}function _e(e){if(i.id="",i.parentId="orgRoot",i.fullId="",i.parentName="",i.parentFullName="",e){if(e.nodeKindId!="station"){s.error("请在电站节点添加。");return}i.parentId=e.id,i.parentName=e.name,i.fullId="/"+e.organId+"/"+e.powerStationId,i.parentFullName=e.organName+"-"+e.powerStationName}else{s.error("请选中电站节点添加。");return}const t=V(i);I.open.type=!0,I.title.type=t+"接线图"}function Te(e){const t=V({id:e.id});if(!e||e.nodeKindId!="wiringDiagramType"){s.error(`请选择接线图节点${t}`);return}Ce(e,t)&&(lt({id:e.id}).then(r=>{at(i,r.result)}),I.open.type=!0,I.title.type=t+"接线图")}function Ce(e,t){return e?v.value&&v.value.list&&v.value.list.length>0?(s.error("该接线图存在接线图设置，不能"+t),!1):!0:!1}function Se(e){if(!e||e.nodeKindId!="wiringDiagramType"){s.error("请选择接线图节点删除");return}if(e.children.length>0)return s.error("该接线图存在子节点，不能删除"),!1;if(v.value&&v.value.list&&v.value.list.length>0)return s.error("该接线图有接线图设置数据，不能删除"),!1;ke(function(){dt("?id="+e.id).then(()=>{j()})})}function ke(e){_({title:p("common.message.confirmTitle"),iconType:"warning",content:p("common.message.delMessage"),onOk(){return u(this,null,function*(){yield e(),s.success(p("common.delSuccessText"))})}})}function j(){ee()}function Ne(){let e=U.value;e&&e.validateFields().then(()=>{K.value=!0,i.fullName=De();let t=V(i);st(i).then(()=>{s.success(t+"成功"),ae(),j(),I.open.type=!1,K.value=!1}).catch(()=>{K.value=!1})})}function V(e){return e.id?"编辑":"添加"}function De(){let e=i.parentFullName;return e?e+"-"+oe.trim(i.name):oe.trim(i.name)}function te(){ae(),y.value=!1,I.open.type=!1}function ae(){var e,t;(e=U.value)==null||e.resetFields(),(t=ce.value)==null||t.resetFields()}function Re(e){if(l.stationId=null,l.stationName=null,l.stationOrganId=null,l.stationOrganName=null,l.nodeKindId=null,l.folderId="test",e){l.stationOrganId=e.organId,l.stationOrganName=e.organName,l.nodeKindId=e.nodeKindId;let t=e.organName;e.nodeKindId=="station"&&(l.stationId=e.powerStationId,l.stationName=e.name,t=t+"-"+e.name),e.nodeKindId=="wiringDiagramType"&&(t=t+"-"+e.name,W.folderId=e.id,l.folderId=e.id),A.value={typeId:e.id,fullName:t,id:e.id,name:e.name,nodeKindId:e.nodeKindId,existChildNode:e.children==null?!1:e.children.length>0}}if(c.value!=null)return s.error("请先完成编辑。"),!1;F()}function Fe(){const e=Q.value.getSelectedTreeNode();if(!e){s.error("请选择接线图");return}if(e.nodeKindId!="wiringDiagramType"){s.error("请选择接线图的节点");return}if(c.value!=null)return s.error("请先完成编辑。"),!1;const t=ye();t.splice(0,t.length);const r={folderId:e.id,editable:!0,isNew:!0,key:`${Date.now()}`};t.push(r),w.value.folderId=e.id,L("SearchBox123",Z),g.value=$(r),c.value=r}function Ee(){return f.value.length==0?(s.error("请选择数据"),!1):!0}function Be(e){return e.editable?[{label:"保存",onClick:Pe.bind(null,e)},{label:"取消",popConfirm:{title:"是否取消修改",confirm:ze.bind(null,e)}}]:[{label:"修改",icon:"clarity:bullet-list-line",disabled:Ke(e),onClick:Oe.bind(null,e)}]}function Oe(e){var t;w.value.folderId=e.folderId,w.value.esn=e.esn,L("SearchBox123",Z),L("SearchBox12",G),g.value=$(e),c.value=e,(t=e.onEdit)==null||t.call(e,!0)}const $=e=>Reflect.has(e,"id")?Reflect.get(e,"id"):"",Ke=e=>g.value?g.value!==$(e):!1;function Pe(e){return u(this,null,function*(){var r;S.value=!0,(yield(r=e.onValid)==null?void 0:r.call(e))&&mt(e).then(()=>{g.value="",c.value=null,s.success("已修改"),F(),S.value=!1})})}function ze(e){var t;g.value="",c.value=null,S.value=!1,(t=e.onEdit)==null||t.call(e,!1,!1),F()}function Le(){return u(this,null,function*(){_({title:"导出",iconType:"warning",content:"确定要导出所有记录？",onOk(){return u(this,null,function*(){const t=n({index:"序号"}),r=J,N=n([]),T=n([]);r.forEach(h=>{h.dataIndex!=="id"&&(t.value[h.dataIndex]=h.title,T.value.push(h.dataIndex))});let H=yield gt(l);v.value=H.result,v.value.forEach(function(h,P){let R=n({index:P+1});T.value.forEach(D=>{D==="diagramDataType"?R.value[D]=h.diagramDataTypeText:R.value[D]=h[D]}),N.value.push(R.value)}),nt({data:N.value,header:t.value,filename:"接线图设置.xlsx"})})}})})}function Ae(){Ee()&&_({title:"提示",iconType:"warning",content:"确定要删除选中记录？",onOk(){return u(this,null,function*(){pt("?ids="+f.value).then(()=>{s.success("已删除"),f.value=[],F()})})}})}return Ve(()=>{ee()}),(e,t)=>{const r=b("a-button"),N=b("upload-outlined"),T=b("a-upload"),H=b("a-modal"),h=b("a-input"),P=b("a-form-item"),R=b("a-col"),D=b("a-row"),Ue=b("a-form");return q(),ne(C(et),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:d(()=>[o(tt,{ref_key:"treeRef",ref:Q,title:"电站组织",onSelect:Re,value:X.value,class:"left-tree-layout",isShowOperationBtns:!0,fieldNames:{key:"id",title:"name"},onAdd:_e,onEdit:Te,onDelete:Se,onRefresh:j},null,8,["value"]),$e("div",vt,[o(C(qe),{class:"fix-basic-table",onRegister:C(he),searchInfo:l,onResizeColumn:t[0]||(t[0]=(m,M)=>M.width=m)},{toolbar:d(()=>[o(r,{class:"yellow-btn",preIcon:C(z).IMPORT,onClick:me},{default:d(()=>[E("导入配置")]),_:1},8,["preIcon"]),o(r,{type:"primary",preIcon:C(z).ADD,onClick:Fe},{default:d(()=>[E("添加")]),_:1},8,["preIcon"]),o(r,{class:"red-btn",disabled:!Ie.value,preIcon:C(z).DELETE,onClick:Ae},{default:d(()=>[E("删除")]),_:1},8,["disabled","preIcon"]),o(r,{class:"yellow-btn",preIcon:C(z).EXPORT,onClick:Le},{default:d(()=>[E("导出")]),_:1},8,["preIcon"])]),bodyCell:d(({column:m,record:M})=>[m.key==="action"?(q(),ne(C(Xe),{key:0,actions:Be(M)},null,8,["actions"])):ie("",!0)]),_:1},8,["onRegister","searchInfo"])]),o(H,{visible:y.value,"onUpdate:visible":t[2]||(t[2]=m=>y.value=m),title:"导入配置",width:"600px",onOk:ge,onCancel:te},{default:d(()=>[o(T,{"file-list":k.value,"onUpdate:fileList":t[1]||(t[1]=m=>k.value=m),name:"file",headers:W,onChange:pe,accept:".json",action:"/admin-api/baseset/wiringdiagram/import"},{default:d(()=>[o(r,null,{default:d(()=>[o(N),E(" 选择文件 ")]),_:1})]),_:1},8,["file-list"])]),_:1},8,["visible"]),o(Me,{visible:I.open.type,"onUpdate:visible":t[5]||(t[5]=m=>I.open.type=m),title:I.title.type,onOk:Ne,onCancel:te,height:250,width:600,smode:"normal"},{default:d(()=>[o(Ue,{ref_key:"modalFormRef",ref:U,model:i,name:"userForm"},{default:d(()=>[o(D,{gutter:24},{default:d(()=>[le(o(R,{span:20},{default:d(()=>[o(P,{label:"接线图编码",name:"code",labelCol:{style:{width:"124px"}},rules:[{required:!0,max:30}]},{default:d(()=>[o(h,{value:i.code,"onUpdate:value":t[3]||(t[3]=m=>i.code=m),maxlength:30,disabled:Y.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[re,!0]])]),_:1}),o(D,{gutter:24},{default:d(()=>[le(o(R,{span:20},{default:d(()=>[o(P,{label:"接线图名称",name:"name",labelCol:{style:{width:"124px"}},rules:[{required:!0,max:30}]},{default:d(()=>[o(h,{value:i.name,"onUpdate:value":t[4]||(t[4]=m=>i.name=m),maxlength:30,disabled:Y.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[re,!0]])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title"]),K.value?(q(),He("div",ht)):ie("",!0)]),_:1})}}});const Zt=Qe(xt,[["__scopeId","data-v-11328d66"]]);export{Zt as default};
//# sourceMappingURL=wiringdiagram-9b96cb4f.js.map
