{"version":3,"file":"index-e9715492.js","sources":["../../src/views/po/integrated/training/index.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <CommonTree\n      title=\"电站组织\"\n      @select=\"handleSelect\"\n      :value=\"treeData\"\n      class=\"left-tree-layout\"\n      :toolbar=\"true\"\n      :canEdit=\"false\"\n      :canAdd=\"false\"\n      :canDelete=\"false\"\n      :isShowOperationBtns=\"false\"\n      :fieldNames=\"{ key: 'id', title: 'name' }\"\n    />\n\n    <div class=\"right-table-layout\">\n      <BasicTable\n        @register=\"registerTable\"\n        class=\"fix-basic-table\"\n        :searchInfo=\"searchInfo\"\n        @resize-column=\"(w, col) => (col.width = w)\"\n        @row-db-click=\"(record) => handleReadOnlyView(record)\"\n        @selection-change=\"handleSelectChange\"\n      >\n        <template #toolbar>\n          <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleCreate\">\n            {{ t('common.action.create') }}\n          </a-button>\n          <a-button\n            class=\"red-btn\"\n            :disabled=\"selectedRowId == ''\"\n            :preIcon=\"IconEnum.DELETE\"\n            @click=\"handleDelete\"\n            >{{ t('common.delText') }}</a-button\n          >\n          <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExport\">\n            {{ t('common.action.export') }}\n          </a-button>\n        </template>\n      </BasicTable>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { ref, onMounted, reactive } from 'vue';\n  import { TreeItem } from '/@/components/Tree';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import { PageWrapper } from '/@/components/Page';\n  import { BasicTable, useTable, SorterResult } from '@/components/Table';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { message } from 'ant-design-vue';\n  import { assign } from 'lodash-es';\n  import { exportExcelFile } from '@/utils/file/download';\n  import {\n    columns,\n    searchFormSchema,\n    getStationTreeList,\n    getTrainingList,\n    exprotTrainingList,\n    getTraining,\n  } from './data';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import * as CommonUtil from '/@/utils/common';\n\n  const { t } = useI18n();\n  const searchInfo = reactive<any>({});\n  const treeData = ref<TreeItem[]>([]);\n  const selectedNode = reactive<any>({});\n\n  const { createConfirm, createMessage } = useMessage();\n  let selectedRowId = ref('');\n  //代码启动执行\n  onMounted(() => {\n    getStationTreeData();\n    MsgManager.getInstance().listen('training-record', reload);\n  });\n\n  //查询电站组织树\n  async function getStationTreeData() {\n    treeData.value = (await getStationTreeList({})) as unknown as TreeItem[];\n    reload();\n  }\n\n  //电站组织树选中事件\n  function handleSelect(node) {\n    searchInfo.stationOrganId = null;\n    searchInfo.stationId = null;\n    if (node) {\n      searchInfo.stationOrganId = node.organId;\n      searchInfo.stationId = node.powerStationId;\n      selectedNode.stationOrganId = node.organId;\n      selectedNode.stationOrganName = node.organName;\n      selectedNode.stationId = node.powerStationId;\n      selectedNode.stationName = node.powerStationName;\n      selectedNode.nodeKindId = node.nodeKindId;\n    }\n    reload();\n  }\n\n  const getTrainingListParam = async () => {\n    const paginationRef = getPaginationRef() as any;\n    const searchPageInfo = reactive<any>({});\n    assign(searchPageInfo, searchInfo);\n    searchPageInfo.pageNo = paginationRef.current;\n    searchPageInfo.pageSize = paginationRef.pageSize;\n    if (!searchPageInfo.order) {\n      searchPageInfo.field = 'fillinDate';\n      searchPageInfo.order = 'desc';\n    }\n    let dataObj = await getTrainingList(searchPageInfo);\n    return dataObj;\n  };\n\n  const [registerTable, { reload, getSelectRows, getPaginationRef }] = useTable({\n    title: '培训记录列表',\n    api: getTrainingListParam,\n    columns: columns,\n    formConfig: searchFormSchema,\n    useSearchForm: true,\n    showTableSetting: true,\n    bordered: true,\n    pagination: { pageSize: 20 },\n    showIndexColumn: true,\n    tableSetting: { fullScreen: true },\n    handleSearchInfoFn(info) {\n      assign(searchInfo, info);\n      return info;\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        searchInfo.sortField = sortInfo.field;\n        searchInfo.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n        searchInfo.sortField = '';\n        searchInfo.sortOrder = '';\n      }\n    },\n    rowSelection: { type: 'radio', fixed: true, onSelect: onSelect },\n    fetchSetting: {\n      listField: 'list',\n      pageField: 'pageNo',\n      sizeField: 'pageSize',\n      totalField: 'total',\n    },\n  });\n\n  function handleSelectChange({ keys, rows }) {\n    if (rows && rows.length > 0) {\n      const record = rows[0];\n      selectedRowId.value = record.id;\n    } else {\n      selectedRowId.value = '';\n    }\n  }\n\n  function onSelect(record, selected) {\n    if (selected) {\n      selectedRowId.value = record.id;\n    } else {\n      selectedRowId.value = '';\n    }\n  }\n\n  //新增\n  function handleCreate() {\n    if (!selectedNode.stationId) {\n      message.error('请先选择电站。');\n      return;\n    }\n\n    addTabPage(`/po/integrated/training/create`, '添加培训记录', {\n      stationOrganId: selectedNode.stationOrganId,\n      stationOrganName: selectedNode.stationOrganName,\n      stationId: selectedNode.stationId,\n      stationName: selectedNode.stationName,\n      id: '',\n    });\n  }\n\n  function handleReadOnlyView(record: any) {\n    CommonUtil.toFlowPage(record.id);\n  }\n\n  //获取表格选择数据\n  function checkSelectData() {\n    const selectRows = getSelectRows();\n    if (selectRows.length == 0) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return selectRows[0] as any;\n  }\n  //删除\n  async function handleDelete() {\n    const row = checkSelectData();\n    if (!row.id) {\n      return;\n    }\n    const res = await getTraining({ id: row.id });\n\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要删除选中记录？',\n      async onOk() {\n        if (res.result.status != 0) {\n          message.error('非草稿状态不能删除。');\n          return;\n        }\n        // 发起取消\n        await ProcessInstanceApi.deleteProcessInstance(res.result.processInstanceId);\n        message.success('已删除。');\n        reload();\n      },\n    });\n  }\n\n  //导出\n  function handleExport() {\n    createConfirm({\n      title: t('common.exportTitle'),\n      iconType: 'warning',\n      content: t('common.message.exportMessage'),\n      async onOk() {\n        await exprotTrainingList(searchInfo).then((res) => {\n          exportExcelFile(res?.data, '培训信息.xls');\n        });\n        createMessage.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n</script>\n<style lang=\"less\" scoped>\n  .left-tree-layout {\n    flex-shrink: 0;\n    width: 298px;\n    border-radius: 2px;\n  }\n\n  .right-table-layout {\n    width: calc(100% - 308px);\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings) {\n      margin-right: 0;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n</style>\n"],"names":["t","useI18n","searchInfo","reactive","treeData","ref","selectedNode","createConfirm","createMessage","useMessage","selectedRowId","onMounted","getStationTreeData","MsgManager","reload","__async","getStationTreeList","handleSelect","node","getTrainingListParam","paginationRef","getPaginationRef","searchPageInfo","assign","getTrainingList","registerTable","getSelectRows","useTable","columns","searchFormSchema","info","sortInfo","onSelect","handleSelectChange","keys","rows","record","selected","handleCreate","message","addTabPage","handleReadOnlyView","CommonUtil.toFlowPage","checkSelectData","selectRows","handleDelete","row","res","getTraining","ProcessInstanceApi.deleteProcessInstance","handleExport","exprotTrainingList","exportExcelFile"],"mappings":"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"}