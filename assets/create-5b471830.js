var r=(j,M,g)=>new Promise((T,k)=>{var f=i=>{try{h(g.next(i))}catch(n){k(n)}},I=i=>{try{h(g.throw(i))}catch(n){k(n)}},h=i=>i.done?T(i.value):Promise.resolve(i.value).then(f,I);h((g=g.apply(j,M)).next())});import{d as he,ax as be,u as _,k as v,r as E,e as ye,o as xe,al as m,Z as C,a9 as H,aa as o,$ as w,f as s,v as U,A as X,_ as N,F as Q,ae as Ce,E as b,ad as $,ac as Z}from"./vue-71d1abb3.js";import{B as we}from"./BillTitle-d17ab3e4.js";import{b as De,au as ke,ak as Se,aB as Ee,a7 as G,av as D,ax as K,aC as Me,at as Te,_ as Be}from"./index.js";import{W as Pe}from"./WfApproveBox-a3448232.js";import"./index-74ac3212.js";import{P as Re}from"./index-20519caf.js";import{a as J,g as Le,b as Ne,d as $e,f as Ke,h as je,i as Fe}from"./monthly-62dfedc7.js";import{a as ee}from"./assign-37f1c13d.js";import{j as Ae}from"./Export2Excel-389a8fc9.js";import{a2 as y}from"./antd-15ac76ed.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./BasicTable-0434a334.js";import"./useForm-dea3ed18.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-f4fc48e6.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./Dialog-0a006d82.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./OrganDialog-dd1023ce.js";import"./uniqBy-92d3bc7f.js";import"./index-085d06c7.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useTable-109483b3.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useContentViewHeight-7f845167.js";import"./useRender-21ce56fb.js";const ze={class:"load"},Oe={class:"process-box"},Ve={class:"header-box"},We={class:"content"},Ye={class:"left-panel"},qe=["onClick"],He=he({__name:"create",setup(j){const{t:M}=De(),{createConfirm:g}=ke(),T=be(),{currentRoute:k}=T;_(k);const f=Se.getInstance().getQuery(),I=v(!1),h=v(""),i=v([]),n=v([]),F=v([]),B=v([]),t=E({status:0}),A=v(),d=E({}),S=E({}),te=v(!1);S.subject="月度评价",S.infoItems=[];const z=()=>r(this,null,function*(){Fe({templateId:d.id,monthlyEvaluationId:t.id}).then(e=>{e!=null&&(t.status==1&&(F.value=e.buttons),B.value=e.columns,ae())})}),ae=()=>r(this,null,function*(){let e=[{title:"序号",dataIndex:"dataIndex",align:"center"},{title:"电站名称",dataIndex:"stationName",align:"left",width:300}];return B.value.length>0&&B.value.forEach(a=>{let l={title:a.name,dataIndex:a.kind,align:"center",width:120};e.push(l)}),i.value=e,e}),se=()=>r(this,null,function*(){(yield Le({evaluationPeriod:t.evaluationPeriod,status:2,businessStatus:1})).total>0&&y.info("该周期已存在有效的月度评价，请先禁用。"),yield Ne({evaluationMonth:t.evaluationPeriod}).then(a=>{d.processInstanceId=a.processInstanceId,d.id=a.id}),z()});function oe(e){let a=`/po/integrated/assessmentevaluation/monthly/scoring?monthlyEvaluationId=${t.id}&indexKind=${e.kind}&kindName=${e.name}&processInstanceId=${h.value}`;K(a,e.name)}function ne(){d.id!=null?K(`/po/integrated/assessmentevaluation/template/templateCreate?id=${d.id}`,"查看评价模板"):y.error("请先选择评价周期")}function le(e){t.status>0?K(`/po/integrated/assessmentevaluation/monthly/stationDtl?id=${t.id}&stationId=${e.stationId}`,"查看电站得分详情"):y.info("未评分，不能查看。")}const ie=()=>r(this,null,function*(){if(d.id!=null){let e=yield $e(),a=n.value.map(l=>l.stationId);e.forEach(l=>{if(!a.includes(l.id)){let u={stationId:l.id,stationName:l.name};n.value.push(u)}})}else y.error("请先选择评价周期")});function re(){n.value=n.value.filter(e=>P.selectedRowKeys.indexOf(e.stationId)==-1)}function ce(){var e;if(((e=n.value)==null?void 0:e.length)>0){let a;g({title:"提示",iconType:"warning",content:M("common.message.exportMessage"),onOk(){return r(this,null,function*(){let l=[],u={};n.value.forEach(c=>{delete c.stationId,l.push(c)}),i.value.forEach(c=>{u[c.dataIndex]=c.title}),Ae({data:l,header:u,filename:"月度评价分.xlsx"})})}})}}const P=E({selectedRowKeys:[],loading:!1}),de=ye(()=>P.selectedRowKeys.length>0),ue=e=>{console.log("selectedRowKeys changed: ",e),P.selectedRowKeys=e},O=()=>r(this,null,function*(){let e={monthlyEvaluationId:t.id,templateId:d.id},a=yield Ke(e);n.value=a}),pe=()=>{var e;((e=n.value)==null?void 0:e.length)>0?V(0):y.error("必须选择电站。")},me=()=>{var e;((e=n.value)==null?void 0:e.length)>0?V(1):y.error("必须选择电站。")},V=e=>r(this,null,function*(){A.value.validateFields().then(()=>{t.detailList=n.value,t.evaluationTemplateId=d.id,t.status=e,je(t).then(a=>{e>=1?setTimeout(function(){G.getInstance().sendMsg("monthly-evaluation",{}),Me()},200):(Te.getInstance().success("保存成功"),t.id=a.result,R())}).catch(()=>{})})}),W=e=>r(this,null,function*(){let{billCode:a,fillinDate:l,personMemberName:u,deptName:c}=e;Object.assign(S,{billCode:a,fillinDate:l,personMemberName:u,deptName:c})}),R=()=>r(this,null,function*(){let e=yield J(t.id);ee(t,e),t.processInstanceId||(t.processInstanceId=f.processInstanceId),I.value=e.status>0,W(e),d.id=e.evaluationTemplateId,yield z(),O()});return xe(()=>r(this,null,function*(){if(ee(t,f),f.id)yield R();else if(f.processInstanceId)h.value=f.processInstanceId,t.processInstanceId=f.processInstanceId,Ee(t.processInstanceId).then(e=>{t.id=e.businessKey,R()});else{let e=yield J("");W(e),t.billCode=e.billCode,t.fillinDate=e.fillinDate}G.getInstance().listen("scoring-evaluation",O)})),(e,a)=>{const l=m("a-input"),u=m("a-form-item"),c=m("a-col"),fe=m("a-date-picker"),ve=m("a-row"),Y=m("a-card"),Ie=m("a-form"),x=m("a-button"),_e=m("a-table");return C(),H(_(Re),{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:o(()=>[w("div",ze,[w("div",Oe,[w("div",Ve,[s(we,{options:S},null,8,["options"]),s(Pe,{onSave:pe,onSubmit:me,processStatus:t.status,processInstanceId:t.processInstanceId},null,8,["processStatus","processInstanceId"])]),w("div",We,[w("div",Ye,[s(Ie,{ref_key:"monthlyFormRef",ref:A,model:t,name:"Form"},{default:o(()=>[s(Y,{title:"基础信息",bordered:!1},{default:o(()=>[s(ve,{gutter:32},{default:o(()=>[U(s(c,{span:12},{default:o(()=>[s(u,{label:"主题",name:"subject",labelAlign:"right",labelCol:{span:4},rules:[{required:!0,message:"请输入主题"}]},{default:o(()=>[s(l,{value:t.subject,"onUpdate:value":a[0]||(a[0]=p=>t.subject=p),disabled:I.value,style:{width:"100%"},maxlength:"128"},null,8,["value","disabled"])]),_:1})]),_:1},512),[[X,!0]]),U(s(c,{span:12},{default:o(()=>[s(u,{label:"评价周期",name:"evaluationPeriod",labelAlign:"right",labelCol:{span:4},rules:[{required:!0,message:"请选择月份"}]},{default:o(()=>[s(fe,{value:t.evaluationPeriod,"onUpdate:value":a[1]||(a[1]=p=>t.evaluationPeriod=p),"value-format":"YYYY-MM",disabled:I.value,onChange:se,style:{"min-width":"100%"},picker:"month"},null,8,["value","disabled"])]),_:1})]),_:1},512),[[X,!0]])]),_:1})]),_:1})]),_:1},8,["model"]),s(Y,{title:"评价情况",bordered:!1},{extra:o(()=>[(C(!0),N(Q,null,Ce(F.value,(p,L)=>(C(),H(x,{key:L,class:"tab-button",type:"ghost",preIcon:_(D).SEARCH,onClick:q=>oe(p)},{default:o(()=>[b($(p.name),1)]),_:2},1032,["preIcon","onClick"]))),128)),s(x,{class:"tab-button",type:"primary",disabled:I.value,preIcon:_(D).ADD,onClick:ie},{default:o(()=>[b("获取电站")]),_:1},8,["disabled","preIcon"]),s(x,{class:"tab-button red-btn",preIcon:_(D).DELETE,disabled:!de.value||I.value,onClick:re},{default:o(()=>[b("删除电站 ")]),_:1},8,["preIcon","disabled"]),s(x,{class:"tab-button",type:"primary",disabled:te.value,preIcon:_(D).VIEW,onClick:ne},{default:o(()=>[b("查看评价模板")]),_:1},8,["disabled","preIcon"]),s(x,{style:{"margin-right":"16px"},class:"tab-button yellow-btn",preIcon:_(D).EXPORT,onClick:ce},{default:o(()=>[b("导出")]),_:1},8,["preIcon"])]),default:o(()=>[s(_e,{columns:i.value,"data-source":n.value,pagination:!1,size:"small",bordered:"",rowKey:"stationId",class:"table-content","row-selection":{selectedRowKeys:e.selectedRowKeys,onChange:ue},scroll:{x:500,y:"calc(100vh - 323px)"}},{bodyCell:o(({column:p,text:L,record:q,index:ge})=>[["stationName"].includes(p.dataIndex)?(C(),N("a",{key:0,onClick:Ue=>le(q)},$(L),9,qe)):Z("",!0),p.dataIndex==="dataIndex"?(C(),N(Q,{key:1},[b($(ge+1),1)],64)):Z("",!0)]),_:1},8,["columns","data-source","row-selection","scroll"])]),_:1})])])])])]),_:1})}}});const Pt=Be(He,[["__scopeId","data-v-f07e4fe5"]]);export{Pt as default};
//# sourceMappingURL=create-5b471830.js.map
