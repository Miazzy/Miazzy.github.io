{"version":3,"file":"index-99d0a730.js","sources":["../../src/views/po/integrated/personcertificate/index.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <CommonTree\n      title=\"电站组织\"\n      @select=\"handleSelect\"\n      :value=\"treeData\"\n      class=\"left-tree-layout\"\n      :toolbar=\"true\"\n      :canEdit=\"false\"\n      :canAdd=\"false\"\n      :canDelete=\"false\"\n      :isShowOperationBtns=\"false\"\n      :fieldNames=\"{ key: 'id', title: 'name' }\"\n    />\n    <!--数据表格-->\n    <div class=\"right-table-layout\">\n      <BasicTable\n        @register=\"registerTable\"\n        class=\"fix-basic-table\"\n        :searchInfo=\"searchInfo\"\n        @resize-column=\"(w, col) => (col.width = w)\"\n        @row-db-click=\"(record) => handleView(record)\"\n        @selection-change=\"handleSelectChange\"\n      >\n        <template #toolbar>\n          <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleCreate()\">\n            {{ t('common.action.create') }}\n          </a-button>\n          <a-button\n            type=\"primary\"\n            :disabled=\"selectedRowId == ''\"\n            :preIcon=\"IconEnum.EDIT\"\n            @click=\"handleEdit\"\n            >{{ t('common.action.edit') }}</a-button\n          >\n          <a-button\n            class=\"red-btn\"\n            :disabled=\"selectedRowId == ''\"\n            :preIcon=\"IconEnum.DELETE\"\n            @click=\"handleDelete\"\n            >{{ t('common.delText') }}</a-button\n          >\n          <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExport\">\n            {{ t('common.action.export') }}\n          </a-button>\n        </template>\n      </BasicTable>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, ref, reactive } from 'vue';\n  import { BasicTable, useTable, SorterResult } from '/@/components/Table';\n  import { PageWrapper } from '/@/components/Page';\n  import { TreeItem } from '/@/components/Tree';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import {\n    columns,\n    searchFormSchema,\n    getPersoncertificateList,\n    getStationTreeList,\n    deletePersoncertificate,\n    exprotPersoncertificate,\n  } from './data';\n  import { message } from 'ant-design-vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { IconEnum } from '@/enums/appEnum';\n  import { assign } from 'lodash-es';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { exportExcelFile } from '@/utils/file/download';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n\n  const { t } = useI18n();\n  const searchInfo = reactive<any>({});\n  const treeData = ref<TreeItem[]>([]);\n  const selectedNode = reactive<any>({});\n  const { createConfirm, createMessage } = useMessage();\n\n  let selectedRowId = ref('');\n\n  //代码启动执行\n  onMounted(() => {\n    getStationTreeData();\n\n    MsgManager.getInstance().listen('person-certificate', reload);\n  });\n\n  //查询电站组织树\n  async function getStationTreeData() {\n    treeData.value = (await getStationTreeList({})) as unknown as TreeItem[];\n    reload();\n  }\n\n  //电站组织树选中事件\n  function handleSelect(node) {\n    searchInfo.stationOrganId = null;\n    searchInfo.stationId = null;\n    searchInfo.periodId = null;\n    if (node) {\n      searchInfo.stationOrganId = node.organId;\n      searchInfo.stationId = node.powerStationId;\n      searchInfo.periodId = node.powerStationPeriodId;\n      selectedNode.stationOrganId = node.organId;\n      selectedNode.stationOrganName = node.organName;\n      selectedNode.stationId = node.powerStationId;\n      selectedNode.stationName = node.powerStationName;\n      selectedNode.periodId = node.powerStationPeriodId;\n      selectedNode.periodName = node.powerStationPeriodName;\n      selectedNode.nodeKindId = node.nodeKindId;\n    }\n    reload();\n  }\n\n  const getPersoncertificateParam = async () => {\n    const paginationRef = getPaginationRef() as any;\n    const searchPageInfo = reactive<any>({});\n    assign(searchPageInfo, searchInfo);\n    searchPageInfo.pageNo = paginationRef.current;\n    searchPageInfo.pageSize = paginationRef.pageSize;\n\n    let dataObj = await getPersoncertificateList(searchPageInfo);\n    return dataObj;\n  };\n\n  const [\n    registerTable,\n    { getForm, reload, getSelectRows, clearSelectedRowKeys, getPaginationRef },\n  ] = useTable({\n    title: '持证列表',\n    api: getPersoncertificateParam,\n    columns: columns,\n    formConfig: searchFormSchema,\n    useSearchForm: true,\n    fetchSetting: {\n      listField: 'list',\n      pageField: 'pageNo',\n      sizeField: 'pageSize',\n      totalField: 'total',\n    },\n    handleSearchInfoFn(info) {\n      assign(searchInfo, info);\n      return info;\n    },\n    clickToRowSelect: true,\n    bordered: true,\n    pagination: { pageSize: 20 },\n    showIndexColumn: true,\n    showTableSetting: true,\n    tableSetting: { fullScreen: true },\n    rowSelection: { type: 'radio', fixed: true, onSelect: onSelect },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        searchInfo.sortField = sortInfo.field;\n        searchInfo.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n        searchInfo.sortField = '';\n        searchInfo.sortOrder = '';\n      }\n    },\n  });\n\n  function handleSelectChange({ keys, rows }) {\n    if (rows && rows.length > 0) {\n      const record = rows[0];\n      selectedRowId.value = record.id;\n    } else {\n      selectedRowId.value = '';\n    }\n  }\n\n  function onSelect(record, selected) {\n    if (selected) {\n      selectedRowId.value = record.id;\n    } else {\n      selectedRowId.value = '';\n    }\n  }\n\n  //新增\n  function handleCreate() {\n    if (!selectedNode.stationId) {\n      message.error('请先选择电站。');\n      return;\n    }\n    addTabPage(`/po/integrated/personcertificate/create`, '添加人员持证', {\n      stationOrganId: selectedNode.stationOrganId,\n      stationOrganName: selectedNode.stationOrganName,\n      stationId: selectedNode.stationId,\n      stationName: selectedNode.stationName,\n    });\n  }\n\n  //修改\n  function handleEdit() {\n    const row = checkSelectData();\n    if (!row.id) {\n      return;\n    }\n    addTabPage(`/po/integrated/personcertificate/create?id=${row.id}`, '修改人员持证');\n  }\n\n  //查看\n  function handleView(record: any) {\n    if (!record.id) {\n      return;\n    }\n    addTabPage(`/po/integrated/personcertificate/create`, '查看人员持证', {\n      id: record.id,\n      type: 'view',\n      page_readonly: 'true',\n    });\n  }\n\n  //获取表格选择数据\n  function checkSelectData() {\n    const selectRows = getSelectRows();\n    if (selectRows.length == 0) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return selectRows[0] as any;\n  }\n\n  //删除\n  async function handleDelete() {\n    const row = checkSelectData();\n    if (!row.id) {\n      return;\n    }\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要删除选中记录？',\n      async onOk() {\n        deletePersoncertificate(row.id).then(() => {\n          message.success('已删除');\n          clearSelectedRowKeys();\n          reload();\n        });\n      },\n    });\n  }\n\n  //导出\n  function handleExport() {\n    createConfirm({\n      title: t('common.exportTitle'),\n      iconType: 'warning',\n      content: t('common.message.exportMessage'),\n      async onOk() {\n        await exprotPersoncertificate(getForm().getFieldsValue()).then((res) => {\n          exportExcelFile(res?.data, '人员持证.xls');\n        });\n        createMessage.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n</script>\n<style lang=\"less\" scoped>\n  .left-tree-layout {\n    flex-shrink: 0;\n    width: 298px;\n    border-radius: 2px;\n  }\n\n  .right-table-layout {\n    width: calc(100% - 308px);\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings) {\n      margin-right: 0;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n</style>\n"],"names":["t","useI18n","searchInfo","reactive","treeData","ref","selectedNode","createConfirm","createMessage","useMessage","selectedRowId","onMounted","getStationTreeData","MsgManager","reload","__async","getStationTreeList","handleSelect","node","getPersoncertificateParam","paginationRef","getPaginationRef","searchPageInfo","assign","getPersoncertificateList","registerTable","getForm","getSelectRows","clearSelectedRowKeys","useTable","columns","searchFormSchema","info","onSelect","sortInfo","handleSelectChange","keys","rows","record","selected","handleCreate","message","addTabPage","handleEdit","row","checkSelectData","handleView","selectRows","handleDelete","deletePersoncertificate","handleExport","exprotPersoncertificate","res","exportExcelFile"],"mappings":"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"}