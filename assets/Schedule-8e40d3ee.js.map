{"version":3,"file":"Schedule-8e40d3ee.js","sources":["../../src/views/workbench/Schedule.vue"],"sourcesContent":["<template>\n  <a-card title=\"日程安排\" :bordered=\"false\" :key=\"cardKey\">\n    <template #extra>\n      <a-dropdown v-model:visible=\"dropdownVisible\" :trigger=\"['click']\">\n        <template #overlay>\n          <a-menu @click=\"handleClickMenu\">\n            <a-menu-item key=\"meeting\">会议提醒</a-menu-item>\n            <a-menu-item key=\"schedule\">日程提醒</a-menu-item>\n          </a-menu>\n        </template>\n        <!-- <a-button type=\"primary\"> 导入 </a-button> -->\n        <span @click.prevent>新增 &gt;</span>\n      </a-dropdown>\n      <Schedule ref=\"schedule\" />\n    </template>\n    <div class=\"card-content\" style=\"height: 360px; overflow-y: auto\">\n      <a-calendar\n        v-model:value=\"value\"\n        @panel-change=\"onPanelChange\"\n        @select=\"select\"\n        :fullscreen=\"false\"\n      >\n        <template #dateCellRender=\"{ current }\">\n          <a-popover title=\"日程会议\" trigger=\"click\">\n            <template #content>\n              <p style=\"white-space: pre-wrap\">{{ Content }}</p>\n            </template>\n            <ul class=\"events\">\n              <li v-for=\"item in getListData(current)\" :key=\"item.content\">\n                <a-badge :status=\"item.type\" :text=\"item.content\" />\n              </li>\n            </ul>\n          </a-popover>\n        </template>\n      </a-calendar>\n    </div>\n  </a-card>\n</template>\n\n<script lang=\"ts\" setup>\n  import { ref, onMounted, nextTick } from 'vue';\n  import { Dayjs } from 'dayjs';\n  import Schedule from '../oa/schedule/Schedule.vue';\n  import { defHttp } from '/@/utils/http/axios';\n  import { MsgManager } from '/@/message/MsgManager';\n  import { forEach } from '/@/utils/helper/treeHelper';\n  import moment from 'moment';\n\n  let cardKey = 0;\n  const schedule = ref();\n  const dropdownVisible = ref(false);\n  function handleClickMenu({ key }) {\n    dropdownVisible.value = false;\n    setTimeout(() => {\n      schedule.value.handleClickMenu(key);\n    }, 300);\n  }\n  const value = ref<Dayjs>();\n  const needReadData = ref<boolean>(true);\n\n  const getAlldaySchedule = (params) =>\n    defHttp.get(\n      {\n        url: '/oa/calendar-schedule/getAlldaySchedule',\n        params,\n      },\n      {},\n    );\n  const visible = ref<boolean>(false);\n  const list = ref([]);\n  const Content = ref<string>();\n  let startTime = new Date();\n  let endTime = new Date();\n  const getListData = (value: Dayjs) => {\n    let dt = value.toDate();\n    if (dt < startTime) {\n      startTime = dt;\n    }\n    if (dt > endTime) {\n      endTime = dt;\n    }\n    let year = dt.getFullYear();\n    let month = (dt.getMonth() + 1).toString().padStart(2, '0');\n    let date = dt.getDate().toString().padStart(2, '0');\n    let dtstr = `${year}-${month}-${date}`;\n    let listData = list.value[dtstr];\n    const resultData = [];\n    const scheduleData = [];\n    let scheduleItem = {};\n    if (listData != null) {\n      forEach(listData, (item) => {\n        if (item.dataType == 'schedule') {\n          let week = new Date(item.today).getDay();\n          let startWeek = new Date(item.startTime).getDay();\n          scheduleItem = item;\n          switch (item.notificationRules) {\n            case 'not': //不重复\n              if (item.today == moment(new Date(item.startTime)).format('YYYY-MM-DD')) {\n                scheduleData.push(item);\n              }\n              break;\n            case 'day': //每日\n              scheduleData.push(item);\n              break;\n            case 'workday': //工作日\n              if (week >= 1 && week <= 5) {\n                scheduleData.push(item);\n              }\n              break;\n            case 'weekday': //每周\n              if (week == startWeek) {\n                scheduleData.push(item);\n              }\n              break;\n            case 'monthly': //每月\n              let number1 = Math.ceil(new Date(item.today).getDate() / 7);\n              let number2 = Math.ceil(new Date(item.startTime).getDate() / 7);\n              if (week == startWeek && number1 == number2) {\n                scheduleData.push(item);\n              }\n              break;\n            case 'monthly2': //每月当日\n              if (new Date(item.startTime).getDate() == new Date(item.today).getDate()) {\n                scheduleData.push(item);\n              }\n              break;\n          }\n        } else {\n          resultData.push(item);\n        }\n      });\n      if (scheduleData.length > 0) {\n        scheduleItem.content = '日程(' + scheduleData.length + ')';\n        resultData.push(scheduleItem);\n      }\n    }\n    return resultData || [];\n  };\n\n  async function readData() {\n    let start = document.querySelector(\n      '.ant-picker-calendar .ant-picker-date-panel tr:first-child .ant-picker-cell:first-child',\n    );\n    let end = document.querySelector(\n      '.ant-picker-calendar .ant-picker-date-panel tr:last-child .ant-picker-cell:last-child',\n    );\n    let startDate = '';\n    let endDate = '';\n    if (start == null || end == null) {\n      startDate = startTime.toISOString().split('T')[0];\n      endDate = endTime.toISOString().split('T')[0];\n    } else {\n      startDate = start.getAttribute('title');\n      endDate = end.getAttribute('title');\n    }\n\n    let data = await getAlldaySchedule({ startDate: startDate, endDate: endDate });\n    list.value = data.result;\n  }\n\n  onMounted(async () => {\n    readData();\n    MsgManager.getInstance().listen('setMeeting', async function () {\n      setTimeout(async () => {\n        await readData();\n        cardKey += 1;\n      }, 10);\n    });\n  });\n\n  const onPanelChange = (value: Dayjs, mode: string) => {\n    setTimeout(async () => {\n      await readData();\n      cardKey += 1;\n    }, 10);\n  };\n\n  const getSchedule = (params) =>\n    defHttp.get(\n      {\n        url: '/oa/calendar-schedule/getTodaySchedule',\n        params,\n      },\n      {},\n    );\n\n  const select = (value: Dayjs) => {\n    let listData = list.value[moment(value.toDate()).format('YYYY-MM-DD')];\n    let contentData = '';\n    if (listData != null) {\n      forEach(listData, (item) => {\n        if (item.dataType == 'schedule') {\n          let week = new Date(item.today).getDay();\n          let startWeek = new Date(item.startTime).getDay();\n          switch (item.notificationRules) {\n            case 'not': //不重复\n              if (item.today == moment(new Date(item.startTime)).format('YYYY-MM-DD')) {\n                contentData += item.contentData;\n              }\n              break;\n            case 'day': //每日\n              contentData += item.contentData;\n              break;\n            case 'workday': //工作日\n              if (week >= 1 && week <= 5) {\n                contentData += item.contentData;\n              }\n              break;\n            case 'weekday': //每周\n              if (week == startWeek) {\n                contentData += item.contentData;\n              }\n              break;\n            case 'monthly': //每月\n              let number1 = Math.ceil(new Date(item.today).getDate() / 7);\n              let number2 = Math.ceil(new Date(item.startTime).getDate() / 7);\n              if (week == startWeek && number1 == number2) {\n                contentData += item.contentData;\n              }\n              break;\n            case 'monthly2': //每月当日\n              if (new Date(item.startTime).getDate() == new Date(item.today).getDate()) {\n                contentData += item.contentData;\n              }\n              break;\n          }\n        } else {\n          contentData += item.contentData + '\\n';\n        }\n      });\n    }\n    Content.value = contentData;\n    visible.value = true;\n    // getSchedule({ date: value.toDate().toDateString() })\n    //   .then((data) => {\n    //     Content.value = data.result;\n    //     visible.value = true;\n    //   })\n    //   .catch(() => {});\n  };\n</script>\n\n<style lang=\"less\" scoped>\n  .card-content {\n    height: 360px;\n    padding-top: 1px;\n    // .calendar-cell {\n    //   font-size: 12px;\n    //   text-align-last: left;\n    //   .detail {\n    //     display: flex;\n    //     justify-content: space-between;\n    //     align-items: center;\n    //   }\n    // }\n    :deep(.ant-picker-calendar .ant-picker-panel) {\n      .ant-picker-body {\n        padding: 0;\n      }\n    }\n\n    :deep(.ant-picker-calendar-mini .ant-picker-content) {\n      height: 292px;\n\n      th {\n        padding: 8px 0;\n      }\n    }\n\n    :deep(\n        .ant-picker-cell-in-view.ant-picker-cell-selected .ant-picker-cell-inner,\n        .ant-picker-cell-in-view.ant-picker-cell-range-start .ant-picker-cell-inner,\n        .ant-picker-cell-in-view.ant-picker-cell-range-end .ant-picker-cell-inner\n      ) {\n      background-color: #1890ff;\n    }\n\n    :deep(.ant-picker-cell-in-view.ant-picker-cell-today .ant-picker-cell-inner::before) {\n      border-color: #1890ff;\n    }\n  }\n\n  .events {\n    margin: 0;\n    padding: 0;\n    list-style: none;\n  }\n</style>\n"],"names":["cardKey","schedule","ref","dropdownVisible","handleClickMenu","key","value","getAlldaySchedule","params","defHttp","visible","list","Content","startTime","endTime","getListData","dt","year","month","date","dtstr","listData","resultData","scheduleData","scheduleItem","forEach","item","week","startWeek","moment","number1","number2","readData","__async","start","end","startDate","endDate","data","onMounted","MsgManager","onPanelChange","mode","select","contentData"],"mappings":"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"}