{"version":3,"file":"index-26c1e73f.js","sources":["../../src/views/baseset/monitor/smartdevices/drivingrecorder/index.vue"],"sourcesContent":["<template>\n  <div>\n    <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n      <!-- 电站组织树 -->\n\n      <CommonTree\n        title=\"电站组织\"\n        @select=\"handleSelect\"\n        :value=\"treeData\"\n        class=\"left-tree-layout\"\n        :toolbar=\"true\"\n        :canEdit=\"false\"\n        :canAdd=\"false\"\n        :canDelete=\"false\"\n        :isShowOperationBtns=\"false\"\n        :fieldNames=\"{ key: 'id', title: 'name' }\"\n      />\n\n      <div class=\"right-table-layout\">\n        <div>\n          <BasicTable\n            class=\"fix-basic-table\"\n            @register=\"registerTable\"\n            :searchInfo=\"searchInfo\"\n            @resize-column=\"(w, col) => (col.width = w)\"\n            @row-db-click=\"(record) => handleView(record)\"\n          >\n            <template #toolbar>\n              <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleCreate\">添加</a-button>\n              <a-button\n                type=\"primary\"\n                :disabled=\"selectedRowId == ''\"\n                :preIcon=\"IconEnum.EDIT\"\n                @click=\"handleUpdate\"\n                >修改</a-button\n              >\n              <a-button\n                class=\"red-btn\"\n                :disabled=\"selectedRowId == ''\"\n                :preIcon=\"IconEnum.DELETE\"\n                @click=\"handleDelete\"\n                >删除</a-button\n              >\n              <a-button\n                class=\"green-btn\"\n                :disabled=\"selectedRowId == ''\"\n                :preIcon=\"IconEnum.ENABLE\"\n                @click=\"handleEnableIndex\"\n                >启用</a-button\n              >\n              <a-button\n                class=\"grey-btn\"\n                :disabled=\"selectedRowId == ''\"\n                :preIcon=\"IconEnum.DISABLE\"\n                @click=\"handleDisableIndex\"\n                >禁用</a-button\n              >\n              <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExportIndex\"\n                >导出</a-button\n              >\n            </template>\n            <template #bodyCell=\"{ column, text, record }\">\n              <template v-if=\"column.dataIndex === 'status'\">\n                <span style=\"color: #19be6b\" v-if=\"text == 1\">启用</span>\n                <span style=\"color: red\" v-if=\"text == 0\">禁用</span>\n              </template>\n            </template>\n          </BasicTable>\n        </div>\n      </div>\n      <!-- 数据表格 -->\n    </PageWrapper>\n  </div>\n</template>\n<script lang=\"ts\" setup>\n  import type { FormProps } from '/@/components/Form/src/types/form';\n  import { onMounted, reactive, ref, toRaw } from 'vue';\n  import { BasicTable, useTable, SorterResult } from '/@/components/Table';\n  import { TreeItem } from '/@/components/Tree';\n  import { PageWrapper } from '/@/components/Page';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import { message } from 'ant-design-vue';\n  import { jsonToSheetXlsx } from '/@/components/Excel';\n\n  import {\n    getDrivingRecorderList,\n    getTreeData,\n    formState,\n    getIndex,\n    deleteDrivingRecorder,\n    getDrivingRecorderListColumns,\n    exportExcel,\n    updateStatusIndex,\n  } from './index';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { IconEnum } from '@/enums/appEnum';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '/@/message/MsgManager';\n\n  let selectedRowId = ref('');\n  const { createConfirm } = useMessage();\n  const searchInfo = reactive<any>({\n    assetCode: null,\n    deviceCode: null,\n    userName: null,\n    status: null,\n  }); // 查询信息\n\n  const treeData = ref<TreeItem[]>([]); // 左侧电站树数据\n  const periodParam = ref({}); // 查询分期下拉框数据的参数\n\n  const checkedKeys = ref<Array<string | number>>([]); // 复选框的选择的数据\n  const areaColumn = getDrivingRecorderListColumns();\n\n  const indexList = ref<Array<any>>([]);\n  const getDrivingRecorderListByParam = async () => {\n    let areaList = await getDrivingRecorderList(searchInfo);\n    indexList.value = areaList.result;\n    return areaList.result;\n  };\n  const searchForm: FormProps = {\n    baseColProps: { span: 8 },\n    labelWidth: 120,\n    autoAdvancedLine: 1,\n    showAdvancedButton: true,\n    schemas: [\n      { field: 'assetCode', component: 'Input', label: '资产编号' },\n      { field: 'deviceCode', component: 'Input', label: '设备编号' },\n      { field: 'plateNumber', component: 'Input', label: '当前车牌号' },\n      {\n        field: 'status',\n        label: '状态',\n        component: 'Select',\n        componentProps: {\n          options: [\n            { label: '启用', value: '1' },\n            { label: '禁用', value: '0' },\n          ],\n        },\n      },\n    ],\n  };\n\n  const [registerTable, { reload, getPaginationRef }] = useTable({\n    title: '行车记录仪设置列表',\n    api: async () => {\n      const paginationRef = getPaginationRef() as any;\n      searchInfo.pageNo = paginationRef.current;\n      searchInfo.pageSize = paginationRef.pageSize;\n      let dataObj = await getDrivingRecorderListByParam();\n      return dataObj;\n    },\n    columns: areaColumn,\n    useSearchForm: true,\n    formConfig: searchForm,\n    showTableSetting: true,\n    bordered: true,\n    rowKey: 'id',\n    rowSelection: {\n      type: 'radio',\n      onChange: onSelect,\n    },\n    handleSearchInfoFn(info) {\n      searchInfo.status = info.status;\n      searchInfo.assetCode = info.assetCode;\n      searchInfo.deviceCode = info.deviceCode;\n      searchInfo.plateNumber = info.plateNumber;\n      return info;\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        searchInfo.sortField = sortInfo.field;\n        searchInfo.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n        searchInfo.sortField = null;\n        searchInfo.sortOrder = null;\n      }\n    },\n  });\n  function onSelect(record, selected) {\n    if (selected.length > 0) {\n      checkedKeys.value = [record[0]];\n      selectedRowId.value = record[0];\n    } else {\n      checkedKeys.value = [];\n      selectedRowId.value = '';\n    }\n  }\n\n  // 查询左侧电站树数据\n  async function queryDeptTreeList() {\n    const deptList = (await getTreeData({})) as unknown as TreeItem[];\n    treeData.value = deptList.result;\n\n    reload();\n  }\n  // 添加区域\n  function handleCreate() {\n    formState.id = '';\n    formState.deviceType = '行车记录仪';\n    formState.disabledInput = 'false';\n    if (searchInfo.stationId == null) {\n      message.error('请先选择电站。');\n      return;\n    }\n\n    addTabPage(\n      `/baseset/monitor/smartdevices/drivingrecorder/create`,\n      '添加行车记录仪设置',\n      toRaw(formState),\n    );\n  }\n\n  function handleView(record: any) {\n    addTabPage(\n      `/baseset/monitor/smartdevices/drivingrecorder/create?id=${record.id}` +\n        `&disabledInput=true`,\n      '查看行车记录仪设置',\n    );\n  }\n\n  async function handleUpdate() {\n    if (!checkSelectData()) {\n      return;\n    }\n    const res = await getIndex({ id: checkedKeys.value[0] });\n\n    if (res.result.status == 0) {\n      message.error('已禁用，不可修改.');\n      return;\n    }\n\n    addTabPage(\n      `/baseset/monitor/smartdevices/drivingrecorder/create?id=` +\n        checkedKeys.value['0'] +\n        `&disabledInput=false`,\n      '修改行车记录仪设置',\n    );\n  }\n\n  // 删除区域\n  async function handleDelete() {\n    console.log(checkedKeys.value);\n    if (checkedKeys.value.length != 1) {\n      message.info('请选择一条数据.');\n      return false;\n    }\n\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要删除选中记录？',\n      async onOk() {\n        deleteDrivingRecorder(checkedKeys.value[0]).then(() => {\n          message.success('已删除。');\n          checkedKeys.value = [];\n          reload();\n        });\n      },\n    });\n  }\n\n  // 启用安全检查指标\n  function handleEnableIndex() {\n    if (!checkSelectData()) {\n      return;\n    }\n    const params = '?id=' + checkedKeys.value['0'] + '&status=1';\n    updateStatusIndex(params).then(() => {\n      message.success('已启用');\n      reload();\n    });\n  }\n\n  // 禁用安全检查指标\n  function handleDisableIndex() {\n    if (!checkSelectData()) {\n      return;\n    }\n    const params = '?id=' + checkedKeys.value['0'] + '&status=0';\n    updateStatusIndex(params).then(() => {\n      message.success('已禁用');\n      reload();\n    });\n  }\n\n  // 左侧树状菜单选中事件\n  function handleSelect(node = {}) {\n    searchInfo.stationId = null;\n    searchInfo.stationName = null;\n    searchInfo.stationOrganId = null;\n    searchInfo.stationOrganName = null;\n    searchInfo.nodeKindId = null;\n    periodParam.value.nodeKindId = null;\n    searchInfo.searchId = null;\n    if (node != null) {\n      searchInfo.stationOrganId = node.organId;\n      searchInfo.stationOrganName = node.organName;\n      if (node.nodeKindId == 'station') {\n        searchInfo.stationId = node.powerStationId;\n        searchInfo.stationName = node.name;\n        periodParam.value.stationId = node.powerStationId;\n\n        formState.stationId = searchInfo.stationId;\n        formState.stationName = searchInfo.stationName;\n        formState.stationOrganId = searchInfo.stationOrganId;\n        formState.stationOrganName = searchInfo.stationOrganName;\n      }\n\n      searchInfo.nodeKindId = node.nodeKindId;\n      periodParam.value.nodeKindId = node.nodeKindId;\n      searchInfo.searchId = node.id;\n    }\n\n    reload();\n  }\n\n  function checkSelectData() {\n    if (checkedKeys.value.length == 0 || checkedKeys.value.length > 1 || !checkedKeys.value['0']) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return true;\n  }\n\n  // 导出\n  async function handleExportIndex() {\n    createConfirm({\n      title: '导出',\n      iconType: 'warning',\n      content: '确定要导出所有记录？',\n      async onOk() {\n        const header = ref({ index: '序号' });\n        const indexColumns = getDrivingRecorderListColumns();\n        const data = ref<Array<any>>([]);\n        const keys = ref<Array<any>>([]);\n        indexColumns.forEach((column) => {\n          if (!(column.dataIndex === 'id')) {\n            header.value[column.dataIndex] = column.title;\n            keys.value.push(column.dataIndex);\n          }\n        });\n\n        let areaList = await exportExcel(searchInfo);\n        indexList.value = areaList.result;\n\n        indexList.value.forEach(function (item, index) {\n          let statusDisplayName = '';\n          switch (item.status) {\n            case 0:\n              statusDisplayName = '禁用';\n              break;\n            case 1:\n              statusDisplayName = '启用';\n              break;\n          }\n          let exportItem = ref({ index: index + 1 });\n          keys.value.forEach((key) => {\n            exportItem.value[key] = key === 'status' ? statusDisplayName : item[key];\n          });\n          data.value.push(exportItem.value);\n        });\n        jsonToSheetXlsx({\n          data: data.value,\n          header: header.value,\n          filename: '行车记录仪设置.xlsx',\n        });\n      },\n    });\n  }\n\n  // 启动执行代码\n  onMounted(() => {\n    queryDeptTreeList();\n    MsgManager.getInstance().listen('drivingRecorder', function () {\n      setTimeout(() => {\n        reload();\n      }, 500);\n    });\n  });\n</script>\n<style lang=\"less\" scoped>\n  .dialog-loading {\n    position: absolute;\n    z-index: 1000 !important;\n    top: 45%;\n    left: 45%;\n  }\n\n  .dialog-mask {\n    position: absolute;\n    z-index: 1001 !important;\n    top: -1px;\n    width: 100%;\n    height: 100%;\n    opacity: 0.3;\n    background: #ccc;\n  }\n\n  .left-tree-layout {\n    flex-shrink: 0;\n    width: 298px;\n    border-radius: 2px;\n  }\n\n  .right-table-layout {\n    width: calc(100% - 308px);\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings) {\n      margin-right: 0;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n</style>\n"],"names":["selectedRowId","ref","createConfirm","useMessage","searchInfo","reactive","treeData","periodParam","checkedKeys","areaColumn","getDrivingRecorderListColumns","indexList","getDrivingRecorderListByParam","__async","areaList","getDrivingRecorderList","searchForm","registerTable","reload","getPaginationRef","useTable","paginationRef","onSelect","info","sortInfo","record","selected","queryDeptTreeList","deptList","getTreeData","handleCreate","formState","message","addTabPage","toRaw","handleView","handleUpdate","checkSelectData","getIndex","handleDelete","deleteDrivingRecorder","handleEnableIndex","params","updateStatusIndex","handleDisableIndex","handleSelect","node","handleExportIndex","header","indexColumns","data","keys","column","exportExcel","item","index","statusDisplayName","exportItem","key","jsonToSheetXlsx","onMounted","MsgManager"],"mappings":"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"}