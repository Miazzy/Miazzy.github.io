{"version":3,"file":"index-ac55139f.js","sources":["../../src/api/baseset/operation/powerstation/index.ts","../../src/views/oa/attend/index.vue"],"sourcesContent":["import { defHttp } from '/@/utils/http/axios';\n\nexport enum Api {\n  getPowerStationUrl = '/baseset/powerstation/get',\n  getAllPowerStationUrl = '/baseset/powerstation/list',\n}\n\n// 查询电站基础信息\nexport const getPowerStation = (params) => defHttp.get({ url: Api.getPowerStationUrl, params }, {});\n\n// 查询所有电站基础信息\nexport const getAllPowerStation = () =>\n  defHttp.get({ url: Api.getAllPowerStationUrl }, { isOnlyResult: true });\n","<template>\n  <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <CommonTree\n      title=\"电站组织\"\n      @select=\"handleSelect\"\n      :value=\"treeData\"\n      class=\"left-tree-layout\"\n      :toolbar=\"true\"\n      :canEdit=\"false\"\n      :canAdd=\"false\"\n      :canDelete=\"false\"\n      :isShowOperationBtns=\"false\"\n      :fieldNames=\"{ key: 'id', title: 'name' }\"\n    />\n    <div class=\"right-table-layout\">\n      <BasicTable\n        @register=\"registerTable\"\n        @resize-column=\"(w, col) => (col.width = w)\"\n        @row-db-click=\"(record) => handleView(record)\"\n        class=\"fix-basic-table\"\n        :searchInfo=\"searchInfo\"\n        @selection-change=\"handleSelectionChange\"\n      >\n        <template #toolbar>\n          <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleAdd\">{{\n            t('common.action.create')\n          }}</a-button>\n          <a-button\n            :disabled=\"disabledBtn\"\n            type=\"primary\"\n            :preIcon=\"IconEnum.EDIT\"\n            @click=\"handleEdit\"\n            >{{ t('common.action.edit') }}</a-button\n          >\n          <a-button\n            :disabled=\"disabledBtn\"\n            class=\"red-btn\"\n            :preIcon=\"IconEnum.DELETE\"\n            @click=\"handleDelete\"\n            >{{ t('common.delText') }}</a-button\n          >\n          <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExport\">{{\n            t('common.action.export')\n          }}</a-button>\n          <a-button\n            v-auth=\"`oa:att:index:setting`\"\n            type=\"primary\"\n            :preIcon=\"IconEnum.SETTING\"\n            @click=\"handlePeriod\"\n            >{{ t('排班周期设置') }}</a-button\n          >\n        </template>\n      </BasicTable>\n    </div>\n    <PeriodModal @register=\"registerPeriodModal\" />\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, reactive, ref, toRaw } from 'vue';\n  import { useUserStore } from '/@/store/modules/user';\n  import { useMessage } from '/@/hooks/web/useMessage';\n  import { useI18n } from '/@/hooks/web/useI18n';\n  import { IconEnum } from '/@/enums/appEnum';\n  import { useModal } from '/@/components/Modal';\n  import { BasicTable, useTable, SorterResult } from '/@/components/Table';\n  import { TreeItem } from '/@/components/Tree';\n  import { PageWrapper } from '/@/components/Page';\n  import CommonTree from '/@/components/Framework/Tree/CommonTree.vue';\n  import { exportExcelFile } from '/@/utils/file/download';\n  import * as CommonApi from '/@/api/baseset/common';\n  import * as PowerStationApi from '/@/api/baseset/operation/powerstation';\n  import * as AttendApi from '/@/api/oa/att';\n  import { columns, searchForm } from './attend.data';\n  import PeriodModal from './PeriodModal.vue';\n  import { assign } from 'lodash-es';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n\n  const { t } = useI18n();\n  const message = useMessage();\n  const userStore = useUserStore();\n  const userInfo = toRaw(userStore.getUserInfo);\n  const treeData = ref<TreeItem[]>([]);\n  const searchInfo = reactive<any>({});\n  const checkedNode = reactive<any>({});\n  const disabledBtn = ref<boolean>(true);\n  const [registerPeriodModal, { openModal }] = useModal();\n  const getPageByParam = async () => {\n    const paginationRef = getPaginationRef() as any;\n    const searchPageInfo = reactive<any>({});\n    assign(searchPageInfo, searchInfo);\n    searchPageInfo.pageNo = paginationRef.current;\n    searchPageInfo.pageSize = paginationRef.pageSize;\n    if (!searchPageInfo.sortField) {\n      searchPageInfo.sortField = 'createTime';\n      searchPageInfo.sortOrder = 'desc';\n    }\n    return await AttendApi.getPage(searchPageInfo);\n  };\n\n  const tableTitle = ref<string>('月排班');\n  const [registerTable, { reload, clearSelectedRowKeys, getPaginationRef, getSelectRows }] =\n    useTable({\n      title: tableTitle,\n      api: getPageByParam,\n      columns: columns(),\n      useSearchForm: true,\n      formConfig: searchForm,\n      bordered: true,\n      rowKey: 'id',\n      rowSelection: {\n        type: 'radio',\n      },\n      sortFn: (sortInfo: SorterResult) => {\n        const sortOrder = sortInfo.order?.replace('end', '');\n        searchInfo.sortOrder = sortOrder;\n        searchInfo.sortField = sortOrder ? sortInfo.field : undefined;\n      },\n      handleSearchInfoFn(info) {\n        assign(searchInfo, info);\n        return info;\n      },\n      showTableSetting: true,\n      tableSetting: { fullScreen: true },\n      showIndexColumn: true,\n    });\n\n  // 查询左侧树数据\n  async function queryTreeList() {\n    const typeList = await CommonApi.getStationTree({});\n    treeData.value = typeList.result as unknown[] as TreeItem[];\n  }\n\n  // 左侧树选中事件\n  function handleSelect(node) {\n    searchInfo.stationId = null;\n    searchInfo.stationOrganId = null;\n    checkedNode.stationId = '';\n    checkedNode.stationName = '';\n    checkedNode.stationOrganId = '';\n    checkedNode.stationOrganName = '';\n    if (node) {\n      if (node.nodeKindId === 'org') {\n        searchInfo.stationOrganId = node.id;\n      }\n      if (node.nodeKindId === 'station') {\n        searchInfo.stationId = node.powerStationId;\n        checkedNode.stationId = node.powerStationId;\n        checkedNode.stationName = node.powerStationName;\n        checkedNode.stationOrganId = node.organId;\n        checkedNode.stationOrganName = node.organName;\n      }\n    }\n    reload();\n  }\n\n  const handleAdd = async () => {\n    if (!checkedNode.stationId) {\n      message.warning('请选择电站组织');\n      return;\n    }\n    const powerStationRes = await PowerStationApi.getPowerStation({ id: checkedNode.stationId });\n    if (powerStationRes.result) {\n      checkedNode.connectCapacity = powerStationRes.result.connectCapacity;\n    }\n    goRouter(toRaw(checkedNode));\n  };\n\n  const handleEdit = async () => {\n    const record = checkSelectData();\n    if (!record) {\n      return;\n    }\n    goRouter({ id: record.id });\n  };\n\n  const handleView = async (record: any) => {\n    goRouter({ id: record.id, isReadonly: true });\n  };\n\n  const goRouter = async (query) => {\n    const period = await getPeriodList();\n    if (!period) {\n      return;\n    }\n    assign(query, period);\n    addTabPage('/oa/attend/create', getTabPageName(query, query.isReadonly), query);\n  };\n\n  const getTabPageName = (record: any, isView?: boolean) => {\n    const name = tableTitle.value;\n    if (isView) {\n      return `查看${name}`;\n    }\n    if (!record?.id) {\n      return `${t('common.action.create')}${name}`;\n    }\n    return `${t('common.action.edit')}${name}`;\n  };\n\n  const getPeriodList = async () => {\n    const res = await AttendApi.getPeriodList();\n    if (!res.result || res.result.length == 0) {\n      message.warning('请进行排班周期设置');\n      return false;\n    }\n    const item = res.result[0];\n    return {\n      periodRule: item.rule,\n      periodStartDay: item.startDay,\n      periodEndDay: item.endDay,\n    };\n  };\n\n  const handleDelete = async () => {\n    const record = checkSelectData();\n    if (!record) {\n      return;\n    }\n    if (userInfo.userId !== record.creator) {\n      message.error('您无权删除该数据');\n      return;\n    }\n    await message.delConfirm();\n    await AttendApi.deleteData(record.id);\n    message.success(t('common.delSuccess'));\n    clearSelectedRowKeys();\n    reload();\n  };\n\n  function checkSelectData() {\n    const rows = getSelectRows();\n    if (rows.length == 0) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return rows[0];\n  }\n\n  function handleExport() {\n    message.createConfirm({\n      title: t('common.message.confirmTitle'),\n      iconType: 'warning',\n      content: t('common.message.exportMessage'),\n      async onOk() {\n        searchInfo.filename = `${tableTitle.value}.xls`;\n        await AttendApi.exportExcel(searchInfo).then((res) => {\n          exportExcelFile(res?.data, searchInfo.filename);\n        });\n        searchInfo.filename = null;\n        message.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n\n  const modalOptions = { visible: true };\n  function handlePeriod() {\n    AttendApi.getPeriodList().then((res) => {\n      const result = res.result as Array<any>;\n      if (result.length == 0) {\n        openModal(modalOptions, {\n          isUpdate: false,\n        });\n      } else {\n        openModal(modalOptions, {\n          record: result[0],\n          isUpdate: true,\n        });\n      }\n    });\n  }\n\n  function handleSelectionChange({ rows }) {\n    disabledBtn.value = rows.length === 0;\n  }\n\n  // 启动执行代码\n  onMounted(() => {\n    queryTreeList();\n\n    MsgManager.getInstance().listen('oa-attend', reload);\n  });\n</script>\n<style lang=\"less\" scoped>\n  @import '/@/design/biz/bizList.less';\n</style>\n"],"names":["getPowerStation","params","defHttp","t","useI18n","message","useMessage","userStore","useUserStore","userInfo","toRaw","treeData","ref","searchInfo","reactive","checkedNode","disabledBtn","registerPeriodModal","openModal","useModal","getPageByParam","__async","paginationRef","getPaginationRef","searchPageInfo","assign","AttendApi.getPage","tableTitle","registerTable","reload","clearSelectedRowKeys","getSelectRows","useTable","columns","searchForm","sortInfo","sortOrder","_a","info","queryTreeList","typeList","CommonApi.getStationTree","handleSelect","node","handleAdd","powerStationRes","PowerStationApi.getPowerStation","goRouter","handleEdit","record","checkSelectData","handleView","query","period","getPeriodList","addTabPage","getTabPageName","isView","name","res","AttendApi.getPeriodList","item","handleDelete","AttendApi.deleteData","rows","handleExport","AttendApi.exportExcel","exportExcelFile","modalOptions","handlePeriod","result","handleSelectionChange","onMounted","MsgManager"],"mappings":"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"}