{"version":3,"file":"yearReportCreate-654a97b4.js","sources":["../../src/views/po/elec/produce/yearReportCreate.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <div class=\"process-box\">\n        <div class=\"header-box\">\n          <!-- 标题 -->\n          <BillTitle :options=\"billTitleOptions\" />\n          <WfApproveBox\n            @save=\"onSave\"\n            @submit=\"onSubmit\"\n            :processStatus=\"formState.status\"\n            :processInstanceId=\"formState.processInstanceId\"\n          />\n        </div>\n        <!-- 表单内容 -->\n        <div class=\"content\">\n          <div class=\"left-panel\"\n            ><a-form\n              ref=\"yearReportFormRef\"\n              :model=\"formState\"\n              name=\"yearReportForm\"\n              scrollToFirstError=\"true\"\n            >\n              <a-card title=\"基本信息\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"电站名称\"\n                      name=\"stationName\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.stationName\" style=\"width: 100%\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"分期\"\n                      name=\"periodName\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.periodName\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"年报周期\"\n                      name=\"yearCycle\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                      :rules=\"[{ required: true, message: '请选择年份' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.yearCycle\"\n                        value-format=\"YYYY\"\n                        @change=\"changeReportDay\"\n                        style=\"min-width: 100%\"\n                        :disabled=\"iProcess\"\n                        picker=\"year\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"年发电量(kWh)\"\n                      name=\"genElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.genElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"理论发电(kWh)\"\n                      name=\"theoElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.theoElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"外接厂用电(kWh)\"\n                      name=\"facUsed\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.facUsed\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"上网电量(kWh)\"\n                      name=\"onlineElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.onlineElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"下网电量(kWh)\"\n                      name=\"offlineElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.offlineElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"损失电量(kWh)\"\n                      name=\"totalLoss\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.totalLoss\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"利用小时数(h)\"\n                      name=\"validHours\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.validHours\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"综合厂用电率(%)\"\n                      name=\"facRatio\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.facRatio\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"系统效率(%)\"\n                      name=\"sysEfficiency\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.sysEfficiency\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"平均温度(℃)\"\n                      name=\"avgTemp\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.avgTemp\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"平均风速(m/s)\"\n                      name=\"avgWind\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.avgWind\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"年辐照值(万KJ/㎡)\"\n                      name=\"radiation\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.radiation\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"24\" class=\"textarea-item\">\n                    <a-form-item\n                      label=\"生产数据分析\"\n                      name=\"remark\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 2 }\"\n                      :rules=\"[{ required: true, message: '请输入生产数据分析' }]\"\n                    >\n                      <a-textarea\n                        :rows=\"10\"\n                        v-model:value=\"formState.remark\"\n                        placeholder=\"1000字以内\"\n                        :maxlength=\"1000\"\n                        :disabled=\"iProcess\"\n                        show-count\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n            </a-form>\n\n            <a-card title=\"运维管理年度总结\" :bordered=\"false\">\n              <UploadBox\n                :width=\"800\"\n                :height=\"550\"\n                :maxCount=\"20\"\n                :maxSize=\"100 * 1024 * 1024\"\n                :application=\"`po`\"\n                :module=\"`yearReport`\"\n                :vmode=\"formState.status == 0 ? `box` : `view`\"\n                :bizId=\"formState.bizFileId\"\n              />\n            </a-card>\n          </div>\n        </div>\n      </div>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { computed, onMounted, reactive, ref, unref, UnwrapRef } from 'vue';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import Icon from '@/components/Icon/Icon.vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { useRouter } from 'vue-router';\n  import { message, FormInstance } from 'ant-design-vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { assign } from 'lodash-es';\n  import * as FileApi from '@/api/infra/file';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import { getBaseInfo, getAttCloumns, insertYearReport, getYearReport } from './index';\n  import { MsgManager } from '@/message/MsgManager';\n  import { closeCurrentTab } from '@/utils/route';\n  import { SysMessage } from '/@/hooks/web/useMessage';\n  import { PageWrapper } from '/@/components/Page';\n  import { Memory } from '@/router/index';\n\n  const iProcess = ref<boolean>(false);\n  const { t } = useI18n();\n  const router = useRouter();\n  const { currentRoute } = router;\n  const route = unref(currentRoute);\n  const query = Memory.getInstance().getQuery(); // route.query;\n\n  const processInstanceId = ref(null);\n  interface FormState {}\n  const yearReportFormRef = ref<FormInstance>();\n  const formState: UnwrapRef<FormState> = reactive({ status: 0 });\n  const billTitleOptions = reactive<any>({});\n  billTitleOptions.subject = '生产年报';\n  billTitleOptions.infoItems = [];\n  // 加载日报汇总的基础数据\n  const loadBaseInfo = async () => {\n    if (formState.yearCycle == null) {\n      return;\n    }\n    formState.requestType = 'year';\n    let data = await getBaseInfo(formState);\n    formState.genElec = data.result.genElec;\n    formState.offlineElec = data.result.offlineElec;\n    formState.onlineElec = data.result.onlineElec;\n    formState.theoElec = data.result.theoElec;\n    formState.facUsed = data.result.facUsed;\n    formState.totalLoss = data.result.totalLoss;\n    formState.validHours = data.result.validHours;\n    formState.facRatio = data.result.facRatio;\n    formState.sysEfficiency = data.result.sysEfficiency;\n    formState.avgTemp = data.result.avgTemp;\n    formState.avgWind = data.result.avgWind;\n    formState.radiation = data.result.radiation;\n    formState.connectCapacity = data.result.connectCapacity;\n  };\n\n  // 日期选择后更新并网容量，加载损失电量数据\n  function changeReportDay() {\n    // 查询并网容量\n    loadBaseInfo();\n  }\n\n  //-------------------------------------------------------流程相关操作-------------------------------------------------------------\n\n  const onSave = () => {\n    doSave(0);\n  };\n\n  const onSubmit = () => {\n    doSave(1);\n  };\n\n  const doSave = (status: number) => {\n    yearReportFormRef.value.validateFields().then(() => {\n      let param = formState;\n      param.status = status;\n      insertYearReport(param)\n        .then((data) => {\n          //关闭弹窗\n          SysMessage.getInstance().success(t('common.saveSuccessText'));\n          formState.id = data.result;\n          loadBizData();\n          if (status >= 1) {\n            setTimeout(function () {\n              MsgManager.getInstance().sendMsg('day-report', { key: 'year' });\n              closeCurrentTab();\n            }, 200);\n          }\n        })\n        .catch(() => {});\n    });\n  };\n  const loadBizBaseInfo = async (res: any) => {\n    let { billCode, fillinDate, personMemberName, deptName } = res;\n    Object.assign(billTitleOptions, { billCode, fillinDate, personMemberName, deptName });\n  };\n  const loadBizData = async () => {\n    let res = await getYearReport(formState.id);\n    // 填充业务数据\n    iProcess.value = res.status > 0;\n    loadBizBaseInfo(res);\n    assign(formState, res);\n    if (!formState.processInstanceId) {\n      formState.processInstanceId = query.processInstanceId;\n    }\n  };\n  // 填充电站分期数据\n  const loadPeriodData = async () => {\n    let res = await getYearReport('');\n    loadBizBaseInfo(res);\n    formState.billCode = res.billCode;\n    formState.fillinDate = res.fillinDate;\n    formState.stationId = query.stationId;\n    formState.stationName = query.stationName;\n    formState.periodId = query.periodId;\n    formState.periodName = query.periodName;\n    formState.stationOrganId = query.organId;\n    formState.stationOrganName = query.organName;\n    loadBaseInfo();\n    // 获取附件id\n    getBizFileId();\n  };\n\n  const getBizFileId = async () => {\n    FileApi.getBizId().then((res) => {\n      formState.bizFileId = res;\n    });\n  };\n\n  onMounted(async () => {\n    assign(formState, query);\n    if (query.id) {\n      await loadBizData();\n    } else if (query.processInstanceId) {\n      processInstanceId.value = query.processInstanceId as unknown as string;\n      formState.processInstanceId = query.processInstanceId as unknown as string;\n      ProcessInstanceApi.getProcessInstance(formState.processInstanceId).then(async (res) => {\n        formState.id = res.businessKey;\n        await loadBizData();\n      });\n    } else {\n      // 填充参数数据\n      loadPeriodData();\n    }\n  });\n</script>\n\n<style lang=\"less\">\n  .theme1 {\n    .form-subtitle-box {\n      .title-left {\n        color: rgb(255 255 255 / 85%);\n      }\n    }\n  }\n\n  .theme3 {\n    .form-subtitle-box {\n      .title-left {\n        color: rgb(0 0 0 / 85%);\n      }\n    }\n  }\n</style>\n<style lang=\"less\" scoped>\n  .form-subtitle-box {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 6px;\n    padding: 9px 16px 0;\n\n    .title-left {\n      display: flex;\n      align-items: center;\n      font-size: 14px;\n      font-weight: 500;\n      line-height: 28px;\n\n      &::before {\n        content: '';\n        display: inline-block;\n        width: 3px;\n        height: 16px;\n        margin-right: 10px;\n        background-color: #1890ff;\n      }\n    }\n\n    .title-right {\n      :deep(.ant-btn) {\n        height: 28px;\n        margin-right: 10px;\n        padding: 3px 13px;\n        font-size: 12px;\n\n        &:last-child {\n          margin-right: 0;\n        }\n      }\n    }\n  }\n\n  .fix-detail-page {\n    :deep(&.vben-page-wrapper-content.detail-content) {\n      margin: 0;\n    }\n  }\n</style>\n"],"names":["iProcess","ref","t","useI18n","router","useRouter","currentRoute","unref","query","Memory","processInstanceId","yearReportFormRef","formState","reactive","billTitleOptions","loadBaseInfo","__async","data","getBaseInfo","changeReportDay","onSave","doSave","onSubmit","status","param","insertYearReport","SysMessage","loadBizData","MsgManager","closeCurrentTab","loadBizBaseInfo","res","billCode","fillinDate","personMemberName","deptName","getYearReport","assign","loadPeriodData","getBizFileId","FileApi.getBizId","onMounted","ProcessInstanceApi.getProcessInstance"],"mappings":"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"}