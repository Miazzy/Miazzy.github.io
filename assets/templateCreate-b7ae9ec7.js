var ke=Object.defineProperty,De=Object.defineProperties;var Re=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var Ke=Object.prototype.hasOwnProperty,Ee=Object.prototype.propertyIsEnumerable;var te=(m,i,r)=>i in m?ke(m,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):m[i]=r,ae=(m,i)=>{for(var r in i||(i={}))Ke.call(i,r)&&te(m,r,i[r]);if(ee)for(var r of ee(i))Ee.call(i,r)&&te(m,r,i[r]);return m},oe=(m,i)=>De(m,Re(i));var U=(m,i,r)=>new Promise((b,M)=>{var _=v=>{try{k(r.next(v))}catch(d){M(d)}},x=v=>{try{k(r.throw(v))}catch(d){M(d)}},k=v=>v.done?b(v.value):Promise.resolve(v.value).then(_,x);k((r=r.apply(m,i)).next())});import{d as Le,ax as Be,u as h,k as C,r as F,e as ne,o as Ne,al as c,Z as D,a9 as V,aa as n,$ as R,f as a,v as j,A as W,E as T,_ as se,ac as le,ad as re}from"./vue-71d1abb3.js";import{B as Ae}from"./BillTitle-d17ab3e4.js";import{b as Pe,ak as He,aB as Oe,av as Y,a7 as Ue,aC as Fe,at as Ve,_ as je}from"./index.js";import{b as ie}from"./index-316f6ffb.js";import We from"./indexModel-303590c3.js";import{_ as Ye}from"./templateHisModel.vue_vue_type_script_setup_true_lang-8f2d2a80.js";import{P as qe}from"./index-20519caf.js";import{W as ze}from"./WfApproveBox-a3448232.js";import{a as de,b as $e,d as Qe,e as Ze,f as Ge}from"./template-39a1216a.js";import{u as Je}from"./useTabs-2b062e85.js";import{a as ce}from"./assign-37f1c13d.js";import{a2 as N}from"./antd-15ac76ed.js";import"./useWindowSizeFn-13b1b8a2.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./useContentViewHeight-7f845167.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./BasicTable-0434a334.js";import"./useForm-dea3ed18.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-f4fc48e6.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./Dialog-0a006d82.js";import"./OrganDialog-dd1023ce.js";import"./uniqBy-92d3bc7f.js";import"./index-085d06c7.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useTable-109483b3.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useRender-21ce56fb.js";const Xe={class:"load"},et={class:"process-box"},tt={class:"header-box"},at={class:"content"},ot={class:"left-panel"},nt={key:0},st={key:0},lt=Le({name:"LeaveCreate",__name:"templateCreate",setup(m){Je(),Pe();const i=Be(),{currentRoute:r}=i;h(r);const b=He.getInstance().getQuery(),M=C(null),_=C(!1),x=C(""),k=$e(),v=Qe(),d=C([]),w=C([]),q=C(),s=F({status:0}),ue={width:1200,height:600,visible:!0},[pe,{openModal:me}]=ie(),fe={width:1200,height:600,visible:!0},[_e,{openModal:ve}]=ie();C([]);const ge=t=>{let l=[];t.forEach(e=>{let u={indexCode:e.code,indexKind:e.kind,indexName:e.name,evaluationIndexId:e.id,indexKindText:e.kindText,evaluationMethod:e.evaluationMethod,assessTarget:e.assessTarget,scoreRuleDesc:e.scoreRuleDesc,allowOverrun:e.allowOverrun};l.push(u)});let o=d.value.map(e=>e.evaluationIndexId);l.forEach(e=>{o.indexOf(e.evaluationIndexId)==-1&&d.value.push(e)}),E()},he=t=>{x.value=t,z()},K=F({});K.subject="评价模板",K.infoItems=[];const A=F({selectedRowKeys:[],loading:!1}),be=ne(()=>A.selectedRowKeys.length>0),xe=t=>{console.log("selectedRowKeys changed: ",t),A.selectedRowKeys=t};function Ie(){me(ue,{})}function ye(){ve(fe,{})}function Ce(){d.value=d.value.filter(t=>A.selectedRowKeys.indexOf(t.id)==-1),E()}function z(){Ze({evaluationTemplateId:x.value}).then(t=>{d.value=t,E()})}function E(){if(d.value.length==0)return;let t=d.value,l=[];t.forEach(function(e,u){l.includes(e.indexKind)||l.push(e.indexKind)});let o=[];if(l.length>0){let e=0;l.forEach(function(f){let g=0,I={},L;t.forEach(function(y){y.indexKind==f&&(g=g+(y.score==null?0:y.score),L=y.indexKindText)}),e=e+g,I.presetScore=g,I.kindName=L,I.indexKind=f,o.push(I)});let u=0;for(let f=0;f<o.length-1;f++)if(o[f].presetScore>0){let g=o[f].presetScore/e*100;o[f].proportion=Math.round(g),u=u+Math.round(g),o[f].presetTotalScore=e}else o[f].proportion=0;let H=u>0?100-u:o[o.length-1].presetScore>0?100:0;o[o.length-1].proportion=H,o[o.length-1].presetTotalScore=e,w.value=o}}const $=ne(()=>{let t=0;w.value.forEach(o=>{t+=o.presetScore});let l=t>0?100:0;return{totalScore:t,totalProportion:l}}),we=()=>{Q(0)},Se=()=>{Q(1)},Q=t=>{q.value.validateFields().then(()=>{if(d.value.length==0){N.error("必须选择指标明细。");return}if(d.value.find(e=>{if(e.score==null)return N.error("必须填写分值。"),!0})!=null)return!0;if(w.value.length==0){N.error("必须设置占比数据。");return}let o=0;if(w.value.forEach(e=>{o=o+e.proportion}),o!=100){N.error("占比总和必须为100。");return}s.detailList=d.value,s.proportionList=w.value,Ge(oe(ae({},s),{status:t})).then(e=>{s.status=t,t>=1?setTimeout(function(){Ue.getInstance().sendMsg("evaluation-template",{}),Fe()},500):(Ve.getInstance().success("保存成功"),x.value=e.result,s.id=e.result,P())}).catch(e=>{console.log(e)})})},Z=t=>U(this,null,function*(){let{billCode:l,fillinDate:o,personMemberName:e,deptName:u}=t;Object.assign(K,{billCode:l,fillinDate:o,personMemberName:e,deptName:u})});function P(){de(x.value).then(t=>{ce(s,t),s.processInstanceId||(s.processInstanceId=b.processInstanceId),_.value=t.status>0,Z(t),z()})}return Ne(()=>U(this,null,function*(){if(ce(s,b),b.id)x.value=b.id,yield P();else if(b.processInstanceId)M.value=b.processInstanceId,Oe(M.value).then(t=>{x.value=t.businessKey,P()});else{let t=yield de("");Z(t),s.billCode=t.billCode,s.fillinDate=t.fillinDate}})),(t,l)=>{const o=c("a-input"),e=c("a-form-item"),u=c("a-col"),H=c("a-date-picker"),f=c("a-textarea"),g=c("a-row"),I=c("a-card"),L=c("a-form"),y=c("a-button"),G=c("a-input-number"),J=c("a-table"),O=c("a-table-summary-cell"),X=c("a-typography-text"),Te=c("a-table-summary-row");return D(),V(h(qe),{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:n(()=>[R("div",Xe,[R("div",et,[R("div",tt,[a(Ae,{options:K},null,8,["options"]),a(ze,{onSave:we,onSubmit:Se,processStatus:s.status,processInstanceId:s.processInstanceId},null,8,["processStatus","processInstanceId"])]),R("div",at,[R("div",ot,[a(L,{ref_key:"templateFormRef",ref:q,model:s,name:"Form"},{default:n(()=>[a(I,{title:"基本信息",bordered:!1},{default:n(()=>[a(g,null,{default:n(()=>[j(a(u,{span:12},{default:n(()=>[a(e,{label:"主题",name:"subject",labelAlign:"right",labelCol:{span:4},rules:[{required:!0,message:"请输入主题"}]},{default:n(()=>[a(o,{value:s.subject,"onUpdate:value":l[0]||(l[0]=p=>s.subject=p),disabled:_.value,style:{width:"100%"},maxlength:"128"},null,8,["value","disabled"])]),_:1})]),_:1},512),[[W,!0]]),j(a(u,{span:12},{default:n(()=>[a(e,{label:"生效月份",name:"effectiveMonth",labelAlign:"right",labelCol:{span:4},rules:[{required:!0,message:"请选择月份"}]},{default:n(()=>[a(H,{value:s.effectiveMonth,"onUpdate:value":l[1]||(l[1]=p=>s.effectiveMonth=p),"value-format":"YYYY-MM",disabled:_.value,onChange:t.changeReportDay,style:{"min-width":"100%"},picker:"month"},null,8,["value","disabled","onChange"])]),_:1})]),_:1},512),[[W,!0]]),j(a(u,{span:24,class:"textarea-item"},{default:n(()=>[a(e,{label:"设置说明",name:"description",labelAlign:"right",labelCol:{span:2}},{default:n(()=>[a(f,{rows:1,value:s.description,"onUpdate:value":l[2]||(l[2]=p=>s.description=p),maxlength:1e3,disabled:_.value,"show-count":""},null,8,["value","disabled"])]),_:1})]),_:1},512),[[W,!0]])]),_:1})]),_:1})]),_:1},8,["model"]),a(I,{title:"指标构成",bordered:!1},{extra:n(()=>[a(y,{class:"tab-button",type:"primary",disabled:_.value,preIcon:h(Y).ADD,onClick:Ie},{default:n(()=>[T("选择指标")]),_:1},8,["disabled","preIcon"]),a(y,{class:"tab-button",type:"primary",disabled:_.value,preIcon:h(Y).ADD,onClick:ye},{default:n(()=>[T("获取历史版本")]),_:1},8,["disabled","preIcon"]),a(y,{style:{"margin-right":"18px"},class:"tab-button red-btn",preIcon:h(Y).DELETE,disabled:!be.value||_.value,onClick:Ce},{default:n(()=>[T("删除 ")]),_:1},8,["preIcon","disabled"])]),default:n(()=>[a(J,{style:{margin:"0 9px 0 8px"},columns:h(k),"data-source":d.value,pagination:!1,size:"small",bordered:"",rowKey:"id","row-selection":{selectedRowKeys:t.selectedRowKeys,onChange:xe},scroll:{x:480,y:300}},{bodyCell:n(({column:p,text:Me,record:S})=>[["score","maxAdditionalScore"].includes(p.dataIndex)?(D(),se("div",nt,[(D(),V(G,{key:0,value:S[p.dataIndex],"onUpdate:value":B=>S[p.dataIndex]=B,onChange:B=>E(S),min:0,max:9999,disabled:_.value,controls:!1,style:{margin:"-5px 0"}},null,8,["value","onUpdate:value","onChange","disabled"]))])):le("",!0)]),_:1},8,["columns","data-source","row-selection"])]),_:1}),a(I,{title:"指标占比",bordered:!1},{default:n(()=>[a(J,{style:{margin:"0 9px 0 8px"},columns:h(v),"data-source":w.value,pagination:!1,size:"small",bordered:"",scroll:{x:480,y:400}},{summary:n(()=>[a(Te,null,{default:n(()=>[a(O,{type:"success"},{default:n(()=>[T("合计")]),_:1}),a(O,null,{default:n(()=>[a(X,{type:"success"},{default:n(()=>[T(re($.value.totalScore),1)]),_:1})]),_:1}),a(O,null,{default:n(()=>[a(X,{type:"success"},{default:n(()=>[T(re($.value.totalProportion),1)]),_:1})]),_:1})]),_:1})]),bodyCell:n(({column:p,text:Me,record:S})=>[p.dataIndex=="proportion"?(D(),se("div",st,[(D(),V(G,{key:0,value:S[p.dataIndex],"onUpdate:value":B=>S[p.dataIndex]=B,min:1,max:9999,disabled:_.value,controls:!1,style:{margin:"-5px 0"}},null,8,["value","onUpdate:value","disabled"]))])):le("",!0)]),_:1},8,["columns","data-source"])]),_:1})])])])]),a(We,{onRegister:h(pe),minHeight:500,maxWidth:200,onSelectedIndex:ge,fIndexList:d.value},null,8,["onRegister","fIndexList"]),a(Ye,{onRegister:h(_e),minHeight:500,width:800,onSelectedTempId:he},null,8,["onRegister"])]),_:1})}}});const Wt=je(lt,[["__scopeId","data-v-8223616f"]]);export{Wt as default};
//# sourceMappingURL=templateCreate-b7ae9ec7.js.map
