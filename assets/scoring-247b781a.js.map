{"version":3,"file":"scoring-247b781a.js","sources":["../../src/views/po/integrated/assessmentevaluation/monthly/scoring.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <div class=\"process-box\">\n        <div class=\"header-box\">\n          <!-- 标题 -->\n          <BillTitle :options=\"billTitleOptions\" />\n          <a-button type=\"primary\" @click=\"saveScoring\">保存</a-button>\n        </div>\n        <!-- 表单内容 -->\n        <div class=\"content\">\n          <div class=\"left-panel\">\n            <a-form ref=\"templateFormRef\" :model=\"formState\" name=\"Form\">\n              <a-card title=\"基础信息\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"主题\"\n                      name=\"subject\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input\n                        v-model:value=\"formState.subject\"\n                        disabled\n                        style=\"width: 100%\"\n                        maxlength=\"128\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"评价周期\"\n                      name=\"evaluationPeriod\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.evaluationPeriod\"\n                        value-format=\"YYYY-MM\"\n                        disabled\n                        @change=\"changeReportDay\"\n                        style=\"min-width: 100%\"\n                        picker=\"month\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n            </a-form>\n            <a-card title=\"指标评分\" :bordered=\"false\">\n              <template #extra>\n                <a-form :model=\"searchInfo\" name=\"indexSearch\" layout=\"inline\" autocomplete=\"off\">\n                  <a-form-item label=\"指标\" name=\"indexId\">\n                    <a-select\n                      style=\"width: 200px\"\n                      allow-clear\n                      v-model:value=\"searchInfo.evaluationTemplateDtlId\"\n                      placeholder=\"请选择评价指标\"\n                      :options=\"indexOptions\"\n                    />\n                  </a-form-item>\n                  <a-form-item label=\"电站\" name=\"evaluationMethod\">\n                    <a-select\n                      style=\"width: 200px\"\n                      allow-clear\n                      v-model:value=\"searchInfo.stationId\"\n                      placeholder=\"请选择电站\"\n                      :options=\"stationOptions\"\n                    />\n                  </a-form-item>\n                  <a-form-item>\n                    <a-button class=\"form-but\" @click=\"resetFrom\">重置</a-button>\n                    <a-button type=\"primary\" @click=\"searchList\">查询</a-button>\n                  </a-form-item>\n                  <a-form-item label=\"调整分\" name=\"adjustmentScore\">\n                    <a-input-number v-model:value=\"searchInfo.adjustmentScore\" />\n                  </a-form-item>\n                  <a-form-item>\n                    <a-button\n                      type=\"primary\"\n                      :preIcon=\"IconEnum.SETTING\"\n                      @click=\"batachSetAdjustmentScore\"\n                      >批量设置调整分</a-button\n                    >\n                  </a-form-item>\n                </a-form></template\n              >\n\n              <a-table\n                style=\"margin: 0 8px\"\n                :columns=\"scoringColumns\"\n                :data-source=\"scoringList\"\n                :pagination=\"false\"\n                size=\"small\"\n                bordered\n                rowKey=\"id\"\n                :row-selection=\"{\n                  selectedRowKeys: selectedRowKeys,\n                  onChange: onSelectChange,\n                  fixed: true,\n                }\"\n                @change=\"changeTable\"\n                @resize-column=\"(w, col) => (col.width = w)\"\n                :scroll=\"{ x: 480, y: 480 }\"\n              >\n                <template #bodyCell=\"{ column, text, record }\">\n                  <template v-if=\"column.dataIndex === 'adjustmentScore'\"\n                    ><div>\n                      <a-input-number\n                        v-if=\"true\"\n                        v-model:value=\"record[column.dataIndex]\"\n                        @change=\"changeAdj(record)\"\n                        :max=\"9999\"\n                        :disabled=\"iProcess\"\n                        :controls=\"false\"\n                      />\n                    </div>\n                  </template>\n                  <template v-if=\"column.dataIndex === 'evaluationDesc'\"\n                    ><div>\n                      <a-input\n                        v-if=\"true\"\n                        v-model:value=\"record[column.dataIndex]\"\n                        :disabled=\"iProcess\"\n                        :controls=\"false\"\n                        maxlength=\"128\"\n                      />\n                    </div>\n                  </template>\n                </template>\n              </a-table>\n            </a-card>\n          </div>\n        </div>\n      </div>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { computed, onMounted, reactive, ref, unref, UnwrapRef } from 'vue';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import { useModal } from '/@/components/Modal';\n  import { IconEnum } from '@/enums/appEnum';\n  import { assign } from 'lodash-es';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import DictSelectBox from '@/components/Framework/Combox/DictSelectBox.vue';\n  import Icon from '@/components/Icon/Icon.vue';\n  import { message, FormInstance } from 'ant-design-vue';\n  import { PlusOutlined, RestOutlined } from '@ant-design/icons-vue';\n  import {\n    getScoringColumns,\n    getScoringList,\n    getMonthlyById,\n    getIndexByKind,\n    getAllStations,\n    saveMonthlyDtl,\n  } from './monthly';\n  import { addTabAndClose } from '/@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n  import { Memory } from '@/router/index';\n\n  defineOptions({ name: 'LeaveCreate' });\n  const query = Memory.getInstance().getQuery();\n  const searchInfo = reactive({});\n  const iProcess = ref<boolean>(false);\n  const templateId = ref('');\n  const scoringColumns = ref([]);\n  const scoringList = ref([]);\n  const templateFormRef = ref<FormInstance>();\n  const formState: UnwrapRef<FormState> = reactive({ status: 0 });\n  const billTitleOptions = reactive<any>({});\n  const indexOptions = ref<any>([]); //指标\n  const stationOptions = ref<any>([]); //电站\n\n  billTitleOptions.infoItems = [];\n\n  //-------------------------------------------------------明细相关-------------------------------------------------------------\n  // 查询当前大类下的所有指标\n  const allIndex = async () => {\n    let indexs = await getIndexByKind({\n      evaluationTemplateId: formState.evaluationTemplateId,\n      indexKind: formState.indexKind,\n    });\n    let indexOpt = [];\n    indexs.forEach((item) => {\n      indexOpt.push({ value: item.id, label: item.indexName });\n    });\n    indexOptions.value = indexOpt;\n  };\n\n  // 查询参与评价的所有电站\n  const allStations = async () => {\n    let stations = await getAllStations({\n      monthlyEvaluationId: formState.id,\n    });\n    let stationOpt = [];\n    stations.forEach((item) => {\n      stationOpt.push({ value: item.stationId, label: item.stationName });\n    });\n    stationOptions.value = stationOpt;\n  };\n\n  // 修改调整分计算最终分\n  const changeAdj = async (record: any) => {\n    let addFinalScore = parseInt(record.evaluationScore) + parseInt(record.adjustmentScore);\n    if (addFinalScore > record.tdMaxScore || addFinalScore < 0) {\n      message.error('最终得分应在：【0 ~ ' + record.tdMaxScore + '】之间。');\n      record.adjustmentScore = null;\n      record.finalScore = null;\n    } else {\n      record.finalScore = addFinalScore;\n    }\n  };\n\n  // 批量设置调整分\n  const batachSetAdjustmentScore = async () => {\n    let errorFlag = false;\n    if (state.selectedRowKeys.length == 0) {\n      message.error('请选择指标。');\n      return;\n    }\n    if (searchInfo.adjustmentScore == null) {\n      message.error('请输入调整分');\n      return;\n    }\n    scoringList.value.forEach((item) => {\n      if (state.selectedRowKeys.includes(item.id)) {\n        item.adjustmentScore = searchInfo.adjustmentScore;\n        let addFinalScore = parseInt(item.evaluationScore) + parseInt(item.adjustmentScore);\n        if (addFinalScore > item.tdMaxScore || addFinalScore < 0) {\n          errorFlag = true;\n          item.adjustmentScore = null;\n          item.finalScore = null;\n        } else {\n          item.finalScore = addFinalScore;\n        }\n      }\n    });\n    if (errorFlag) {\n      message.error('最终得分应在：【0~最大分值】之间。');\n    }\n  };\n\n  // 查询\n  function searchList() {\n    loadDetailList();\n  }\n  /**\n   * 重置\n   */\n  function resetFrom() {\n    searchInfo.evaluationTemplateDtlId = null;\n    searchInfo.stationId = null;\n  }\n\n  type Key = string | number;\n  const state = reactive<{\n    selectedRowKeys: Key[];\n    loading: boolean;\n  }>({\n    selectedRowKeys: [], // Check here to configure the default column\n    loading: false,\n  });\n  const hasSelected = computed(() => state.selectedRowKeys.length > 0);\n  const start = () => {\n    state.loading = true;\n    // ajax request after empty completing\n    setTimeout(() => {\n      state.loading = false;\n      state.selectedRowKeys = [];\n    }, 1000);\n  };\n  const onSelectChange = (selectedRowKeys: Key[]) => {\n    console.log('selectedRowKeys changed: ', selectedRowKeys);\n    state.selectedRowKeys = selectedRowKeys;\n  };\n\n  // 根据评价id获取明细列表\n  const loadDetailList = async () => {\n    let param = {\n      monthlyEvaluationId: formState.id,\n      stationId: searchInfo.stationId,\n      evaluationTemplateDtlId: searchInfo.evaluationTemplateDtlId,\n      indexKind: formState.indexKind,\n      sortField: searchInfo.sortField,\n      sortOrder: searchInfo.sortOrder,\n    };\n    let res = await getScoringList(param);\n    scoringList.value = res;\n  };\n\n  const changeTable: TableProps['onChange'] = (\n    pag: { pageSize: number; current: number },\n    filter,\n    sorter,\n  ) => {\n    if (sorter.order) {\n      searchInfo.sortField = sorter.field;\n      searchInfo.sortOrder = sorter.order.replace('end', '');\n    } else {\n      searchInfo.sortField = '';\n      searchInfo.sortOrder = '';\n    }\n    loadDetailList();\n  };\n  //-------------------------------------------------------流程相关操作-------------------------------------------------------------\n\n  const saveScoring = () => {\n    doSave(1);\n  };\n\n  const doSave = (status: number) => {\n    formState.scoringList = scoringList.value;\n    formState.status = status;\n    saveMonthlyDtl(formState)\n      .then(() => {\n        setTimeout(function () {\n          MsgManager.getInstance().sendMsg('scoring-evaluation', {});\n          addTabAndClose(`/po/integrated/assessmentevaluation/monthly/create?id=${formState.id}`);\n        }, 200);\n      })\n      .catch(() => {});\n  };\n\n  // 填充流程数和业务数据\n  const loadBizData = async () => {\n    let bizData = await getMonthlyById(formState.id);\n    // 加载流程信息\n    loadBizBaseInfo(bizData);\n    // 填充业务数据\n    assign(formState, bizData);\n    // 指标下拉框\n    allIndex();\n\n    // 电站下拉框\n    allStations();\n    // 加载明细数据；\n    loadDetailList();\n  };\n\n  const initColumns = async () => {\n    scoringColumns.value = getScoringColumns();\n  };\n\n  const loadBizBaseInfo = async (res: any) => {\n    let { billCode, fillinDate, personMemberName, deptName } = res;\n    Object.assign(billTitleOptions, { billCode, fillinDate, personMemberName, deptName });\n  };\n  onMounted(async () => {\n    await initColumns();\n    if (query.monthlyEvaluationId) {\n      // 根据评价id获取基础数据和标题等\n      formState.id = query.monthlyEvaluationId;\n      formState.indexKind = query.indexKind;\n      billTitleOptions.subject = query.kindName;\n      loadBizData();\n    }\n  });\n</script>\n<style lang=\"less\" scoped>\n  .form-but {\n    margin: 0 5px;\n  }\n\n  .fix-detail-page {\n    :deep(&.vben-page-wrapper-content.detail-content) {\n      margin: 0;\n    }\n  }\n</style>\n"],"names":["query","Memory","searchInfo","reactive","iProcess","ref","scoringColumns","scoringList","templateFormRef","formState","billTitleOptions","indexOptions","stationOptions","allIndex","__async","indexs","getIndexByKind","indexOpt","item","allStations","stations","getAllStations","stationOpt","changeAdj","record","addFinalScore","message","batachSetAdjustmentScore","errorFlag","state","searchList","loadDetailList","resetFrom","computed","onSelectChange","selectedRowKeys","param","res","getScoringList","changeTable","pag","filter","sorter","saveScoring","doSave","status","saveMonthlyDtl","MsgManager","addTabAndClose","loadBizData","bizData","getMonthlyById","loadBizBaseInfo","assign","initColumns","getScoringColumns","billCode","fillinDate","personMemberName","deptName","onMounted"],"mappings":"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"}