var h=(k,u,S)=>new Promise((V,v)=>{var j=p=>{try{Y(S.next(p))}catch(s){v(s)}},L=p=>{try{Y(S.throw(p))}catch(s){v(s)}},Y=p=>p.done?V(p.value):Promise.resolve(p.value).then(j,L);Y((S=S.apply(k,u)).next())});import{d as $e,aD as Oe,J as te,k as _,r as Ue,o as Ae,al as f,Z as I,a9 as P,aa as i,$,f as l,_ as Be,E as D,ad as w,u as c,ac as x,v as F,A as H,aG as Fe,aH as He}from"./vue-71d1abb3.js";import{h as M}from"./moment-4717c495.js";import{b as Ve,au as je,a0 as Le,av as C,at as y,ax as We,aC as Ge,a7 as qe,_ as ze}from"./index.js";import{b as Ze}from"./index-316f6ffb.js";import{D as Je}from"./Dialog-0a006d82.js";import{B as ne}from"./BasicTable-0434a334.js";import{T as Ke}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as oe}from"./useTable-109483b3.js";import"./antd-15ac76ed.js";import{e as Xe}from"./download-03e71dd5.js";import{d as Qe}from"./index-5d738211.js";import{b as se,c as ea,f as aa,h as ta,g as na}from"./index-9919c3bd.js";import{_ as oa}from"./StationPersonModal.vue_vue_type_script_setup_true_lang-9c4ac419.js";import{S as re,d as sa,a as ra}from"./attend.data-d9985a5d.js";import{a as le}from"./assign-37f1c13d.js";import"./useWindowSizeFn-13b1b8a2.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";const la=k=>(Fe("data-v-28d50549"),k=k(),He(),k),ia={class:"load"},da={class:"process-box"},ca={class:"header-box"},ua=la(()=>$("div",{class:"header-left"},"月排班",-1)),fa={key:0,class:"header-right"},ma={class:"content"},pa=$e({__name:"create",setup(k){const{t:u}=Ve(),{createConfirm:S,createMessage:V}=je(),{query:v}=Oe(),j=Le(),L=te(j.getUserInfo),Y=_(!1),p=_(),s=Ue({spinning:!1}),m=_(!1),N=_([]),O=_(),U=_(!1),[ie,{openModal:de}]=Ze(),[ce,{setProps:ue,getDataSource:W,getSelectRows:z,clearSelectedRowKeys:fe}]=oe({dataSource:O,columns:sa,bordered:!0,useSearchForm:!1,canResize:!1,pagination:!1,showTableSetting:!1,tableSetting:{fullScreen:!0},rowSelection:{type:"checkbox"}}),[me,{reload:pe,getSelectRows:he}]=oe({api:()=>na({stationId:s.stationId,beforeMonth:s.month,sortField:"month",sortOrder:"asc"}),columns:ra,pagination:!0,striped:!1,useSearchForm:!1,showTableSetting:!1,bordered:!0,showIndexColumn:!0,canResize:!0,rowSelection:{type:"radio"}}),ge=()=>h(this,null,function*(){const e=he();if(e.length==0){y.getInstance().warning("请选择历史排班");return}const a=yield se(e[0].id);a.result.forEach(n=>{ae(n,["Id","Name"])}),W().forEach(n=>{for(let o=0;o<a.result.length;o++){const r=a.result[o];if(M(n.day).format("DD")===M(r.day).format("DD")){n.dayPersonIds=r.dayPersonIds,n.dayPersonNames=r.dayPersonNames,n.nightPersonIds=r.nightPersonIds,n.nightPersonNames=r.nightPersonNames,n.unscheduledPersonId=r.unscheduledPersonId,n.unscheduledPersonName=r.unscheduledPersonName,n.remark=r.remark;break}}}),U.value=!1});function Z(e){if(!s.month){y.getInstance().warning("请选择月份");return}const a=z();if(!a||a.length===0){y.getInstance().warning("请选择排班明细行数据");return}const t={visible:!0},n=e===re.DAY?"白班批量设置":"夜班批量设置";de(t,{title:n,type:e,stationId:s.stationId})}function ye({values:e}){const a=z();W().forEach(n=>{a.forEach(o=>{o.day===n.day&&(e.type===re.DAY?(n.dayPersonIds=e.personIds,n.dayPersonNames=e.personNames):(n.nightPersonIds=e.personIds,n.nightPersonNames=e.personNames),J(n))})})}function J(e){let a=Array(),t=Array();if(e.dayPersonIds&&e.dayPersonIds.length>0&&e.nightPersonIds&&e.nightPersonIds.length>0){const n=[].concat(e.dayPersonIds).concat(e.nightPersonIds);for(let o=0;o<N.value.length;o++){const r=N.value[o].lable,g=N.value[o].value;n.includes(r)||(a.push(r),t.push(g))}}e.unscheduledPersonId=a.join(","),e.unscheduledPersonName=t.join(",")}function _e(e,a,t,n){const o=t.replace("Names","Ids");n[o]=a.map(r=>r.lable),J(n)}function Ie(){if(!s.month){y.getInstance().warning("请选择月份");return}U.value=!0,pe()}function ve(){if(!s.id){y.getInstance().warning("请保存数据后再导出");return}S({title:u("common.message.confirmTitle"),iconType:"warning",content:u("common.message.exportMessage"),onOk(){return h(this,null,function*(){const a={schedulingId:s.id,filename:"排班明细.xls"};yield ea(a).then(t=>{Xe(t==null?void 0:t.data,a.filename)}),a.filename="",V.success(u("common.exportSuccessText"))})}})}function be(){if(!s.id){y.getInstance().warning("请保存数据后再查看");return}We("/oa/attend/calendar","查看日历",te(s))}const Pe=e=>h(this,null,function*(){e.dayPersonIds=[],e.dayPersonNames=[],e.dayPersonId="",e.dayPersonName="",e.nightPersonIds=[],e.nightPersonNames=[],e.nightPersonId="",e.nightPersonName="",e.unscheduledPersonId="",e.unscheduledPersonName="",e.remark=""}),De=e=>h(this,null,function*(){const a=c(s);let t="",n="";const o=M(e);if(a.periodRule==="natural_month")t=o.startOf("month").format("YYYY-MM-DD"),n=o.endOf("month").format("YYYY-MM-DD"),s.period=`${t}~${n}`;else{const g=o.endOf("month").format("DD"),T=o.add(1,"month").format("YYYY-MM"),A=o.endOf("month").format("DD"),E=a.periodStartDay,B=a.periodEndDay,G=Q(E),q=Q(B);t=`${e}-${G}`,n=`${T}-${q}`,Number(E)>Number(g)&&(t=`${e}-${g}`),Number(B)>Number(A)&&(n=`${T}-${A}`)}const r=[];t&&n?s.period=`${t}~${n}`:s.period="",fe(),we(t,n,r)}),we=(e,a,t)=>{const n=M(e),o=K(e,t);O.value=[{day:e,week:X(e),dayType:o?"legal_holidays":"weekday",dayTypeText:o?"法定节假日":"工作日"}];let r=n.add(1,"days").format("YYYY-MM-DD");for(;r<=a;){const g=K(r,t);O.value.push({day:r,week:X(r),dayType:g?"legal_holidays":"weekday",dayTypeText:g?"法定节假日":"工作日"}),r=n.add(1,"days").format("YYYY-MM-DD")}},K=(e,a)=>{for(let n=0;n<a.length;n++){const o=a[n];if(e===o.firstDate||e===o.secondDate)return!1;if(e>=o.startDate&&e<=o.endDate)return!0}const t=M(e).day();return t===6||t===0};function X(e){switch(M(e).day()){case 1:return"星期一";case 2:return"星期二";case 3:return"星期三";case 4:return"星期四";case 5:return"星期五";case 6:return"星期六";case 0:return"星期日"}}function Q(e){return Number(e)<10?`0${e}`:e}function xe(e){return[{label:u("清除"),icon:C.DELETE,danger:!0,popConfirm:{title:"是否确认清除填写的数据",confirm:Pe.bind(null,e)}}]}const ee=()=>h(this,null,function*(){Ge(),qe.getInstance().sendMsg("oa-attend",{})}),ke=()=>{p.value.validate().then(()=>{const e=W();for(let a=0;a<e.length;a++){const t=e[a],n=t.dayPersonIds;if(!n||n.length==0){y.getInstance().warning(`${t.day}，请设置白班人员`);return}const o=t.nightPersonIds;if(!o||o.length==0){y.getInstance().warning(`${t.day}，请设置夜班人员`);return}}Se(e)}).catch(e=>{console.log("onSubmit=》error",e)})},Se=e=>h(this,null,function*(){s.spinning=!0;try{const a=c(s);e.forEach(t=>{Ye(t,["Id","Name"])}),a.detailList=e,yield aa(a).then(t=>{s.id=t.result,y.getInstance().success(u("common.saveSuccessText"))}),setTimeout(function(){ee()},200)}finally{s.spinning=!1}});function Ne(){Qe(s.stationId).then(e=>{N.value=[],e&&e.length>0&&e.forEach(a=>{N.value.push({value:a.name,lable:a.userId})})})}const Te=()=>h(this,null,function*(){if(le(s,v),v.id){const e=yield ta(v.id);le(s,e.result);const a=!!v.isReadonly;m.value=L.userId!==s.creator||a}ue({actionColumn:{width:80,title:u("common.operate"),dataIndex:"action",fixed:"right",ifShow:!m.value}})}),Me=()=>h(this,null,function*(){const e=yield se(s.id);e.result.forEach(a=>{ae(a,["Id","Name"])}),O.value=e.result});function Ce(){Ne()}function Ye(e,a){a.forEach(t=>{_(["dayPerson","nightPerson"]).value.forEach(o=>{const r=e[o+t+"s"];r&&r.length>0&&(e[o+t]=r.join(","))})})}function ae(e,a){a.forEach(t=>{_(["dayPerson","nightPerson"]).value.forEach(o=>{const r=e[o+t];r&&(e[o+t+"s"]=r.split(","))})})}return Ae(()=>h(this,null,function*(){yield Te(),yield Ce(),Me()})),(e,a)=>{const t=f("a-button"),n=f("a-input"),o=f("a-form-item"),r=f("a-col"),g=f("a-date-picker"),T=f("a-row"),A=f("a-textarea"),E=f("a-card"),B=f("a-form"),G=f("a-select"),q=f("a-spin"),Ee=f("PageWrapper");return I(),P(Ee,{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:i(()=>[$("div",ia,[l(q,{spinning:s.spinning,tip:"Loading..."},{default:i(()=>[$("div",da,[$("div",ca,[ua,m.value?x("",!0):(I(),Be("div",fa,[l(t,{type:"primary",onClick:ke,loading:Y.value},{default:i(()=>[D(w(c(u)("common.saveText")),1)]),_:1},8,["loading"]),l(t,{class:"!ml-2.5",onClick:ee},{default:i(()=>[D(w(c(u)("common.cancelText")),1)]),_:1})]))]),$("div",ma,[l(B,{ref_key:"formRef",ref:p,model:s,labelAlign:"right",autocomplete:"off"},{default:i(()=>[l(E,{title:"基本信息",bordered:!1},{default:i(()=>[l(T,{gutter:32},{default:i(()=>[F(l(r,{span:12},{default:i(()=>[l(o,{name:"stationName",label:"电站",labelCol:{class:"detail-label"}},{default:i(()=>[l(n,{disabled:"",value:s.stationName,"onUpdate:value":a[0]||(a[0]=d=>s.stationName=d)},null,8,["value"])]),_:1})]),_:1},512),[[H,!0]]),F(l(r,{span:12},{default:i(()=>[l(o,{label:"月份",name:"month",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请选择月份"}]},{default:i(()=>[l(g,{value:s.month,"onUpdate:value":a[1]||(a[1]=d=>s.month=d),picker:"month",format:"YYYY-MM","value-format":"YYYY-MM",style:"width: 100%",maxlength:7,onChange:De,disabled:m.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[H,!0]])]),_:1}),l(T,{gutter:32},{default:i(()=>[F(l(r,{span:12},{default:i(()=>[l(o,{name:"period",label:"排班周期",labelCol:{class:"detail-label"}},{default:i(()=>[l(n,{disabled:"",value:s.period,"onUpdate:value":a[2]||(a[2]=d=>s.period=d)},null,8,["value"])]),_:1})]),_:1},512),[[H,!0]])]),_:1}),l(T,{gutter:32},{default:i(()=>[F(l(r,{span:24},{default:i(()=>[l(o,{name:"remark",label:"备注",labelCol:{class:"detail-label"}},{default:i(()=>[l(A,{value:s.remark,"onUpdate:value":a[3]||(a[3]=d=>s.remark=d),row:"4",maxlength:1e3,"show-count":"",disabled:m.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[H,!0]])]),_:1})]),_:1})]),_:1},8,["model"]),l(E,{bordered:!1},{default:i(()=>[l(c(ne),{title:"排班明细",onRegister:c(ce)},{toolbar:i(()=>[m.value?x("",!0):(I(),P(t,{key:0,type:"primary",preIcon:c(C).SETTING,onClick:a[4]||(a[4]=d=>Z("day"))},{default:i(()=>[D(w(c(u)("白班批量设置")),1)]),_:1},8,["preIcon"])),m.value?x("",!0):(I(),P(t,{key:1,type:"primary",preIcon:c(C).SETTING,onClick:a[5]||(a[5]=d=>Z("night"))},{default:i(()=>[D(w(c(u)("夜班批量设置")),1)]),_:1},8,["preIcon"])),m.value?x("",!0):(I(),P(t,{key:2,class:"yellow-btn",preIcon:c(C).IMPORT,onClick:Ie},{default:i(()=>[D(w(c(u)("历史排版导入")),1)]),_:1},8,["preIcon"])),l(t,{class:"yellow-btn",preIcon:c(C).EXPORT,onClick:ve},{default:i(()=>[D(w(c(u)("common.action.export")),1)]),_:1},8,["preIcon"]),l(t,{type:"primary",preIcon:c(C).VIEW,onClick:be},{default:i(()=>[D(w(c(u)("查看日历")),1)]),_:1},8,["preIcon"])]),bodyCell:i(({column:d,record:b})=>[d.dataIndex==="dayPersonNames"||d.dataIndex==="nightPersonNames"?(I(),P(G,{key:0,value:b[d.dataIndex],"onUpdate:value":R=>b[d.dataIndex]=R,"show-search":"","allow-clear":"",mode:"multiple",style:{width:"100%"},options:N.value,onChange:(R,Re)=>_e(R,Re,d.dataIndex,b),disabled:m.value},null,8,["value","onUpdate:value","options","onChange","disabled"])):x("",!0),d.dataIndex==="remark"?(I(),P(n,{key:1,value:b[d.dataIndex],"onUpdate:value":R=>b[d.dataIndex]=R,title:b[d.dataIndex],maxlength:200,disabled:m.value},null,8,["value","onUpdate:value","title","disabled"])):x("",!0),d.key==="action"&&!m.value?(I(),P(c(Ke),{key:2,actions:xe(b)},null,8,["actions"])):x("",!0)]),_:1},8,["onRegister"])]),_:1})])])]),_:1},8,["spinning"]),l(oa,{onRegister:c(ie),onSuccess:ye},null,8,["onRegister"]),l(Je,{visible:U.value,"onUpdate:visible":a[6]||(a[6]=d=>U.value=d),title:"历史排班导入","force-render":"",onOk:ge,height:520},{default:i(()=>[l(c(ne),{onRegister:c(me),maxHeight:340},null,8,["onRegister"])]),_:1},8,["visible"])])]),_:1})}}});const La=ze(pa,[["__scopeId","data-v-28d50549"]]);export{La as default};
//# sourceMappingURL=create-41d1c574.js.map
