var x=(v,_,u)=>new Promise((h,w)=>{var t=c=>{try{f(u.next(c))}catch(C){w(C)}},R=c=>{try{f(u.throw(c))}catch(C){w(C)}},f=c=>c.done?h(c.value):Promise.resolve(c.value).then(t,R);f((u=u.apply(v,_)).next())});import{d as pe,aD as ce,r as S,k as F,o as ye,al as d,Z as y,a9 as k,aa as s,$ as b,f as o,u as p,E as fe,ac as N,_ as B,F as ge,ad as P,J as ve,aG as he,aH as Ie}from"./vue-71d1abb3.js";import{a as T}from"./index.esm-c216ed00.js";import{b as be,aB as _e,av as W,bP as we,aC as Ce,a7 as xe,_ as ke}from"./index.js";import{B as z}from"./BasicTable-0434a334.js";import{T as Ne}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as j}from"./useTable-109483b3.js";import{a2 as I}from"./antd-15ac76ed.js";import{_ as De}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{B as Se}from"./BillTitle-d17ab3e4.js";import{W as Be}from"./WfApproveBox-a3448232.js";import{U as Te}from"./UploadBox-636ecf02.js";import{c as Re,d as qe,f as Ee}from"./index-c462aef4.js";import{a as Fe,d as Qe}from"./index-e3dac917.js";import{b as Ue}from"./index-cfbcaec7.js";import{d as Oe}from"./index-5d738211.js";import{D as Me}from"./Dialog-0a006d82.js";import{P as Pe}from"./index-20519caf.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useContentViewHeight-7f845167.js";const We=v=>(he("data-v-7812abdb"),v=v(),Ie(),v),ze={class:"load"},je={class:"process-box"},Ae={class:"header-box"},Ve={class:"content"},He=We(()=>b("div",{class:"customer_require"},"实盘数量",-1)),Le={key:0,style:{color:"#dc0000"}},Ye={key:1,style:{color:"#338ed1"}},$e={key:2},Ke=pe({name:"InventoryCreate",__name:"create",setup(v){const{t:_}=be(),{query:u}=ce(),h=S({});h.subject="库存盘点";const w=F(),t=S({spinning:!1,processInstanceId:"",id:"",warehouseId:"",warehouseName:"",status:"",warehouseType:"",inventoryType:"",inventoryById:"",inventoryByName:"",inventoryDate:"",remark:"",stationOrganId:"",stationOrganName:"",stationId:"",stationName:"",bizFileId:""}),R=S({}),f=F(!1),c=[{key:"materialCode",title:"物料编码",dataIndex:"materialCode",align:"center",width:120},{key:"materialCategoryName",title:"物料类别",dataIndex:"materialCategoryName",align:"center",width:120},{key:"materialName",title:"物料名称",dataIndex:"materialName",align:"center",width:120},{key:"balanceQty",title:"结存数量",dataIndex:"balanceQty",align:"center",width:100},{key:"unitName",title:"单位",dataIndex:"unitName",align:"center",width:120}],C={baseColProps:{lg:6,md:8},labelWidth:90,schemas:[{label:"物料名称",field:"materialName",component:"Input"}]},[A,{reload:V,getSelectRows:H}]=j({api:Ue,rowKey:"warehousingDtlId",columns:c,useSearchForm:!0,formConfig:C,bordered:!0,pagination:!0,rowSelection:{type:"checkbox"},maxHeight:343,beforeFetch(e){return e.warehouseId=t.warehouseId,e}}),L=()=>{const e=H();if(e.length==0)return I.warning("请选择入库批次。"),!1;const a=D();for(let n=0;n<e.length;n++){if(a.filter(q=>q.warehousingDtlId==e[n].warehousingDtlId).length>0)return I.warning("入库批次：'"+e[n].warehousingCode+"'，物料：'"+e[n].materialName+"'已存在。"),!1;const m={materialId:e[n].materialId,materialCode:e[n].materialCode,materialName:e[n].materialName,materialWholeName:e[n].materialWholeName,materialCategoryId:e[n].materialCategoryId,materialCategoryName:e[n].materialCategoryName,billCode:e[n].warehousingCode,warehousingDtlId:e[n].warehousingDtlId,qty:e[n].qty,remark:e[n].remark,unitId:e[n].unitId,unitName:e[n].unitName,balanceQty:e[n].balanceQty,warehousingQty:e[n].warehousingQty,editable:!0,key:`${Date.now()}`};a.push(m)}f.value=!1},Q=F([]);function Y(e,a){t.inventoryNames=a.map(n=>n.label)}function U(){Oe(t.stationId).then(e=>{e&&e.length>0&&e.forEach(a=>{Q.value.push({value:a.userId,label:a.name})})})}const $=()=>{f.value=!0,V()},K=e=>{if(e.id)Qe(e.id).then(()=>{O(),I.success("操作成功。")});else{const a=D(),n=a.indexOf(e);n!==-1&&a.splice(n,1)}},G=[{title:"盘点单号",dataIndex:"billCode",width:160},{title:"物料编码",dataIndex:"materialCode",width:120},{title:"物料类别",dataIndex:"materialCategoryName",width:120},{title:"物料名称",dataIndex:"materialName",width:120},{title:"结存数量",dataIndex:"qty",width:120},{slots:{title:"inventoryQty"},dataIndex:"inventoryQty",width:120},{title:"盘点结果",dataIndex:"inventoryResult",width:120},{title:"备注",dataIndex:"remark",width:200}],J=(e,a,n,r)=>{console.log(e,a,n,r)},Z=S({}),[X,{reload:O,getDataSource:D}]=j({api:Fe,pagination:!1,bordered:!0,columns:G,formConfig:{labelWidth:120},useSearchForm:!1,actionColumn:{width:140,title:_("common.operate"),dataIndex:"action",fixed:"right"},onChange:J,immediate:!1,beforeFetch(e){return e.inventoryId=t.id,T(e,Z),e},showTableSetting:!1}),ee=()=>x(this,null,function*(){we().then(e=>{t.bizFileId=e})}),te=e=>e==null,ae=()=>{M(0)},ne=()=>{w.value.validate().then(()=>{const e=D();if(e.length==0)return I.warning("请添加盘点明细。"),!1;if(e.filter(n=>te(n.inventoryQty)||n.inventoryQty<0).length>0)return I.warning("请填写实盘数量。"),!1;M(1)}).catch(e=>{console.log("error",e)})},M=e=>x(this,null,function*(){t.spinning=!0;try{t.inventoryById=t.inventoryIds.join(","),t.inventoryByName=t.inventoryNames.join(",");const a=ve(t);a.status=e,a.dtlList=D();const n=yield qe(a);t.id=n.result,I.success(e==1?"提交成功。":"保存成功"),e==1&&setTimeout(()=>{Ce(),xe.getInstance().sendMsg("inventory-page",{})},100)}catch(a){console.log("error",a)}finally{t.spinning=!1}}),oe=()=>x(this,null,function*(){Ee(t.id).then(e=>{t.inventoryIds=e.inventoryById.split(","),t.inventoryNames=e.inventoryByName.split(","),T(t,e),t.processInstanceId||(t.processInstanceId=u.processInstanceId);let{billCode:a,fillinDate:n,personMemberName:r,deptName:m}=e;Object.assign(h,{billCode:a,fillinDate:n,personMemberName:r,deptName:m}),U(),O()})});return ye(()=>x(this,null,function*(){u.processInstanceId?(t.processInstanceId=u.processInstanceId,_e(u.processInstanceId).then(e=>{t.id=e.businessKey,oe()})):Re().then(e=>{T(t,e),T(t,u),ee();let{billCode:a,fillinDate:n,personMemberName:r,deptName:m}=e;Object.assign(h,{billCode:a,fillinDate:n,personMemberName:r,deptName:m}),U(),t.status=0})})),(e,a)=>{const n=d("a-input"),r=d("a-form-item"),m=d("a-col"),q=d("a-date-picker"),se=d("a-select"),ie=d("a-textarea"),le=d("a-row"),E=d("a-card"),re=d("a-button"),de=d("a-input-number"),me=d("a-form"),ue=d("a-spin");return y(),k(p(Pe),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:s(()=>[b("div",ze,[o(ue,{spinning:t.spinning,tip:"Loading..."},{default:s(()=>[b("div",je,[b("div",Ae,[o(Se,{options:h},null,8,["options"]),o(Be,{onSave:ae,onSubmit:ne,processInstanceId:t.processInstanceId,processStatus:t.status},null,8,["processInstanceId","processStatus"])]),b("div",Ve,[o(me,{ref_key:"formRef",ref:w,model:t,labelAlign:"right",autocomplete:"off",scrollToFirstError:!0},{default:s(()=>[o(E,{title:"基本信息",bordered:!1},{default:s(()=>[o(le,{gutter:32},{default:s(()=>[o(m,{span:12},{default:s(()=>[o(r,{name:"warehouseName",label:"库房名称",labelCol:{span:4}},{default:s(()=>[o(n,{disabled:"",value:t.warehouseName,"onUpdate:value":a[0]||(a[0]=i=>t.warehouseName=i)},null,8,["value"])]),_:1})]),_:1}),o(m,{span:12},{default:s(()=>[o(r,{name:"inventoryType",label:"盘点类型",labelCol:{span:4},rules:[{required:!0,message:"请选择盘点类型"}]},{default:s(()=>[o(De,{type:"po_inventory_type",disabled:t.status!=0,onChange:a[1]||(a[1]=i=>"()=> formState.inventoryType = value"),value:t.inventoryType,"onUpdate:value":a[2]||(a[2]=i=>t.inventoryType=i),style:{width:"100%"}},null,8,["disabled","value"])]),_:1})]),_:1}),o(m,{span:12},{default:s(()=>[o(r,{label:"盘点日期",name:"inventoryDate",labelAlign:"right",labelCol:{span:4},rules:[{required:!0,message:"请选择盘点日期"}]},{default:s(()=>[o(q,{value:t.inventoryDate,"onUpdate:value":a[3]||(a[3]=i=>t.inventoryDate=i),style:{"min-width":"100%"},"value-format":"YYYY-MM-DD",disabled:t.status!=0},null,8,["value","disabled"])]),_:1})]),_:1}),o(m,{span:12},{default:s(()=>[o(r,{name:"inventoryIds",label:"盘点人",labelCol:{span:4},rules:[{required:!0,message:"请选择盘点人"}]},{default:s(()=>[o(se,{value:t.inventoryIds,"onUpdate:value":a[4]||(a[4]=i=>t.inventoryIds=i),"show-search":"","allow-clear":"",mode:"multiple",style:{width:"100%"},options:Q.value,onChange:Y,disabled:t.status!=0},null,8,["value","options","disabled"])]),_:1})]),_:1}),o(m,{span:24,class:"textarea-item"},{default:s(()=>[o(r,{label:"说明",name:"remark",labelAlign:"right",labelCol:{span:2}},{default:s(()=>[o(ie,{rows:5,value:t.remark,"onUpdate:value":a[5]||(a[5]=i=>t.remark=i),placeholder:"128字以内",maxlength:128,disabled:t.status!=0},null,8,["value","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),o(E,{bordered:!1},{default:s(()=>[o(p(z),{title:"盘点明细",onRegister:p(X)},{toolbar:s(()=>[t.status===0?(y(),k(re,{key:0,type:"primary",preIcon:p(W).ADD,onClick:$},{default:s(()=>[fe(" 添加 ")]),_:1},8,["preIcon"])):N("",!0)]),inventoryQty:s(()=>[He]),bodyCell:s(({column:i,record:l})=>[i.dataIndex==="inventoryQty"?(y(),k(de,{key:0,value:l[i.dataIndex],"onUpdate:value":g=>l[i.dataIndex]=g,min:0,disabled:t.status!=0,rules:[{required:!0,message:"请填写实盘数量"}],step:.01,parser:g=>g.match(/^[0-9]*\.([0-9]{0,2})|^[0-9]*/)[0],onChange:g=>{g-l.qty==0?l.inventoryResult="":l.inventoryResult=(g-l.qty).toFixed(2)}},null,8,["value","onUpdate:value","disabled","parser","onChange"])):N("",!0),i.dataIndex==="inventoryResult"?(y(),B(ge,{key:1},[l.inventoryResult<0?(y(),B("span",Le,P(l.inventoryResult),1)):l.inventoryResult>0?(y(),B("span",Ye,P(l.inventoryResult),1)):(y(),B("span",$e))],64)):N("",!0),i.dataIndex==="remark"?(y(),k(n,{key:2,value:l[i.dataIndex],"onUpdate:value":g=>l[i.dataIndex]=g,disabled:t.status!=0,maxlength:10},null,8,["value","onUpdate:value","disabled"])):N("",!0),i.key==="action"?(y(),k(p(Ne),{key:3,actions:[{icon:p(W).DELETE,danger:!0,label:p(_)("common.delText"),ifShow:()=>t.status===0,popConfirm:{title:p(_)("common.message.delMessage"),placement:"left",confirm:K.bind(null,l)}}]},null,8,["actions"])):N("",!0)]),_:1},8,["onRegister"])]),_:1})]),_:1},8,["model"]),o(E,{title:"附件信息",bordered:!1},{default:s(()=>[o(Te,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"inventory",vmode:t.status==0?"box":"view",bizId:t.bizFileId},null,8,["vmode","bizId"])]),_:1})]),b("div",null,[o(Me,{visible:f.value,"onUpdate:visible":a[6]||(a[6]=i=>f.value=i),width:1e3,title:"选择物料",onOk:L,maskClosable:!1},{default:s(()=>[o(p(z),{onRegister:p(A),class:"table-in-dialog",searchInfo:R},null,8,["onRegister","searchInfo"])]),_:1},8,["visible"])])])]),_:1},8,["spinning"])])]),_:1})}}});const qt=ke(Ke,[["__scopeId","data-v-7812abdb"]]);export{qt as default};
//# sourceMappingURL=create-ff799da3.js.map
