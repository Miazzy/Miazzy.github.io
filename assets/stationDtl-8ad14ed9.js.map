{"version":3,"file":"stationDtl-8ad14ed9.js","sources":["../../src/views/po/integrated/assessmentevaluation/monthly/stationDtl.vue"],"sourcesContent":["<template>\n  <div class=\"load\">\n    <div class=\"process-box\">\n      <div class=\"header-box\">\n        <!-- 标题 -->\n        <BillTitle :options=\"billTitleOptions\" />\n        <!-- <PrintButton v-if=\"formState.status === 2 ? true : false\" /> -->\n      </div>\n      <!-- 表单内容 -->\n      <div class=\"content\">\n        <a-form ref=\"templateFormRef\" :model=\"formState\" name=\"Form\">\n          <a-card title=\"基础信息\" :bordered=\"false\">\n            <a-row :gutter=\"32\">\n              <a-col v-show=\"true\" :span=\"12\">\n                <a-form-item label=\"主题\" name=\"subject\" labelAlign=\"right\" :labelCol=\"{ span: 4 }\">\n                  <a-input\n                    v-model:value=\"formState.subject\"\n                    disabled\n                    style=\"width: 100%\"\n                    maxlength=\"128\"\n                  />\n                </a-form-item>\n              </a-col>\n              <a-col v-show=\"true\" :span=\"12\">\n                <a-form-item\n                  label=\"评价周期\"\n                  name=\"evaluationPeriod\"\n                  labelAlign=\"right\"\n                  :labelCol=\"{ span: 4 }\"\n                >\n                  <a-date-picker\n                    v-model:value=\"formState.evaluationPeriod\"\n                    value-format=\"YYYY-MM\"\n                    disabled\n                    style=\"min-width: 100%\"\n                    picker=\"month\"\n                  />\n                </a-form-item>\n              </a-col>\n            </a-row>\n            <a-row :gutter=\"32\">\n              <a-col v-show=\"true\" :span=\"12\">\n                <a-form-item\n                  label=\"电站\"\n                  name=\"stationId\"\n                  labelAlign=\"right\"\n                  :rules=\"[{ required: true, message: '请输选择电站' }]\"\n                  :labelCol=\"{ span: 4 }\"\n                >\n                  <a-select\n                    v-model:value=\"formState.stationId\"\n                    allow-clear\n                    placeholder=\"请选择电站\"\n                    :options=\"stationOptions\"\n                  />\n                </a-form-item>\n              </a-col>\n              <a-col v-show=\"true\" :span=\"12\" style=\"text-align: right\">\n                <!-- <a-form-item label=\"1111\" labelAlign=\"right\" :labelCol=\"{ span: 16 }\"> -->\n                <a-button style=\"margin-right: 10px\" @click=\"resetFrom\">重置</a-button>\n                <a-button type=\"primary\" @click=\"searchList\">查询</a-button>\n                <!-- </a-form-item> -->\n              </a-col>\n            </a-row>\n          </a-card>\n        </a-form>\n        <a-card title=\"得分详情\" :bordered=\"false\">\n          <template #extra>\n            <div style=\"display: flex; justify-content: flex-end\">\n              <a-button class=\"tab-button\" :preIcon=\"IconEnum.VIEW\" @click=\"openTemplateDtl\"\n                >查看评价模板</a-button\n              >\n              <a-button\n                class=\"tab-button\"\n                style=\"margin-right: 16px\"\n                :preIcon=\"IconEnum.DOWNLOAD\"\n                @click=\"exportDetailList\"\n                >导出</a-button\n              >\n            </div>\n          </template>\n        </a-card>\n        <!-- 数据表格 -->\n        <a-table\n          style=\"margin: 0 8px\"\n          :columns=\"stationDtlColumns\"\n          :data-source=\"stationDtlList\"\n          :pagination=\"false\"\n          size=\"small\"\n          bordered\n          :scroll=\"{ x: 480, y: 600 }\"\n          @change=\"changeTable\"\n          @resize-column=\"(w, col) => (col.width = w)\"\n        >\n          <template #bodyCell=\"{ column, text, record }\">\n            <template v-if=\"column.dataIndex === 'weightScore' && record.difference != 0\"\n              >{{ text }}({{ record.difference }})\n            </template></template\n          >\n        </a-table>\n      </div>\n    </div>\n  </div>\n</template>\n<script lang=\"ts\" setup>\n  import { computed, onMounted, reactive, ref, unref, UnwrapRef } from 'vue';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { useRouter } from 'vue-router';\n  import { IconEnum } from '@/enums/appEnum';\n  import { assign } from 'lodash-es';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import DictSelectBox from '@/components/Framework/Combox/DictSelectBox.vue';\n  // import { Icon } from '@iconify/vue';\n  import Icon from '@/components/Icon/Icon.vue';\n  import { message, FormInstance } from 'ant-design-vue';\n  import { PlusOutlined, RestOutlined } from '@ant-design/icons-vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import { jsonToSheetXlsx } from '/@/components/Excel';\n  import { getStationDtlColumns, getStationDtlList, getAllStations, getMonthlyById } from './monthly';\n  import { addTabPage } from '@/utils/route';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import PrintButton from '/@/components/Framework/Button/PrintButton.vue';\n  import { Memory } from '@/router/index';\n\n  const { createConfirm } = useMessage();\n\n  const router = useRouter();\n  const { currentRoute } = router;\n  const route = unref(currentRoute);\n  const query = Memory.getInstance().getQuery(); // route.query;\n  interface FormState {}\n  const stationDtlColumns = ref([]);\n  const stationDtlList = ref([]);\n  const templateFormRef = ref<FormInstance>();\n  const formState: UnwrapRef<FormState> = reactive({ status: 0 });\n  const billTitleOptions = reactive<any>({});\n  const stationOptions = ref<any>([{ label: 'aaa', value: 1 }]); //电站\n  billTitleOptions.subject = '电站得分详情';\n  billTitleOptions.infoItems = [];\n  //-------------------------------------------------------明细相关-------------------------------------------------------------\n  // 查询参与评价的所有电站\n  const allStations = async () => {\n    let stations = await getAllStations({\n      monthlyEvaluationId: formState.id,\n    });\n    let stationOpt = [];\n    stations.forEach((item) => {\n      stationOpt.push({ value: item.stationId, label: item.stationName });\n    });\n    stationOptions.value = stationOpt;\n  };\n\n  const searchInfo = reactive({});\n  // 根据评价id获取明细列表\n  const loadDetailList = async () => {\n    let param = {\n      id: formState.id,\n      stationId: formState.stationId,\n      evaluationTemplateDtlId: formState.evaluationTemplateDtlId,\n      sortField: searchInfo.sortField,\n      sortOrder: searchInfo.sortOrder,\n    };\n    let res = await getStationDtlList(param);\n    stationDtlList.value = res;\n  };\n\n  // 查询\n  const searchList = async () => {\n    templateFormRef.value.validateFields().then(async () => {\n      let monthly = await getMonthlyByPeriod({ evaluationPeriod: formState.evaluationPeriod });\n      // 填充业务数据\n      if (monthly == null) {\n        formState.id = '';\n        formState.evaluationTemplateDtlId = '';\n      } else {\n        assign(formState, monthly);\n      }\n      loadDetailList();\n    });\n  };\n  /**\n   * 重置\n   */\n  function resetFrom() {\n    formState.stationId = null;\n  }\n\n  const changeTable: TableProps['onChange'] = (\n    pag: { pageSize: number; current: number },\n    filter,\n    sorter,\n  ) => {\n    if (sorter.order) {\n      searchInfo.sortField = sorter.field;\n      searchInfo.sortOrder = sorter.order.replace('end', '');\n    } else {\n      searchInfo.sortField = '';\n      searchInfo.sortOrder = '';\n    }\n    loadDetailList();\n  };\n\n  // 跳转到模板明细\n  function openTemplateDtl() {\n    // let param = { monthlyEvaluationId: formState.id, evaluationType: item.type };\n    if (formState.evaluationTemplateId != null) {\n      // router.push(\n      //  `/po/integrated/assessmentevaluation/template/templateCreate?templateId=${formState.evaluationTemplateId}`,\n      // );\n      addTabPage(\n        `/po/integrated/assessmentevaluation/template/templateCreate?id=${formState.evaluationTemplateId}`,\n        '查看评价模板',\n      );\n    }\n  }\n\n  // 导出明细数据\n  function exportDetailList() {\n    if (stationDtlList.value?.length > 0) {\n      createConfirm({\n        title: '提示',\n        iconType: 'warning',\n        content: '确定要导出所有记录？',\n        async onOk() {\n          let exportDataList = [];\n          let header = {};\n\n          stationDtlList.value.forEach((item) => {\n            delete item.monthlyEvaluationDtlId;\n            delete item.indexKind;\n            delete item.evaluationMethod;\n            exportDataList.push(item);\n          });\n          stationDtlColumns.value.forEach((item) => {\n            header[item.dataIndex] = item.title;\n          });\n\n          jsonToSheetXlsx({\n            data: exportDataList,\n            header: header,\n            filename: '电站得分详情.xlsx',\n          });\n        },\n      });\n    } else {\n      message.info('无数据，不能导出。');\n    }\n  }\n\n  const changeMonth = async () => {};\n  //-------------------------------------------------------流程相关操作-------------------------------------------------------------\n\n  // 填充流程数和业务数据\n  const loadBizData = async () => {\n    if (formState.id != null) {\n      let monthly = await getMonthlyById(formState.id);\n      // 填充业务数据\n      assign(formState, monthly);\n      // 加载流程信息\n      loadBizBaseInfo(monthly);\n      // 电站下拉框\n      allStations();\n      // 加载明细数据；\n      loadDetailList();\n    }\n  };\n\n  const loadBizBaseInfo = async (res: any) => {\n    let { billCode, fillinDate, personMemberName, deptName } = res;\n    Object.assign(billTitleOptions, { billCode, fillinDate, personMemberName, deptName });\n  };\n  const initColumns = async () => {\n    stationDtlColumns.value = getStationDtlColumns();\n  };\n  onMounted(async () => {\n    assign(formState, query);\n    await initColumns();\n    if (query.id) {\n      // 根据评价id获取基础数据和标题等\n      loadBizData();\n    }\n  });\n</script>\n<style lang=\"less\" scoped>\n  .textarea-item {\n    :deep(.ant-form-item-control-input-content) {\n      margin-left: 20px;\n    }\n  }\n\n  .tab-button {\n    margin: 4px;\n  }\n\n  .tab-button-div {\n    height: 60px;\n    padding: 14px;\n    background: white;\n  }\n</style>\n"],"names":["createConfirm","useMessage","router","useRouter","currentRoute","unref","query","Memory","stationDtlColumns","ref","stationDtlList","templateFormRef","formState","reactive","billTitleOptions","stationOptions","allStations","__async","stations","getAllStations","stationOpt","item","searchInfo","loadDetailList","param","res","getStationDtlList","searchList","monthly","assign","resetFrom","changeTable","pag","filter","sorter","openTemplateDtl","addTabPage","exportDetailList","_a","exportDataList","header","jsonToSheetXlsx","message","loadBizData","getMonthlyById","loadBizBaseInfo","billCode","fillinDate","personMemberName","deptName","initColumns","getStationDtlColumns","onMounted"],"mappings":"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"}