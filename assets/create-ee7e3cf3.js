var Y=(o,q,h)=>new Promise((d,y)=>{var N=p=>{try{w(h.next(p))}catch(D){y(D)}},A=p=>{try{w(h.throw(p))}catch(D){y(D)}},w=p=>p.done?d(p.value):Promise.resolve(p.value).then(N,A);w((h=h.apply(o,q)).next())});import{P as me}from"./index-20519caf.js";import{a5 as T,a0 as ve,aj as fe,aB as Ie,aD as G,av as be,at as S,aC as ge,a7 as xe,_ as _e}from"./index.js";import{B as he}from"./BasicTable-0434a334.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as ye}from"./useTable-109483b3.js";import"./antd-15ac76ed.js";import{B as we}from"./BillTitle-d17ab3e4.js";import{W as De}from"./WfApproveBox-a3448232.js";import{_ as Ce}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{D as Te}from"./Dialog-0a006d82.js";import{S as Ne}from"./SearchBox-22bb02d6.js";import{U as J}from"./UploadBox-636ecf02.js";import{d as Se,J as Ue,e as Ae,k as I,r as K,o as ke,al as u,Z as b,a9 as g,aa as s,$ as _,f as n,u as U,ag as Pe,ac as x,E as j,aG as Me,aH as qe}from"./vue-71d1abb3.js";import"./useContentViewHeight-7f845167.js";import"./useWindowSizeFn-13b1b8a2.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";const Fe="/po/equipment/page";function Ee(o){return T.get({url:"/po/inspection-execution/dtl/list",params:o})}function Re(o){return T.get({url:"/po/inspection-execution/get",params:o})}function ze(o){return T.post({url:"/po/inspection-execution/create",params:o})}function Be(o){return T.get({url:"/po/inspection-plan/dtl/list",params:o})}function Oe(o){return T.get({url:"/po/inspection-plan/selectInspectionAreaType",params:o})}function Ye(o){return T.post({url:"/baseset/common/list-stationPerson?stationId="+o})}const je=[{title:"项目",dataIndex:"indexItem",align:"left",headAlign:"center",width:80},{title:"巡检内容及标准",dataIndex:"indexContent",align:"left",headAlign:"center",width:260},{slots:{title:"result"},dataIndex:"result",width:160,align:"left"},{slots:{title:"needRectification"},align:"left",headAlign:"center",dataIndex:"needRectification",width:100},{title:"计划整改措施",dataIndex:"rectificationMeasures",width:160},{title:"计划完成日期",dataIndex:"finishedRectificationDate",width:120},{title:"隐患类别",dataIndex:"hiddenDangerType",width:160},{title:"检查附件",dataIndex:"bizFileId",width:160}],L=o=>(Me("data-v-86ea8f5b"),o=o(),qe(),o),He={class:"load"},Ve={class:"process-box"},We={class:"header-box"},$e={class:"content"},Ge=L(()=>_("div",{class:"customer_require"},"巡检结果",-1)),Je=L(()=>_("div",{class:"customer_require"},"是否整改",-1)),Ke={style:{padding:"0 10px"}},Le=Se({__name:"create",setup(o){const q=ve(),h=Ue(q.getUserInfo),d=Ae(()=>e.status!=0||e.status==0&&e.personMemberId!=""&&e.personMemberId.substring(0,32)!=h.userId),y=I(!1),N=I(!1),A=I(""),w=I(""),p=I(""),D=I(),k=I([]),F=I([]);let{params:v}=fe();const e=K({id:v.id||"",subject:"",stationName:v.stationName||"",stationId:v.stationId||"",stationOrganName:v.stationOrganName||"",stationOrganId:v.stationOrganId||"",powerStationType:v.stationType,status:0,billCode:"",fillinDate:"",personMemberId:"",spinning:!1,planId:"",planName:"",inspectionData:"",inspectionAreaType:"",deviceId:"",deviceName:"",weather:"",temperature:"",inspectorId:"",inspectorName:"",description:"",inspectionPeriod:"",dtl:{},bizFileId:""}),H=K({subject:"巡检执行"}),Z=()=>{k.value.length==0&&(e.inspectionData?S.getInstance().error("该巡检时间下没有巡检区域."):S.getInstance().error("请先选择巡检时间."))},Q=l=>{e.inspectionAreaType="",e.inspectionPeriod="",k.value=[],de([]),l&&Oe({stationId:e.stationId,inspectionDate:l}).then(t=>{t.result.forEach(i=>{k.value.push({value:i.inspectionAreaType,label:i.inspectionAreaTypeText,planName:i.subject,planId:i.planId,planStationId:i.planStationId,inspectionPeriodText:i.inspectionPeriodText,acount:i.acount})})})},E=()=>{e.dtl=z(),e.spinning=!0,ze(e).then(l=>{l.result!=""?(N.value=!1,e.id=l.result,S.getInstance().success(e.status==1?"提交成功":"保存成功."),e.status==1?setTimeout(()=>{ge(),xe.getInstance().sendMsg("inspection-execution",{})},100):R()):(e.status=0,S.getInstance().error("保存失败.")),e.spinning=!1}).catch(l=>{e.status=0,e.spinning=!1,console.log(l)})},X=()=>{P.value=!0},ee=()=>{let l=z(),t=0;l.forEach(()=>{oe(t,"result",p.value),t++}),P.value=!1},te=()=>({stationId:e.stationId,status:1}),ae=[{title:"设备名称",dataIndex:"name",width:120},{title:"物料",dataIndex:"materialName",width:120},{title:"生产厂家",dataIndex:"factoryName",width:120},{title:"区域",dataIndex:"areaName",width:120}],ne=(l,t)=>{let i=t.record;e.deviceId=i.key,e.deviceName=i.name},se=()=>Y(this,null,function*(){if(N.value||!e.id){let l=[];return(yield Be({inspectionPlanId:e.planId})).result.forEach(i=>{l.push({planDetailId:i.id,indexId:i.indexId,needRectification:0,indexItem:i.indexItem,indexContent:i.indexContent,bizFileId:G()})}),l}else return(yield Ee({inspectionExecutionId:e.id})).result}),le=(l,t)=>{e.inspectionAreaType=l,e.planId=t.planId,e.planName=t.planName,e.planStationId=t.planStationId,N.value=!0,e.inspectionPeriod=t.inspectionPeriodText+t.acount+"次",y.value=l==="PvAreaDev",l!=="PvAreaDev"&&(e.deviceName="",e.deviceId=""),R()},[ie,{reload:R,getDataSource:z,updateTableData:oe,setTableData:de}]=ye({api:se,columns:je,bordered:!0,useSearchForm:!1,showTableSetting:!1,pagination:!1}),P=I(!1),B={handleAgree:l=>{console.log("同意",l)},handleSave:l=>{console.log("保存",l),e.status=0,E()},handleSubmit:l=>{console.log("提交",l),e.status=1;const t=D.value;t&&t.validateFields().then(()=>{if(z().length===0){S.getInstance().info("巡检清单不能为空");return}E()}).catch(i=>{console.log(i),e.status=0})}};return ke(()=>Y(this,null,function*(){if(w.value=v.processInstanceId,!e.id&&v.processInstanceId){const l=yield Ie(v.processInstanceId);e.id=l.businessKey}Re({id:e.id}).then(l=>{let t=l.result;if(e.id){for(let C in t)e[C]=t[C];e.status=Number(e.status),y.value=e.inspectionAreaType==="PvAreaDev",R()}else e.billCode=t.billCode,e.personMemberName=t.personMemberName,e.deptName=t.deptName,e.fillinDate=t.fillinDate,e.bizFileId=G();let{billCode:i,fillinDate:c,personMemberName:m,deptName:M}=t;Object.assign(H,{billCode:i,fillinDate:c,personMemberName:m,deptName:M})}).then(()=>{e.status==0?Ye(e.stationId).then(l=>{let t={};l.result.forEach(i=>{t[i.userId]=i.name});for(let i in t)F.value.push({label:t[i],value:i})}):F.value.push({value:e.inspectorId,label:e.inspectorName})})})),(l,t)=>{const i=u("a-input"),c=u("a-form-item"),m=u("a-col"),M=u("a-date-picker"),C=u("a-select"),V=u("a-input-number"),W=u("a-textarea"),re=u("a-row"),O=u("a-card"),$=u("a-select-option"),ue=u("a-button"),pe=u("a-form"),ce=u("a-spin");return b(),g(U(me),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:s(()=>[_("div",He,[n(ce,{spinning:e.spinning,tip:"Loading..."},{default:s(()=>[_("div",Ve,[_("div",We,[n(we,{options:H},null,8,["options"]),n(De,{processInstanceId:w.value,onAgree:B.handleAgree,onSave:B.handleSave,onSubmit:B.handleSubmit,processStatus:e.status,listenMessage:"inspection-execution"},null,8,["processInstanceId","onAgree","onSave","onSubmit","processStatus"])]),_("div",$e,[n(pe,{model:e,name:"basic",ref_key:"formRef",ref:D,autocomplete:"off",onFinish:E},{default:s(()=>[n(O,{title:"基本信息",bordered:!1},{default:s(()=>[n(re,{gutter:32},{default:s(()=>[n(m,{span:12},{default:s(()=>[n(c,{label:"电站名称",name:"formState.stationName",labelCol:{style:{width:"124px"}},rules:[{required:!1}]},{default:s(()=>[n(i,{value:e.stationName,"onUpdate:value":t[0]||(t[0]=a=>e.stationName=a),disabled:"true"},null,8,["value"])]),_:1})]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"巡检时间",name:"inspectionData",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"巡检时间不能为空。"}]},{default:s(()=>[n(M,{disabled:d.value,"show-time":"",value:e.inspectionData,"onUpdate:value":t[1]||(t[1]=a=>e.inspectionData=a),format:"YYYY-MM-DD HH:mm",valueFormat:"YYYY-MM-DD HH:mm",style:{width:"100%"},onChange:Q},null,8,["disabled","value"])]),_:1})]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"巡检区域",name:"inspectionAreaType",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"巡检区域不能为空。"}]},{default:s(()=>[n(C,{value:e.inspectionAreaType,"onUpdate:value":t[2]||(t[2]=a=>e.inspectionAreaType=a),"allow-clear":"",options:k.value,disabled:d.value,onChange:le,onClick:Z},null,8,["value","options","disabled"])]),_:1})]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"巡检设备",name:"deviceId",labelCol:{style:{width:"124px"}},rules:[{required:y.value,message:"巡检设备不能为空。"}]},{default:s(()=>[n(Ne,{searchText:A.value,"onUpdate:searchText":t[3]||(t[3]=a=>A.value=a),value:e.deviceName,"onUpdate:value":t[4]||(t[4]=a=>e.deviceName=a),columns:ae,disabled:d.value,api:U(Fe),apiParamFunc:te,pagination:!0,style:{width:"100%"},onChange:ne},null,8,["searchText","value","disabled","api"])]),_:1},8,["rules"])]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"天气情况",name:"weather",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"天气情况不能为空"}]},{default:s(()=>[n(i,{value:e.weather,"onUpdate:value":t[5]||(t[5]=a=>e.weather=a),disabled:d.value,maxlength:"32"},null,8,["value","disabled"])]),_:1})]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"气温(℃)",name:"temperature",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"气温(℃)不能为空"}]},{default:s(()=>[n(V,{value:e.temperature,"onUpdate:value":t[6]||(t[6]=a=>e.temperature=a),min:"-50",max:"100",disabled:d.value},null,8,["value","disabled"])]),_:1})]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"巡查人",name:"inspectorId",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"巡查人不能为空"}]},{default:s(()=>[n(C,{value:e.inspectorId,"onUpdate:value":t[7]||(t[7]=a=>e.inspectorId=a),allowClear:"",options:F.value,disabled:d.value,onChange:t[8]||(t[8]=(a,r)=>{e.inspectorId=a,e.inspectorName=r.label})},null,8,["value","options","disabled"])]),_:1})]),_:1}),n(m,{span:12},{default:s(()=>[n(c,{label:"巡检频率",name:"inspectionPeriod",labelCol:{style:{width:"124px"}},rules:[{required:!1}]},{default:s(()=>[n(V,{value:e.inspectionPeriod,"onUpdate:value":t[9]||(t[9]=a=>e.inspectionPeriod=a),disabled:"true"},null,8,["value"])]),_:1})]),_:1}),n(m,{span:24},{default:s(()=>[n(c,{label:"异常情况",name:"description",labelCol:{style:{width:"124px"}},rules:[{required:!1,message:"异常情况不能为空"}]},{default:s(()=>[n(W,{value:e.description,"onUpdate:value":t[10]||(t[10]=a=>e.description=a),placeholder:"无异常，请勿填写“异常情况”",row:"3",maxlength:"512",disabled:d.value},null,8,["value","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),n(O,{bordered:!1},{default:s(()=>[n(U(he),{title:"巡检清单",onRegister:U(ie)},Pe({result:s(()=>[Ge]),needRectification:s(()=>[Je]),bodyCell:s(({column:a,record:r})=>[a.dataIndex==="result"?(b(),g(i,{key:0,value:r[a.dataIndex],"onUpdate:value":f=>r[a.dataIndex]=f,maxlength:"128",disabled:d.value,style:{width:"100%"}},null,8,["value","onUpdate:value","disabled"])):x("",!0),a.dataIndex==="needRectification"?(b(),g(C,{key:1,value:r[a.dataIndex],"onUpdate:value":f=>r[a.dataIndex]=f,"allow-clear":"",style:{width:"100%"},disabled:d.value},{default:s(()=>[n($,{value:0},{default:s(()=>[j("否")]),_:1}),n($,{value:1},{default:s(()=>[j("是")]),_:1})]),_:2},1032,["value","onUpdate:value","disabled"])):x("",!0),a.dataIndex==="finishedRectificationDate"?(b(),g(M,{key:2,value:r[a.dataIndex],"onUpdate:value":f=>r[a.dataIndex]=f,disabled:d.value,valueFormat:"YYYY-MM-DD",style:{width:"100%"}},null,8,["value","onUpdate:value","disabled"])):x("",!0),a.dataIndex==="rectificationMeasures"?(b(),g(i,{key:3,value:r[a.dataIndex],"onUpdate:value":f=>r[a.dataIndex]=f,disabled:d.value,maxlength:"512",style:{width:"100%"}},null,8,["value","onUpdate:value","disabled"])):x("",!0),a.dataIndex==="hiddenDangerType"?(b(),g(Ce,{key:4,type:"hidden_danger_type",subtype:"inspection",value:r[a.dataIndex],"onUpdate:value":f=>r[a.dataIndex]=f,disabled:d.value,style:{width:"100%"}},null,8,["value","onUpdate:value","disabled"])):x("",!0),a.dataIndex==="bizFileId"?(b(),g(J,{key:5,width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"inspectionexecutiondtl",vmode:e.status==0?"box":"view",bizId:r[a.dataIndex]},null,8,["vmode","bizId"])):x("",!0)]),_:2},[e.status==0&&!d.value?{name:"toolbar",fn:s(()=>[n(ue,{onClick:X,preIcon:U(be).EDIT},{default:s(()=>[j(" 巡检结果 ")]),_:1},8,["preIcon"])]),key:"0"}:void 0]),1032,["onRegister"])]),_:1}),n(O,{title:"附件上传",bordered:!1},{default:s(()=>[n(J,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"inspectionexecution",vmode:e.status==0?"box":"view",bizId:e.bizFileId},null,8,["vmode","bizId"])]),_:1})]),_:1},8,["model"])]),e.status==0?(b(),g(Te,{key:0,visible:P.value,"onUpdate:visible":t[12]||(t[12]=a=>P.value=a),title:"批量修改巡检结果",maskClosable:!1,onOk:ee,width:350,height:255},{default:s(()=>[_("div",Ke,[n(W,{value:p.value,"onUpdate:value":t[11]||(t[11]=a=>p.value=a),rows:4,maxlength:"500"},null,8,["value"])])]),_:1},8,["visible"])):x("",!0)])]),_:1},8,["spinning"])])]),_:1})}}});const Ut=_e(Le,[["__scopeId","data-v-86ea8f5b"]]);export{Ut as default};
//# sourceMappingURL=create-ee7e3cf3.js.map
