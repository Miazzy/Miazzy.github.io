{"version":3,"file":"create-6bb33acb.js","sources":["../../src/views/po/ticket/operationticket/create.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <a-spin :spinning=\"formState.spinning\" tip=\"Loading...\">\n        <div class=\"process-box\">\n          <!-- 标题和操作按钮-->\n          <div class=\"header-box\">\n            <BillTitle :options=\"billTitleOption\" />\n            <WfApproveBox\n              @save=\"onSave\"\n              @submit=\"onSubmit\"\n              @before=\"onBefore\"\n              :processInstanceId=\"formState.processInstanceId\"\n              :processStatus=\"formState.status\"\n              :mode=\"getApproveBoxMode\"\n              :businessStatus=\"businessStatus\"\n              :listenMessage=\"listenMessage\"\n            />\n            <CustomPrint\n              v-if=\"formState.status == 2\"\n              path=\"operationTicket\"\n              :params=\"{ base: formState, details: itemDataSource }\"\n            />\n          </div>\n          <!-- 表单内容 -->\n          <div class=\"content\">\n            <a-form ref=\"formRef\" :model=\"formState\" labelAlign=\"right\" autocomplete=\"off\">\n              <a-card title=\"基本信息\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"stationName\"\n                      label=\"电站名称\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                    >\n                      <a-input v-model:value=\"formState.stationName\" disabled />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"ticketNumber\"\n                      label=\"操作票号\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                    >\n                      <a-input v-model:value=\"formState.ticketNumber\" disabled />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"actionType\"\n                      label=\"操作类型\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请选择操作类型' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.actionType\"\n                        :type=\"`action_type`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"commandTime\"\n                      label=\"发令时间\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入发令时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.commandTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"commanderName\"\n                      label=\"发令人\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-input v-model:value=\"formState.commanderName\" disabled />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"recipientId\"\n                      label=\"受令人\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请选择受令人' }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.recipientId\"\n                        show-search\n                        allow-clear\n                        style=\"width: 100%\"\n                        placeholder=\"请选择受令人\"\n                        :options=\"stationPersonOptions\"\n                        @change=\"handleChangeStationPerson\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"subject\"\n                      label=\"操作任务\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入操作任务' }]\"\n                    >\n                      <a-input\n                        v-model:value=\"formState.subject\"\n                        :maxlength=\"100\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n              <a-card :bordered=\"false\">\n                <BasicTable ref=\"tableRef\" title=\"操作项目\" @register=\"registerTable\">\n                  <template v-if=\"!disabledInput\" #toolbar>\n                    <a-button\n                      type=\"primary\"\n                      :preIcon=\"IconEnum.ADD\"\n                      @click=\"handleAddItem\"\n                      v-if=\"!disabledInput\"\n                    >\n                      {{ t('common.action.create') }}\n                    </a-button>\n                    <a-dropdown v-if=\"!disabledInput\">\n                      <template #overlay>\n                        <a-menu @click=\"handleClickMenu\">\n                          <a-menu-item key=\"downloadTemplate\">下载模板</a-menu-item>\n                          <a-menu-item key=\"import\">\n                            <a-upload\n                              name=\"file\"\n                              :showUploadList=\"false\"\n                              :headers=\"headers\"\n                              accept=\".xls,.xlsx\"\n                              :before-upload=\"beforeUpload\"\n                              @change=\"handleChange\"\n                              :action=\"importExcelUrl\"\n                            >\n                              {{ '导入数据' }}\n                            </a-upload>\n                          </a-menu-item>\n                        </a-menu>\n                      </template>\n                      <a-button class=\"yellow-btn\"> excel导入 </a-button>\n                    </a-dropdown>\n                    <a-button class=\"yellow-btn\" @click=\"handleImportItem\" v-if=\"!disabledInput\">\n                      {{ '历史操作票导入' }}\n                    </a-button>\n                  </template>\n                  <template #bodyCell=\"{ column, record }\">\n                    <template v-if=\"column.dataIndex === 'content'\">\n                      <a-input\n                        v-model:value=\"record[column.dataIndex]\"\n                        :maxlength=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </template>\n                    <template v-if=\"column.dataIndex === 'status'\">\n                      <a-checkbox\n                        v-model:checked=\"record[column.dataIndex]\"\n                        :disabled=\"process.operation.disabled\"\n                      />\n                    </template>\n                    <template v-if=\"column.dataIndex === 'action'\">\n                      <TableAction\n                        :actions=\"[\n                          {\n                            tooltip: '删除',\n                            color: 'error',\n                            icon: 'ant-design:delete-outlined',\n                            ifShow: !disabledInput,\n                            onClick: handleDeleteItem.bind(null, record),\n                          },\n                        ]\"\n                      />\n                    </template>\n                  </template>\n                </BasicTable>\n              </a-card>\n\n              <a-card v-if=\"process.archive.show\" title=\"执行归档\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"principalTime\"\n                      label=\"操作时间\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入操作时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.principalTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"process.archive.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"qualifiedTime\"\n                      label=\"完成时间\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入完成时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.qualifiedTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"process.archive.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"operatorId\"\n                      label=\"操作人\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请选择操作人' }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.operatorId\"\n                        show-search\n                        allow-clear\n                        style=\"width: 100%\"\n                        placeholder=\"请选择操作人\"\n                        :options=\"stationPersonOptions\"\n                        @change=\"handleChangeOperator\"\n                        :disabled=\"process.archive.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"headName\"\n                      label=\"运维负责人\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入运维负责人' }]\"\n                    >\n                      <a-tree-select\n                        v-model:value=\"formState.headName\"\n                        show-search\n                        style=\"width: 100%\"\n                        :dropdown-style=\"{ maxHeight: '400px', overflow: 'auto' }\"\n                        allow-clear\n                        tree-default-expand-all\n                        :tree-data=\"orgTreeData\"\n                        tree-node-filter-prop=\"label\"\n                        @change=\"handleChangeTree\"\n                        :disabled=\"process.archive.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <UploadBox\n                  :width=\"800\"\n                  :height=\"550\"\n                  :maxCount=\"20\"\n                  :maxSize=\"100 * 1024 * 1024\"\n                  :application=\"`po`\"\n                  :module=\"`operationticket`\"\n                  :vmode=\"process.archive.disabled ? `view` : `box`\"\n                  :bizId=\"formState.bizFileId\"\n                />\n              </a-card>\n\n              <a-card v-if=\"process.manager.show\" title=\"合格性检查\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"result\"\n                      label=\"检查结论\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请选择检查结论' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.result\"\n                        :type=\"`inspection_conclusion`\"\n                        :disabled=\"process.manager.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      name=\"checkTime\"\n                      label=\"检查时间\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入检查时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.checkTime\"\n                        show-time\n                        format=\"YYYY-MM-DD HH:mm\"\n                        value-format=\"YYYY-MM-DD HH:mm\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"process.manager.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"24\">\n                    <a-form-item\n                      name=\"illustrate\"\n                      label=\"验证说明\"\n                      :labelCol=\"{ class: 'detail-label' }\"\n                      :rules=\"[{ required: true, message: '请输入验证说明' }]\"\n                    >\n                      <a-textarea\n                        v-model:value=\"formState.illustrate\"\n                        show-count\n                        :rows=\"4\"\n                        :maxlength=\"1000\"\n                        :disabled=\"process.manager.disabled\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n            </a-form>\n          </div>\n        </div>\n      </a-spin>\n\n      <!-- 弹窗页面 -->\n      <Dialog\n        v-model:visible=\"historyItemModal\"\n        title=\"历史操作票导入\"\n        okText=\"导入\"\n        @ok=\"handleOk\"\n        :height=\"520\"\n      >\n        <BasicTable class=\"table-in-dialog\" @register=\"registerModalTable\" :maxHeight=\"340\" />\n      </Dialog>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, reactive, ref, UnwrapRef, toRaw, computed } from 'vue';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useUserStore } from '/@/store/modules/user';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { ValidateErrorEntity } from 'ant-design-vue/es/form/interface';\n  import type { UploadProps, SelectProps, TreeSelectProps } from 'ant-design-vue';\n  import { FormInstance, Upload } from 'ant-design-vue';\n  import { SysMessage } from '@/hooks/web/useMessage';\n  import Dialog from '@/components/Framework/Modal/Dialog.vue';\n  import { BasicTable, useTable, TableAction, EditRecordRow } from '/@/components/Table';\n  import { jsonToSheetXlsx } from '/@/components/Excel';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import DictSelectBox from '@/components/Framework/Combox/DictSelectBox.vue';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import { getToken } from '/@/utils/auth';\n  import { buildShortUUID } from '@/utils/uuid';\n  import {\n    getItemColumns,\n    itemModalColumns,\n    getItemList,\n    getPage,\n    saveData,\n    getData,\n    getOrg,\n    getStationPerson,\n    getOrgTree,\n    detailTableProps,\n    importExcelUrl,\n  } from './operationticket.data';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { assign } from 'lodash-es';\n  import { trim } from 'xe-utils';\n  import { closeCurrentTab } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n  import CustomPrint from '../components/CustomPrint.vue';\n  import { Memory } from '@/router/index';\n\n  const { t } = useI18n();\n  const userStore = useUserStore();\n  const userInfo = toRaw(userStore.getUserInfo);\n  const query = Memory.getInstance().getQuery(); // route.query;\n  const formRef = ref<FormInstance>();\n  const formState: UnwrapRef<any> = reactive({ spinning: false, status: 0 });\n  const historyItemModal = ref<boolean>(false);\n  const headers = {\n    Authorization: `Bearer ${getToken()}`,\n  };\n  const stationPersonOptions = ref<SelectProps['options']>([]) as any;\n  const billTitleOption = reactive<any>({ subject: '操作票申请' });\n  const disabledInput = ref<boolean>(true);\n  const process = reactive({\n    // 受令人节点\n    operation: {\n      show: false,\n      disabled: true,\n    },\n    // 归档节点\n    archive: {\n      show: false,\n      disabled: true,\n    },\n    // 经理节点\n    manager: {\n      show: false,\n      disabled: true,\n    },\n  });\n  const itemDataSource = ref<any[]>();\n\n  const businessStatus = ref<string>('');\n  const listenMessage = ref(query.processInstanceId ? undefined : 'operation-ticket');\n  const getApproveBoxMode = computed(() => {\n    return !process.operation.disabled || !process.archive.disabled || !process.manager.disabled\n      ? 'before'\n      : 'default';\n  });\n  const onBefore = (flowData, beforeOperationType) => {\n    const action = beforeOperationType.replace('before', '').toLowerCase();\n    onSubmit(flowData, action);\n  };\n  const validateProcessForm = (flowData, action) => {\n    if (action !== 'agree') {\n      return true;\n    }\n    // todo 过程数据校验\n    // if (flowData.definitionKey === '_Node') {\n    //   return false;\n    // }\n    return true;\n  };\n\n  const onSave = () => {\n    doSave('save', 0);\n  };\n\n  const onSubmit = async (flowData, action) => {\n    const value = formRef.value;\n    if (!value) {\n      return;\n    }\n    // 校验表单数据\n    if (action === 'submit' || action === 'agree') {\n      let pass = true;\n      await value.validateFields().catch((errorObj: ValidateErrorEntity<any>) => {\n        console.log('onSubmit=》error', errorObj);\n        const errorFields = errorObj.errorFields;\n        // 表单滚动到第一个报错处(antd),解决form中scrollToFirstError配置无效\n        document\n          .querySelector('.ant-form-item-has-error')\n          ?.scrollIntoView({ behavior: 'smooth', block: 'center' });\n        if (errorFields && errorFields.length > 0) {\n          error(errorFields[0].errors[0]);\n          pass = false;\n          return;\n        }\n      });\n      if (!pass) {\n        return;\n      }\n      if (!validateProcessForm(flowData, action)) {\n        return;\n      }\n    }\n    const status = action ? null : 1;\n    doSave(action, status);\n  };\n\n  const doSave = async (action, status) => {\n    formState.spinning = true;\n    try {\n      await saveBiz(action, status);\n    } catch (error) {\n      formState.spinning = false;\n      console.log('error', error);\n    }\n  };\n\n  const saveBiz = async (action, status) => {\n    const formData = toRaw(formState) as any;\n    if (status != null && status > -1) {\n      formData.status = status;\n    }\n    if (formData.headId) {\n      formData.headId = formData.headId.split('@')[0];\n    }\n    const dtlList = ref<any>([]);\n    getItemDataSource().forEach((item) => {\n      const dtl = ref<any>({});\n      assign(dtl.value, item);\n      if (dtl.value.status == true) {\n        dtl.value.status = 1;\n      } else if (dtl.value.status == false) {\n        dtl.value.status = 0;\n      }\n      dtlList.value.push(dtl.value);\n    });\n    if (status == 1) {\n      dtlList.value.forEach((item) => {\n        if (!trim(item.content)) {\n          const message = '操作项目，操作内容不能为空';\n          error(message);\n          throw new Error(message);\n        }\n      });\n    }\n    formState.dtlList = dtlList.value;\n    await saveData(formData)\n      .then((res) => {\n        formState.id = res.result;\n        if (status == 1) {\n          disabledInput.value = true;\n        }\n        businessStatus.value = action;\n        formState.spinning = false;\n        if (status === 0 || status === 1) {\n          success('操作成功');\n        }\n        reloadBizTable(status);\n      })\n      .catch(() => {\n        formState.spinning = false;\n      });\n  };\n\n  const reloadBizTable = (status: number) => {\n    if (status === 0 || status === 1) {\n      setTimeout(() => {\n        if (status === 1) {\n          closeCurrentTab();\n        }\n        MsgManager.getInstance().sendMsg('operation-ticket', {});\n      }, 200);\n    }\n  };\n\n  const error = (content) => {\n    formState.spinning = false;\n    SysMessage.getInstance().error(content);\n  };\n\n  const success = (content) => {\n    SysMessage.getInstance().success(content);\n  };\n\n  const initNodeAuth = (node: string) => {\n    const processVariable = { ...formState.processVariable };\n    const isCurrentNodeAuth =\n      processVariable.taskDefinitionKey === node &&\n      processVariable.assigneeId === userInfo.userId &&\n      processVariable.status === 1;\n    const type = node.replace('Node', '');\n    process[type].disabled = !isCurrentNodeAuth;\n  };\n\n  // 处理任务实列节点是否显示\n  const handleTaskInstanceNode = () => {\n    const taskInstances = formState.taskInstances;\n    if (taskInstances?.length) {\n      taskInstances.forEach((item) => {\n        if (item.taskDefinitionKey === 'operationNode') {\n          process.operation.show = true;\n        }\n        if (item.taskDefinitionKey === 'archiveNode') {\n          process.archive.show = true;\n        }\n        if (item.taskDefinitionKey === 'managerNode') {\n          process.manager.show = true;\n        }\n      });\n    }\n    // 通过、不通过、终止业务节点全部显示\n    if (formState.status === 2 || formState.status === 3 || formState.status === 5) {\n      process.operation.show = true;\n      process.archive.show = true;\n      process.manager.show = true;\n    }\n  };\n\n  const isEdit = () => {\n    // 受令人节点\n    initNodeAuth('operationNode');\n    // 归档节点\n    initNodeAuth('archiveNode');\n    // 经理节点\n    initNodeAuth('managerNode');\n    // 申请节点\n    const isApply =\n      (formState.status === 0 || formState.status === 6) &&\n      (!formState.personMemberId || formState.personMemberId.indexOf(userInfo.userId) > -1);\n    disabledInput.value = !isApply;\n    // 处理任务实列节点是否显示\n    handleTaskInstanceNode();\n  };\n\n  const getRecordable = async () => {\n    const res = await getData({ id: query.id });\n    if (res.result) {\n      assign(formState, res.result);\n      formState.status = Number(formState.status);\n      formState.processInstanceId = formState.processVariable?.processInstanceId;\n      disabledInput.value = formState.status != 0;\n      if (!formState.processInstanceId) {\n        formState.processInstanceId = query.processInstanceId;\n      }\n      const { billCode, fillinDate, personMemberName, deptName } = res.result;\n      Object.assign(billTitleOption, { billCode, fillinDate, personMemberName, deptName });\n\n      isEdit();\n    }\n  };\n\n  const getItemData = async (paramObj) => {\n    const id = await getBizParamId();\n    const param = { ticketId: paramObj.ticketId ? paramObj.ticketId : id };\n    const dataObj = await getItemList(param);\n    if (dataObj.result) {\n      dataObj.result.forEach((item) => {\n        if (item.status == 1) {\n          item.status = true;\n        } else if (item.status == 0) {\n          item.status = false;\n        }\n      });\n    }\n    return dataObj.result;\n  };\n\n  const [registerTable, { setProps: setItemProps, getDataSource: getItemDataSource }] = useTable(\n    assign(\n      {\n        dataSource: itemDataSource,\n        // columns: getItemColumns(process),\n      },\n      detailTableProps,\n    ),\n  );\n\n  const initTableData = async () => {\n    const dataObj = await getItemData({});\n    itemDataSource.value = dataObj;\n  };\n\n  const getItemModalData = async () => {\n    const paginationRef = getPaginationRef() as any;\n    const param = {\n      stationId: formState.stationId,\n      status: 2,\n      pageNo: paginationRef.current,\n      pageSize: paginationRef.pageSize,\n    };\n    const dataObj = await getPage(param);\n    return dataObj.result;\n  };\n\n  const [registerModalTable, { getPaginationRef, getSelectRows }] = useTable({\n    api: getItemModalData,\n    columns: itemModalColumns,\n    pagination: true,\n    striped: false,\n    useSearchForm: false,\n    showTableSetting: false,\n    bordered: true,\n    showIndexColumn: true,\n    canResize: true,\n    rowSelection: {\n      type: 'radio',\n    },\n  });\n\n  function handleOk() {\n    const rows = getSelectRows();\n    if (rows.length == 0) {\n      SysMessage.getInstance().error('请选择操作票');\n      return;\n    }\n    getItemData({ ticketId: rows[0].id }).then((rows) => {\n      pushItemRows(rows, false);\n      historyItemModal.value = false;\n    });\n  }\n\n  function pushItemRows(rows: Array<any>, isImport: boolean) {\n    const data = getItemDataSource();\n    rows.forEach((item) => {\n      let status = item.status;\n      if (isImport) {\n        status = status == 1 ? true : item.status == 0 ? false : null;\n      }\n      const addRow: EditRecordRow = {\n        content: item.content,\n        status: status,\n        editable: true,\n        isNew: true,\n        key: `${Date.now()}`,\n      };\n      data.push(addRow);\n    });\n  }\n\n  function handleAddItem() {\n    pushItemRows([{ content: '', status: false }], false);\n  }\n\n  function handleClickMenu({ key }) {\n    if (key === 'downloadTemplate') {\n      downloadTemplate();\n    }\n  }\n\n  function downloadTemplate() {\n    jsonToSheetXlsx({\n      data: [{ index: 1, content: '操作内容案例', status: '是' }],\n      header: {\n        index: '序号',\n        content: '操作内容',\n        status: '是否完成',\n      },\n      filename: '内容模板.xlsx',\n    });\n  }\n\n  const beforeUpload: UploadProps['beforeUpload'] = (file) => {\n    // .xls  application/vnd.ms-excel\n    // .xlsx application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\n    const isExcel =\n      file.type === 'application/vnd.ms-excel' ||\n      file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n    if (!isExcel) {\n      SysMessage.getInstance().error(`${file.name} 不是Excel文件`);\n    }\n    return isExcel || Upload.LIST_IGNORE;\n  };\n\n  const handleChange = (list) => {\n    const file = list.file;\n    console.log('file', file);\n    if (file.status === 'done' && file.response && file.response.data) {\n      pushItemRows(file.response.data, true);\n    } else if (file.status === 'error') {\n      SysMessage.getInstance().error('导入数据失败');\n    }\n  };\n\n  function handleImportItem() {\n    historyItemModal.value = true;\n  }\n\n  function handleDeleteItem(record) {\n    const data = getItemDataSource();\n    let index = data.indexOf(record);\n    if (index !== -1) {\n      data.splice(index, 1);\n    }\n  }\n\n  function handleChangeStationPerson(value: string, option) {\n    formState.recipientName = option.label;\n  }\n\n  function handleChangeOperator(value: string, option) {\n    formState.operatorName = option.label;\n  }\n\n  function initStationPersonOptions() {\n    getStationPerson('?stationId=' + formState.stationId).then((res) => {\n      if (res.result && res.result.length > 0) {\n        res.result.forEach((item) => {\n          stationPersonOptions.value.push({ value: item.userId, label: item.name });\n        });\n      }\n    });\n  }\n\n  function dig(data) {\n    const list: TreeSelectProps['treeData'] = [];\n    for (let i = 0; i < data.length; i++) {\n      const item = data[i];\n      const treeNode: TreeSelectProps['treeData'][number] = {\n        label: item.name,\n        value: item.id,\n        disabled: item.orgKindId !== 'psm',\n      };\n\n      if (item.children && item.children.length > 0) {\n        treeNode.children = dig(item.children);\n      }\n\n      list.push(treeNode);\n    }\n    return list;\n  }\n\n  function handleChangeTree(value, label) {\n    formState.headId = value;\n    formState.headName = label[0];\n  }\n\n  const orgTreeData = ref<TreeSelectProps['treeData']>();\n\n  const getBizParamId = async () => {\n    let id = query.id;\n    if (!id && query.processInstanceId) {\n      const processInstance = (await ProcessInstanceApi.getProcessInstance(\n        query.processInstanceId as string,\n      )) as any;\n      const businessKey = processInstance.businessKey;\n      query.id = businessKey;\n      id = businessKey;\n    }\n    return id;\n  };\n\n  const initUserOrg = async () => {\n    const res = await getOrg({});\n    if (res.result && res.result.user) {\n      formState.commanderId = res.result.user.id;\n      formState.commanderName = res.result.user.name;\n    }\n  };\n\n  const initOrgTree = async () => {\n    const typeList = await getOrgTree({\n      orgId: formState.stationOrganId,\n      orgKindIds: 'ogn,dpt,pos,psm',\n      showPosition: true,\n      status: 1,\n    });\n    orgTreeData.value = dig(typeList.result);\n  };\n\n  const setTableProps = () => {\n    setItemProps({\n      columns: getItemColumns(process),\n      actionColumn: {\n        width: 80,\n        title: '操作',\n        dataIndex: 'action',\n        ifShow: !disabledInput.value,\n      },\n    });\n  };\n\n  onMounted(async () => {\n    query.id = await getBizParamId();\n    await getRecordable();\n    if (!query.id) {\n      assign(formState, query);\n      disabledInput.value = false;\n      formState.bizFileId = buildShortUUID();\n      await initUserOrg();\n    }\n    setTableProps();\n    initStationPersonOptions();\n    initOrgTree();\n    initTableData();\n  });\n</script>\n<style lang=\"less\" scoped>\n  @import '/@/design/biz/bizForm.less';\n</style>\n"],"names":["t","useI18n","userStore","useUserStore","userInfo","toRaw","query","Memory","formRef","ref","formState","reactive","historyItemModal","headers","getToken","stationPersonOptions","billTitleOption","disabledInput","process","itemDataSource","businessStatus","listenMessage","getApproveBoxMode","computed","onBefore","flowData","beforeOperationType","action","onSubmit","validateProcessForm","onSave","doSave","__async","value","pass","errorObj","errorFields","_a","error","status","saveBiz","formData","dtlList","getItemDataSource","item","dtl","assign","trim","message","saveData","res","success","reloadBizTable","closeCurrentTab","MsgManager","content","SysMessage","initNodeAuth","node","processVariable","__spreadValues","isCurrentNodeAuth","type","handleTaskInstanceNode","taskInstances","isEdit","isApply","getRecordable","getData","billCode","fillinDate","personMemberName","deptName","getItemData","paramObj","id","getBizParamId","param","dataObj","getItemList","registerTable","setItemProps","useTable","detailTableProps","initTableData","getItemModalData","paginationRef","getPaginationRef","getPage","registerModalTable","getSelectRows","itemModalColumns","handleOk","rows","pushItemRows","isImport","data","addRow","handleAddItem","handleClickMenu","key","downloadTemplate","jsonToSheetXlsx","beforeUpload","file","isExcel","Upload","handleChange","list","handleImportItem","handleDeleteItem","record","index","handleChangeStationPerson","option","handleChangeOperator","initStationPersonOptions","getStationPerson","dig","i","treeNode","handleChangeTree","label","orgTreeData","businessKey","ProcessInstanceApi.getProcessInstance","initUserOrg","getOrg","initOrgTree","typeList","getOrgTree","setTableProps","getItemColumns","onMounted","buildShortUUID"],"mappings":"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"}