var _e=Object.defineProperty;var j=Object.getOwnPropertySymbols;var ve=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var E=(_,c,d)=>c in _?_e(_,c,{enumerable:!0,configurable:!0,writable:!0,value:d}):_[c]=d,N=(_,c)=>{for(var d in c||(c={}))ve.call(c,d)&&E(_,d,c[d]);if(j)for(var d of j(c))ge.call(c,d)&&E(_,d,c[d]);return _};var y=(_,c,d)=>new Promise((u,O)=>{var e=v=>{try{h(d.next(v))}catch(x){O(x)}},I=v=>{try{h(d.throw(v))}catch(x){O(x)}},h=v=>v.done?u(v.value):Promise.resolve(v.value).then(e,I);h((d=d.apply(_,c)).next())});import{d as Ie,J as R,k as m,r as U,e as he,o as we,al as b,Z as P,a9 as T,aa as n,$ as B,f as o,ac as W,v as k,A as D}from"./vue-71d1abb3.js";import{a0 as ye,ak as ke,aD as De,aC as xe,a7 as Se,at as J,aB as Pe,_ as Te}from"./index.js";import{B as Oe}from"./BillTitle-d17ab3e4.js";import{_ as Ce}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{_ as Ne}from"./UploadTable.vue_vue_type_script_setup_true_lang-5478923e.js";import{W as Be}from"./WfApproveBox-a3448232.js";import{_ as Me}from"./FaultWorkOrder.vue_vue_type_script_setup_true_lang-ceb68cff.js";import{_ as qe}from"./HiddenWorkOrder.vue_vue_type_script_setup_true_lang-f6f042af.js";import{_ as Fe}from"./DailyWorkOrder.vue_vue_type_script_setup_true_lang-d2791c4d.js";import{d as Re,c as Ue,f as We}from"./workorder.data-e18a6fd9.js";import{a as F}from"./assign-37f1c13d.js";import"./antd-15ac76ed.js";import"./UploadBox-636ecf02.js";import"./Dialog-0a006d82.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./BasicTable-0434a334.js";import"./useForm-dea3ed18.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-f4fc48e6.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./OrganDialog-dd1023ce.js";import"./uniqBy-92d3bc7f.js";import"./index-085d06c7.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useTable-109483b3.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./TicketTable-81dd11bc.js";import"./useRender-21ce56fb.js";const ze={class:"load"},Ke={class:"process-box"},Ye={class:"header-box"},Ae={class:"content"},He={class:"detail-upload-table"},Ve=Ie({__name:"create",setup(_){const c=ye(),d=R(c.getUserInfo),u=ke.getInstance().getQuery(),O=m(),e=U({spinning:!1,status:0,fault:{},hidden:{},daily:{}}),I=m([]),h=U({subject:"工单申请"}),v=m(!1),x=m(!1),z=m(!1),g=m(!0),r=U({process:{show:!1,disabled:!0},confirm:{show:!1,disabled:!0}}),w=m(),K=m(""),Q=m(u.processInstanceId?void 0:"work-order"),Z=he(()=>!r.process.disabled||!r.confirm.disabled?"before":"default"),G=(s,t)=>{const a=t.replace("before","").toLowerCase();Y(s,a)},X=(s,t,a)=>{if(a!=="agree")return!0;if(!r.process.disabled){if(!(s.workOrderType==="qx"||s.workOrderType==="yh")&&!H(s.daily.endDate,s.daily.startDate))return M("开始时间必须小于结束时间"),!1;if(s.isInvoicing==="1"&&w.value.getTicketList().length===0)return M("请关联开具两票数据"),!1}return!0},ee=()=>{V("save",0)},Y=(s,t)=>y(this,null,function*(){const a=O.value;if(!a)return;if(t==="submit"||t==="agree"){let p=!0;if(yield a.validateFields().catch(q=>{var C;console.log("onSubmit=》error",q);const S=q.errorFields;if((C=document.querySelector(".ant-form-item-has-error"))==null||C.scrollIntoView({behavior:"smooth",block:"center"}),S&&S.length>0){M(S[0].errors[0]),p=!1;return}}),!p)return;const i=R(e);if(F(i,w.value.childFormState),!H(i.planEndDate,i.planStartDate)){M("计划开始时间必须小于计划完成时间");return}if(!X(i,s,t))return}V(t,t?null:1)}),se=m(),A=m([]),te=s=>{e.bizFileId||(e.bizFileId=De());const t={qx:["缺陷情况","消缺处理","消缺确认"],yh:["隐患发现","整改处理","结果确认"],cc:["除草方案","处理过程","结果确认"],zjqx:["清洗方案","处理过程","结果确认"],lsjg:["紧固方案","处理过程","结果确认"],ff:["防腐方案","处理过程","结果确认"]},a={fileKindId:"",filetype:"",bizId:e.bizFileId,maxCount:20,maxSize:20*1024*1024,required:!1,readonly:!0},l=[];let p=N({},a);if(p.fileKindId="apply",p.filetype=t[s][0],p.readonly=g.value,l.push(p),r.process.show){let i=N({},a);i.fileKindId="process",i.filetype=t[s][1],i.readonly=r.process.disabled,l.push(i)}if(r.confirm.show){let i=N({},a);i.fileKindId="confirm",i.filetype=t[s][2],i.readonly=r.confirm.disabled,l.push(i)}A.value=l},H=(s,t)=>{const a=new Date(Date.parse(s)),l=new Date(Date.parse(t));return a>l},V=(s,t)=>y(this,null,function*(){e.spinning=!0;try{yield ae(s,t)}catch(a){e.spinning=!1,console.log("error",a)}}),ae=(s,t)=>y(this,null,function*(){const a=R(e);F(a,w.value.childFormState);const l=t===0||t===1;l&&(a.status=t),r.process.disabled||(a.ticketList=w.value.getTicketList()),yield Re(a).then(p=>{e.id=p.result,t==1&&(g.value=!0),e.spinning=!1,K.value=s,l&&re("操作成功"),oe(t)}).catch(()=>{e.spinning=!1})}),oe=s=>{(s===0||s===1)&&setTimeout(()=>{s===1&&xe(),Se.getInstance().sendMsg("work-order",{})},200)},M=s=>{e.spinning=!1,J.getInstance().error(s)},re=s=>{J.getInstance().success(s)},$=s=>{const t=N({},e.processVariable),a=t.taskDefinitionKey===s&&t.assigneeId.indexOf(d.userId)>-1&&t.status===1,l=s.replace("Node","");r[l].disabled=!a},ne=()=>{const s=e.taskInstances;s!=null&&s.length&&s.forEach(t=>{t.taskDefinitionKey==="processNode"&&(r.process.show=!0),t.taskDefinitionKey==="confirmNode"&&(r.confirm.show=!0)}),(e.status===2||e.status===3||e.status===5)&&(r.process.show=!0,r.confirm.show=!0)},le=()=>{$("processNode"),$("confirmNode");const s=(e.status===0||e.status===6)&&(!e.personMemberId||e.personMemberId.indexOf(d.userId)>-1);g.value=!s,ne()},ie=()=>y(this,null,function*(){var t;const s=yield Ue({id:u.id,workOrderType:u.workOrderType});if(s.result){F(e,s.result),e.status=Number(e.status),e.isInvoicing=String(e.isInvoicing!=null?e.isInvoicing:""),e.processInstanceId=(t=e.processVariable)==null?void 0:t.processInstanceId,e.processInstanceId||(e.processInstanceId=u.processInstanceId);const{billCode:a,fillinDate:l,personMemberName:p,deptName:i}=s.result;Object.assign(h,{billCode:a,fillinDate:l,personMemberName:p,deptName:i}),le()}});function de(s,t){e.confirmById=t.lable}function ce(){We("?stationId="+e.stationId).then(s=>{s.result&&s.result.length>0&&s.result.forEach(t=>{I.value.push({value:t.name,lable:t.userId})})})}const ue=()=>y(this,null,function*(){let s=u.id;if(!s&&u.processInstanceId){const a=(yield Pe(u.processInstanceId)).businessKey;u.id=a,s=a}return s});function pe(){const s=e.workOrderTypeText;s&&(h.subject=`${s}申请`),e.workOrderType==="qx"?x.value=!0:e.workOrderType==="yh"?v.value=!0:z.value=!0}return we(()=>y(this,null,function*(){u.id=yield ue(),yield ie(),u.id||(F(e,u),e.fault||(e.fault={}),e.hidden||(e.hidden={}),e.daily||(e.daily={}),g.value=!1),te(e.workOrderType),pe(),ce()})),(s,t)=>{const a=b("a-form-item"),l=b("a-col"),p=b("a-select"),i=b("a-row"),q=b("a-date-picker"),S=b("a-input-number"),C=b("a-textarea"),L=b("a-card"),fe=b("a-form"),me=b("a-spin"),be=b("PageWrapper");return P(),T(be,{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:n(()=>[B("div",ze,[o(me,{spinning:e.spinning,tip:"Loading..."},{default:n(()=>[B("div",Ke,[B("div",Ye,[o(Oe,{options:h},null,8,["options"]),o(Be,{onSave:ee,onSubmit:Y,onBefore:G,processInstanceId:e.processInstanceId,processStatus:e.status,mode:Z.value,businessStatus:K.value,listenMessage:Q.value},null,8,["processInstanceId","processStatus","mode","businessStatus","listenMessage"])]),B("div",Ae,[o(fe,{ref_key:"formRef",ref:O,model:e,labelAlign:"right",autocomplete:"off"},{default:n(()=>[x.value?(P(),T(Me,{key:0,ref_key:"childWorkOrderRef",ref:w,formState:e,disabledInput:g.value,showProcess:r.process.show,disabledProcessInput:r.process.disabled,stationPersonOptions:I.value},null,8,["formState","disabledInput","showProcess","disabledProcessInput","stationPersonOptions"])):v.value?(P(),T(qe,{key:1,ref_key:"childWorkOrderRef",ref:w,formState:e,disabledInput:g.value,showProcess:r.process.show,disabledProcessInput:r.process.disabled,stationPersonOptions:I.value},null,8,["formState","disabledInput","showProcess","disabledProcessInput","stationPersonOptions"])):z.value?(P(),T(Fe,{key:2,ref_key:"childWorkOrderRef",ref:w,formState:e,disabledInput:g.value,showProcess:r.process.show,disabledProcessInput:r.process.disabled,stationPersonOptions:I.value},null,8,["formState","disabledInput","showProcess","disabledProcessInput","stationPersonOptions"])):W("",!0),r.confirm.show?(P(),T(L,{key:3,title:"结果确认",bordered:!1},{default:n(()=>[o(i,{gutter:32},{default:n(()=>[k(o(l,{span:12},{default:n(()=>[o(a,{name:"result",label:"验证结果",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请选择验证结果"}]},{default:n(()=>[o(Ce,{value:e.result,"onUpdate:value":t[0]||(t[0]=f=>e.result=f),type:"validate_result",disabled:r.confirm.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]]),k(o(l,{span:12},{default:n(()=>[o(a,{name:"confirmByName",label:"确认人",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请选择确认人"}]},{default:n(()=>[o(p,{value:e.confirmByName,"onUpdate:value":t[1]||(t[1]=f=>e.confirmByName=f),"show-search":"","allow-clear":"",style:{width:"100%"},options:I.value,onChange:de,disabled:r.confirm.disabled},null,8,["value","options","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1}),o(i,{gutter:32},{default:n(()=>[k(o(l,{span:12},{default:n(()=>[o(a,{name:"confirmDate",label:"确认时间",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请输入确认时间"}]},{default:n(()=>[o(q,{value:e.confirmDate,"onUpdate:value":t[2]||(t[2]=f=>e.confirmDate=f),"show-time":"",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm",style:"width: 100%",disabled:r.confirm.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]]),k(o(l,{span:12},{default:n(()=>[o(a,{name:"duration",label:"处理时长(h)",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请输入处理时长(h)"}]},{default:n(()=>[o(S,{value:e.duration,"onUpdate:value":t[3]||(t[3]=f=>e.duration=f),min:1,max:1e8,precision:2,disabled:r.confirm.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1}),e.workOrderType==="qx"?(P(),T(i,{key:0,gutter:32},{default:n(()=>[k(o(l,{span:12},{default:n(()=>[o(a,{name:"lossTotal",label:"产生损耗电量(kWh)",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请输入产生损耗电量(kWh)"}]},{default:n(()=>[o(S,{value:e.lossTotal,"onUpdate:value":t[4]||(t[4]=f=>e.lossTotal=f),min:0,max:99999999,precision:4,disabled:r.confirm.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1})):W("",!0),o(i,{gutter:32},{default:n(()=>[k(o(l,{span:24},{default:n(()=>[o(a,{name:"resultDescription",label:"结果确认",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请输入结果确认"}]},{default:n(()=>[o(C,{value:e.resultDescription,"onUpdate:value":t[5]||(t[5]=f=>e.resultDescription=f),"show-count":"",rows:4,maxlength:1e3,disabled:r.confirm.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1}),o(i,{gutter:32},{default:n(()=>[k(o(l,{span:24},{default:n(()=>[o(a,{name:"remark",label:"备注",labelCol:{class:"detail-label-8"}},{default:n(()=>[o(C,{value:e.remark,"onUpdate:value":t[6]||(t[6]=f=>e.remark=f),"show-count":"",rows:4,maxlength:1e3,disabled:r.confirm.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[D,!0]])]),_:1})]),_:1})):W("",!0),o(L,{title:"附件资料",bordered:!1},{default:n(()=>[B("div",He,[o(Ne,{ref_key:"uploadTable",ref:se,rows:A.value,colwidths:["15%","70%","15%"],application:"po",module:"workorder",mode:!g.value||!r.process.disabled||!r.confirm.disabled?"normal":"view"},null,8,["rows","mode"])])]),_:1})]),_:1},8,["model"])])])]),_:1},8,["spinning"])])]),_:1})}}});const Os=Te(Ve,[["__scopeId","data-v-f7dfff7f"]]);export{Os as default};
//# sourceMappingURL=create-34eca8a4.js.map
