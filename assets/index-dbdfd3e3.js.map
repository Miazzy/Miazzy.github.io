{"version":3,"file":"index-dbdfd3e3.js","sources":["../../src/views/po/safety/safecheckexecution/index.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight \n  contentClass=\"flex\"  \n  style=\"position: relative\" >\n    <stationTree @select-tree=\"selectTree\" />\n    <div class=\"right-table-layout\">\n    <BasicTable @register=\"registerTable\"  \n    @selection-change=\"handleSelectChange\"\n    class=\"fix-basic-table\"\n    @resize-column=\"(w, col) => (col.width = w)\"\n    @row-dbClick=\"dbClick\">\n      <template #toolbar>\n        <a-button\n          type=\"primary\"\n          :preIcon=\"IconEnum.ADD\"\n          @click=\"handleCreate\"\n          v-if=\"queryParam.safetyCheckType == CheckTypeNum.REGULAR\"\n        >\n          {{ '添加' }}\n        </a-button>\n        <a-button class=\"red-btn\" :disabled=\"selectedRowId == ''\" :preIcon=\"IconEnum.DELETE\" @click=\"handleCancel\"\n          v-if=\"queryParam.safetyCheckType == CheckTypeNum.REGULAR\"\n          >\n          {{ '删除' }}\n        </a-button>\n        <a-button  class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExport\">\n          {{ '导出' }}\n        </a-button>\n      </template>\n      <template #bodyCell=\"{ column, text, record }\">\n        <template v-if=\"column.dataIndex === 'rectification'\">\n          <a @click=\"openPage(`${record.dtlIds}`)\" target=\"_blank\">\n            {{ text }}\n          </a>\n        </template>\n      </template>\n    </BasicTable>\n    </div>\n  </PageWrapper>\n</template>\n\n<script lang=\"ts\" setup>\n\timport * as CommonUtil from '/@/utils/common';\n  import { PageWrapper } from '/@/components/Page';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { useMessage,SysMessage } from '@/hooks/web/useMessage';\n  import { IconEnum } from '@/enums/appEnum';\n  import { BasicTable, useTable,SorterResult } from '@/components/Table';\n  import { MsgManager } from '/@/message/MsgManager';\n  import { useRouter } from 'vue-router';\n  import {  onMounted, ref   } from 'vue';\n  import { urlToPath } from '/@/utils/route';\n  import stationTree from '@/views/po/stationtree/stationTree.vue';\n  import { exportExcelFile } from '@/utils/file/download';\n  import { setStationAndOrgan } from '@/views/po/stationtree/stationTree';\n  import { deleteProcessInstance } from '@/api/bpm/processInstance';\n\n  import {\n    getColumns,\n    searchFormSchema,\n    getSafeCheckTemplatePage,\n    exportSafeCheckTemplate,\n    CheckTypeNum,\n  } from './safecheckexecution';\n\n  import { parseRoutePath } from '/@/utils/route';\n  import { addTabPage } from '@/utils/route';\n\n  const router = useRouter();\n  const { currentRoute } = router;\n  let selectedRowId = ref('');\n  let {params:query} = urlToPath() as any;\n  const queryParam: any = ref({\n    status: '',\n    safetyCheckType: query.checkType,\n    subject: '',\n    billCode: '',\n    pageNo: 1,\n    pageSize: 10,\n    sortField: 'fillinDate',\n    sortOrder: 'desc'\n  });\n  defineOptions({ name: 'SafecheckExecution' });\n\n  const { t } = useI18n();\n  const { createConfirm, createMessage } = useMessage();\n\n  const openPage = (dtlIds) => {\n    // router.push(`/po/danger/index?dtlIds=` + dtlIds);\n    addTabPage(`/po/danger/index?dtlIds=` + dtlIds);\n  };\n\n  function selectTree(data) {\n    setStationAndOrgan(data, queryParam, null, reload);\n  }\n// 解析路由参数\nconst parseUrlParams = () => {\n  const path = currentRoute.value.path;\n  const params = parseRoutePath(path);\n  queryParam.value.safetyCheckType = params.checkType;\n};\n\n  parseUrlParams();\n  function getColumnsByType() {\n    const path = currentRoute.value.path;\n    const params = parseRoutePath(path);\n    return getColumns(params.checkType);\n  }\n  const [registerTable, { getForm, reload, getPaginationRef,getSelectRows }] = useTable({\n    title: queryParam.value.safetyCheckType == CheckTypeNum.REGULAR?'定期检查':'专项检查',\n    api: async () => {\n      const paginationRef = getPaginationRef() as any;    \n      queryParam.value.pageNo = paginationRef.current;\n      queryParam.value.pageSize = paginationRef.pageSize;\n      let dataObj = await getSafeCheckTemplatePage(queryParam.value);\n      return dataObj.result;\n    },\n    columns: getColumnsByType(),\n    rowKey: 'id',\n    bordered: true,\n    formConfig: { \n      labelWidth: 120, \n      schemas: searchFormSchema,\n      showAdvancedButton:false, \n    },\n    useSearchForm: true,\n    showTableSetting: true,\n    rowSelection: {\n      type: 'radio',\n      fixed: true,\n      onSelect: onSelect\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        queryParam.value.sortField = sortInfo.field.replace('Text', '');\n        queryParam.value.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n        queryParam.value.sortField = 'fillinDate';\n        queryParam.value.sortOrder = 'desc';\n      }\n    },\n    handleSearchInfoFn(info) {\n      for (const key in info) {\n        queryParam.value[key] = info[key];\n      }\n    }\n  });\n  function onSelect(record, selected) {\n    if (selected) {\n      selectedRowId.value = record.id;\n    } else {\n      selectedRowId.value = '';\n    }\n  }\n  function handleSelectChange({ keys, rows }) {\n    if (rows && rows.length > 0) {\n      const record = rows[0];\n      selectedRowId.value = record.id;\n    } else {\n      selectedRowId.value = '';\n    }\n  }\n  const dbClick=(record, index, event)=>{\n    \n    handleEdit(record);\n  }\n\n  function handleCreate() {\n    if (!queryParam.value.stationId) {\n      SysMessage.getInstance().info('请选中电站添加');\n      return;\n    }\n    const { currentRoute } = router;\n    const path = currentRoute.value.path;\n    const array = path.split('/');\n    const pvalue = array[array.length - 1]; // 取出路径中的参数\n    // router.push({\n    //   path: `/po/safety/safecheckexecution/create/${pvalue}?id=`,\n    //   query: {\n    //     stationId: queryParam.value.stationId,\n    //     stationName: queryParam.value.stationName,\n    //     safetyCheckType: queryParam.value.safetyCheckType,\n    //     stationOrganId: queryParam.value.stationOrganId,\n    //     stationOrganName: queryParam.value.stationOrganName,\n    //   },\n    // });\n    let title=queryParam.value.safetyCheckType == CheckTypeNum.REGULAR?'添加定期检查':'添加专项检查';\n    addTabPage(`/po/safety/safecheckexecution/create/${pvalue}?id=`, title, {\n      stationId: queryParam.value.stationId,\n      stationName: queryParam.value.stationName,\n      safetyCheckType: queryParam.value.safetyCheckType,\n      stationOrganId: queryParam.value.stationOrganId,\n      stationOrganName: queryParam.value.stationOrganName,\n    });\n  }\n\n  function handleEdit(record) {\n    const { currentRoute } = router;\n    const path = currentRoute.value.path;\n    const array = path.split('/');\n    const pvalue = array[array.length - 1]; // 取出路径中的参数\n \n    let str='';\n    // if(record.status==0){\n    //   str='修改'\n    // } else if (record.status==1){\n    //   str='审批'\n    // } else {\n    //   str='查看'\n    // }\n    let title='';\n    if(record.safetyCheckType == CheckTypeNum.REGULAR){\n      title=str+'定期检查';\n    } else {\n      title=str+'专项检查';\n    }\n    // addTabPage(\n    //   `/po/safety/safecheckexecution/create/${pvalue}?id=${record.id}&processInstanceId=${record.processInstanceId}`,\n    //   title\n    // );\n    CommonUtil.toFlowPage(record.id,title);\n  }\n\n\n  const handleCancel = async () => {\n    let rows = getSelectRows();\n    if(rows.length != 1){\n      SysMessage.getInstance().success('请选择一行数据');\n      return;\n    }\n    let record = rows[0];\n\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要删除选中的记录？',\n      async onOk() {\n        if(record.status !=0){\n          SysMessage.getInstance().success('非草稿状态不能删除');\n          return;\n        }\n        await deleteProcessInstance(record.processInstanceId);\n        SysMessage.getInstance().success('删除成功');\n        reload();\n      },\n    });\n    \n  };\n\n  async function handleExport() {\n    createConfirm({\n      title: t('common.exportTitle'),\n      iconType: 'warning',\n      content: t('common.exportMessage'),\n      async onOk() {\n        let exportParams = getForm().getFieldsValue();\n        Object.assign(exportParams,queryParam.value);\n        await exportSafeCheckTemplate(exportParams).then((res) => {\n          exportExcelFile(\n            res?.data,\n            (queryParam.value.safetyCheckType == CheckTypeNum.SPECIAL ? '专项' : '定期') + '检查.xls',\n          );\n        });\n        createMessage.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n\n   // 启动时，解析URL参数\n  onMounted(() => {\n    parseUrlParams();\n    MsgManager.getInstance().listen('safe-check-execution',  ()=>{\n      reload()\n    });\n  });\n</script>\n\n<style lang=\"less\" scoped>\n  .right-table-layout {\n    flex: 1;\n    width: calc(100% - 308px);\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings) {\n      margin-right: 0;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n</style>\n"],"names":["router","useRouter","currentRoute","selectedRowId","ref","query","urlToPath","queryParam","t","useI18n","createConfirm","createMessage","useMessage","openPage","dtlIds","addTabPage","selectTree","data","setStationAndOrgan","reload","parseUrlParams","path","params","parseRoutePath","getColumnsByType","getColumns","registerTable","getForm","getPaginationRef","getSelectRows","useTable","CheckTypeNum","__async","paginationRef","getSafeCheckTemplatePage","searchFormSchema","onSelect","sortInfo","info","key","record","selected","handleSelectChange","keys","rows","dbClick","index","event","handleEdit","handleCreate","SysMessage","array","pvalue","title","str","CommonUtil.toFlowPage","handleCancel","deleteProcessInstance","handleExport","exportParams","exportSafeCheckTemplate","res","exportExcelFile","onMounted","MsgManager"],"mappings":"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"}