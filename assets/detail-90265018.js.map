{"version":3,"file":"detail-90265018.js","sources":["../../src/views/hr/manage/oaleave/detail.vue"],"sourcesContent":["<template>\n  <div class=\"load\">\n    <a-spin :spinning=\"formState.spinning\" tip=\"Loading...\">\n      <div class=\"process-box\">\n        <!-- 标题 -->\n        <BillTitle :options=\"billTitleOptions\" />\n        <!-- 表单内容 -->\n        <div class=\"content\">\n          <div class=\"left-panel\">\n            <a-card title=\"基本信息\">\n              <a-form\n                :label-col=\"labelCol\"\n                :wrapper-col=\"wrapperCol\"\n                ref=\"formRef\"\n                :model=\"formState\"\n                :rules=\"rules\"\n              >\n                <a-form-item label=\"请假类型\" name=\"type\">\n                  <a-select\n                    v-model:value=\"formState.type\"\n                    allowClear\n                    :options=\"typeData\"\n                    placeholder=\"请选择请假类型\"\n                    :disabled=\"formState.status != 0\"\n                  />\n                </a-form-item>\n\n                <a-form-item label=\"开始时间\" name=\"startTime\">\n                  <a-date-picker\n                    v-model:value=\"formState.startTime\"\n                    :show-time=\"{ format: 'HH:mm:mm' }\"\n                    valueFormat=\"YYYY-MM-DD HH:mm:mm\"\n                    placeholder=\"请选择\"\n                    :disabled=\"formState.status != 0\"\n                  />\n                </a-form-item>\n                <a-form-item label=\"结束时间\" name=\"endTime\">\n                  <a-date-picker\n                    v-model:value=\"formState.endTime\"\n                    :show-time=\"{ format: 'HH:mm:mm' }\"\n                    valueFormat=\"YYYY-MM-DD HH:mm:mm\"\n                    placeholder=\"请选择\"\n                    :disabled=\"formState.status != 0\"\n                  />\n                </a-form-item>\n                <a-form-item label=\"请假事由\" name=\"reason\">\n                  <a-textarea v-model:value=\"formState.reason\" :disabled=\"formState.status != 0\" />\n                </a-form-item>\n              </a-form>\n            </a-card>\n            <a-card title=\"附件信息\">\n              <div class=\"clearfix\">\n                <UploadBox\n                  :width=\"800\"\n                  :height=\"550\"\n                  :maxCount=\"20\"\n                  :maxSize=\"100 * 1024 * 1024\"\n                  :application=\"`po`\"\n                  :module=\"`inventory`\"\n                  :vmode=\"formState.status == 0 ? `box` : `view`\"\n                  :bizId=\"formState.bizFileId\"\n                />\n              </div>\n            </a-card>\n            <a-card title=\"表格附件信息\">\n              <div class=\"clearfix\">\n                <BasicTable @register=\"registerAttachmentTable\" @edit-change=\"onEditChange\">\n                  <template #toolbar>\n                    <a-button\n                      type=\"primary\"\n                      :preIcon=\"IconEnum.ADD\"\n                      @click=\"handleAttachmentCreate\"\n                      v-if=\"formState.status === 0\"\n                    >\n                      添加\n                      <!-- {{ t('action.create') }} -->\n                    </a-button>\n                  </template>\n                  <template #bodyCell=\"{ column, record }\">\n                    <template v-if=\"column.key === 'action'\">\n                      <TableAction :actions=\"createActions(record)\" />\n                    </template>\n                  </template>\n                </BasicTable>\n              </div>\n            </a-card>\n          </div>\n          <div class=\"right-panel\">\n            <WfApproveBox\n              @save=\"onSave\"\n              @submit=\"onSubmit\"\n              :processStatus=\"formState.status\"\n              :processInstanceId=\"processInstanceId\"\n            />\n          </div>\n        </div>\n      </div>\n    </a-spin>\n  </div>\n</template>\n<script lang=\"ts\" setup>\n  import { ValidateErrorEntity } from 'ant-design-vue/es/form/interface';\n  import { Moment } from 'moment';\n  import { reactive, ref, toRaw, UnwrapRef, onMounted } from 'vue';\n  import { message } from 'ant-design-vue';\n  import { useRouter, useRoute } from 'vue-router';\n  import { cloneDeep } from 'lodash-es';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useMessage } from '/@/hooks/web/useMessage';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import {\n    BasicTable,\n    useTable,\n    TableAction,\n    BasicColumn,\n    ActionItem,\n    EditRecordRow,\n  } from '/@/components/Table';\n\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import { createOaLeave, getOaLeave } from '@/api/hr/oaleave';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n\n  import * as FileApi from '@/api/infra/file';\n\n  defineOptions({ name: 'OALeaveCreate' });\n\n  const router = useRouter();\n  const { query } = useRoute();\n\n  const labelCol = { span: 2 };\n  const wrapperCol = { span: 12 };\n  const billTitleOptions = reactive<any>({});\n  billTitleOptions.title = '请假申请';\n  billTitleOptions.infoItems = [];\n\n  const typeData: any = ref([]);\n  const processInstanceId = ref(null);\n\n  interface FormState {\n    id: string | undefined;\n    type: string | undefined;\n    startTime: Moment | undefined;\n    endTime: Moment | undefined;\n    reason: string | undefined;\n    status: number | 0;\n    spinning: boolean;\n    bizFileId: string | undefined;\n  }\n\n  const formRef = ref();\n  const formState: UnwrapRef<FormState> = reactive({\n    id: '',\n    type: '',\n    startTime: undefined,\n    endTime: undefined,\n    reason: '',\n    status: 0,\n    spinning: false,\n    bizFileId: '',\n  });\n  const rules = {\n    type: [{ required: true, message: '请选择请假类型', trigger: 'change' }],\n    startTime: [{ required: true, message: '请选择开始时间', trigger: 'change' }],\n    endTime: [{ required: true, message: '请选择结束时间', trigger: 'change' }],\n    reason: [{ required: true, message: '请输入请假事由', trigger: 'blur' }],\n  };\n\n  //==================================附件资料  begin ==================================\n\n  const getBizFileId = async () => {\n    FileApi.getBizId().then((res) => {\n      formState.bizFileId = res;\n    });\n  };\n\n  //==================================附件资料  end ==================================\n\n  //==================================附件表格资料  begin ==================================\n  const { createMessage: msg } = useMessage();\n  const currentEditKeyRef = ref('');\n  const fileList = ref([]);\n  const currentEditNodeRef = ref();\n\n  const handleAttachmentCreate = () => {\n    const dataSource = getAttachmentDataSource();\n    const addRow: EditRecordRow = {\n      key: `${Date.now()}`,\n    };\n    dataSource.push(addRow);\n  };\n\n  const attachmentColumns: BasicColumn[] = [\n    {\n      title: '附件',\n      dataIndex: 'name6',\n      editRow: true,\n      align: 'left',\n      editComponent: 'UploadBox',\n      editComponentProps: {\n        width: 800, // 上传弹框宽度\n        height: 550, // 上传弹框高度\n        maxCount: 20, // 最多上传文件数\n        maxSize: 100 * 1024 * 1024, // 单文件最大上传大小\n        application: 'po', //附件上传必须携带参数：应用，如：po、baseset、hr、da等\n        module: 'oaleave', //附件上传必须携带参数：模块\n        bizId: () => {\n          return formState.bizFileId; //附件上传必须携带参数：业务ID\n        },\n        callback: (value, options) => {\n          currentEditNodeRef.value; // currentEditNodeRef 此变量的定义要放在前面\n        },\n      },\n      width: 150,\n    },\n  ];\n\n  const [registerAttachmentTable, { getDataSource: getAttachmentDataSource }] = useTable({\n    columns: attachmentColumns,\n    showIndexColumn: false,\n    showTableSetting: true,\n    tableSetting: { fullScreen: true },\n    actionColumn: {\n      width: 160,\n      title: '操作',\n      dataIndex: 'action',\n    },\n    dataSource: fileList,\n  });\n\n  function onEditChange({ column, value, record }) {\n    // 本例\n    if (column.dataIndex === 'id') {\n      record.editValueRefs.name4.value = `${value}`;\n    }\n    console.log(column, value, record);\n  }\n\n  function handleEdit(record: EditRecordRow) {\n    try {\n      if (Reflect.has(currentEditKeyRef, 'value')) {\n        currentEditKeyRef.value = record.key;\n        currentEditNodeRef.value = record;\n        record.onEdit?.(true);\n      }\n    } catch (error) {\n      //\n    }\n  }\n\n  async function handleSave(record: EditRecordRow) {\n    msg.loading({ content: '正在保存...', duration: 0, key: 'saving' });\n    const valid = await record.onValid?.();\n    if (valid) {\n      try {\n        const data = cloneDeep(record.editValueRefs);\n        console.log(data);\n        // 保存之后提交编辑状态\n        const pass = await record.onEdit?.(false, true);\n        if (pass) {\n          currentEditKeyRef.value = '';\n        }\n        msg.success({ content: '数据已保存', key: 'saving' });\n      } catch (error) {\n        msg.error({ content: '保存失败', key: 'saving' });\n      }\n    } else {\n      msg.error({ content: '请填写正确的数据', key: 'saving' });\n    }\n  }\n\n  function handleCancel(record: EditRecordRow) {\n    try {\n      if (Reflect.has(currentEditKeyRef, 'value')) {\n        currentEditKeyRef.value = '';\n        record.onEdit?.(false, false);\n      }\n    } catch (error) {\n      //\n    }\n  }\n\n  function createActions(record: EditRecordRow): ActionItem[] {\n    if (!record.editable) {\n      return [\n        {\n          label: '编辑',\n          disabled: currentEditKeyRef.value ? currentEditKeyRef.value !== record.key : false,\n          onClick: handleEdit.bind(null, record),\n        },\n      ];\n    }\n    return [\n      {\n        label: '保存',\n        onClick: handleSave.bind(null, record),\n      },\n      {\n        label: '取消',\n        popConfirm: {\n          title: '是否取消编辑',\n          confirm: handleCancel.bind(null, record),\n        },\n      },\n    ];\n  }\n\n  //==================================附件表格资料  end ==================================\n\n  const onSave = () => {\n    doSave(0);\n  };\n\n  const onSubmit = () => {\n    formRef.value\n      .validate()\n      .then(() => {\n        const formData = toRaw(formState);\n        const isCompare = compareDate(formData.endTime, formData.startTime);\n        if (!isCompare) {\n          warning('请确认开始时间和结束时间。');\n          return;\n        }\n        doSave(1);\n      })\n      .catch((error: ValidateErrorEntity<FormState>) => {\n        console.log('onSubmit=》error', error);\n      });\n  };\n\n  const doSave = async (status) => {\n    formState.spinning = true;\n    try {\n      const formData = toRaw(formState);\n      formData['status'] = status;\n      console.log('formData', formData);\n      await createOaLeave(formData);\n      success(status == 1 ? '提交成功。' : '保存成功');\n      router.push('/hr/manage/oaleave');\n    } catch (error) {\n      console.log('error', error);\n    } finally {\n      formState.spinning = false;\n    }\n  };\n\n  const getInfo = async () => {\n    getOaLeave(formState.id).then((res) => {\n      formState.type = res['type'] + '';\n      formState.startTime = res['startTime'];\n      formState.endTime = res['endTime'];\n      formState.reason = res['reason'];\n      formState.status = res.status;\n      formState.bizFileId = res.bizFileId;\n\n      if (formState.status > 0) {\n        billTitleOptions.infoItems.push({\n          key: 'billCode',\n          label: '单据编号',\n          value: res.billCode,\n          position: 'left',\n        });\n        billTitleOptions.infoItems.push({\n          key: 'fillinDate',\n          label: '制单日期',\n          value: res.fillinDate,\n          position: 'center',\n        });\n        billTitleOptions.infoItems.push({\n          key: 'createPerson',\n          label: '创建人',\n          value: res.deptName + '.' + res.personMemberName,\n          position: 'right',\n        });\n      }\n    });\n  };\n\n  /** 初始化 */\n  onMounted(async () => {\n    typeData.value.push({ label: '病假', value: '1' });\n    typeData.value.push({ label: '事假', value: '2' });\n    typeData.value.push({ label: '婚假', value: '3' });\n\n    if (query.processInstanceId) {\n      processInstanceId.value = query.processInstanceId as unknown as string;\n      ProcessInstanceApi.getProcessInstance(processInstanceId.value).then((res) => {\n        formState.id = res.businessKey;\n        getInfo();\n      });\n    }\n  });\n\n  const compareDate = (d1, d2) => {\n    let date1 = new Date(Date.parse(d1));\n    let date2 = new Date(Date.parse(d2));\n    return date1 > date2;\n  };\n\n  const warning = (content) => {\n    message.warning(content);\n  };\n\n  const success = (content) => {\n    message.success(content);\n  };\n</script>\n<style lang=\"less\" scoped>\n  .process-box {\n    width: calc(100% - 20px);\n    height: calc(100% - 20px);\n    margin: 10px;\n\n    .content {\n      background: #fefefe;\n      .left-panel {\n        width: 83.5%;\n        float: left;\n        background: #fefefe;\n        border: 1px solid #f0f0f0;\n        margin: 5px 0px;\n        padding: 10px 0px 5px 0px;\n        height: calc(100vh - 200px);\n      }\n      .right-panel {\n        width: 16.25%;\n        float: right;\n        background: #fefefe;\n        border: 1px solid #f0f0f0;\n        margin: 5px 0px;\n        padding: 10px 0px 5px 0px;\n        height: calc(100vh - 200px);\n\n        .button-content {\n          margin: 16px 0 0 16px;\n          .ant-btn {\n            margin: 0px 10px 0px 0px;\n          }\n        }\n      }\n    }\n  }\n</style>\n"],"names":["router","useRouter","query","useRoute","labelCol","wrapperCol","billTitleOptions","reactive","typeData","ref","processInstanceId","formRef","formState","rules","msg","useMessage","currentEditKeyRef","fileList","currentEditNodeRef","handleAttachmentCreate","dataSource","getAttachmentDataSource","addRow","attachmentColumns","value","options","registerAttachmentTable","useTable","onEditChange","column","record","handleEdit","_a","error","handleSave","__async","data","cloneDeep","_b","handleCancel","createActions","onSave","doSave","onSubmit","formData","toRaw","compareDate","warning","status","createOaLeave","success","getInfo","getOaLeave","res","onMounted","ProcessInstanceApi.getProcessInstance","d1","d2","date1","date2","content","message"],"mappings":"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"}