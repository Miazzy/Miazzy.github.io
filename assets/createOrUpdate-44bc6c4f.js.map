{"version":3,"file":"createOrUpdate-44bc6c4f.js","sources":["../../src/views/po/safety/safecheckissue/createOrUpdate.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight  contentClass=\"flex\" style=\"position: relative\">\n  <div class=\"load\">\n    <a-spin :spinning=\"formState.spinning\" tip=\"Loading...\">\n      <div class=\"process-box\">\n        <div class=\"header-box\">\n          <BillTitle :options=\"billTitleOptions\" />\n          <WfApproveBox\n            @agree=\"handleAgree\"\n            @save=\"handleSave\"\n            @submit=\"handleSubmit\"\n            :processStatus=\"formState.status\"\n            :processInstanceId=\"processInstanceId\"\n            :listenMessage=\"`safe-check-issue`\"\n          />\n          <!-- <PrintButton style=\"margin-left: 10px\" v-if=\"formState.status === 2\" /> -->\n        </div>\n        <div class=\"content tab-model\">\n          <a-form\n            :model=\"formState\"\n            name=\"basic\"\n            ref=\"formRef\"\n            :label-col=\"{ span: 4 }\"\n            :wrapper-col=\"{ span: 20 }\"\n            autocomplete=\"off\"\n            @finish=\"onFinish\"\n          >\n            <a-card title=\"基本信息\" :bordered=\"false\">\n              <a-row :gutter=\"32\">\n                <a-col :span=\"12\">\n                  <a-form-item\n                    label=\"安全检查模板\"\n                    name=\"templateId\"\n                    :labelCol=\"{ style: { width: '124px'} }\" \n                    :rules=\"[{ required: true, message: '安全检查模板' }]\"\n                  >\n                    <a-select\n                      v-model:value=\"formState.templateId\"\n                      allowClear\n                      :options=\"templateData\"\n                      @change=\"changeTemplate\"\n                      :disabled=\"disabledInput\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col :span=\"12\">\n                  <a-form-item\n                    label=\"主题\"\n                    name=\"subject\"\n                    :labelCol=\"{ style: { width: '124px'} }\" \n                    :rules=\"[{ required: true, message: '主题' }]\"\n                  >\n                    <a-input\n                      v-model:value=\"formState.subject\"\n                      :disabled=\"disabledInput\"\n                      maxlength=\"128\"\n                    />\n                  </a-form-item>\n                </a-col>\n\n                <a-col :span=\"12\">\n                  <a-form-item\n                    label=\"任务日期\"\n                    name=\"taskDate\"\n                    :labelCol=\"{ style: { width: '124px'} }\" \n                    :rules=\"[{ required: true, message: '任务日期' }]\"\n                  >\n                    <a-date-picker\n                      v-model:value=\"formState.taskDate\"\n                      valueFormat=\"YYYY-MM-DD\"\n                      style=\"width: 100%\"\n                      :disabled=\"disabledInput\"\n                      @change=\"changeTaskDate\"\n                    />\n                  </a-form-item>\n                </a-col>\n                <a-col :span=\"12\">\n                  <a-form-item\n                    label=\"下发人\"\n                    name=\"issuedPersonId\"\n                    :labelCol=\"{ style: { width: '124px'} }\" \n                    :rules=\"[{ required: true, message: '下发人' }]\"\n                  >\n                    <a-select\n                      v-model:value=\"formState.issuedPersonId\"\n                      allow-clear\n                      :options=\"issuedPersonData\"\n                      @change=\"changeIssuedPerson\"\n                      :disabled=\"disabledInput\"\n                    />\n                  </a-form-item>\n                </a-col>\n              </a-row>\n            </a-card>\n          </a-form>\n          <a-card title=\"\" :bordered=\"false\">\n            <div id=\"more-tab-content\" class=\"tab-table-div\">\n            <a-tabs v-model:activeKey=\"activeKey\" @change=\"switchCom\">\n              <a-tab-pane key=\"tplChild\" tab=\"检查项目\">\n                <tplList ref=\"tplChild\" v-model:disabledInput=\"disabledInput\"/>\n              </a-tab-pane>\n              <a-tab-pane key=\"issueDtlChild\" tab=\"下发电站\" force-render>\n                <issueList ref=\"issueDtlChild\" \n                v-model:disabledInput=\"disabledInput\"\n                v-model:templateId=\"formState.templateId\"\n                v-model:taskDate=\"formState.taskDate\"\n                />\n              </a-tab-pane>\n            </a-tabs>\n          </div>\n          </a-card>\n        </div>\n      </div>\n    </a-spin>\n  </div>\n</PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  //form\n  import { PageWrapper } from '/@/components/Page';\n  import { reactive, ref, onMounted,toRaw,computed } from 'vue';\n  import { urlToPath } from '/@/utils/route';\n  import { FormInstance } from 'ant-design-vue';\n  import { SysMessage } from '/@/hooks/web/useMessage';\n  // import PrintButton from '/@/components/Framework/Button/PrintButton.vue';\n  import {\n    addIssueData,\n    getIssueData,\n    getListTplData,\n    getOrgPersonlData,\n    getOrgUser,\n  } from './createOrUpdate';\n  import tplList from './tplList.vue';\n  import issueList from './issueList.vue';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { MsgManager } from '/@/message/MsgManager';\n  import { closeCurrentTab } from '@/utils/route';\n  import { useUserStore } from '/@/store/modules/user';\n\n\n  const userStore = useUserStore();\n  const userInfo = toRaw(userStore.getUserInfo);\n  const billTitleOptions = reactive<any>({subject : '专项检查下发'});\n \n \n  const disabledInput=computed(()=>{\n    return formState.status!=0 || (formState.status==0 && \n    formState.personMemberId !='' && \n          formState.personMemberId.substring(0,32) != userInfo.userId);\n  })\n  const isRequire = ref(true);\n\n  const formRef = ref<FormInstance>();\n\n  const templateData: any = ref([]);\n  const issuedPersonData: any = ref([]);\n  const tplChild: any = ref(null);\n  const issueDtlChild: any = ref(null);\n  const processInstanceId: any = ref<string>('');\n  const activeKey = ref('tplChild');\n\n  const switchCom = (index) => {\n    tplChild.value.reloadGrid({ templateId: formState.templateId });\n    issueDtlChild.value.reloadGrid({ \n        safeCheckIssueId: formState.id, \n        status: formState.status,\n        templateId:formState.templateId,\n        taskDate:formState.taskDate,\n        activeKey:activeKey.value,\n        disabledInput:disabledInput\n      });\n  };\n\n  const changeTaskDate=()=>{\n    issueDtlChild.value.reloadGrid({ \n        safeCheckIssueId: formState.id, \n        status: formState.status,\n        templateId:formState.templateId,\n        taskDate:formState.taskDate,\n        activeKey:activeKey.value,\n        disabledInput:disabledInput\n      });\n      if (activeKey.value == 'issueDtlChild') {\n        issueDtlChild.value.resetData();\n      }\n      \n  }\n\n  const changeTemplate = (value, item) => {\n    formState.templateId = value;\n    formState.templateName = item.label;\n    formState.checkType = item.checkType;\n    if (activeKey.value == 'tplChild') {\n      tplChild.value.reloadGrid({ templateId: formState.templateId });\n    }else {\n      issueDtlChild.value.reloadGrid({ \n        safeCheckIssueId: formState.id, \n        status: formState.status,\n        activeKey:activeKey.value,\n        templateId:formState.templateId,\n        taskDate:formState.taskDate\n      });\n      issueDtlChild.value.resetData();\n    }\n  };\n  const changeIssuedPerson = (value, item) => {\n    formState.issuedPersonId = value;\n    formState.issuedPersonName = item.label;\n  };\n\n  const handleAgree = (flowData) => {\n    console.log('同意', flowData);\n  };\n\n  const handleSave = (flowData) => {\n    console.log('保存', flowData);\n    isRequire.value = false;\n    formState.status = 0;\n    onFinish();\n  };\n  const handleSubmit = (flowData) => {\n    console.log('提交', flowData);\n    isRequire.value = true;\n    formState.status = 1;\n    const value = formRef.value;\n    if (!value) {\n      return;\n    }\n    value\n      .validateFields()\n      .then(() => {\n        if (issueDtlChild.value.getDataSource().length === 0) {\n          SysMessage.getInstance().info('电站不能为空');\n          formState.status = 0;\n          return;\n        }\n        onFinish();\n      })\n      .catch((e) => {\n        console.log(e);\n        formState.status = 0;\n      });\n  };\n  let {params:query} = urlToPath() as any;\n  const formState:any = reactive({\n    id: query.id || '',\n    subject: '',\n    checkType: '',\n    templateId: '',\n    templateName: '',\n    checkPeriod: '',\n    personMemberId: '',\n    num: 1,\n    status: 0,\n    taskDate: null,\n    issuedPersonId: null,\n    issuedPersonName: '',\n    billCode: '',\n    fillinDate: '',\n    spinning:false,\n    dtl: {},\n  });\n\n  const onFinish = () => {\n    formState.dtl = issueDtlChild.value.getDataSource();\n    formState.spinning=true;\n    addIssueData(formState)\n      .then((rsp) => {\n        if (rsp.result != '') {\n          formState.id = rsp.result;\n          SysMessage.getInstance().success(formState.status == 1 ? '提交成功' : '保存成功');\n          if (formState.status == 1) {\n            setTimeout(() => {\n              closeCurrentTab();\n              MsgManager.getInstance().sendMsg('safe-check-issue', {});\n            }, 100);\n          }\n        } else {\n          formState.status = 0;\n          isRequire.value = false;\n        \n          SysMessage.getInstance().error('保存失败.');\n        }\n        formState.spinning=false;\n      })\n      .catch((e) => {\n        console.log(e);\n        isRequire.value = false;\n        formState.status = 0;\n        formState.spinning=false;\n      });\n  };\n\n  // global\n  onMounted(async () => {\n    processInstanceId.value = query.processInstanceId;\n    if (!formState.id && query.processInstanceId) {\n      const processInstance = await ProcessInstanceApi.getProcessInstance(\n        query.processInstanceId as string,\n      );\n\n      formState.id = processInstance.businessKey;\n    }\n    //查询初始数据\n    getIssueData({ id: formState.id })\n      .then((rsp) => {\n        let rs = rsp.result;\n        if (formState.id) {\n          for (let key in rs) {\n            formState[key] = rs[key];\n          }\n          formState.status = Number(formState.status);\n          tplChild.value.reloadGrid({ templateId: formState.templateId });\n        } else {\n          formState.billCode = rs.billCode;\n          formState.personMemberName = rs.personMemberName;\n          formState.deptName=rs.deptName;\n          formState.fillinDate = rs.fillinDate;\n        }\n        let { billCode, fillinDate, personMemberName,deptName } = rs;\n        Object.assign(billTitleOptions, { billCode, fillinDate, personMemberName,deptName });\n      })\n      .then(() => {\n        //当前组织下其他人\n        if (formState.status == 0) {\n          getOrgUser({}).then((rsp) => {\n            getOrgPersonlData({ deptId: rsp.result.org.deptId, orgKindIds: 'psm'}).then((rsp) => {\n              let data = {};\n              rsp.result.forEach((e) => {\n                data[e.personId] = e.name;\n              });\n              for (const key in data) {\n                issuedPersonData.value.push({ label: data[key], value: key });\n              }\n            });\n          });\n        } else {\n          issuedPersonData.value.push({\n            label: formState.issuedPersonName,\n            value: formState.issuedPersonId,\n          });\n        }\n      });\n\n    //查询模板\n    getListTplData({ checkType: '2', status: 2, bizStatus: 1 }).then((rsp) => {\n      rsp.result.forEach((e) => {\n        templateData.value.push({ label: e.subject, value: e.id, checkType: e.checkType });\n      });\n    });\n  });\n</script>\n\n<style lang=\"less\" scoped>\n  .process-box {\n    margin-top: 0;\n  }\n\n  :deep(.vben-basic-table-header__toolbar) {\n    margin-top: 8px;\n  }\n</style>\n"],"names":["userStore","useUserStore","userInfo","toRaw","billTitleOptions","reactive","disabledInput","computed","formState","isRequire","ref","formRef","templateData","issuedPersonData","tplChild","issueDtlChild","processInstanceId","activeKey","switchCom","index","changeTaskDate","changeTemplate","value","item","changeIssuedPerson","handleAgree","flowData","handleSave","onFinish","handleSubmit","SysMessage","e","query","urlToPath","addIssueData","rsp","closeCurrentTab","MsgManager","onMounted","__async","processInstance","ProcessInstanceApi.getProcessInstance","getIssueData","rs","key","billCode","fillinDate","personMemberName","deptName","getOrgUser","getOrgPersonlData","data","getListTplData"],"mappings":"gvDA8IE,MAAMA,EAAYC,IACZC,EAAWC,GAAMH,EAAU,WAAW,EACtCI,EAAmBC,EAAc,CAAC,QAAU,QAAS,CAAA,EAGrDC,EAAcC,GAAS,IACpBC,EAAU,QAAQ,GAAMA,EAAU,QAAQ,GACjDA,EAAU,gBAAiB,IACrBA,EAAU,eAAe,UAAU,EAAE,EAAE,GAAKN,EAAS,MAC5D,EACKO,EAAYC,EAAI,EAAI,EAEpBC,EAAUD,IAEVE,EAAoBF,EAAI,CAAA,CAAE,EAC1BG,EAAwBH,EAAI,CAAA,CAAE,EAC9BI,EAAgBJ,EAAI,IAAI,EACxBK,EAAqBL,EAAI,IAAI,EAC7BM,EAAyBN,EAAY,EAAE,EACvCO,EAAYP,EAAI,UAAU,EAE1BQ,EAAaC,GAAU,CAC3BL,EAAS,MAAM,WAAW,CAAE,WAAYN,EAAU,WAAY,EAC9DO,EAAc,MAAM,WAAW,CAC3B,iBAAkBP,EAAU,GAC5B,OAAQA,EAAU,OAClB,WAAWA,EAAU,WACrB,SAASA,EAAU,SACnB,UAAUS,EAAU,MACpB,cAAAX,CAAA,CACD,CAAA,EAGCc,EAAe,IAAI,CACvBL,EAAc,MAAM,WAAW,CAC3B,iBAAkBP,EAAU,GAC5B,OAAQA,EAAU,OAClB,WAAWA,EAAU,WACrB,SAASA,EAAU,SACnB,UAAUS,EAAU,MACpB,cAAAX,CAAA,CACD,EACGW,EAAU,OAAS,iBACrBF,EAAc,MAAM,WACtB,EAIEM,EAAiB,CAACC,EAAOC,IAAS,CACtCf,EAAU,WAAac,EACvBd,EAAU,aAAee,EAAK,MAC9Bf,EAAU,UAAYe,EAAK,UACvBN,EAAU,OAAS,WACrBH,EAAS,MAAM,WAAW,CAAE,WAAYN,EAAU,WAAY,GAE9DO,EAAc,MAAM,WAAW,CAC7B,iBAAkBP,EAAU,GAC5B,OAAQA,EAAU,OAClB,UAAUS,EAAU,MACpB,WAAWT,EAAU,WACrB,SAASA,EAAU,QAAA,CACpB,EACDO,EAAc,MAAM,YACtB,EAEIS,EAAqB,CAACF,EAAOC,IAAS,CAC1Cf,EAAU,eAAiBc,EAC3Bd,EAAU,iBAAmBe,EAAK,KAAA,EAG9BE,EAAeC,GAAa,CACxB,QAAA,IAAI,KAAMA,CAAQ,CAAA,EAGtBC,EAAcD,GAAa,CACvB,QAAA,IAAI,KAAMA,CAAQ,EAC1BjB,EAAU,MAAQ,GAClBD,EAAU,OAAS,EACVoB,GAAA,EAELC,EAAgBH,GAAa,CACzB,QAAA,IAAI,KAAMA,CAAQ,EAC1BjB,EAAU,MAAQ,GAClBD,EAAU,OAAS,EACnB,MAAMc,EAAQX,EAAQ,MACjBW,GAIFA,EAAA,iBACA,KAAK,IAAM,CACV,GAAIP,EAAc,MAAM,cAAc,EAAE,SAAW,EAAG,CACzCe,EAAA,YAAA,EAAc,KAAK,QAAQ,EACtCtB,EAAU,OAAS,EACnB,MACF,CACSoB,GAAA,CACV,EACA,MAAOG,GAAM,CACZ,QAAQ,IAAIA,CAAC,EACbvB,EAAU,OAAS,CAAA,CACpB,CAAA,EAEL,GAAI,CAAC,OAAOwB,CAAK,EAAIC,EAAU,EAC/B,MAAMzB,EAAgBH,EAAS,CAC7B,GAAI2B,EAAM,IAAM,GAChB,QAAS,GACT,UAAW,GACX,WAAY,GACZ,aAAc,GACd,YAAa,GACb,eAAgB,GAChB,IAAK,EACL,OAAQ,EACR,SAAU,KACV,eAAgB,KAChB,iBAAkB,GAClB,SAAU,GACV,WAAY,GACZ,SAAS,GACT,IAAK,CAAC,CAAA,CACP,EAEKJ,EAAW,IAAM,CACXpB,EAAA,IAAMO,EAAc,MAAM,cAAc,EAClDP,EAAU,SAAS,GACnB0B,GAAa1B,CAAS,EACnB,KAAM2B,GAAQ,CACTA,EAAI,QAAU,IAChB3B,EAAU,GAAK2B,EAAI,OACnBL,EAAW,YAAc,EAAA,QAAQtB,EAAU,QAAU,EAAI,OAAS,MAAM,EACpEA,EAAU,QAAU,GACtB,WAAW,IAAM,CACC4B,IAChBC,EAAW,YAAY,EAAE,QAAQ,mBAAoB,CAAE,CAAA,GACtD,GAAG,IAGR7B,EAAU,OAAS,EACnBC,EAAU,MAAQ,GAEPqB,EAAA,YAAA,EAAc,MAAM,OAAO,GAExCtB,EAAU,SAAS,EAAA,CACpB,EACA,MAAOuB,GAAM,CACZ,QAAQ,IAAIA,CAAC,EACbtB,EAAU,MAAQ,GAClBD,EAAU,OAAS,EACnBA,EAAU,SAAS,EAAA,CACpB,CAAA,EAIL,OAAA8B,GAAU,IAAYC,EAAA,sBAEpB,GADAvB,EAAkB,MAAQgB,EAAM,kBAC5B,CAACxB,EAAU,IAAMwB,EAAM,kBAAmB,CACtC,MAAAQ,EAAkB,MAAMC,EAC5BT,EAAM,iBAAA,EAGRxB,EAAU,GAAKgC,EAAgB,WACjC,CAEaE,EAAA,CAAE,GAAIlC,EAAU,EAAA,CAAI,EAC9B,KAAM2B,GAAQ,CACb,IAAIQ,EAAKR,EAAI,OACb,GAAI3B,EAAU,GAAI,CAChB,QAASoC,KAAOD,EACJnC,EAAAoC,CAAG,EAAID,EAAGC,CAAG,EAEfpC,EAAA,OAAS,OAAOA,EAAU,MAAM,EAC1CM,EAAS,MAAM,WAAW,CAAE,WAAYN,EAAU,WAAY,CAAA,MAE9DA,EAAU,SAAWmC,EAAG,SACxBnC,EAAU,iBAAmBmC,EAAG,iBAChCnC,EAAU,SAASmC,EAAG,SACtBnC,EAAU,WAAamC,EAAG,WAE5B,GAAI,CAAE,SAAAE,EAAU,WAAAC,EAAY,iBAAAC,EAAiB,SAAAC,GAAaL,EAC1D,OAAO,OAAOvC,EAAkB,CAAE,SAAAyC,EAAU,WAAAC,EAAY,iBAAAC,EAAiB,SAAAC,EAAU,CAAA,CACpF,EACA,KAAK,IAAM,CAENxC,EAAU,QAAU,EACtByC,EAAW,CAAE,CAAA,EAAE,KAAMd,GAAQ,CAC3Be,GAAkB,CAAE,OAAQf,EAAI,OAAO,IAAI,OAAQ,WAAY,KAAM,CAAA,EAAE,KAAMA,GAAQ,CACnF,IAAIgB,EAAO,CAAA,EACXhB,EAAI,OAAO,QAASJ,GAAM,CACnBoB,EAAApB,EAAE,QAAQ,EAAIA,EAAE,IAAA,CACtB,EACD,UAAWa,KAAOO,EACCtC,EAAA,MAAM,KAAK,CAAE,MAAOsC,EAAKP,CAAG,EAAG,MAAOA,CAAA,CAAK,CAC9D,CACD,CAAA,CACF,EAED/B,EAAiB,MAAM,KAAK,CAC1B,MAAOL,EAAU,iBACjB,MAAOA,EAAU,cAAA,CAClB,CACH,CACD,EAGY4C,GAAA,CAAE,UAAW,IAAK,OAAQ,EAAG,UAAW,CAAG,CAAA,EAAE,KAAMjB,GAAQ,CACpEA,EAAA,OAAO,QAASJ,GAAM,CACxBnB,EAAa,MAAM,KAAK,CAAE,MAAOmB,EAAE,QAAS,MAAOA,EAAE,GAAI,UAAWA,EAAE,SAAW,CAAA,CAAA,CAClF,CAAA,CACF,CAAA,EACF"}