{"version":3,"file":"issueList-77ab7d2e.js","sources":["../../src/views/po/safety/safecheckissue/createOrUpdate.ts","../../src/views/po/safety/safecheckissue/issueList.vue"],"sourcesContent":["import { BasicColumn } from '@/components/Table';\nimport { defHttp } from '@/utils/http/axios';\nimport { useUserStore } from '/@/store/modules/user';\n\nenum Api {\n  //查询模版明细指标\n  getTplDtlData = '/po/safe-check-template/dtl/list',\n  //查询模版指标\n  getListTplData = '/po/safe-check-template/list',\n\n  //保存或更新\n  addIssueData = '/po/safe-check-issue/create',\n  //查询明细\n  getIssueData = '/po/safe-check-issue/get',\n\n\n  //查询下发电站\n  getListIssueData = '/po/safe-check-issue/dtl/list',\n  //查询电站数据\n  getListStationData = '/baseset/common/list-station',\n  getOrgPersonlData = '/system/org/list-tree',\n  getOrgUser = '/po/safe-check-issue/getOrg',\n}\n\n// 查询安全检查模版下发列表\nexport function getTplDtlData(params) {\n  return defHttp.get({ url: Api.getTplDtlData, params });\n}\n// 查询安全检查模版下发列表\nexport function getListTplData(params) {\n  return defHttp.get({ url: Api.getListTplData, params });\n}\n\n// 保存或更新\nexport function addIssueData(params) {\n  return defHttp.post({ url: Api.addIssueData, params });\n}\n\nexport function getIssueData(params) {\n  return defHttp.get({ url: Api.getIssueData, params });\n}\n\nexport function getListIssueData(params) {\n  return defHttp.get({ url: Api.getListIssueData, params });\n}\nexport function getListStationData(params) {\n  return defHttp.post({ url: Api.getListStationData, params });\n}\nexport function getOrgPersonlData(params) {\n  return defHttp.post({ url: Api.getOrgPersonlData, params });\n}\nexport function getOrgUser(params) {\n  return defHttp.get({ url: Api.getOrgUser, params });\n}\n\nexport const dtlColumns: BasicColumn[] = [\n  { title: '所属公司', dataIndex: 'stationOrganName',align: 'left',headAlign:'center', width: 160 ,ifShow:useUserStore().isMultiOrganization},\n  { title: '电站名称', dataIndex: 'stationName',align: 'left',headAlign:'center', width: 160 },\n  { title: '检查单号', dataIndex: 'billCode', width: 160 },\n  { title: '检查单状态', dataIndex: 'statusText', width: 80 },\n  { title: '待整改项数', dataIndex: 'rectificationNum',align: 'right',headAlign:'center', width: 100 },\n  { title: '负责人', dataIndex: 'responsiblePersonName',align: 'left',headAlign:'center', width: 160 },\n  { title: '检查日期', dataIndex: 'checkDate', width: 100 },\n];\n","<template>\n  <BasicTable @register=\"issueDtlTable\" >\n    <template #toolbar>\n      <a-button :preIcon=\"IconEnum.ADD\" \n      type=\"primary\"\n      v-if=\"status == 0 && !props.disabledInput && activeKey == 'issueDtlChild'\"\n       @click=\"addRow\" :style=\"{ 'margin-right': '10px' }\">\n        {{ '添加' }}\n      </a-button>\n      <a-button :preIcon=\"IconEnum.DELETE\" \n       @click=\"deleteRow\"\n       v-if=\"status == 0 && !props.disabledInput && activeKey == 'issueDtlChild'\"\n       >\n        {{ '删除' }}\n      </a-button>\n    </template>\n  </BasicTable>\n\n  <Dialog\n    :maskClosable=\"false\"\n    v-model:visible=\"open\"\n    title=\"选择下发电站\"\n    @ok=\"handleOk\"\n    :width=\"1000\"\n  >\n    <BasicTable  @register=\"powerstationTable\" class=\"table-in-dialog\" />\n  </Dialog>\n</template>\n\n<script lang=\"ts\" setup>\n  import { defHttp } from '@/utils/http/axios';\n  import { ref } from 'vue';\n  import { BasicTable, useTable } from '@/components/Table';\n  import { dtlColumns, getListIssueData, getListStationData } from './createOrUpdate';\n  import { message } from 'ant-design-vue';\n  import { IconEnum } from '@/enums/appEnum';\n  import { buildUUID } from '@/utils/uuid';\n  import Dialog from '@/components/Framework/Modal/Dialog.vue';\n  import { useUserStore } from '/@/store/modules/user';\n  const props = defineProps({\n    disabledInput:{ type: Boolean, default: false },\n    taskDate:{ type: Date, default: null },\n    templateId:{ type: String, default: '' }\n  })\n  const safeCheckIssueId = ref('');\n  const status = ref(0);\n  const initReload = ref(true);\n\n  const stationIds=ref('');\n  const activeKey=ref('');\n\n  const getAllReadyStation=()=> {\n    let params={\n      templateId:props.templateId,\n      taskDate:props.taskDate\n    };\n  return defHttp.get({ url:  '/po/safe-check-execution/getAllReadyStation',  params})\n\n}\n\nconst resetData=()=>{\n  setTableData([]);\n}\n\n  const reloadGrid = (param) => {\n    safeCheckIssueId.value = param.safeCheckIssueId;\n    status.value = param.status;\n\n    activeKey.value=param.activeKey;\n\n    if (initReload.value) {\n      reload();\n      initReload.value = false;\n    }\n    if (status.value != 0) {\n      document.getElementsByClassName('ant-table-title')[0].style = 'display:none';\n    }\n  };\n\n  const open = ref(false);\n  const addRow = () => {\n    if(props.templateId == '' || props.taskDate == null){\n      message.error('安全检查模板和任务日期不能为空。');\n      return false;\n    }\n    getAllReadyStation().then(rsp=>{\n      stationIds.value=rsp.result;\n      open.value = true;\n    })\n   \n  };\n\n  function deleteRow() {\n    deleteTableDataRecord(getSelectRowKeys());\n  }\n\n  const handleOk = () => {\n    let rows = getSelectRows();\n    if (rows.length == 0) {\n      message.info('请选择指标');\n      return false;\n    }\n    open.value = false;\n    let existData = getDataSource();\n    let keyMap = {};\n    existData.forEach((e) => {\n      keyMap[e.stationId] = e.stationId;\n    });\n    rows.forEach((e) => {\n      if (!keyMap[e.powerStationId]) {\n        existData.push({\n          id: buildUUID(),\n          stationOrganId: e.organId,\n          stationOrganName: e.organName,\n          stationId: e.powerStationId,\n          stationName: e.powerStationName,\n        });\n      }\n    });\n\n    setTableData(existData);\n    clearSelectedRowKeys();\n  };\n  const [\n    issueDtlTable,\n    { setTableData, getSelectRowKeys, deleteTableDataRecord, getDataSource, reload },\n  ] = useTable({\n    title: '',\n    api: async () => {\n      let dataObj = await getListIssueData({\n        safeCheckIssueId: safeCheckIssueId.value,\n      });\n      return dataObj.result;\n    },\n    rowKey: 'id',\n    bordered: true,\n    pagination: false,\n    target: '#more-tab-content',\n    targetTabKey: 'issueDtlChild',\n    targetTabValue: activeKey,\n    columns: dtlColumns,\n    useSearchForm: false,\n    showTableSetting: false,\n    rowSelection: {\n      type: 'checkbox',\n    },\n  });\n\n  const getOrgInfoData = async (params) => {\n    let rsp=await defHttp.get({ url: '/bi/common/org/info', params }, { isOnlyResult: true });\n    let data=[] as any;\n    rsp.forEach(e => {\n      data.push({value:e.id,label:e.label});\n    });\n    return data;\n  };\n  const statiQueryParam: any = ref({ \n    pageNo: 1, \n    pageSize: 10,\n    templateId:props.templateId,\n    taskDate:props.taskDate });\n  const [powerstationTable, { getSelectRows, clearSelectedRowKeys, getPaginationRef }] = useTable({\n    title: '',\n    api: async () => {\n      const paginationRef = getPaginationRef() as any;\n      statiQueryParam.value.pageNo = paginationRef.current;\n      statiQueryParam.value.pageSize = paginationRef.pageSize;\n      statiQueryParam.value.exceptStationIdList=stationIds.value;\n      let dataObj = await getListStationData(statiQueryParam.value);\n      return dataObj.result;\n    },\n    columns: [\n      { title: '所属公司', dataIndex: 'organName', width: 80,ifShow:useUserStore().isMultiOrganization },\n      { title: '电站名称', dataIndex: 'powerStationName', width: 160 },\n    ],\n    formConfig: {\n      labelWidth: 120,\n      schemas: [\n        {\n          label: '所属公司',\n          field: 'stationOrganId',\n          component: 'ApiSelect',\n          componentProps: {\n            options: [],\n            api: getOrgInfoData,\n          },\n          colProps: { span: 10 }\n          ,ifShow:useUserStore().isMultiOrganization \n        },\n        {\n          label: '电站名称',\n          field: 'powerStationName',\n          component: 'Input',\n          colProps: { span: 10 },\n        },\n      ],\n    },\n    bordered: true,\n    useSearchForm: true,\n    showTableSetting: false,\n    rowSelection: {\n      type: 'checkbox',\n    },\n    handleSearchInfoFn(info) {\n      statiQueryParam.value.organName = info.organName;\n      statiQueryParam.value.powerStationName = info.powerStationName;\n    },\n    maxHeight: 343\n  });\n\n  defineExpose({ reloadGrid, getDataSource,resetData });\n</script>\n<style lang=\"less\" scoped>\n  :deep(.ant-table-container) {\n    overflow-x: hidden;\n  }\n\n  :deep(.vben-basic-table-header__toolbar) {\n    margin-top: 8px;\n  }\n</style>\n"],"names":["getListTplData","params","defHttp","addIssueData","getIssueData","getListIssueData","getListStationData","getOrgPersonlData","getOrgUser","dtlColumns","useUserStore","safeCheckIssueId","ref","status","initReload","stationIds","activeKey","getAllReadyStation","props","resetData","setTableData","reloadGrid","param","reload","open","addRow","message","rsp","deleteRow","deleteTableDataRecord","getSelectRowKeys","handleOk","rows","getSelectRows","existData","getDataSource","keyMap","e","buildUUID","clearSelectedRowKeys","issueDtlTable","useTable","__async","getOrgInfoData","data","statiQueryParam","powerstationTable","getPaginationRef","paginationRef","info","__expose"],"mappings":"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"}