{"version":3,"file":"infoarchiveCreate-bc44839e.js","sources":["../../src/views/po/integrated/infoarchive/infoarchiveCreate.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <a-spin :spinning=\"formState.spinning\" tip=\"Loading...\">\n        <div class=\"process-box\">\n          <!-- 标题和操作按钮 -->\n          <div class=\"header-box\">\n            <BillTitle :options=\"billTitleOption\" />\n            <WfApproveBox\n              @save=\"onSave\"\n              @submit=\"onSubmit\"\n              :processInstanceId=\"formState.processInstanceId\"\n              :processStatus=\"formState.status\"\n            />\n            <!-- 取消打印 -->\n            <!-- <PrintButton v-if=\"formState.status === 2 ? true : false\" /> -->\n          </div>\n          <!-- 表单内容 -->\n          <div class=\"content\">\n            <div>\n              <a-form ref=\"formRef\" :model=\"formState\" labelAlign=\"right\" autocomplete=\"off\">\n                <a-card title=\"基本信息\" :bordered=\"false\">\n                  <a-row>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"stationName\"\n                        label=\"电站名称\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: false }]\"\n                      >\n                        <a-input disabled v-model:value=\"formState.id\" v-if=\"false\" />\n                        <a-input disabled v-model:value=\"formState.stationId\" v-if=\"false\" />\n                        <a-input disabled v-model:value=\"formState.stationName\" />\n                        <a-input disabled v-model:value=\"formState.stationOrganId\" v-if=\"false\" />\n                        <a-input disabled v-model:value=\"formState.stationOrganName\" v-if=\"false\" />\n                      </a-form-item>\n                    </a-col>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"periodName\"\n                        label=\"期数\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: false }]\"\n                      >\n                        <a-input disabled v-model:value=\"formState.periodName\" />\n                        <a-input disabled v-model:value=\"formState.periodId\" v-if=\"false\" />\n                      </a-form-item>\n                    </a-col>\n                  </a-row>\n\n                  <a-row>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"competentName\"\n                        label=\"主管单位\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: true, message: '请选择主管单位' }]\"\n                      >\n                        <DictSelectBox\n                          v-model:value=\"formState.competentName\"\n                          :type=\"`competentType`\"\n                          :style=\"`width: 100%`\"\n                          :disabled=\"disabledInput\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"issuedDate\"\n                        label=\"下发日期\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: true, message: '请选择下发日期' }]\"\n                      >\n                        <a-date-picker\n                          v-model:value=\"formState.issuedDate\"\n                          format=\"YYYY-MM-DD\"\n                          value-format=\"YYYY-MM-DD\"\n                          :style=\"`width: 100%`\"\n                          :disabled=\"disabledInput\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                  </a-row>\n\n                  <a-row>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"grade\"\n                        label=\"重要等级\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: true, message: '请选择重要等级' }]\"\n                      >\n                        <DictSelectBox\n                          v-model:value=\"formState.grade\"\n                          :type=\"`archiveGradeType`\"\n                          :style=\"`width: 100%`\"\n                          :disabled=\"disabledInput\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"issuingCompany\"\n                        label=\"发文单位\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: true, message: '请输入发文单位' }]\"\n                      >\n                        <a-input\n                          v-model:value=\"formState.issuingCompany\"\n                          placeholder=\"请输入发文单位\"\n                          :disabled=\"disabledInput\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                  </a-row>\n\n                  <a-row>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"competentNameLevel\"\n                        label=\"主管单位级别\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ required: true, message: '请选择主管单位级别' }]\"\n                      >\n                        <DictSelectBox\n                          v-model:value=\"formState.competentNameLevel\"\n                          :type=\"`competentLevelType`\"\n                          :style=\"`width: 100%`\"\n                          :disabled=\"disabledInput\"\n                          @change=\"handleSelectChange\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                    <a-col v-show=\"true\" :span=\"12\">\n                      <a-form-item\n                        name=\"otherCompetentName\"\n                        label=\"其他主管单位\"\n                        :labelCol=\"{ span: 6 }\"\n                        :rules=\"[{ message: '请输入其他主管单位' }]\"\n                        :required=\"isRequired\"\n                      >\n                        <a-input\n                          v-model:value=\"formState.otherCompetentName\"\n                          placeholder=\"请输入其他主管单位\"\n                          :disabled=\"disabledInput\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                  </a-row>\n\n                  <a-row>\n                    <a-col v-show=\"true\" :span=\"24\">\n                      <a-form-item\n                        name=\"subject\"\n                        label=\"主题\"\n                        :labelCol=\"{ span: 3 }\"\n                        :rules=\"[{ required: true, message: '请输入主题' }]\"\n                      >\n                        <a-input\n                          v-model:value=\"formState.subject\"\n                          placeholder=\"请输入主题\"\n                          :disabled=\"disabledInput\"\n                          :maxlength=\"100\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                  </a-row>\n\n                  <a-row>\n                    <a-col v-show=\"true\" :span=\"24\">\n                      <a-form-item\n                        name=\"requirement\"\n                        label=\"文件要求\"\n                        :labelCol=\"{ span: 3 }\"\n                        :rules=\"[{ required: true, message: '请输入文件要求' }]\"\n                      >\n                        <a-textarea\n                          :rows=\"4\"\n                          v-model:value=\"formState.requirement\"\n                          placeholder=\"请输入文件要求\"\n                          :disabled=\"disabledInput\"\n                          :maxlength=\"1000\"\n                        />\n                      </a-form-item>\n                    </a-col>\n                  </a-row>\n                </a-card>\n                <a-card title=\"信息档案附件\" :bordered=\"false\">\n                  <UploadBox\n                    :width=\"800\"\n                    :height=\"550\"\n                    :maxCount=\"20\"\n                    :maxSize=\"100 * 1024 * 1024\"\n                    :application=\"`po`\"\n                    :module=\"`infoarchive`\"\n                    :vmode=\"formState.status == 0 ? `box` : `view`\"\n                    :bizId=\"formState.bizFileId\"\n                  />\n                </a-card>\n              </a-form>\n            </div>\n          </div>\n        </div>\n      </a-spin>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { reactive, onMounted, UnwrapRef, ref, toRaw, unref } from 'vue';\n  import { useRouter } from 'vue-router';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import DictSelectBox from '@/components/Framework/Combox/DictSelectBox.vue';\n  import { ValidateErrorEntity } from 'ant-design-vue/es/form/interface';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { saveInfoarchive, getInfoarchive } from './data';\n  import { message, FormInstance } from 'ant-design-vue';\n  import { assign } from 'lodash-es';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import * as FileApi from '@/api/infra/file';\n  import { closeCurrentTab } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n  import { PageWrapper } from '/@/components/Page';\n  import { Memory } from '@/router/index';\n\n  const query = Memory.getInstance().getQuery(); // route.query;\n  const formState: UnwrapRef<any> = reactive({ spinning: false, status: 0 });\n  const formRef = ref<FormInstance>();\n  const disabledInput = ref<boolean>(true);\n\n  const isRequired = ref<boolean>(false);\n\n  const billTitleOption = reactive<any>({ subject: '信息档案' });\n  billTitleOption.title = '信息档案';\n\n  const handleSelectChange = (value: string) => {\n    if (value === '6') {\n      isRequired.value = true;\n    } else {\n      isRequired.value = false;\n    }\n  };\n\n  const onSave = () => {\n    const value = formRef.value;\n    if (!value) {\n      return;\n    }\n    value\n      .validateFields()\n      .then(() => {\n        doSave(0);\n      })\n      .catch((error: ValidateErrorEntity<any>) => {\n        console.log('onSubmit=》error', error);\n      });\n  };\n\n  const onSubmit = () => {\n    const value = formRef.value;\n    if (!value) {\n      return;\n    }\n    value\n      .validateFields()\n      .then(() => {\n        doSave(1);\n      })\n      .catch((error: ValidateErrorEntity<any>) => {\n        console.log('onSubmit=》error', error);\n      });\n  };\n\n  const doSave = async (status) => {\n    formState.spinning = true;\n    try {\n      await saveBizData(status);\n    } catch (error) {\n      formState.spinning = false;\n    }\n  };\n\n  function saveBizData(status) {\n    const formData = toRaw(formState) as any;\n    formData.status = status;\n    saveInfoarchive(formData)\n      .then((res) => {\n        formState.id = res;\n        getInfoarchive({ id: res }).then((data) => {\n          assign(formState, data.result);\n        });\n        if (status == 1) {\n          disabledInput.value = true;\n          setTimeout(() => {\n            closeCurrentTab();\n            MsgManager.getInstance().sendMsg('infoarchive', {});\n          }, 100);\n        }\n        formState.spinning = false;\n        success('操作成功');\n      })\n      .catch(() => {\n        formState.spinning = false;\n      });\n  }\n\n  const getRecordable = async () => {\n    const res = await getInfoarchive({ id: query.id });\n    if (res.result) {\n      if (query.id != '') {\n        assign(formState, res.result);\n      }\n      disabledInput.value = formState.status != 0;\n      if (!formState.processInstanceId) {\n        formState.processInstanceId = query.processInstanceId;\n      }\n      let { billCode, fillinDate, personMemberName, deptName } = res.result;\n      Object.assign(billTitleOption, { billCode, fillinDate, personMemberName, deptName });\n    }\n  };\n\n  const getBizParamId = async () => {\n    let id = query.id;\n    if (!id && query.processInstanceId) {\n      const processInstance = await ProcessInstanceApi.getProcessInstance(\n        query.processInstanceId as string,\n      );\n      const businessKey = processInstance.businessKey;\n      query.id = businessKey;\n      id = businessKey;\n    }\n    return id;\n  };\n\n  onMounted(async () => {\n    assign(formState, query);\n    query.id = await getBizParamId();\n\n    await getRecordable();\n    if (!query.id) {\n      disabledInput.value = false;\n      getBizFileId();\n    }\n  });\n\n  const getBizFileId = async () => {\n    FileApi.getBizId().then((res) => {\n      formState.bizFileId = res;\n    });\n  };\n  const success = (content) => {\n    message.success(content);\n  };\n</script>\n<style lang=\"less\" scoped>\n  .fix-detail-page {\n    :deep(&.vben-page-wrapper-content.detail-content) {\n      margin: 0;\n    }\n  }\n\n  .process-box {\n    :deep(.vben-basic-table-header__toolbar > button.ant-btn:last-child) {\n      margin-right: 0;\n    }\n\n    & > .content {\n      padding-bottom: 10px;\n    }\n  }\n</style>\n"],"names":["query","Memory","formState","reactive","formRef","ref","disabledInput","isRequired","billTitleOption","handleSelectChange","value","onSave","doSave","error","onSubmit","status","__async","saveBizData","formData","toRaw","saveInfoarchive","res","getInfoarchive","data","assign","closeCurrentTab","MsgManager","success","getRecordable","billCode","fillinDate","personMemberName","deptName","getBizParamId","id","businessKey","ProcessInstanceApi.getProcessInstance","onMounted","getBizFileId","FileApi.getBizId","content","message"],"mappings":"orDAwOE,MAAMA,EAAQC,EAAO,YAAY,EAAE,SAAS,EACtCC,EAA4BC,EAAS,CAAE,SAAU,GAAO,OAAQ,EAAG,EACnEC,EAAUC,IACVC,EAAgBD,EAAa,EAAI,EAEjCE,EAAaF,EAAa,EAAK,EAE/BG,EAAkBL,EAAc,CAAE,QAAS,MAAQ,CAAA,EACzDK,EAAgB,MAAQ,OAElB,MAAAC,EAAsBC,GAAkB,CACxCA,IAAU,IACZH,EAAW,MAAQ,GAEnBA,EAAW,MAAQ,EACrB,EAGII,EAAS,IAAM,CACnB,MAAMD,EAAQN,EAAQ,MACjBM,GAIFA,EAAA,iBACA,KAAK,IAAM,CACVE,EAAO,CAAC,CAAA,CACT,EACA,MAAOC,GAAoC,CAClC,QAAA,IAAI,kBAAmBA,CAAK,CAAA,CACrC,CAAA,EAGCC,EAAW,IAAM,CACrB,MAAMJ,EAAQN,EAAQ,MACjBM,GAIFA,EAAA,iBACA,KAAK,IAAM,CACVE,EAAO,CAAC,CAAA,CACT,EACA,MAAOC,GAAoC,CAClC,QAAA,IAAI,kBAAmBA,CAAK,CAAA,CACrC,CAAA,EAGCD,EAAgBG,GAAWC,EAAA,sBAC/Bd,EAAU,SAAW,GACjB,GAAA,CACF,MAAMe,EAAYF,CAAM,QACjBF,EAAO,CACdX,EAAU,SAAW,EACvB,CAAA,GAGF,SAASe,EAAYF,EAAQ,CACrB,MAAAG,EAAWC,EAAMjB,CAAS,EAChCgB,EAAS,OAASH,EAClBK,GAAgBF,CAAQ,EACrB,KAAMG,GAAQ,CACbnB,EAAU,GAAKmB,EACfC,EAAe,CAAE,GAAID,CAAK,CAAA,EAAE,KAAME,GAAS,CAClCC,EAAAtB,EAAWqB,EAAK,MAAM,CAAA,CAC9B,EACGR,GAAU,IACZT,EAAc,MAAQ,GACtB,WAAW,IAAM,CACCmB,IAChBC,EAAW,YAAY,EAAE,QAAQ,cAAe,CAAE,CAAA,GACjD,GAAG,GAERxB,EAAU,SAAW,GACrByB,EAAQ,MAAM,CAAA,CACf,EACA,MAAM,IAAM,CACXzB,EAAU,SAAW,EAAA,CACtB,CACL,CAEA,MAAM0B,EAAgB,IAAYZ,EAAA,sBAChC,MAAMK,EAAM,MAAMC,EAAe,CAAE,GAAItB,EAAM,GAAI,EACjD,GAAIqB,EAAI,OAAQ,CACVrB,EAAM,IAAM,IACPwB,EAAAtB,EAAWmB,EAAI,MAAM,EAEhBf,EAAA,MAAQJ,EAAU,QAAU,EACrCA,EAAU,oBACbA,EAAU,kBAAoBF,EAAM,mBAEtC,GAAI,CAAE,SAAA6B,EAAU,WAAAC,EAAY,iBAAAC,EAAkB,SAAAC,GAAaX,EAAI,OAC/D,OAAO,OAAOb,EAAiB,CAAE,SAAAqB,EAAU,WAAAC,EAAY,iBAAAC,EAAkB,SAAAC,EAAU,CACrF,CAAA,GAGIC,EAAgB,IAAYjB,EAAA,sBAChC,IAAIkB,EAAKlC,EAAM,GACX,GAAA,CAACkC,GAAMlC,EAAM,kBAAmB,CAIlC,MAAMmC,GAHkB,MAAMC,EAC5BpC,EAAM,iBAAA,GAE4B,YACpCA,EAAM,GAAKmC,EACND,EAAAC,CACP,CACO,OAAAD,CAAA,GAGTG,EAAU,IAAYrB,EAAA,sBACpBQ,EAAOtB,EAAWF,CAAK,EACjBA,EAAA,GAAK,MAAMiC,IAEjB,MAAML,EAAc,EACf5B,EAAM,KACTM,EAAc,MAAQ,GACTgC,IACf,EACD,EAED,MAAMA,EAAe,IAAYtB,EAAA,sBAC/BuB,EAAiB,EAAE,KAAMlB,GAAQ,CAC/BnB,EAAU,UAAYmB,CAAA,CACvB,CAAA,GAEGM,EAAWa,GAAY,CAC3BC,GAAQ,QAAQD,CAAO,CAAA"}