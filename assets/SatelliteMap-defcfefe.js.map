{"version":3,"file":"SatelliteMap-defcfefe.js","sources":["../../src/views/da/stationOperation/device/iconUrl.ts","../../src/views/da/stationOperation/SatelliteMap.vue"],"sourcesContent":["export const iconUrl = {\n  // 电子工牌\n  ewc: {\n    online: '/images/work_card_online.svg',\n    leave: '/images/work_card_leave.svg',\n    offline: '/images/work_card_offline.svg',\n  },\n  // 行车记录仪\n  dr: {\n    online: '/images/dashcam_online.svg',\n    leave: '/images/dashcam_leave.svg',\n    offline: '/images/dashcam_offline.svg',\n  },\n  // 巡检仪\n  ii: {\n    online: '/images/itinerant_detector_online.svg',\n    leave: '/images/itinerant_detector_leave.svg',\n    offline: '/images/itinerant_detector_offline.svg',\n  },\n};\n","<template>\n  <div class=\"satellite-map\">\n    <div id=\"map-container\" class=\"map-container\"></div>\n    <div class=\"mask-left\"></div>\n    <div class=\"mask-top\"></div>\n    <div class=\"mask-right\"></div>\n    <div class=\"mask-bottom\"></div>\n  </div>\n</template>\n<script lang=\"ts\" setup>\n  import { onMounted, ref } from 'vue';\n  import { useGo } from '/@/hooks/web/usePage';\n  import { MsgManager } from '/@/message/MsgManager';\n  import { iconUrl } from './device/iconUrl';\n\n  const mapObject = ref();\n  const trackAni = ref();\n  const go = useGo();\n  // 初始化地图\n  const initMap = () => {\n    mapObject.value = new BMapGL.Map('map-container'); // 创建Map实例\n    mapObject.value.enableScrollWheelZoom(true); //开启鼠标滚轮缩放\n    mapObject.value.setMapType(BMAP_EARTH_MAP); // 设置地图类型为地球模式\n    mapObject.value.centerAndZoom(new BMapGL.Point(112, 34), 5); // 初始化地图,设置中心点坐标和地图级别\n  };\n\n  // 创建label\n  const createLabel = (pt, content) => {\n    let opts = {\n      position: pt, // 指定文本标注所在的地理位置\n      offset: new BMapGL.Size(10, -40), //设置文本偏移量\n    };\n    let label = new BMapGL.Label(content, opts); // 创建文本标注对象\n    label.setStyle({\n      //样式\n      width: 'auto !important',\n      color: 'white',\n      fontSize: '12px',\n      backgroundColor: 'rgba(0,0,0)',\n      border: 0,\n      padding: '10px',\n      borderRadius: '4px',\n    });\n    return label; // 返回label\n  };\n\n  // 创建mark\n  const createMark = (pt, markItem) => {\n    // pt 坐标点\n    let marker = new BMapGL.Marker(pt);\n    mapObject.value.addOverlay(marker); // 创建标记\n    // 点击marker跳转到电站运营\n    marker.onclick = () => {\n      go({\n        path: '/stationOperation',\n        query: {\n          id: markItem.id,\n        },\n      });\n    };\n\n    // 添加title 标题信息\n    let label = createLabel(pt, markItem.name);\n    // 移入\n    marker.onmouseover = () => {\n      mapObject.value.addOverlay(label);\n    };\n    // 移除\n    marker.onmouseout = () => {\n      mapObject.value.removeOverlay(label);\n    };\n  };\n\n  // 获取mark 并将mark 标记在地图上\n  const getDoMarkData = async () => {};\n\n  //////////////////////////////智能设备（电子工牌、巡检仪、行车记录仪）/////////////////////////////////////////\n  // 创建mark\n  const createSmartDeviceMark = (pt, markItem, type) => {\n    let myIcon = new BMapGL.Icon(iconUrl[type][markItem.status], new BMapGL.Size(30, 44), {\n      anchor: new BMapGL.Size(15, 44),\n    });\n    // 创建标注对象并添加到地图\n    let marker = new BMapGL.Marker(pt, { icon: myIcon });\n    mapObject.value.addOverlay(marker);\n\n    // 点击marker打开弹框\n    marker.onclick = async () => {\n      MsgManager.getInstance().sendMsg('smart-device-modal-info', { type: type, record: markItem });\n    };\n\n    // 添加title 标题信息\n    const label = createLabel(pt, markItem.stationShortName);\n    // 移入\n    marker.onmouseover = () => {\n      mapObject.value.addOverlay(label);\n    };\n    // 移除\n    marker.onmouseout = () => {\n      mapObject.value.removeOverlay(label);\n    };\n  };\n\n  // 创建地理编码实例\n  let myGeo = new BMapGL.Geocoder();\n  const initAddress = (item) => {\n    // 根据坐标得到地址描述\n    myGeo.getLocation(new BMapGL.Point(item.longitude, item.latitude), function (result) {\n      if (result) {\n        item.address = result.address;\n      }\n    });\n  };\n\n  // 初始化全部点位标记\n  const initAllPointMark = async ({ type, data }) => {\n    clearOverlays();\n    // 移除地图移动结束时触发此事件\n    removeEventListener();\n    // 设置中心点坐标和地图级别\n    mapObject.value.centerAndZoom(new BMapGL.Point(112, 34), 5);\n    if (data?.length) {\n      data.forEach((item) => {\n        initAddress(item);\n        if (item.status === 'online') {\n          const pt = new BMapGL.Point(item.longitude, item.latitude);\n          createSmartDeviceMark(pt, item, type);\n        }\n      });\n    }\n  };\n\n  // 初始化点位标记\n  const initPointMark = ({ type, record }) => {\n    // 关闭智能设备弹窗\n    MsgManager.getInstance().sendMsg('smart-device-modal', false);\n    // 初始化地址\n    initAddress(record);\n    // 返回地图当前缩放级别\n    const zoom = mapObject.value.getZoom();\n    // 设置中心点坐标和地图级别\n    const pt = new BMapGL.Point(record.longitude, record.latitude);\n    mapObject.value.centerAndZoom(pt, 14);\n    createSmartDeviceMark(pt, record, type);\n\n    // 地图事件\n    const event = Math.round(zoom) === 14 ? 'moveend' : 'zoomend';\n    removeEventListener();\n    addEventListener(event, type, record);\n  };\n\n  const addEventListener = (event, type, record) => {\n    mapObject.value.addEventListener(event, () => {\n      MsgManager.getInstance().sendMsg('smart-device-modal-info', {\n        type: type,\n        record: record,\n        removeEvent: removeEventListener,\n      });\n    });\n  };\n\n  const removeEventListener = () => {\n    mapObject.value.removeEventListener('zoomend');\n    mapObject.value.removeEventListener('moveend');\n  };\n\n  // 轨迹回放\n  const initMapTrack = ({ trackParams, data }) => {\n    switch (trackParams.type) {\n      // 绘制轨迹\n      case 'track':\n        drawTrace(trackParams, data);\n        break;\n      // 回放\n      case 'replay':\n        trackAni.value.setDuration(trackParams.duration);\n        trackAni.value.start();\n        break;\n      // 暂停\n      case 'pause':\n        trackAni.value.pause();\n        break;\n      // 继续\n      case 'continue':\n        trackAni.value.continue();\n        break;\n      // 结束\n      case 'cancel':\n        trackAni.value.cancel();\n        break;\n      default:\n    }\n  };\n\n  // 创建开始标注对象并添加到地图\n  const createStartMarker = (lng, lat) => {\n    const point = new BMapGL.Point(lng, lat);\n    let myIcon = new BMapGL.Icon('/images/marker_start.png', new BMapGL.Size(30, 50), {\n      anchor: new BMapGL.Size(15, 50),\n    });\n    let startMarker = new BMapGL.Marker(point, { icon: myIcon });\n    mapObject.value.addOverlay(startMarker);\n  };\n\n  // 创建结束标注对象并添加到地图\n  const createEndMarker = (lng, lat) => {\n    const point = new BMapGL.Point(lng, lat);\n    let myIcon = new BMapGL.Icon('/images/marker_end.png', new BMapGL.Size(30, 50), {\n      anchor: new BMapGL.Size(15, 50),\n    });\n    // 创建标注对象并添加到地图\n    let endMarker = new BMapGL.Marker(point, { icon: myIcon });\n    mapObject.value.addOverlay(endMarker);\n  };\n\n  const clearOverlays = () => {\n    MsgManager.getInstance().sendMsg('smart-device-modal', false);\n    mapObject.value.clearOverlays();\n  };\n\n  const drawTrace = async (trackParams, data) => {\n    clearOverlays();\n    createStartMarker(data[0].longitude, data[0].latitude);\n    createEndMarker(data[data.length - 1].longitude, data[data.length - 1].latitude);\n    //轨迹线\n    let paths = [] as any;\n    data.forEach((item) => {\n      const point = new BMapGL.Point(item.longitude, item.latitude);\n      paths.push(point);\n    });\n\n    //添加折线\n    const bluePolyline = new BMapGL.Polyline(paths, getTrackAnimationOptions('blue'));\n    mapObject.value.addOverlay(bluePolyline);\n\n    const greenPolyline = new BMapGL.Polyline(paths, getTrackAnimationOptions('green'));\n    trackAni.value = new BMapGLLib.TrackAnimation(mapObject.value, greenPolyline, {\n      overallView: true, // 动画完成后自动调整视野到总览\n      tilt: 30, // 轨迹播放的角度，默认为55\n      duration: trackParams.trackDuration, // 动画持续时长，默认为10000，单位ms\n      delay: 0, // 动画开始的延迟，默认0，单位ms\n    });\n  };\n\n  const getTrackAnimationOptions = (color) => {\n    return {\n      enableEditing: false, //是否启用线编辑，默认为false\n      enableClicking: true, //是否响应点击事件，默认为true\n      icons: [],\n      strokeStyle: 'dashed',\n      strokeColor: color, //折线颜色\n      strokeWeight: 8, //折线的宽度，以像素为单位\n      strokeOpacity: 0.8, //折线的透明度，取值范围0 - 1\n      strokeTexture: {\n        url: `https://mapopen-pub-jsapigl.bj.bcebos.com/svgmodel/Icon_road_${color}_arrow.png`,\n        width: 16,\n        height: 64,\n      },\n    };\n  };\n\n  const listenSmartDevice = () => {\n    // 监听智能设备全部点位信息\n    MsgManager.getInstance().listen('smart-device-all-point-mark', initAllPointMark);\n    // 监听智能设备点位信息\n    MsgManager.getInstance().listen('smart-device-point-mark', initPointMark);\n    // 监听智能设备轨迹回放\n    MsgManager.getInstance().listen('smart-device-track', initMapTrack);\n    // 监听智能设备覆盖物\n    MsgManager.getInstance().listen('smart-device-clear-overlays', clearOverlays);\n  };\n\n  //////////////////////////////智能设备（电子工牌、巡检仪、行车记录仪）/////////////////////////////////////////\n\n  onMounted(() => {\n    initMap();\n    getDoMarkData();\n    listenSmartDevice();\n  });\n</script>\n<style lang=\"less\" scoped>\n  .satellite-map {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n\n    .map-container {\n      width: 100%;\n      height: 100%;\n    }\n\n    .mask-left {\n      position: absolute;\n      z-index: 9;\n      top: 0;\n      left: 0;\n      width: 24.43vw;\n      height: 100vh;\n      background: url('../images/left.png') no-repeat center/100% 100%;\n    }\n\n    .mask-top {\n      position: absolute;\n      z-index: 9;\n      top: 0;\n      left: 0;\n      width: 100vw;\n      height: calc(0.96rem + 10.09vh);\n      background: url('../images/top.png') no-repeat center/100% 100%;\n    }\n\n    .mask-right {\n      position: absolute;\n      z-index: 9;\n      top: 0;\n      right: 0;\n      width: 24.43vw;\n      height: 100vh;\n      background: url('../images/right.png') no-repeat center/100% 100%;\n    }\n\n    .mask-bottom {\n      position: absolute;\n      z-index: 9;\n      bottom: 0;\n      left: 0;\n      width: 100vw;\n      height: calc(0.16rem + 6.58vw);\n      background: url('../images/bottom.png') no-repeat center/100% 100%;\n    }\n  }\n</style>\n"],"names":["iconUrl","mapObject","ref","trackAni","useGo","initMap","createLabel","pt","content","opts","label","getDoMarkData","__async","createSmartDeviceMark","markItem","type","myIcon","marker","MsgManager","myGeo","initAddress","item","result","initAllPointMark","_0","data","clearOverlays","removeEventListener","initPointMark","record","zoom","event","addEventListener","initMapTrack","trackParams","drawTrace","createStartMarker","lng","lat","point","startMarker","createEndMarker","endMarker","paths","bluePolyline","getTrackAnimationOptions","greenPolyline","color","listenSmartDevice","onMounted"],"mappings":"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"}