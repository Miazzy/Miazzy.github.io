var Qe=Object.defineProperty;var te=Object.getOwnPropertySymbols;var Xe=Object.prototype.hasOwnProperty,Ze=Object.prototype.propertyIsEnumerable;var se=(_,f,m)=>f in _?Qe(_,f,{enumerable:!0,configurable:!0,writable:!0,value:m}):_[f]=m,le=(_,f)=>{for(var m in f||(f={}))Xe.call(f,m)&&se(_,m,f[m]);if(te)for(var m of te(f))Ze.call(f,m)&&se(_,m,f[m]);return _};var h=(_,f,m)=>new Promise((H,g)=>{var q=k=>{try{C(m.next(k))}catch(N){g(N)}},t=k=>{try{C(m.throw(k))}catch(N){g(N)}},C=k=>k.done?H(k.value):Promise.resolve(k.value).then(q,t);C((m=m.apply(_,f)).next())});import{d as ea,J as oe,k as I,r as K,e as aa,o as ta,al as c,Z as w,a9 as y,aa as l,$ as P,f as s,ac as x,v as b,A as v,u as D,ag as sa,E as Y,ad as L}from"./vue-71d1abb3.js";import{b as la,a0 as oa,ak as na,bS as ra,aD as ia,av as da,aC as ua,a7 as ca,at as U,aB as ma,_ as pa}from"./index.js";import{D as fa}from"./Dialog-0a006d82.js";import{B as ne}from"./BasicTable-0434a334.js";import{T as ba}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as re}from"./useTable-109483b3.js";import{b2 as va}from"./antd-15ac76ed.js";import"./index-74ac3212.js";import{B as ga}from"./BillTitle-d17ab3e4.js";import{_ as ie}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{U as ha}from"./UploadBox-636ecf02.js";import{W as _a}from"./WfApproveBox-a3448232.js";import{d as Ia,i as wa,f as ya,a as ka,h as xa,j as Ca,k as Ta,l as Da,m as Na,n as Sa,g as Ma}from"./operationticket.data-6214dc37.js";import{x as Ya}from"./index-66d20ba6.js";import Ua from"./CustomPrint-6ef48b80.js";import{a as B}from"./assign-37f1c13d.js";import{j as Ha}from"./Export2Excel-389a8fc9.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useRender-21ce56fb.js";import"./print-a0e9f882.js";const qa={class:"load"},Oa={class:"process-box"},Pa={class:"header-box"},Ba={class:"content"},Ra=ea({__name:"create",setup(_){const{t:f}=la(),m=oa(),H=oe(m.getUserInfo),g=na.getInstance().getQuery(),q=I(),t=K({spinning:!1,status:0}),C=I(!1),k={Authorization:`Bearer ${ra()}`},N=I([]),V=K({subject:"操作票申请"}),p=I(!0),u=K({operation:{show:!1,disabled:!0},archive:{show:!1,disabled:!0},manager:{show:!1,disabled:!0}}),R=I(),$=I(""),de=I(g.processInstanceId?void 0:"operation-ticket"),ue=aa(()=>!u.operation.disabled||!u.archive.disabled||!u.manager.disabled?"before":"default"),ce=(a,e)=>{const n=e.replace("before","").toLowerCase();W(a,n)},me=(a,e)=>!0,pe=()=>{G("save",0)},W=(a,e)=>h(this,null,function*(){const n=q.value;if(!n)return;if(e==="submit"||e==="agree"){let r=!0;if(yield n.validateFields().catch(d=>{var S;console.log("onSubmit=》error",d);const T=d.errorFields;if((S=document.querySelector(".ant-form-item-has-error"))==null||S.scrollIntoView({behavior:"smooth",block:"center"}),T&&T.length>0){J(T[0].errors[0]),r=!1;return}}),!r||!me(a,e))return}G(e,e?null:1)}),G=(a,e)=>h(this,null,function*(){t.spinning=!0;try{yield fe(a,e)}catch(n){t.spinning=!1,console.log("error",n)}}),fe=(a,e)=>h(this,null,function*(){const n=oe(t);e!=null&&e>-1&&(n.status=e),n.headId&&(n.headId=n.headId.split("@")[0]);const o=I([]);z().forEach(r=>{const d=I({});B(d.value,r),d.value.status==!0?d.value.status=1:d.value.status==!1&&(d.value.status=0),o.value.push(d.value)}),e==1&&o.value.forEach(r=>{if(!Ya.trim(r.content)){const d="操作项目，操作内容不能为空";throw J(d),new Error(d)}}),t.dtlList=o.value,yield ya(n).then(r=>{t.id=r.result,e==1&&(p.value=!0),$.value=a,t.spinning=!1,(e===0||e===1)&&ve("操作成功"),be(e)}).catch(()=>{t.spinning=!1})}),be=a=>{(a===0||a===1)&&setTimeout(()=>{a===1&&ua(),ca.getInstance().sendMsg("operation-ticket",{})},200)},J=a=>{t.spinning=!1,U.getInstance().error(a)},ve=a=>{U.getInstance().success(a)},E=a=>{const e=le({},t.processVariable),n=e.taskDefinitionKey===a&&e.assigneeId===H.userId&&e.status===1,o=a.replace("Node","");u[o].disabled=!n},ge=()=>{const a=t.taskInstances;a!=null&&a.length&&a.forEach(e=>{e.taskDefinitionKey==="operationNode"&&(u.operation.show=!0),e.taskDefinitionKey==="archiveNode"&&(u.archive.show=!0),e.taskDefinitionKey==="managerNode"&&(u.manager.show=!0)}),(t.status===2||t.status===3||t.status===5)&&(u.operation.show=!0,u.archive.show=!0,u.manager.show=!0)},he=()=>{E("operationNode"),E("archiveNode"),E("managerNode");const a=(t.status===0||t.status===6)&&(!t.personMemberId||t.personMemberId.indexOf(H.userId)>-1);p.value=!a,ge()},_e=()=>h(this,null,function*(){var e;const a=yield ka({id:g.id});if(a.result){B(t,a.result),t.status=Number(t.status),t.processInstanceId=(e=t.processVariable)==null?void 0:e.processInstanceId,p.value=t.status!=0,t.processInstanceId||(t.processInstanceId=g.processInstanceId);const{billCode:n,fillinDate:o,personMemberName:r,deptName:d}=a.result;Object.assign(V,{billCode:n,fillinDate:o,personMemberName:r,deptName:d}),he()}}),Q=a=>h(this,null,function*(){const e=yield ee(),n={ticketId:a.ticketId?a.ticketId:e},o=yield Na(n);return o.result&&o.result.forEach(r=>{r.status==1?r.status=!0:r.status==0&&(r.status=!1)}),o.result}),[Ie,{setProps:we,getDataSource:z}]=re(B({dataSource:R},Ia)),ye=()=>h(this,null,function*(){const a=yield Q({});R.value=a}),ke=()=>h(this,null,function*(){const a=Ce(),e={stationId:t.stationId,status:2,pageNo:a.current,pageSize:a.pageSize};return(yield Ma(e)).result}),[xe,{getPaginationRef:Ce,getSelectRows:Te}]=re({api:ke,columns:Sa,pagination:!0,striped:!1,useSearchForm:!1,showTableSetting:!1,bordered:!0,showIndexColumn:!0,canResize:!0,rowSelection:{type:"radio"}});function De(){const a=Te();if(a.length==0){U.getInstance().error("请选择操作票");return}Q({ticketId:a[0].id}).then(e=>{A(e,!1),C.value=!1})}function A(a,e){const n=z();a.forEach(o=>{let r=o.status;e&&(r=r==1?!0:o.status==0?!1:null);const d={content:o.content,status:r,editable:!0,isNew:!0,key:`${Date.now()}`};n.push(d)})}function Ne(){A([{content:"",status:!1}],!1)}function Se({key:a}){a==="downloadTemplate"&&Me()}function Me(){Ha({data:[{index:1,content:"操作内容案例",status:"是"}],header:{index:"序号",content:"操作内容",status:"是否完成"},filename:"内容模板.xlsx"})}const Ye=a=>{const e=a.type==="application/vnd.ms-excel"||a.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";return e||U.getInstance().error(`${a.name} 不是Excel文件`),e||va.LIST_IGNORE},Ue=a=>{const e=a.file;console.log("file",e),e.status==="done"&&e.response&&e.response.data?A(e.response.data,!0):e.status==="error"&&U.getInstance().error("导入数据失败")};function He(){C.value=!0}function qe(a){const e=z();let n=e.indexOf(a);n!==-1&&e.splice(n,1)}function Oe(a,e){t.recipientName=e.label}function Pe(a,e){t.operatorName=e.label}function Be(){xa("?stationId="+t.stationId).then(a=>{a.result&&a.result.length>0&&a.result.forEach(e=>{N.value.push({value:e.userId,label:e.name})})})}function X(a){const e=[];for(let n=0;n<a.length;n++){const o=a[n],r={label:o.name,value:o.id,disabled:o.orgKindId!=="psm"};o.children&&o.children.length>0&&(r.children=X(o.children)),e.push(r)}return e}function Re(a,e){t.headId=a,t.headName=e[0]}const Z=I(),ee=()=>h(this,null,function*(){let a=g.id;if(!a&&g.processInstanceId){const n=(yield ma(g.processInstanceId)).businessKey;g.id=n,a=n}return a}),Ee=()=>h(this,null,function*(){const a=yield Ca({});a.result&&a.result.user&&(t.commanderId=a.result.user.id,t.commanderName=a.result.user.name)}),ze=()=>h(this,null,function*(){const a=yield Ta({orgId:t.stationOrganId,orgKindIds:"ogn,dpt,pos,psm",showPosition:!0,status:1});Z.value=X(a.result)}),Ae=()=>{we({columns:Da(u),actionColumn:{width:80,title:"操作",dataIndex:"action",ifShow:!p.value}})};return ta(()=>h(this,null,function*(){g.id=yield ee(),yield _e(),g.id||(B(t,g),p.value=!1,t.bizFileId=ia(),yield Ee()),Ae(),Be(),ze(),ye()})),(a,e)=>{const n=c("a-input"),o=c("a-form-item"),r=c("a-col"),d=c("a-row"),T=c("a-date-picker"),S=c("a-select"),O=c("a-card"),j=c("a-button"),ae=c("a-menu-item"),je=c("a-upload"),Fe=c("a-menu"),Ke=c("a-dropdown"),Le=c("a-checkbox"),Ve=c("a-tree-select"),$e=c("a-textarea"),We=c("a-form"),Ge=c("a-spin"),Je=c("PageWrapper");return w(),y(Je,{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:l(()=>[P("div",qa,[s(Ge,{spinning:t.spinning,tip:"Loading..."},{default:l(()=>[P("div",Oa,[P("div",Pa,[s(ga,{options:V},null,8,["options"]),s(_a,{onSave:pe,onSubmit:W,onBefore:ce,processInstanceId:t.processInstanceId,processStatus:t.status,mode:ue.value,businessStatus:$.value,listenMessage:de.value},null,8,["processInstanceId","processStatus","mode","businessStatus","listenMessage"]),t.status==2?(w(),y(Ua,{key:0,path:"operationTicket",params:{base:t,details:R.value}},null,8,["params"])):x("",!0)]),P("div",Ba,[s(We,{ref_key:"formRef",ref:q,model:t,labelAlign:"right",autocomplete:"off"},{default:l(()=>[s(O,{title:"基本信息",bordered:!1},{default:l(()=>[s(d,{gutter:32},{default:l(()=>[b(s(r,{span:12},{default:l(()=>[s(o,{name:"stationName",label:"电站名称",labelCol:{class:"detail-label"}},{default:l(()=>[s(n,{value:t.stationName,"onUpdate:value":e[0]||(e[0]=i=>t.stationName=i),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[v,!0]]),b(s(r,{span:12},{default:l(()=>[s(o,{name:"ticketNumber",label:"操作票号",labelCol:{class:"detail-label"}},{default:l(()=>[s(n,{value:t.ticketNumber,"onUpdate:value":e[1]||(e[1]=i=>t.ticketNumber=i),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[v,!0]])]),_:1}),s(d,{gutter:32},{default:l(()=>[b(s(r,{span:12},{default:l(()=>[s(o,{name:"actionType",label:"操作类型",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请选择操作类型"}]},{default:l(()=>[s(ie,{value:t.actionType,"onUpdate:value":e[2]||(e[2]=i=>t.actionType=i),type:"action_type",disabled:p.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]]),b(s(r,{span:12},{default:l(()=>[s(o,{name:"commandTime",label:"发令时间",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入发令时间"}]},{default:l(()=>[s(T,{value:t.commandTime,"onUpdate:value":e[3]||(e[3]=i=>t.commandTime=i),"show-time":"",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm",style:"width: 100%",disabled:p.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1}),s(d,{gutter:32},{default:l(()=>[b(s(r,{span:12},{default:l(()=>[s(o,{name:"commanderName",label:"发令人",labelCol:{class:"detail-label"},rules:[{required:!1}]},{default:l(()=>[s(n,{value:t.commanderName,"onUpdate:value":e[4]||(e[4]=i=>t.commanderName=i),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[v,!0]]),b(s(r,{span:12},{default:l(()=>[s(o,{name:"recipientId",label:"受令人",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请选择受令人"}]},{default:l(()=>[s(S,{value:t.recipientId,"onUpdate:value":e[5]||(e[5]=i=>t.recipientId=i),"show-search":"","allow-clear":"",style:{width:"100%"},placeholder:"请选择受令人",options:N.value,onChange:Oe,disabled:p.value},null,8,["value","options","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1}),s(d,{gutter:32},{default:l(()=>[b(s(r,{span:24},{default:l(()=>[s(o,{name:"subject",label:"操作任务",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入操作任务"}]},{default:l(()=>[s(n,{value:t.subject,"onUpdate:value":e[6]||(e[6]=i=>t.subject=i),maxlength:100,disabled:p.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1})]),_:1}),s(O,{bordered:!1},{default:l(()=>[s(D(ne),{ref:"tableRef",title:"操作项目",onRegister:D(Ie)},sa({bodyCell:l(({column:i,record:M})=>[i.dataIndex==="content"?(w(),y(n,{key:0,value:M[i.dataIndex],"onUpdate:value":F=>M[i.dataIndex]=F,maxlength:1e3,disabled:p.value},null,8,["value","onUpdate:value","disabled"])):x("",!0),i.dataIndex==="status"?(w(),y(Le,{key:1,checked:M[i.dataIndex],"onUpdate:checked":F=>M[i.dataIndex]=F,disabled:u.operation.disabled},null,8,["checked","onUpdate:checked","disabled"])):x("",!0),i.dataIndex==="action"?(w(),y(D(ba),{key:2,actions:[{tooltip:"删除",color:"error",icon:"ant-design:delete-outlined",ifShow:!p.value,onClick:qe.bind(null,M)}]},null,8,["actions"])):x("",!0)]),_:2},[p.value?void 0:{name:"toolbar",fn:l(()=>[p.value?x("",!0):(w(),y(j,{key:0,type:"primary",preIcon:D(da).ADD,onClick:Ne},{default:l(()=>[Y(L(D(f)("common.action.create")),1)]),_:1},8,["preIcon"])),p.value?x("",!0):(w(),y(Ke,{key:1},{overlay:l(()=>[s(Fe,{onClick:Se},{default:l(()=>[s(ae,{key:"downloadTemplate"},{default:l(()=>[Y("下载模板")]),_:1}),s(ae,{key:"import"},{default:l(()=>[s(je,{name:"file",showUploadList:!1,headers:k,accept:".xls,.xlsx","before-upload":Ye,onChange:Ue,action:D(wa)},{default:l(()=>[Y(L("导入数据"))]),_:1},8,["action"])]),_:1})]),_:1})]),default:l(()=>[s(j,{class:"yellow-btn"},{default:l(()=>[Y(" excel导入 ")]),_:1})]),_:1})),p.value?x("",!0):(w(),y(j,{key:2,class:"yellow-btn",onClick:He},{default:l(()=>[Y(L("历史操作票导入"))]),_:1}))]),key:"0"}]),1032,["onRegister"])]),_:1}),u.archive.show?(w(),y(O,{key:0,title:"执行归档",bordered:!1},{default:l(()=>[s(d,{gutter:32},{default:l(()=>[b(s(r,{span:12},{default:l(()=>[s(o,{name:"principalTime",label:"操作时间",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入操作时间"}]},{default:l(()=>[s(T,{value:t.principalTime,"onUpdate:value":e[7]||(e[7]=i=>t.principalTime=i),"show-time":"",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm",style:"width: 100%",disabled:u.archive.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]]),b(s(r,{span:12},{default:l(()=>[s(o,{name:"qualifiedTime",label:"完成时间",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入完成时间"}]},{default:l(()=>[s(T,{value:t.qualifiedTime,"onUpdate:value":e[8]||(e[8]=i=>t.qualifiedTime=i),"show-time":"",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm",style:"width: 100%",disabled:u.archive.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1}),s(d,{gutter:32},{default:l(()=>[b(s(r,{span:12},{default:l(()=>[s(o,{name:"operatorId",label:"操作人",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请选择操作人"}]},{default:l(()=>[s(S,{value:t.operatorId,"onUpdate:value":e[9]||(e[9]=i=>t.operatorId=i),"show-search":"","allow-clear":"",style:{width:"100%"},placeholder:"请选择操作人",options:N.value,onChange:Pe,disabled:u.archive.disabled},null,8,["value","options","disabled"])]),_:1})]),_:1},512),[[v,!0]]),b(s(r,{span:12},{default:l(()=>[s(o,{name:"headName",label:"运维负责人",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入运维负责人"}]},{default:l(()=>[s(Ve,{value:t.headName,"onUpdate:value":e[10]||(e[10]=i=>t.headName=i),"show-search":"",style:{width:"100%"},"dropdown-style":{maxHeight:"400px",overflow:"auto"},"allow-clear":"","tree-default-expand-all":"","tree-data":Z.value,"tree-node-filter-prop":"label",onChange:Re,disabled:u.archive.disabled},null,8,["value","tree-data","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1}),s(ha,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"operationticket",vmode:u.archive.disabled?"view":"box",bizId:t.bizFileId},null,8,["vmode","bizId"])]),_:1})):x("",!0),u.manager.show?(w(),y(O,{key:1,title:"合格性检查",bordered:!1},{default:l(()=>[s(d,{gutter:32},{default:l(()=>[b(s(r,{span:12},{default:l(()=>[s(o,{name:"result",label:"检查结论",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请选择检查结论"}]},{default:l(()=>[s(ie,{value:t.result,"onUpdate:value":e[11]||(e[11]=i=>t.result=i),type:"inspection_conclusion",disabled:u.manager.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]]),b(s(r,{span:12},{default:l(()=>[s(o,{name:"checkTime",label:"检查时间",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入检查时间"}]},{default:l(()=>[s(T,{value:t.checkTime,"onUpdate:value":e[12]||(e[12]=i=>t.checkTime=i),"show-time":"",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm",style:"width: 100%",disabled:u.manager.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1}),s(d,{gutter:32},{default:l(()=>[b(s(r,{span:24},{default:l(()=>[s(o,{name:"illustrate",label:"验证说明",labelCol:{class:"detail-label"},rules:[{required:!0,message:"请输入验证说明"}]},{default:l(()=>[s($e,{value:t.illustrate,"onUpdate:value":e[13]||(e[13]=i=>t.illustrate=i),"show-count":"",rows:4,maxlength:1e3,disabled:u.manager.disabled},null,8,["value","disabled"])]),_:1})]),_:1},512),[[v,!0]])]),_:1})]),_:1})):x("",!0)]),_:1},8,["model"])])])]),_:1},8,["spinning"]),s(fa,{visible:C.value,"onUpdate:visible":e[14]||(e[14]=i=>C.value=i),title:"历史操作票导入",okText:"导入",onOk:De,height:520},{default:l(()=>[s(D(ne),{class:"table-in-dialog",onRegister:D(xe),maxHeight:340},null,8,["onRegister"])]),_:1},8,["visible"])])]),_:1})}}});const kt=pa(Ra,[["__scopeId","data-v-a4071942"]]);export{kt as default};
//# sourceMappingURL=create-6bb33acb.js.map
