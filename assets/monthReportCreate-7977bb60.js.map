{"version":3,"file":"monthReportCreate-7977bb60.js","sources":["../../src/views/po/elec/produce/monthReportCreate.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <div class=\"process-box\">\n        <div class=\"header-box\">\n          <!-- 标题 -->\n          <BillTitle :options=\"billTitleOptions\" />\n          <WfApproveBox\n            @save=\"onSave\"\n            @submit=\"onSubmit\"\n            :processStatus=\"formState.status\"\n            :processInstanceId=\"formState.processInstanceId\"\n          />\n        </div>\n\n        <!-- 表单内容 -->\n        <div class=\"content\">\n          <div class=\"left-panel\"\n            ><a-form ref=\"monthReportFormRef\" :model=\"formState\" name=\"monthReportForm\">\n              <a-card title=\"基本信息\" :bordered=\"false\">\n                <a-row :gutter=\"32\">\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"电站名称\"\n                      name=\"stationName\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.stationName\" style=\"width: 100%\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"分期\"\n                      name=\"periodName\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.periodName\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"月报周期\"\n                      name=\"monthCycle\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                      :rules=\"[{ required: true, message: '请选择月份' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.monthCycle\"\n                        value-format=\"YYYY-MM\"\n                        @change=\"changeReportDay\"\n                        style=\"min-width: 100%\"\n                        :disabled=\"iProcess\"\n                        picker=\"month\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"月发电量(kWh)\"\n                      name=\"genElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.genElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"理论发电(kWh)\"\n                      name=\"theoElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.theoElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"外接厂用电(kWh)\"\n                      name=\"facUsed\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.facUsed\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"上网电量(kWh)\"\n                      name=\"onlineElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.onlineElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"下网电量(kWh)\"\n                      name=\"offlineElec\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.offlineElec\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"损失电量(kWh)\"\n                      name=\"totalLoss\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.totalLoss\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"利用小时数(h)\"\n                      name=\"validHours\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.validHours\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"综合厂用电率(%)\"\n                      name=\"facRatio\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.facRatio\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"系统效率(%)\"\n                      name=\"sysEfficiency\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.sysEfficiency\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"平均温度(℃)\"\n                      name=\"avgTemp\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.avgTemp\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"平均风速(m/s)\"\n                      name=\"avgWind\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.avgWind\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"12\">\n                    <a-form-item\n                      label=\"月辐照值(万KJ/㎡)\"\n                      name=\"radiation\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 4 }\"\n                    >\n                      <a-input disabled v-model:value=\"formState.radiation\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"24\" class=\"textarea-item\">\n                    <a-form-item\n                      label=\"生产数据分析\"\n                      name=\"remark\"\n                      labelAlign=\"right\"\n                      :labelCol=\"{ span: 2 }\"\n                      :rules=\"[{ required: true, message: '请输入生产数据分析' }]\"\n                    >\n                      <a-textarea\n                        :rows=\"10\"\n                        v-model:value=\"formState.remark\"\n                        placeholder=\"1000字以内\"\n                        :disabled=\"iProcess\"\n                        :maxlength=\"1000\"\n                        show-count\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n            </a-form>\n\n            <a-card title=\"损失电量\" :bordered=\"false\">\n              <div style=\"margin: 0 16px 10px\">\n                <a-table\n                  :columns=\"lossCloumns\"\n                  :data-source=\"lossList\"\n                  :pagination=\"false\"\n                  size=\"small\"\n                  bordered\n                  :row-selection=\"rowSelection\"\n                  @change=\"handleTableYxChange\"\n                  :scroll=\"{ x: 480, y: 620 }\"\n                >\n                  <template #bodyCell=\"{ column, text, record }\">\n                    {{ text }}\n                  </template>\n                </a-table>\n              </div>\n            </a-card>\n          </div>\n        </div>\n      </div>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { computed, onMounted, reactive, ref, unref, UnwrapRef } from 'vue';\n  import BillTitle from '/@/components/Framework/BillTitle/BillTitle.vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { useRouter } from 'vue-router';\n  import { message, FormInstance } from 'ant-design-vue';\n  import WfApproveBox from '/@/components/Framework/WorkFlow/WfApproveBox.vue';\n  import * as ProcessInstanceApi from '@/api/bpm/processInstance';\n  import { MsgManager } from '@/message/MsgManager';\n  import { closeCurrentTab } from '@/utils/route';\n  import { SysMessage } from '/@/hooks/web/useMessage';\n  import { PageWrapper } from '/@/components/Page';\n  import {\n    getLossCloumns,\n    getLossList,\n    getBaseInfo,\n    insertMonthReport,\n    getMonthReport,\n  } from './index';\n  import { assign } from 'lodash-es';\n  import { Memory } from '@/router/index';\n\n  const iProcess = ref<boolean>(false);\n  const { t } = useI18n();\n  const router = useRouter();\n  const { currentRoute } = router;\n  const route = unref(currentRoute);\n  const query = Memory.getInstance().getQuery(); // route.query;\n  const processInstanceId = ref(null);\n  interface FormState {}\n  const lossCloumns = getLossCloumns('month');\n  const lossList = ref([]);\n  const monthReportFormRef = ref<FormInstance>();\n  const formState: UnwrapRef<FormState> = reactive({ status: 0 });\n  const billTitleOptions = reactive<any>({});\n  billTitleOptions.subject = '生产月报';\n  billTitleOptions.infoItems = [];\n  // 加载日报汇总的基础数据\n  const loadBaseInfo = async () => {\n    if (formState.monthCycle == null) {\n      return;\n    }\n    formState.requestType = 'month';\n    let data = await getBaseInfo(formState);\n    formState.genElec = data.result.genElec;\n    formState.offlineElec = data.result.offlineElec;\n    formState.onlineElec = data.result.onlineElec;\n    formState.theoElec = data.result.theoElec;\n    formState.facUsed = data.result.facUsed;\n    formState.totalLoss = data.result.totalLoss;\n    formState.validHours = data.result.validHours;\n    formState.facRatio = data.result.facRatio;\n    formState.sysEfficiency = data.result.sysEfficiency;\n    formState.avgTemp = data.result.avgTemp;\n    formState.avgWind = data.result.avgWind;\n    formState.radiation = data.result.radiation;\n    formState.connectCapacity = data.result.connectCapacity;\n  };\n  // 加载月损失电量数据\n  const loadLossList = async () => {\n    if (formState.monthCycle == null) {\n      return;\n    }\n    formState.requestType = 'month';\n    let data = await getLossList(formState);\n    lossList.value = data.result;\n  };\n\n  // 日期选择后更新并网容量，加载损失电量数据\n  function changeReportDay() {\n    // 查询并网容量\n    loadBaseInfo();\n    loadLossList();\n  }\n\n  //-------------------------------------------------------流程相关操作-------------------------------------------------------------\n\n  const onSave = () => {\n    doSave(0);\n  };\n\n  const onSubmit = () => {\n    doSave(1);\n  };\n\n  const doSave = (status: number) => {\n    monthReportFormRef.value.validateFields().then(() => {\n      let param = formState;\n      param.status = status;\n      param.lossData = lossList.value;\n      insertMonthReport(param)\n        .then((data) => {\n          //关闭弹窗\n          SysMessage.getInstance().success(t('common.saveSuccessText'));\n          // router.push('/po/elec/produce/index');\n          formState.id = data.result;\n          loadBizData();\n          if (status >= 1) {\n            setTimeout(function () {\n              MsgManager.getInstance().sendMsg('day-report', { key: 'month' });\n              closeCurrentTab();\n            }, 200);\n          }\n        })\n        .catch(() => {});\n    });\n  };\n  const loadBizBaseInfo = async (res: any) => {\n    let { billCode, fillinDate, personMemberName, deptName } = res;\n    Object.assign(billTitleOptions, { billCode, fillinDate, personMemberName, deptName });\n  };\n  const loadBizData = async () => {\n    let res = await getMonthReport(formState.id);\n    // 填充业务数据\n    iProcess.value = res.status > 0;\n    loadBizBaseInfo(res);\n    assign(formState, res);\n    if (!formState.processInstanceId) {\n      formState.processInstanceId = query.processInstanceId;\n    }\n    // 加载损失电量数据\n    loadLossList();\n  };\n  // 填充电站分期数据\n  const loadPeriodData = async () => {\n    let res = await getMonthReport('');\n    loadBizBaseInfo(res);\n    formState.billCode = res.billCode;\n    formState.fillinDate = res.fillinDate;\n    formState.stationId = query.stationId;\n    formState.stationName = query.stationName;\n    formState.periodId = query.periodId;\n    formState.periodName = query.periodName;\n    formState.stationOrganId = query.organId;\n    formState.stationOrganName = query.organName;\n    loadBaseInfo();\n  };\n\n  onMounted(async () => {\n    assign(formState, query);\n    if (query.id) {\n      await loadBizData();\n    } else if (query.processInstanceId) {\n      processInstanceId.value = query.processInstanceId as unknown as string;\n      formState.processInstanceId = query.processInstanceId as unknown as string;\n      ProcessInstanceApi.getProcessInstance(formState.processInstanceId).then(async (res) => {\n        formState.id = res.businessKey;\n        await loadBizData();\n      });\n    } else {\n      // 填充参数数据\n      loadPeriodData();\n    }\n  });\n</script>\n<style lang=\"less\" scoped>\n  .fix-detail-page {\n    :deep(&.vben-page-wrapper-content.detail-content) {\n      margin: 0;\n    }\n  }\n</style>\n"],"names":["iProcess","ref","t","useI18n","router","useRouter","currentRoute","unref","query","Memory","processInstanceId","lossCloumns","getLossCloumns","lossList","monthReportFormRef","formState","reactive","billTitleOptions","loadBaseInfo","__async","data","getBaseInfo","loadLossList","getLossList","changeReportDay","onSave","doSave","onSubmit","status","param","insertMonthReport","SysMessage","loadBizData","MsgManager","closeCurrentTab","loadBizBaseInfo","res","billCode","fillinDate","personMemberName","deptName","getMonthReport","assign","loadPeriodData","onMounted","ProcessInstanceApi.getProcessInstance"],"mappings":"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"}