var O=(m,N,b)=>new Promise((g,y)=>{var _=i=>{try{f(b.next(i))}catch(h){y(h)}},U=i=>{try{f(b.throw(i))}catch(h){y(h)}},f=i=>i.done?g(i.value):Promise.resolve(i.value).then(_,U);f((b=b.apply(m,N)).next())});import{P as de}from"./index-20519caf.js";import{a5 as w,a0 as V,aj as ue,aB as pe,a7 as H,aD as me,at as W,aC as ce,_ as fe}from"./index.js";import{O as $}from"./OrganDialog-dd1023ce.js";import{_ as J}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{B as ve}from"./BillTitle-d17ab3e4.js";import{W as be}from"./WfApproveBox-a3448232.js";import{T as ge}from"./index-aadc7f51.js";import{U as _e}from"./UploadBox-636ecf02.js";import{d as he,J as Ie,k as v,e as Ce,r as T,o as we,al as c,x as Ne,Z as C,a9 as Z,aa as n,$ as j,f as l,v as ye,_ as B,u as F,ac as R,E as x,a6 as G}from"./vue-71d1abb3.js";import"./useContentViewHeight-7f845167.js";import"./useWindowSizeFn-13b1b8a2.js";import"./antd-15ac76ed.js";import"./Dialog-0a006d82.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./BasicTable-0434a334.js";import"./useForm-dea3ed18.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-f4fc48e6.js";import"./index-316f6ffb.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./uniqBy-92d3bc7f.js";import"./index-085d06c7.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useTable-109483b3.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";function Ue(m){return w.get({url:"/oa/info-notice-release/get",params:m})}function ke(m){return w.post({url:"/oa/info-notice-release/create",params:m})}function xe(m){return w.post({url:"/system/org/list-tree",params:m})}function De(m){return w.get({url:"/oa/infoKind/getInfoKindByCodePreAndOrgId",params:m})}function Me(m){return w.post({url:"/oa/info-query/read",params:m})}const Ke={class:"load"},Se={class:"process-box"},Ae={class:"header-box"},qe={class:"content"},Oe={key:0,style:{float:"left",width:"10%"}},Te={key:0,style:{float:"left",width:"10%"}},je=he({__name:"create",setup(m){const N=V(),b=Ie(N.getUserInfo),g=v(!1),y=v(!1),_=v(!1),U=v(),f=v(!0),i=Ce(()=>typeof e.status=="undefined"||e.status===0&&e.personMemberId===""?!1:e.status!=0||e.status==0&&e.personMemberId!=""&&e.personMemberId.substring(0,32)!=b.userId),h=v(),z=v(),E=v(""),D=T([]);let{params:k}=ue();const P=T({subject:"通知发布"}),e=T({id:k.id||"",handler:[],receiver:[],spinning:!1,personMemberId:""}),Q=(t,a)=>{e.infoKindId=t,e.infoKindName=a.label},M=()=>{e.spinning=!0,ke(e).then(t=>{t.result!=""?(e.id=t.result,W.getInstance().success(e.status==1?"提交成功":"保存成功"),e.status==1&&setTimeout(()=>{ce(),H.getInstance().sendMsg("info-notice",{})},100)):(f.value=!1,W.getInstance().error("保存失败.")),e.spinning=!1}).catch(t=>{f.value=!1,e.status=0,e.spinning=!1,console.log(t)})},X=()=>{g.value=!0},Y=()=>{e.receiver=[],e.receiverName=""},L=()=>{_.value=!0},ee=()=>{e.handler=[],e.handlerName=""},ae=()=>{g.value=!1},le=t=>{g.value=!1,t&&t.length>0?(e.receiver=[],t.forEach(a=>{e.receiver.push({orgUnitId:a.value,name:a.label,value:a.value,label:a.label})})):e.receiver=[],e.receiverName=e.receiver.map(a=>a.name).join(",")},te=()=>{_.value=!1},ne=t=>{_.value=!1,t&&t.length>0?(e.handler=[],t.forEach(a=>{e.handler.push({orgUnitId:a.value,name:a.label,value:a.value,label:a.label})})):e.handler=[],e.handlerName=e.handler.map(a=>a.name).join(",")},K={handleAgree:t=>{console.log("同意",t)},handleSave:t=>{console.log("保存",t),f.value=!1,e.status=0,M()},handleSubmit:t=>{console.log("提交",t),f.value=!0,e.status=1;const a=U.value;a&&a.validateFields().then(()=>{M()}).catch(p=>{console.log(p),e.status=0})}},oe=()=>O(this,null,function*(){const t=yield xe({orgId:"",orgKindIds:"ogn,dpt,pos,psm",showPosition:!0,status:1});h.value=S(t.result,["psm","dpt","ogn"]),z.value=S(t.result,["psm"])});function S(t,a){const p=[];for(let d=0;d<t.length;d++){const r=t[d],I={label:r.name,value:r.id,orgId:r.orgId,parent_node:r.parent_node,parentId:r.parentId,disabled:a.indexOf(r.orgKindId)==-1};r.children&&r.children.length>0&&(I.children=S(r.children,a)),p.push(I)}return p}return we(()=>O(this,null,function*(){if(E.value=k.processInstanceId,!e.id&&k.processInstanceId){const t=yield pe(k.processInstanceId);e.id=t.businessKey}Ue({id:e.id}).then(t=>{let a=t.result;if(e.id){for(let o in a)e[o]=a[o];e.status=Number(e.status),e.isAllowCopy=e.isAllowCopy+"",e.isAllowDownloadFile=e.isAllowDownloadFile+"",a.receiver&&(e.receiver=[],a.receiver.forEach(o=>{e.receiver.push({value:o.orgUnitId,label:o.orgUnitName,orgUnitId:o.orgUnitId,name:o.orgUnitName})}),e.receiverName=e.receiver.map(o=>o.name).join(",")),a.handler&&(e.handler=[],a.handler.forEach(o=>{e.handler.push({value:o.orgUnitId,label:o.orgUnitName,orgUnitId:o.orgUnitId,name:o.orgUnitName})}),e.handlerName=e.handler.map(o=>o.name).join(",")),e.status==2&&(Me({infoReleaseId:e.id}),H.getInstance().sendMsg("info-query",{}))}else{e.billCode=a.billCode,e.personMemberName=a.personMemberName,e.deptName=a.deptName,e.fillinDate=a.fillinDate,e.bizFileId=me(),e.status=0;const o=N.userInfo.orgs;let u=o.filter(A=>A.isMainOrg==1)[0];u==null&&(u=o[0]),e.organName=u.orgName,e.organId=u.orgId,e.deptName=u.deptName,e.drafterId=u.id,e.drafterName=u.name,e.responsibleDeptName=u.deptName,e.responsibleDeptId=u.deptId,e.personMemberName=u.personMemberName}e.status==0?(oe(),De({type:"infoKind",codePre:"02",orgId:e.organId}).then(o=>{o.result.forEach(u=>{D.push({value:u.id,label:u.name})})})):D.push({value:e.infoKindId,label:e.infoKindName});let{billCode:p,fillinDate:d,personMemberName:r,deptName:I}=a;Object.assign(P,{billCode:p,fillinDate:d,personMemberName:r,deptName:I})})})),(t,a)=>{const p=c("a-input"),d=c("a-form-item"),r=c("a-col"),I=c("a-select"),o=c("a-button"),u=c("a-textarea"),A=c("a-row"),q=c("a-card"),se=c("a-form"),re=c("a-spin"),ie=Ne("global-disabled");return C(),Z(F(de),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:n(()=>[j("div",Ke,[l(re,{spinning:e.spinning,tip:"Loading..."},{default:n(()=>[j("div",Se,[j("div",Ae,[l(ve,{options:P},null,8,["options"]),l(be,{onAgree:K.handleAgree,onSave:K.handleSave,onSubmit:K.handleSubmit,processInstanceId:E.value,processStatus:e.status,listenMessage:"info-notice"},null,8,["onAgree","onSave","onSubmit","processInstanceId","processStatus"])]),ye((C(),B("div",qe,[l(se,{model:e,name:"basic",ref_key:"formRef",ref:U,"label-col":{span:4},"wrapper-col":{span:20},autocomplete:"off",onFinish:M},{default:n(()=>[l(q,{title:"基本信息",bordered:!1},{default:n(()=>[l(A,{gutter:24},{default:n(()=>[F(V)().isMultiOrganization?(C(),Z(r,{key:0,span:12},{default:n(()=>[l(d,{label:"所在公司",name:"infoKindId",labelCol:{span:4},wrapperCol:7,rules:[{required:!1}]},{default:n(()=>[l(p,{value:e.organName,"onUpdate:value":a[0]||(a[0]=s=>e.organName=s),disabled:"true"},null,8,["value"])]),_:1})]),_:1})):R("",!0),l(r,{span:12},{default:n(()=>[l(d,{label:"所在部门",name:"deptName",labelCol:{span:4},wrapperCol:7,rules:[{required:!1}]},{default:n(()=>[l(p,{value:e.deptName,"onUpdate:value":a[1]||(a[1]=s=>e.deptName=s),disabled:"true"},null,8,["value"])]),_:1})]),_:1}),l(r,{span:12},{default:n(()=>[l(d,{label:"发起人",name:"personMemberName",labelCol:{span:4},wrapperCol:7,rules:[{required:!1}]},{default:n(()=>[l(p,{value:e.personMemberName,"onUpdate:value":a[2]||(a[2]=s=>e.personMemberName=s),disabled:"true"},null,8,["value"])]),_:1})]),_:1}),l(r,{span:12},{default:n(()=>[l(d,{label:"信息类型",name:"infoKindId",labelCol:{span:4},wrapperCol:7,rules:[{required:!0,message:"信息类型不能为空"}]},{default:n(()=>[l(I,{value:e.infoKindId,"onUpdate:value":a[3]||(a[3]=s=>e.infoKindId=s),"allow-clear":"",options:D,disabled:i.value,onChange:Q},null,8,["value","options","disabled"])]),_:1})]),_:1}),l(r,{span:12},{default:n(()=>[l(d,{label:"是否允许下载",name:"isAllowDownloadFile",labelCol:{span:4},wrapperCol:7,rules:[{required:!0,message:"是否允许下载不能为空"}]},{default:n(()=>[l(J,{value:e.isAllowDownloadFile,"onUpdate:value":a[4]||(a[4]=s=>e.isAllowDownloadFile=s),type:"yes_or_no",disabled:i.value,style:"width: 100%"},null,8,["value","disabled"])]),_:1})]),_:1}),l(r,{span:12},{default:n(()=>[l(d,{label:"是否允许抄送",name:"isAllowCopy",labelCol:{span:4},wrapperCol:7,rules:[{required:!0,message:"是否允许抄送不能为空"}]},{default:n(()=>[l(J,{value:e.isAllowCopy,"onUpdate:value":a[5]||(a[5]=s=>e.isAllowCopy=s),type:"yes_or_no",disabled:i.value,style:"width: 100%"},null,8,["value","disabled"])]),_:1})]),_:1}),l(r,{span:24},{default:n(()=>[l(d,{label:"接收范围",name:"receiver",labelCol:{span:2},wrapperCol:7,rules:[{required:!0,message:"接收范围不能为空"}]},{default:n(()=>[i.value?R("",!0):(C(),B("div",Oe,[l(o,{type:"link",onClick:X},{default:n(()=>[x("选择")]),_:1}),l(o,{type:"link",onClick:Y},{default:n(()=>[x("清空")]),_:1})])),l(p,{value:e.receiverName,"onUpdate:value":a[6]||(a[6]=s=>e.receiverName=s),disabled:"true",style:G({width:i.value?"100%":"90%"})},null,8,["value","style"])]),_:1})]),_:1}),l(r,{span:24},{default:n(()=>[l(d,{label:"审批人",name:"handler",labelCol:{span:2},wrapperCol:7,rules:[{required:!0,message:"审批人不能为空"}]},{default:n(()=>[i.value?R("",!0):(C(),B("div",Te,[l(o,{type:"link",onClick:L},{default:n(()=>[x("选择")]),_:1}),l(o,{type:"link",onClick:ee},{default:n(()=>[x("清空")]),_:1})])),l(p,{value:e.handlerName,"onUpdate:value":a[7]||(a[7]=s=>e.handlerName=s),disabled:"true",style:G({width:i.value?"100%":"90%"})},null,8,["value","style"])]),_:1})]),_:1}),l(r,{span:24},{default:n(()=>[l(d,{label:"通知主题",name:"subject",labelCol:{span:2},wrapperCol:7,rules:[{required:!0,message:"通知主题不能为空"}]},{default:n(()=>[l(p,{value:e.subject,"onUpdate:value":a[8]||(a[8]=s=>e.subject=s),disabled:i.value,maxlength:"128"},null,8,["value","disabled"])]),_:1})]),_:1}),l(r,{span:24},{default:n(()=>[l(d,{label:"说明",name:"remarks",labelCol:{span:2},wrapperCol:7,rules:[{required:!1,message:"说明不能为空"}]},{default:n(()=>[l(u,{rows:3,value:e.remarks,"onUpdate:value":a[9]||(a[9]=s=>e.remarks=s),placeholder:"1000字以内",maxlength:1e3,disabled:i.value,"show-count":""},null,8,["value","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),l(q,{title:"正文",bordered:!1},{default:n(()=>[l(F(ge),{modelValue:e.content,"onUpdate:modelValue":a[10]||(a[10]=s=>e.content=s),width:"calc(100% - 3.5rem)",height:300,maxChars:2e4,disabled:i.value},null,8,["modelValue","width","disabled"])]),_:1}),l(q,{title:"附件上传",bordered:!1},{default:n(()=>[l(_e,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"oa",module:"infonotice",vmode:i.value?"view":"box",bizId:e.bizFileId},null,8,["vmode","bizId"])]),_:1})]),_:1},8,["model"])])),[[ie,y.value]]),l($,{title:"选择接收范围",value:e.receiver,"onUpdate:value":a[11]||(a[11]=s=>e.receiver=s),visible:g.value,tdata:h.value,tfields:{key:"value",title:"label"},width:800,height:600,onCancel:ae,onConfirm:le},null,8,["value","visible","tdata"]),l($,{title:"选择审批人",value:e.handler,"onUpdate:value":a[12]||(a[12]=s=>e.handler=s),visible:_.value,tdata:z.value,tfields:{key:"value",title:"label"},width:800,height:600,onCancel:te,onConfirm:ne},null,8,["value","visible","tdata"])])]),_:1},8,["spinning"])])]),_:1})}}});const ba=fe(je,[["__scopeId","data-v-da89e06c"]]);export{ba as default};
//# sourceMappingURL=create-ffcac15b.js.map
