{"version":3,"file":"dataDetail-62a9c747.js","sources":["../../src/views/monitor/component/dataDetail.vue"],"sourcesContent":["<template>\n  <div class=\"data-detail\">\n    <div class=\"header-box\">\n      <div class=\"header-left\">\n        <div class=\"radio-btn-box\">\n          <RadioGroup v-model:value=\"showMode\" size=\"small\">\n            <RadioButton value=\"chart\">\n              <Icon icon=\"ant-design:line-chart-outlined\" class=\"radio-btn-icon\" :size=\"14\" />\n            </RadioButton>\n            <RadioButton value=\"table\">\n              <Icon icon=\"ant-design:insert-row-above-outlined\" class=\"radio-btn-icon\" :size=\"14\" />\n            </RadioButton>\n          </RadioGroup>\n        </div>\n        <div class=\"date-picker-box\">\n          <DatePicker v-model:value=\"date\" valueFormat=\"YYYY-MM-DD\" @change=\"handleChangeDate\" />\n        </div>\n        <div v-if=\"showMode === 'chart'\" class=\"select-box\">\n          <Select\n            v-model:value=\"target\"\n            mode=\"multiple\"\n            style=\"min-width: 206px\"\n            placeholder=\"选择指标\"\n            :options=\"targetOptions\"\n            :max-tag-count=\"2\"\n            showArrow\n            @change=\"handleTargetChange\"\n          />\n        </div>\n      </div>\n      <div class=\"header-right\" v-if=\"showMode === 'table'\">\n        <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"exportData\">导出</a-button>\n      </div>\n    </div>\n    <div class=\"content-box\">\n      <div v-if=\"showMode === 'chart'\" class=\"chart-box\">\n        <div style=\"margin-top: 10px; transform: scale(0.85); transform-origin: 0 0\">\n          <EchartLineChart\n            :data=\"pchartData\"\n            :width=\"props.echartWidth\"\n            :height=\"props.echartHeight\"\n            :smooth=\"true\"\n            :disableDataZoom=\"false\"\n            :customTooltipFormatter=\"chartTooltipFormatter\"\n          />\n        </div>\n      </div>\n      <div v-show=\"showMode === 'table'\" class=\"table-box\">\n        <BasicTable @register=\"registerTable\" :scroll=\"{ y: calcTableScroll }\" />\n        <!-- :scroll=\"{ y: calcTableHeight }\" -->\n      </div>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\n  import { onMounted, ref, reactive, watch, computed } from 'vue';\n  import { RadioGroup, RadioButton, Select, DatePicker, Button } from 'ant-design-vue';\n  import Icon from '@/components/Icon/Icon.vue';\n  import type { SelectProps } from 'ant-design-vue';\n\n  import dayjs, { Dayjs } from 'dayjs';\n  import { BasicTable, useTable, TableAction, BasicColumn } from '/@/components/Table';\n  import { formatDate } from '/@/utils/dateUtil';\n  import EchartLineChart from '/@/components/Framework/Chart/EchartLineChart.vue';\n  import { getChartData, getDeviceDataTable } from '../monitorApi.ts';\n  import { jsonToSheetXlsx } from '/@/components/Excel';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { IconEnum } from '@/enums/appEnum';\n\n  const { createConfirm } = useMessage();\n  const pchartData = reactive({\n    barData: [],\n    lineData: [],\n    categories: [],\n    units: [],\n    colors: [\n      ['#078C5D', '#68E4B8'],\n      ['#E59837', '#FAE895'],\n      ['#078C5D', '#68E4B8'],\n    ],\n  });\n\n  const pChartSeriesName = ref([]);\n\n  // 显示方式：图表/表格 chart/table\n  const showMode = ref('chart');\n\n  // 选择日期\n  const date = ref<Dayjs>();\n  const handleChangeDate = (value) => {\n    console.log('选择日期', value);\n    loadChartData();\n  };\n\n  // 选择指标\n  const target = ref([]);\n  const targetOptions = ref<SelectProps['options']>([]);\n  const handleTargetChange = (value: string[]) => {\n    console.log(`selected ${value}`);\n    target.value = value;\n    loadChartData();\n  };\n\n  // 父组件穿过来的表格字段，指标列表\n  interface Props {\n    tableColumns?: [];\n    indexType?: [];\n    esn?: null;\n  }\n\n  // const props = withDefaults(defineProps<Props>(), {});\n\n  const props = defineProps({\n    tableColumns: { type: Array, default: [] },\n    indexType: { type: Array, default: [] },\n    esn: { type: String, default: '' },\n    echartWidth: { type: Number, default: 1200 },\n    echartHeight: { type: Number, default: 712 },\n  });\n\n  const loadBaseInfo = async () => {\n    columns.value = columns.value ? columns.value : props.tableColumns;\n    let tempOptions = [];\n\n    props.indexType.forEach((item) => {\n      if (target.value.length == 0) {\n        target.value.push(item.addressField);\n      }\n      tempOptions.push({ label: item.addressDesc, value: item.addressField });\n    });\n    targetOptions.value = tempOptions;\n    // 初始化日期\n    let current = new Date();\n    date.value = dayjs(formatDate(current), 'YYYY-MM-DD');\n    loadChartData();\n  };\n  // 获取数据\n  const loadChartData = async () => {\n    let params = {};\n    let esns = [];\n    esns.push(props.esn);\n    if (target.value.length === 0) {\n      return;\n    }\n    params.queryFieldList = target.value;\n    params.startDate = formatDate(date.value);\n    params.endDate = formatDate(date.value);\n    params.esns = esns;\n    params.esn = props.esn;\n    params.dataType = 1;\n    params.isCrossTian = false;\n    params.sortField = 'timestamps';\n    params.sortType = 'asc';\n    let res = await getChartData(params);\n    if (res.hisData?.lenght > 0) {\n      pchartData.lineData = res.hisData[0]?.dataList;\n      pchartData.categories = res.hisData[0]?.timeList;\n      pchartData.units = res.hisData[0]?.unitList;\n      pchartData.seriesName = res.hisData[0]?.zhList;\n    }\n\n    // let colorList = [];\n    // let colorSource = [\n    //   ['#078C5D', '#68E4B8'],\n    //   ['#E59837', '#FAE895'],\n    //   ['#078C5D', '#68E4B8'],\n    // ];\n    // for (let i = 0; i < res[0].zhList.length; i++) {\n    //   let index = i % colorSource.lenght;\n    //   colorList.push(colorSource[index]);\n    // }\n    // pchartData.seriesName\n    // pChartSeriesName.value = res[0].zhList;\n    loadTableData();\n  };\n\n  // 处理表数据\n  const loadTableData = async () => {\n    let params = {};\n    let esns = [];\n    esns.push(props.esn);\n    params.startDate = formatDate(date.value);\n    params.endDate = formatDate(date.value);\n    params.esns = esns;\n    params.esn = props.esn;\n    params.dataType = 3;\n    params.isCrossTian = false;\n    params.sortField = 'timestamps';\n    params.sortType = 'desc';\n    let res = await getDeviceDataTable(params);\n\n    if (res.hisData?.lenght > 0) {\n      let timeList = res.hisData[0].timeList;\n      let columnList = res.hisData[0].zhList;\n      let enList = res.hisData[0].enList;\n      let unitList = res.hisData[0].unitList;\n      let dataList = res.hisData[0].dataList;\n      let preColumns = [{ title: '时间', dataIndex: 'time' }];\n      if (columnList.length > 0) {\n        for (let i = 0; i < columnList.length; i++) {\n          let column = { title: columnList[i] + '（' + unitList[i] + '）', dataIndex: enList[i] };\n          preColumns.push(column);\n        }\n        columns.value = preColumns;\n      }\n      if (timeList.length > 0) {\n        let tableList = [];\n        for (let j = 0; j < timeList.length; j++) {\n          let data = { time: timeList[j] };\n          for (let k = 0; k < enList.length; k++) {\n            data[enList[k]] = dataList[k][j];\n          }\n          tableList.push(data);\n        }\n        tableData.value = tableList;\n      }\n      reloadByDataSource(tableData.value);\n      // reload();\n    }\n  };\n\n  // 导出\n  function exportData() {\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要导出所有记录？',\n      async onOk() {\n        let header = {};\n        columns.value.forEach((item) => {\n          header[item.dataIndex] = item.title;\n        });\n\n        let exportDataList = [];\n        tableData.value.forEach((element) => {\n          let temp = {};\n          for (let k in header) {\n            temp[k] = element[k];\n          }\n          exportDataList.push(temp);\n        });\n\n        jsonToSheetXlsx({\n          data: exportDataList,\n          header: header,\n          filename: '数据明细.xlsx',\n        });\n      },\n    });\n  }\n  // 表格\n  const columns = ref([]);\n  const tableData = ref([]);\n  const [registerTable, { reload, reloadByDataSource, reloadApiDataByLocal }] = useTable({\n    // api: getDataList,\n    api: async () => {\n      const data = tableData?.value?.length ? tableData?.value : [];\n      return await reloadApiDataByLocal(data);\n    },\n    columns,\n    bordered: true,\n    showTableSetting: false,\n    rowKey: 'time',\n    pagination: { pageSize: 100, pageSizeOptions: ['20', '50', '100', '200'] },\n    tableSetting: { fullScreen: true },\n    dataSource: [],\n  });\n\n  // 折线图格式化\n  const chartTooltipFormatter = (params) => {\n    const units = pchartData.units;\n    const name = pchartData.seriesName;\n    let content = '';\n    if (params?.length) {\n      content = `${formatDate(date.value)} ${params[0].name}<br />`;\n      params.forEach((item, index) => {\n        content = content + `${name[index]}：${item.value} ${units[index]}`;\n        if (index < params.length - 1) {\n          content = content + `<br />`;\n        }\n      });\n    }\n    return content;\n  };\n\n  watch(\n    () => props.indexType,\n    (newValue) => {\n      loadBaseInfo();\n    },\n  );\n\n  const clearTarget = () => {\n    target.value = [];\n  };\n  const calcTableScroll = computed(() => {\n    if (props.echartHeight) {\n      return props.echartHeight * 0.85 - 85;\n    } else {\n      return 500;\n    }\n  });\n\n  // 启动执行代码\n  onMounted(() => {\n    loadBaseInfo();\n  });\n\n  defineExpose({\n    loadChartData,\n    loadBaseInfo,\n    clearTarget,\n  });\n</script>\n\n<style lang=\"less\">\n  @import '../style/themes.less';\n</style>\n\n<style lang=\"less\" scoped>\n  .data-detail {\n    .header-box {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 10px 15px 0;\n\n      .header-left {\n        display: flex;\n        align-items: center;\n      }\n    }\n\n    .radio-btn-box {\n      margin-right: 20px;\n    }\n\n    .date-picker-box {\n      margin-right: 20px;\n    }\n\n    .content-box {\n      .table-box {\n        // height: 600px;\n        height: 100%;\n        padding: 0 9px;\n        overflow: auto;\n      }\n    }\n  }\n</style>\n"],"names":["createConfirm","useMessage","pchartData","reactive","ref","showMode","date","handleChangeDate","value","loadChartData","target","targetOptions","handleTargetChange","loadBaseInfo","__async","columns","props","tempOptions","item","current","dayjs","formatDate","params","esns","res","getChartData","_a","_b","_c","_d","_e","loadTableData","getDeviceDataTable","timeList","columnList","enList","unitList","dataList","preColumns","i","column","tableList","j","data","k","tableData","reloadByDataSource","exportData","header","exportDataList","element","temp","jsonToSheetXlsx","registerTable","reload","reloadApiDataByLocal","useTable","chartTooltipFormatter","units","name","content","index","watch","newValue","clearTarget","calcTableScroll","computed","onMounted","__expose"],"mappings":"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"}