var x=(C,z,N)=>new Promise((E,c)=>{var M=v=>{try{h(N.next(v))}catch(D){c(D)}},e=v=>{try{h(N.throw(v))}catch(D){c(D)}},h=v=>v.done?E(v.value):Promise.resolve(v.value).then(M,e);h((N=N.apply(C,z)).next())});import{d as xe,J as L,k as T,r as q,o as Ie,al as p,Z as y,a9 as S,aa as l,$ as F,f as t,v as f,A as b,u as U,ac as k,ag as ye,E as Se,ad as Ae,aG as Ce,aH as Ne}from"./vue-71d1abb3.js";import{b as he,a0 as De,ak as Ue,aC as ke,a7 as we,at as K,aD as Te,aB as Fe,_ as Me}from"./index.js";import{B as V}from"./BasicTable-0434a334.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as W}from"./useTable-109483b3.js";import{bD as Be}from"./antd-15ac76ed.js";import{B as ze}from"./BillTitle-d17ab3e4.js";import{S as Ee}from"./SearchBox-22bb02d6.js";import{_ as Re}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{U as Pe}from"./UploadBox-636ecf02.js";import{W as Oe}from"./WfApproveBox-a3448232.js";import{d as Ye,f as Le,h as qe,i as Ke,a as Ve,j as We,k as je}from"./filling.data-83d8e807.js";import{f as He,g as $e}from"./template.data-3d5e7289.js";import{x as A}from"./index-66d20ba6.js";import{a as j}from"./assign-37f1c13d.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./Dialog-0a006d82.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";import"./useRender-21ce56fb.js";const Ge=C=>(Ce("data-v-ab45cd0f"),C=C(),Ne(),C),Je={class:"load"},Qe={class:"process-box"},Ze={class:"header-box"},Xe={class:"content"},ea=Ge(()=>F("div",{class:"customer_require"},"发布结果",-1)),aa=xe({__name:"create",setup(C){const{t:z}=he(),N=De(),E=L(N.getUserInfo),c=Ue.getInstance().getQuery(),M=T(),e=q({spinning:!1,status:0,listenMessage:c.processInstanceId?void 0:"assess-filling"}),h=T([]),v=T(),D=q({subject:"细则填报申请"}),m=T(!0),H=()=>{P(0)},$=()=>{const s=M.value;s&&s.validateFields().then(()=>{const a=B();if(a.length===0){I(`请${z("common.action.create")}项目明细`);return}for(let o=0;o<a.length;o++){const i=a[o];if(!A.trim(i.assessIndexKind)){I("项目明细，类别不能为空");return}if(!A.trim(i.assessIndexName)){I("项目明细，类型不能为空");return}if(!A.trim(i.assessDetail)){I("项目明细，分项不能为空");return}if(!A.trim(i.indexId)||!A.trim(i.indexName)||!A.trim(i.indexSort)){I("项目明细，细则指标不能为空");return}}P(1)}).catch(a=>{var i;console.log("onSubmit=》error",a);const o=a.errorFields;if((i=document.querySelector(".ant-form-item-has-error"))==null||i.scrollIntoView({behavior:"smooth",block:"center"}),o&&o.length>0){I(o[0].errors[0]);return}})},P=s=>x(this,null,function*(){e.spinning=!0;try{if(!O(s===1))return;yield G(s)}catch(a){e.spinning=!1,console.log("error",a)}}),G=s=>x(this,null,function*(){const a=L(e);a.status=s,a.detailList=B(),a.summaryList=le(),yield Le(a).then(o=>{e.id=o.result,s===1&&(m.value=!0),e.spinning=!1,(s===0||s===1)&&Q("操作成功"),J(s)}).catch(()=>{e.spinning=!1})}),J=s=>{(s===0||s===1)&&setTimeout(()=>{s===1&&ke(),we.getInstance().sendMsg("assess-filling",{})},200)},I=s=>{e.spinning=!1,K.getInstance().error(s)},Q=s=>{K.getInstance().success(s)},Z=()=>{const s=e.status===0&&(!e.personMemberId||e.personMemberId.indexOf(E.userId)>-1);m.value=!s},X=s=>{e.periodId=s.record.periodId,e.templateId=s.record.key,e.desulfurizationPrice=s.record.desulfurizationPrice,ee(e.templateId)},ee=s=>x(this,null,function*(){const a=yield He({templateId:s});v.value=a.result}),ae=()=>x(this,null,function*(){const s=yield Ve({id:c.id});if(s.result){j(e,s.result),e.status=Number(e.status),e.processInstanceId||(e.processInstanceId=c.processInstanceId);const{billCode:a,fillinDate:o,personMemberName:i,deptName:r}=s.result;Object.assign(D,{billCode:a,fillinDate:o,personMemberName:i,deptName:r}),Z()}}),[te,{getDataSource:B}]=W({dataSource:v,columns:We,pagination:!1,striped:!1,bordered:!0,canResize:!1}),R=T(),[se,{getDataSource:le}]=W({dataSource:R,columns:je,pagination:!1,striped:!1,bordered:!0,canResize:!1}),ne=()=>x(this,null,function*(){const s=yield qe({fillingId:e.id});v.value=s.result;const a=yield Ke({fillingId:e.id});R.value=a.result});function oe(s,a){a.reverseCalculationAmount=s}function ie(){$e({stationId:e.stationId,businessStatus:1,sortField:"finishedDate",sortOrder:"desc",pageNo:1,pageSize:100}).then(s=>{h.value=s.result.list})}const re=()=>x(this,null,function*(){let s=c.id;if(!s&&c.processInstanceId){const a=yield Fe(c.processInstanceId),o=a==null?void 0:a.businessKey;c.id=o,s=o}return s});function ue(){O(!1)}function O(s){if(!me(s))return!1;const a=B();de(a);const o=a.reduce((r,u)=>{const d=u.indexId;return r[d]||(r[d]={key:d,assessAmount:0,assessElectricity:0,reverseCalculationAmount:0,indexType:u.indexType,indexId:u.indexId,indexName:u.indexName}),r[d].assessAmount=(Number(r[d].assessAmount)+Number(u.assessAmount||0)).toFixed(6),r[d].assessElectricity=(Number(r[d].assessElectricity)+Number(u.assessElectricity||0)).toFixed(6),r[d].reverseCalculationAmount=(Number(r[d].reverseCalculationAmount)+Number(u.reverseCalculationAmount||0)).toFixed(6),r},{});let i=[];for(const r in o)i.push(o[r]);return i.sort((r,u)=>r.sort&&u.sort?r.indexSort-u.indexSort:-1),R.value=i,!0}function de(s){let a=0,o=0,i=0,r=0,u=0;s.forEach(function(d){d.indexType==="check"?a=Number(a)+Number(d.assessAmount||0):d.indexType==="return"?o=Number(o)+Number(d.assessAmount||0):d.indexType==="share"?i=Number(i)+Number(d.assessAmount||0):d.indexType==="compensate"&&(r=Number(r)+Number(d.assessAmount||0)),u=Number(u)+Number(d.assessElectricity||0)}),e.totalAmount=a.toFixed(6),e.returnAmount=o.toFixed(6),e.compensateShareAmount=i.toFixed(6),e.compensateTotalAmount=r.toFixed(6),e.totalElectricity=u.toFixed(6),e.netIncome=(o+r-(a+i)).toFixed(6)}function me(s){const a=B();if(a.length===0)return I("细则明细不存在，请选择期数"),!1;if(!s)return!0;for(let o=0;o<a.length;o++){const i=a[o];if(!A.trim(i.assessResult))return I("细则明细，发布结果不能为空"),!1}return!0}const ce=()=>x(this,null,function*(){c.id=yield re(),yield ae(),c.id||(j(e,c),m.value=!1,e.bizFileId=Te())});function pe(){ie()}return Ie(()=>x(this,null,function*(){yield ce(),pe(),ne()})),(s,a)=>{const o=p("a-input"),i=p("a-form-item"),r=p("a-col"),u=p("a-row"),d=p("a-date-picker"),w=p("a-card"),fe=p("a-textarea"),Y=p("a-input-number"),be=p("a-button"),ve=p("a-form"),_e=p("a-spin"),ge=p("PageWrapper");return y(),S(ge,{detail:!0,dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"fix-detail-page",style:{position:"relative"}},{default:l(()=>[F("div",Je,[t(_e,{spinning:e.spinning,tip:"Loading..."},{default:l(()=>[F("div",Qe,[F("div",Ze,[t(ze,{options:D},null,8,["options"]),t(Oe,{onSave:H,onSubmit:$,processInstanceId:e.processInstanceId,processStatus:e.status,listenMessage:e.listenMessage},null,8,["processInstanceId","processStatus","listenMessage"])]),F("div",Xe,[t(ve,{ref_key:"formRef",ref:M,model:e,labelAlign:"right",autocomplete:"off"},{default:l(()=>[t(w,{title:"基本信息",bordered:!1},{default:l(()=>[t(u,{gutter:32},{default:l(()=>[f(t(r,{span:12},{default:l(()=>[t(i,{name:"stationName",label:"电站名称",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.stationName,"onUpdate:value":a[0]||(a[0]=n=>e.stationName=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]]),f(t(r,{span:12},{default:l(()=>[t(i,{name:"periodName",label:"期数",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请选择期数"}]},{default:l(()=>[t(Ee,{value:e.periodName,"onUpdate:value":a[1]||(a[1]=n=>e.periodName=n),columns:U(Ye),data:h.value,vfield:"periodName",pagination:!1,onSelect:X,disabled:m.value},null,8,["value","columns","data","disabled"])]),_:1})]),_:1},512),[[b,!0]])]),_:1}),t(u,{gutter:32},{default:l(()=>[f(t(r,{span:12},{default:l(()=>[t(i,{name:"desulfurizationPrice",label:"本期脱硫电价(元)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.desulfurizationPrice,"onUpdate:value":a[2]||(a[2]=n=>e.desulfurizationPrice=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]]),f(t(r,{span:12},{default:l(()=>[t(i,{name:"assessCycle",label:"考核月份",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请输入考核月份"}]},{default:l(()=>[t(d,{value:e.assessCycle,"onUpdate:value":a[3]||(a[3]=n=>e.assessCycle=n),picker:"month",format:"YYYY-MM","value-format":"YYYY-MM",style:"width: 100%",maxlength:7,disabled:m.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[b,!0]])]),_:1}),t(u,{gutter:32},{default:l(()=>[f(t(r,{span:12},{default:l(()=>[t(i,{name:"assessKind",label:"考核类型",labelCol:{class:"detail-label-8"},rules:[{required:!0,message:"请选择考核类型"}]},{default:l(()=>[t(Re,{value:e.assessKind,"onUpdate:value":a[4]||(a[4]=n=>e.assessKind=n),type:"assess_kind",disabled:m.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[b,!0]])]),_:1})]),_:1}),t(w,{title:"考核结果",bordered:!1},{default:l(()=>[t(u,{gutter:32},{default:l(()=>[f(t(r,{span:12},{default:l(()=>[t(i,{name:"totalAmount",label:"考核总费用(万元)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.totalAmount,"onUpdate:value":a[5]||(a[5]=n=>e.totalAmount=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]]),f(t(r,{span:12},{default:l(()=>[t(i,{name:"returnAmount",label:"返还总费用(万元)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.returnAmount,"onUpdate:value":a[6]||(a[6]=n=>e.returnAmount=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]])]),_:1}),t(u,{gutter:32},{default:l(()=>[f(t(r,{span:12},{default:l(()=>[t(i,{name:"compensateShareAmount",label:"分摊总费用(万元)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.compensateShareAmount,"onUpdate:value":a[7]||(a[7]=n=>e.compensateShareAmount=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]]),f(t(r,{span:12},{default:l(()=>[t(i,{name:"compensateTotalAmount",label:"补偿总费用(万元)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.compensateTotalAmount,"onUpdate:value":a[8]||(a[8]=n=>e.compensateTotalAmount=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]])]),_:1}),t(u,{gutter:32},{default:l(()=>[f(t(r,{span:12},{default:l(()=>[t(i,{name:"totalElectricity",label:"总考核电量(MWH)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.totalElectricity,"onUpdate:value":a[9]||(a[9]=n=>e.totalElectricity=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]]),f(t(r,{span:12},{default:l(()=>[t(i,{name:"netIncome",label:"净收入(万元)",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(o,{value:e.netIncome,"onUpdate:value":a[10]||(a[10]=n=>e.netIncome=n),disabled:""},null,8,["value"])]),_:1})]),_:1},512),[[b,!0]])]),_:1}),t(u,{gutter:32},{default:l(()=>[f(t(r,{span:24},{default:l(()=>[t(i,{name:"remark",label:"备注",labelCol:{class:"detail-label-8"}},{default:l(()=>[t(fe,{value:e.remark,"onUpdate:value":a[11]||(a[11]=n=>e.remark=n),rows:4,maxlength:500,disabled:m.value},null,8,["value","disabled"])]),_:1})]),_:1},512),[[b,!0]])]),_:1})]),_:1}),t(w,{bordered:!1},{default:l(()=>[t(U(V),{title:"细则明细",onRegister:U(te)},{assessResult:l(()=>[ea]),bodyCell:l(({column:n,record:_})=>[n.dataIndex==="assessResult"?(y(),S(o,{key:0,value:_[n.dataIndex],"onUpdate:value":g=>_[n.dataIndex]=g,maxlength:200,disabled:m.value},null,8,["value","onUpdate:value","disabled"])):k("",!0),n.dataIndex==="assessElectricity"?(y(),S(Y,{key:1,value:_[n.dataIndex],"onUpdate:value":g=>_[n.dataIndex]=g,min:0,max:999999.999999,precision:6,disabled:m.value},null,8,["value","onUpdate:value","disabled"])):k("",!0),n.dataIndex==="assessAmount"?(y(),S(Y,{key:2,value:_[n.dataIndex],"onUpdate:value":g=>_[n.dataIndex]=g,min:0,max:99999999999999e-6,precision:6,disabled:m.value,onChange:g=>oe(g,_)},null,8,["value","onUpdate:value","disabled","onChange"])):k("",!0),n.dataIndex==="situationAnalysis"?(y(),S(o,{key:3,value:_[n.dataIndex],"onUpdate:value":g=>_[n.dataIndex]=g,maxlength:200,disabled:m.value},null,8,["value","onUpdate:value","disabled"])):k("",!0),n.dataIndex==="remark"?(y(),S(o,{key:4,value:_[n.dataIndex],"onUpdate:value":g=>_[n.dataIndex]=g,maxlength:200,disabled:m.value},null,8,["value","onUpdate:value","disabled"])):k("",!0)]),_:1},8,["onRegister"])]),_:1}),t(w,{bordered:!1},{default:l(()=>[t(U(V),{title:"细则汇总",onRegister:U(se)},ye({_:2},[m.value?void 0:{name:"toolbar",fn:l(()=>[m.value?k("",!0):(y(),S(be,{key:0,type:"primary",onClick:ue},{default:l(()=>[t(U(Be)),Se(" "+Ae("汇总"))]),_:1}))]),key:"0"}]),1032,["onRegister"])]),_:1}),t(w,{title:"附件资料",bordered:!1},{default:l(()=>[t(Pe,{width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:"assessFilling",vmode:e.status===0&&!m.value?"box":"view",bizId:e.bizFileId},null,8,["vmode","bizId"])]),_:1})]),_:1},8,["model"])])])]),_:1},8,["spinning"])])]),_:1})}}});const Ra=Me(aa,[["__scopeId","data-v-ab45cd0f"]]);export{Ra as default};
//# sourceMappingURL=create-9b45547f.js.map
