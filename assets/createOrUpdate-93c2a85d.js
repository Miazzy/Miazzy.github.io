var A=(r,R,k)=>new Promise((C,D)=>{var w=c=>{try{y(k.next(c))}catch(T){D(T)}},u=c=>{try{y(k.throw(c))}catch(T){D(T)}},y=c=>c.done?C(c.value):Promise.resolve(c.value).then(w,u);y((k=k.apply(r,R)).next())});import{P as le}from"./index-20519caf.js";import{a5 as P,a0 as se,aj as ne,aB as oe,av as ie,at as Y,aC as de,a7 as re,am as ue,_ as pe}from"./index.js";import{C as U}from"./safecheckexecution-9a1cbf60.js";import{B as ce}from"./BasicTable-0434a334.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as me}from"./useTable-109483b3.js";import"./antd-15ac76ed.js";import{_ as fe}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{B as be}from"./BillTitle-d17ab3e4.js";import{W as he}from"./WfApproveBox-a3448232.js";import{D as ve}from"./Dialog-0a006d82.js";import{U as Ie}from"./UploadBox-636ecf02.js";import{d as ge,J as _e,k as _,e as ke,r as G,o as ye,al as p,Z as f,a9 as b,aa as n,$ as x,f as s,u as h,ac as g,ag as xe,E as B,aG as Ce,aH as De}from"./vue-71d1abb3.js";import"./useContentViewHeight-7f845167.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-316f6ffb.js";import"./useRender-21ce56fb.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./index.esm-c216ed00.js";import"./index-fda2d66c.js";import"./index-c0893416.js";import"./index-33af41d1.js";import"./tree-fc0e156a.js";function we(r){return P.get({url:"/po/safe-check-template/dtl/list",params:r})}function Te(r){return P.get({url:"/po/safe-check-template/list",params:r})}function Se(r){return P.get({url:"/po/safe-check-execution/dtl/list",params:r})}function Ue(r){return P.get({url:"/po/safe-check-execution/get",params:r})}function Pe(r){return P.post({url:"/baseset/common/list-stationPerson?stationId="+r})}function Ne(r){return P.post({url:"/po/safe-check-execution/create",data:r})}const Re=[{title:"检查项目",dataIndex:"indexItem",width:80,customCell:(r,R,k)=>({rowSpan:r.rowSpan})},{title:"检查内容",dataIndex:"indexContent",width:160,align:"left"},{slots:{title:"result"},dataIndex:"result",width:160,align:"left"},{slots:{title:"needRectification"},dataIndex:"needRectification",width:100},{title:"计划整改措施",dataIndex:"measures",width:160},{title:"计划完成日期",dataIndex:"deadlineDate",width:160},{title:"隐患类别",dataIndex:"hiddenDangerType",width:160},{title:"检查附件",dataIndex:"bizFileId",align:"left",headAlign:"center",width:160}],V=r=>(Ce("data-v-1524cec3"),r=r(),De(),r),Me={class:"load"},Ee={class:"process-box"},Oe={class:"header-box"},je={class:"content"},qe=V(()=>x("div",{class:"customer_require"},"检查情况",-1)),Ae=V(()=>x("div",{class:"customer_require"},"是否需要整改",-1)),Ye={style:{padding:"0 10px"}},Be=ge({__name:"createOrUpdate",setup(r){const R=se(),k=_e(R.getUserInfo),C=_(!1),D=_(!1),w=_(!0),u=ke(()=>e.status!=0||e.status==0&&e.personMemberId!=""&&e.personMemberId.substring(0,32)!=k.userId),y=_(""),c=_(""),T=_(),M=_([]),F=_([]);let{params:m}=ne();const e=G({id:m.id||"",subject:"",checkerId:"",personMemberId:"",stationName:m.stationName||"",stationId:m.stationId||"",stationOrganName:m.stationOrganName||"",stationOrganId:m.stationOrganId||"",status:0,checkPeriodDisplay:"",responsiblePersonId:"",responsiblePersonName:"",checkDate:"",taskDate:"",templateId:"",billCode:"",fillinDate:"",templateName:"",checkerName:"",checkPeriod:"",spinning:!1,num:"",safetyCheckType:m.safetyCheckType,dtl:{}}),E=()=>{e.dtl=q(),e.spinning=!0,Ne(e).then(l=>{l.result!=""?(e.id=l.result,Y.getInstance().success(e.status==1?"提交成功":"保存成功"),e.status==1&&setTimeout(()=>{de(),re.getInstance().sendMsg("safe-check-execution",{})},100)):(w.value=!1,Y.getInstance().error("保存失败.")),e.spinning=!1}).catch(l=>{console.log(l),w.value=!1,e.spinning=!1,e.status=0})},O=G({subject:""}),j={handleAgree:l=>{console.log("同意",l)},handleSave:l=>{console.log("保存",l),w.value=!1,e.status=0,E()},handleSubmit:l=>{console.log("提交",l),w.value=!0,e.status=1;const t=T.value;t&&t.validateFields().then(()=>{if(q().length===0){Y.getInstance().info("检查内容与结果不能为空"),e.status=0;return}E()}).catch(o=>{console.log(o),e.status=0})}},[W,{getDataSource:q,updateTableData:$,reload:H}]=me({api:()=>A(this,null,function*(){let l;if(e.id&&!D.value)l=yield Se({safeCheckExecutionId:e.id});else{if(e.templateId){if(l=yield we({safeCheckTemplateId:e.templateId}),l.result.length>0)for(let t=0;t<l.result.length;t++)l.result[t].needRectification=0,l.result[t].bizFileId=ue()}else l={result:[],total:0};J(l.result)}return D.value=!1,l.result}),bordered:!0,pagination:!1,columns:Re,useSearchForm:!1,showTableSetting:!1,rowSelection:{type:"checkbox"}}),J=l=>{if(l.length===0)return;let t={};for(let o=0;o<l.length;o++){let d=l[o].indexItem;t[d]?t[d]=t[d]+1:t[d]=1}l.sort((o,d)=>o.indexItem>d.indexItem?1:-1);for(let o=0;o<l.length;o++){let d=l[o].indexItem;t[d]?(l[o].rowSpan=t[d],delete t[d]):l[o].rowSpan=0}},K=()=>{C.value=!0},Z=()=>{let l=q(),t=0;l.forEach(()=>{$(t,"result",y.value),t++}),C.value=!1};return ye(()=>A(this,null,function*(){if(c.value=m.processInstanceId,!e.id&&m.processInstanceId){const l=yield oe(m.processInstanceId);e.id=l.businessKey}Ue({id:e.id,safetyCheckType:e.safetyCheckType||""}).then(l=>{let t=l.result;if(e.id){for(let N in t)e[N]=t[N];e.status=Number(e.status),e.safetyCheckType==U.REGULAR&&t.num?e.checkPeriodDisplay=t.checkPeriodText+t.num+"次":e.checkPeriodDisplay=""}else e.billCode=t.billCode,e.personMemberName=t.personMemberName,e.deptName=t.deptName,e.fillinDate=t.fillinDate;let{billCode:o,fillinDate:d,personMemberName:v,deptName:S}=t;Object.assign(O,{billCode:o,fillinDate:d,personMemberName:v,deptName:S}),O.subject=(e.safetyCheckType==U.REGULAR?"定期":"专项")+"检查"}).then(()=>{Pe(e.stationId).then(l=>{let t={};l.result.forEach(o=>{t[o.userId]=o.name});for(let o in t)M.value.push({label:t[o],value:o})}),e.safetyCheckType=="1"&&Te({checkType:e.safetyCheckType,status:2,bizStatus:1}).then(l=>{l.result.forEach(t=>{F.value.push({label:t.subject,value:t.id,num:t.num,checkPeriod:t.checkPeriod,checkPeriodText:t.checkPeriodText})})}),H()})})),(l,t)=>{const o=p("a-input"),d=p("a-form-item"),v=p("a-col"),S=p("a-select"),N=p("a-date-picker"),Q=p("a-row"),z=p("a-card"),L=p("a-select-option"),X=p("a-button"),ee=p("a-form"),te=p("a-textarea"),ae=p("a-spin");return f(),b(h(le),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:n(()=>[x("div",Me,[s(ae,{spinning:e.spinning,tip:"Loading..."},{default:n(()=>[x("div",Ee,[x("div",Oe,[s(be,{options:O},null,8,["options"]),s(he,{processInstanceId:c.value,onAgree:j.handleAgree,onSave:j.handleSave,onSubmit:j.handleSubmit,processStatus:e.status,listenMessage:"safe-check-execution"},null,8,["processInstanceId","onAgree","onSave","onSubmit","processStatus"])]),x("div",je,[s(ee,{model:e,name:"basic",ref_key:"formRef",ref:T,"label-col":{span:4},"wrapper-col":{span:20},autocomplete:"off",onFinish:E},{default:n(()=>[s(z,{title:"基本信息",bordered:!1},{default:n(()=>[s(Q,{gutter:32},{default:n(()=>[s(v,{span:12},{default:n(()=>[s(d,{label:"电站名称",name:"stationName",labelCol:{style:{width:"124px"}},rules:[{required:!1}]},{default:n(()=>[s(o,{value:e.stationName,"onUpdate:value":t[0]||(t[0]=a=>e.stationName=a),disabled:""},null,8,["value"])]),_:1})]),_:1}),s(v,{span:12},{default:n(()=>[e.safetyCheckType==h(U).SPECIAL?(f(),b(d,{key:0,label:"任务日期",name:"taskDate",labelCol:{style:{width:"124px"}},rules:[{required:!1}]},{default:n(()=>[s(o,{value:e.taskDate,"onUpdate:value":t[1]||(t[1]=a=>e.taskDate=a),disabled:""},null,8,["value"])]),_:1})):g("",!0),e.safetyCheckType==h(U).REGULAR?(f(),b(d,{key:1,label:"检查模板",name:"templateId",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"检查模板必选"}]},{default:n(()=>[s(S,{value:e.templateId,"onUpdate:value":t[2]||(t[2]=a=>e.templateId=a),allowClear:"",options:F.value,disabled:u.value,onChange:t[3]||(t[3]=(a,i)=>{e.templateId=a,e.templateName=i.label,e.num=i.num,e.checkPeriod=i.checkPeriod,e.checkPeriodDisplay=i.checkPeriodText+i.num+"次",e.subject=i.label+"-"+e.stationName,D.value=!0,h(H)()})},null,8,["value","options","disabled"])]),_:1})):g("",!0)]),_:1}),e.safetyCheckType==h(U).REGULAR?(f(),b(v,{key:0,span:12},{default:n(()=>[s(d,{label:"检查频率",name:"checkPeriodDisplay",labelCol:{style:{width:"124px"}},rules:[{required:!1}]},{default:n(()=>[s(o,{value:e.checkPeriodDisplay,"onUpdate:value":t[4]||(t[4]=a=>e.checkPeriodDisplay=a),disabled:""},null,8,["value"])]),_:1})]),_:1})):g("",!0),s(v,{span:12},{default:n(()=>[s(d,{label:"主题",name:"subject",labelCol:{style:{width:"124px"}},rules:[{required:!1,message:"主题"}]},{default:n(()=>[s(o,{value:e.subject,"onUpdate:value":t[5]||(t[5]=a=>e.subject=a),disabled:u.value||e.safetyCheckType==h(U).SPECIAL,readonly:"true",maxlength:"128"},null,8,["value","disabled"])]),_:1})]),_:1}),s(v,{span:12},{default:n(()=>[s(d,{label:"负责人",name:"responsiblePersonId",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"请选择负责人"}]},{default:n(()=>[s(S,{value:e.responsiblePersonId,"onUpdate:value":t[6]||(t[6]=a=>e.responsiblePersonId=a),allowClear:"",options:M.value,disabled:u.value,onChange:t[7]||(t[7]=(a,i)=>{e.responsiblePersonId=a,e.responsiblePersonName=i.label})},null,8,["value","options","disabled"])]),_:1})]),_:1}),s(v,{span:12},{default:n(()=>[s(d,{label:"检查人",name:"checkerId",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"检查人"}]},{default:n(()=>[s(S,{value:e.checkerId,"onUpdate:value":t[8]||(t[8]=a=>e.checkerId=a),allowClear:"",options:M.value,disabled:u.value,onChange:t[9]||(t[9]=(a,i)=>{e.checkerId=a,e.checkerName=i.label})},null,8,["value","options","disabled"])]),_:1})]),_:1}),s(v,{span:12},{default:n(()=>[s(d,{label:"检查日期",name:"checkDate",labelCol:{style:{width:"124px"}},rules:[{required:!0,message:"检查日期"}]},{default:n(()=>[s(N,{value:e.checkDate,"onUpdate:value":t[10]||(t[10]=a=>e.checkDate=a),valueFormat:"YYYY-MM-DD",style:{width:"100%"},disabled:u.value},null,8,["value","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),s(z,{bordered:!1},{default:n(()=>[s(h(ce),{title:"检查内容与结果",onRegister:h(W)},xe({result:n(()=>[qe]),needRectification:n(()=>[Ae]),bodyCell:n(({column:a,record:i})=>[a.dataIndex==="result"?(f(),b(o,{key:0,value:i[a.dataIndex],"onUpdate:value":I=>i[a.dataIndex]=I,maxlength:"1024",disabled:u.value,style:{width:"100%"}},null,8,["value","onUpdate:value","disabled"])):g("",!0),a.dataIndex==="needRectification"?(f(),b(S,{key:1,value:i[a.dataIndex],"onUpdate:value":I=>i[a.dataIndex]=I,style:{width:"100%"},"allow-clear":"",disabled:u.value},{default:n(()=>[s(L,{value:0},{default:n(()=>[B("否")]),_:1}),s(L,{value:1},{default:n(()=>[B("是")]),_:1})]),_:2},1032,["value","onUpdate:value","disabled"])):g("",!0),a.dataIndex==="deadlineDate"?(f(),b(N,{key:2,disabled:u.value,value:i[a.dataIndex],"onUpdate:value":I=>i[a.dataIndex]=I,valueFormat:"YYYY-MM-DD HH:mm",format:"YYYY-MM-DD HH:mm",style:{width:"100%"}},null,8,["disabled","value","onUpdate:value"])):g("",!0),a.dataIndex==="measures"?(f(),b(o,{key:3,disabled:u.value,value:i[a.dataIndex],"onUpdate:value":I=>i[a.dataIndex]=I,maxlength:"1024",style:{width:"100%"}},null,8,["disabled","value","onUpdate:value"])):g("",!0),a.dataIndex==="hiddenDangerType"?(f(),b(fe,{key:4,type:"hidden_danger_type",disabled:u.value,subtype:"safety",value:i[a.dataIndex],"onUpdate:value":I=>i[a.dataIndex]=I,style:{width:"100%"}},null,8,["disabled","value","onUpdate:value"])):g("",!0),a.dataIndex==="bizFileId"?(f(),b(Ie,{key:5,width:800,height:550,maxCount:20,maxSize:100*1024*1024,application:"po",module:`safeCheckExecution${h(m).safetyCheckType}`,vmode:e.status==0?"box":"view",bizId:i[a.dataIndex]},null,8,["module","vmode","bizId"])):g("",!0)]),_:2},[e.status==0&&!u.value?{name:"toolbar",fn:n(()=>[s(X,{onClick:K,preIcon:h(ie).EDIT},{default:n(()=>[B("检查情况")]),_:1},8,["preIcon"])]),key:"0"}:void 0]),1032,["onRegister"])]),_:1})]),_:1},8,["model"]),s(ve,{visible:C.value,"onUpdate:visible":t[12]||(t[12]=a=>C.value=a),title:"批量修改检查情况",onOk:Z,width:300,height:220,maskClosable:!1},{default:n(()=>[x("div",Ye,[s(te,{value:y.value,"onUpdate:value":t[11]||(t[11]=a=>y.value=a),rows:3,maxlength:"1024"},null,8,["value"])])]),_:1},8,["visible"])])])]),_:1},8,["spinning"])])]),_:1})}}});const kt=pe(Be,[["__scopeId","data-v-1524cec3"]]);export{kt as default};
//# sourceMappingURL=createOrUpdate-93c2a85d.js.map
