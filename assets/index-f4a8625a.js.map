{"version":3,"file":"index-f4a8625a.js","sources":["../../src/views/po/drone/droneinspection/index.vue"],"sourcesContent":["<template>\n  <div>\n    <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n      <!-- 电站组织树 -->\n\n      <CommonTree\n        title=\"电站组织\"\n        @select=\"handleSelect\"\n        :value=\"treeData\"\n        class=\"left-tree-layout\"\n        :toolbar=\"true\"\n        :canEdit=\"false\"\n        :canAdd=\"false\"\n        :canDelete=\"false\"\n        :isShowOperationBtns=\"false\"\n        :fieldNames=\"{ key: 'id', title: 'name' }\"\n      />\n\n      <!-- 数据表格 -->\n      <div class=\"right-table-layout\">\n        <BasicTable\n          class=\"fix-basic-table\"\n          @register=\"registerTable\"\n          :searchInfo=\"searchInfo\"\n          @resize-column=\"(w, col) => (col.width = w)\"\n          @row-db-click=\"(record) => handleView(record)\"\n        >\n          <template #toolbar>\n            <a-button\n              :disabled=\"selectedRowId == ''\"\n              type=\"primary\"\n              :preIcon=\"IconEnum.ADD\"\n              @click=\"handleCreate\"\n              >执行</a-button\n            >\n            <a-button\n              class=\"red-btn\"\n              :disabled=\"selectedRowId == ''\"\n              :preIcon=\"IconEnum.DELETE\"\n              @click=\"handleDelete\"\n              >删除</a-button\n            >\n            <a-button class=\"yellow-btn\" :preIcon=\"IconEnum.EXPORT\" @click=\"handleExportIndex\">{{\n              t('common.action.export')\n            }}</a-button>\n          </template>\n          <template #bodyCell=\"{ column, text }\">\n            <template v-if=\"column.dataIndex === 'status'\">\n              <span style=\"color: red\" v-if=\"text == 0\">未执行</span>\n              <span style=\"color: #e9dd05\" v-if=\"text == 1\">执行中</span>\n              <span style=\"color: #0fff40\" v-if=\"text == 2\">已执行</span>\n              <span style=\"color: red\" v-if=\"text == 3\">执行失败</span>\n            </template>\n          </template>\n        </BasicTable>\n      </div>\n    </PageWrapper>\n  </div>\n  <!-- <settlemenElecModal @reload=\"handleReload\" @register=\"registerDrawer\" /> -->\n</template>\n<script lang=\"ts\" setup>\n  import type { FormProps } from '/@/components/Form/src/types/form';\n  import { onMounted, reactive, ref, toRaw } from 'vue';\n  import { BasicTable, useTable, TableAction, SorterResult } from '/@/components/Table';\n  import { TreeItem } from '/@/components/Tree';\n  import { PageWrapper } from '/@/components/Page';\n  import CommonTree from '@/components/Framework/Tree/CommonTree.vue';\n  import { message, SelectProps } from 'ant-design-vue';\n  import { IconEnum } from '@/enums/appEnum';\n  import {\n    getDroneInspectionList,\n    getTreeData,\n    formState,\n    getDroneInspectionListColumns,\n    deleteIndex,\n    performData,\n    exportExcel,\n  } from './index';\n  import { useRouter } from 'vue-router';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { addTabPage } from '@/utils/route';\n  import { MsgManager } from '/@/message/MsgManager';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import { assign } from 'lodash-es';\n  import { exportExcelFile } from '@/utils/file/download';\n\n  const { createConfirm } = useMessage();\n  const { t } = useI18n();\n  const searchInfo = reactive<any>({}); // 查询信息\n  const treeData = ref<TreeItem[]>([]); // 左侧电站树数据\n  const selectedNode = ref({}); // 被选择的电站节点\n  const periodParam = ref({}); // 查询分期下拉框数据的参数\n\n  const checkedKeys = ref<Array<string | number>>([]); // 复选框的选择的数据\n  const options = ref<SelectProps['options']>([]); //电站分期\n  const areaColumn = getDroneInspectionListColumns(options);\n  const router = useRouter();\n\n  const indexList = ref<Array<any>>([]);\n  const getDroneInspectionListByParam = async () => {\n    let areaList = await getDroneInspectionList(searchInfo);\n    indexList.value = areaList.result;\n    return areaList.result;\n  };\n  let selectedRowId = ref('');\n  const searchForm: FormProps = {\n    showAdvancedButton: true,\n    baseColProps: { span: 8 },\n    labelWidth: 120,\n    autoAdvancedLine: 1,\n    schemas: [\n      { field: 'billCode', component: 'Input', label: '单据编号' },\n      {\n        label: '巡检开始时间',\n        field: 'startTime',\n        component: 'DatePicker',\n        componentProps: {\n          showTime: true,\n          format: 'YYYY-MM-DD HH:mm:ss',\n          valueFormat: 'YYYY-MM-DD HH:mm:ss',\n          style: 'width: 100%',\n        },\n      },\n      {\n        label: '巡检结束时间',\n        field: 'endTime',\n        component: 'DatePicker',\n        componentProps: {\n          showTime: true,\n          format: 'YYYY-MM-DD HH:mm:ss',\n          valueFormat: 'YYYY-MM-DD HH:mm:ss',\n          style: 'width: 100%',\n        },\n      },\n      {\n        label: '状态',\n        field: 'statusList',\n        component: 'CheckboxGroup',\n        componentProps: {\n          options: [\n            { label: '未执行', value: 0 },\n            { label: '执行中', value: 1 },\n            { label: '已执行', value: 2 },\n            { label: '执行失败', value: 3 },\n          ],\n        },\n      },\n    ],\n  };\n  const [registerTable, { reload, getPaginationRef, getSelectRows }] = useTable({\n    title: '无人机巡检列表',\n    api: async () => {\n      const paginationRef = getPaginationRef() as any;\n      searchInfo.pageNo = paginationRef.current;\n      searchInfo.pageSize = paginationRef.pageSize;\n      let dataObj = await getDroneInspectionListByParam();\n      return dataObj;\n    },\n    columns: areaColumn,\n    useSearchForm: true,\n    formConfig: searchForm,\n    showTableSetting: true,\n    bordered: true,\n    rowKey: 'id',\n    rowSelection: {\n      type: 'radio',\n      onChange: onSelect,\n    },\n    handleSearchInfoFn(info) {\n      //debugger;\n      // assign(searchInfo, info);\n      searchInfo.billCode = info.billCode;\n      searchInfo.endTime = info.endTime;\n      searchInfo.startTime = info.startTime;\n      // if (info.statusList?.length > 0) {\n      //   searchInfo.statusList = info.statusList.join(',');\n      // }\n      searchInfo.statusList = info.statusList;\n      return info;\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      if (sortInfo.order) {\n        searchInfo.sortField = sortInfo.field;\n        searchInfo.sortOrder = sortInfo.order.replace('end', '');\n      } else {\n        searchInfo.sortField = null;\n        searchInfo.sortOrder = null;\n      }\n    },\n  });\n  function onSelect(record, selected) {\n    if (selected.length > 0) {\n      checkedKeys.value = [record[0]];\n      selectedRowId.value = record[0];\n    } else {\n      checkedKeys.value = [];\n      selectedRowId.value = '';\n    }\n  }\n  function onSelectAll(selected, selectedRows, changeRows) {\n    const changeIds = changeRows.map((item) => item.id);\n    if (selected) {\n      checkedKeys.value = [...checkedKeys.value, ...changeIds];\n    } else {\n      checkedKeys.value = checkedKeys.value.filter((id) => {\n        return !changeIds.includes(id);\n      });\n    }\n  }\n  // 删除区域\n  function handleDelete() {\n    createConfirm({\n      title: '提示',\n      iconType: 'warning',\n      content: '确定要删除选中记录？',\n      async onOk() {\n        const row = getSelectRows()[0];\n        if (row.status != 0) {\n          message.warning('请选择未执行数据！');\n          return;\n        }\n        deleteIndex(checkedKeys.value).then(() => {\n          message.success('已删除。');\n          reload();\n        });\n      },\n    });\n  }\n  function handleExportIndex() {\n    createConfirm({\n      title: t('common.message.confirmTitle'),\n      iconType: 'warning',\n      content: t('common.message.exportMessage'),\n      async onOk() {\n        searchInfo.filename = `无人机巡检.xls`;\n        await exportExcel(searchInfo).then((res) => {\n          exportExcelFile(res?.data, searchInfo.filename);\n        });\n        searchInfo.filename = null;\n        message.success(t('common.exportSuccessText'));\n      },\n    });\n  }\n\n  // 查询左侧电站树数据\n  async function queryDeptTreeList() {\n    const deptList = (await getTreeData({})) as unknown as TreeItem[];\n    treeData.value = deptList.result;\n    reload();\n  }\n  // 添加区域\n  function handleCreate() {\n    const rows = getSelectRows();\n\n    if (rows.length != 1) {\n      message.warning('请选择一条需要操作的数据。');\n      return;\n    }\n    var row = rows[0];\n    if (row.status != 0) {\n      message.error('只有“未执行”状态可以操作“执行”。');\n      return;\n    }\n\n    performData({ id: row.id }).then((data) => {\n      message.success('下发成功，请稍后查看结果。');\n      reload();\n    });\n  }\n\n  function handleView(record: any) {\n    var form = {\n      id: record.id,\n    };\n    addTabPage(`/po/drone/droneinspection/create`, '查看无人机巡检', toRaw(form));\n  }\n\n  // 根据电站id获取分期信息\n  // 左侧树状菜单选中事件\n  function handleSelect(node = {}) {\n    searchInfo.stationId = null;\n    searchInfo.stationName = null;\n    searchInfo.stationOrganId = null;\n    searchInfo.stationOrganName = null;\n    searchInfo.nodeKindId = null;\n    periodParam.value.nodeKindId = null;\n    searchInfo.searchId = null;\n    if (node != null) {\n      searchInfo.stationOrganId = node.organId;\n      searchInfo.stationOrganName = node.organName;\n      if (node.nodeKindId == 'station') {\n        searchInfo.stationId = node.powerStationId;\n        searchInfo.stationName = node.name;\n        periodParam.value.stationId = node.powerStationId;\n\n        formState.stationId = searchInfo.stationId;\n        formState.stationName = searchInfo.stationName;\n        formState.stationOrganId = searchInfo.stationOrganId;\n        formState.stationOrganName = searchInfo.stationOrganName;\n      }\n\n      searchInfo.nodeKindId = node.nodeKindId;\n      periodParam.value.nodeKindId = node.nodeKindId;\n      searchInfo.searchId = node.id;\n    }\n\n    reload();\n  }\n\n  // 启动执行代码\n  onMounted(() => {\n    queryDeptTreeList();\n    MsgManager.getInstance().listen('droneinspection', function () {\n      setTimeout(() => {\n        reload();\n      }, 500);\n    });\n  });\n</script>\n<style lang=\"less\" scoped>\n  .dialog-loading {\n    position: absolute;\n    z-index: 1000 !important;\n    top: 45%;\n    left: 45%;\n  }\n\n  .dialog-mask {\n    position: absolute;\n    z-index: 1001 !important;\n    top: -1px;\n    width: 100%;\n    height: 100%;\n    opacity: 0.3;\n    background: #ccc;\n  }\n\n  .left-tree-layout {\n    flex-shrink: 0;\n    width: 298px;\n    border-radius: 2px;\n  }\n\n  .right-table-layout {\n    width: calc(100% - 308px);\n  }\n\n  .fix-basic-table {\n    :deep(&.vben-basic-table .ant-table-wrapper) {\n      padding: 10px 16px 12px;\n    }\n\n    :deep(.table-settings) {\n      margin-right: 0;\n    }\n\n    :deep(.table-settings .anticon-setting) {\n      margin-right: 0;\n    }\n  }\n</style>\n"],"names":["createConfirm","useMessage","t","useI18n","searchInfo","reactive","treeData","ref","periodParam","checkedKeys","areaColumn","getDroneInspectionListColumns","useRouter","indexList","getDroneInspectionListByParam","__async","areaList","getDroneInspectionList","selectedRowId","searchForm","registerTable","reload","getPaginationRef","getSelectRows","useTable","paginationRef","onSelect","info","sortInfo","record","selected","handleDelete","message","deleteIndex","handleExportIndex","exportExcel","res","exportExcelFile","queryDeptTreeList","deptList","getTreeData","handleCreate","rows","row","performData","data","handleView","form","addTabPage","toRaw","handleSelect","node","formState","onMounted","MsgManager"],"mappings":"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"}