{"version":3,"file":"index-4271ccd6.js","sources":["../../src/views/baseset/bi/indexstorehouse/index.vue"],"sourcesContent":["<template>\n  <PageWrapper dense contentFullHeight fixedHeight contentClass=\"flex\" style=\"position: relative\">\n    <!-- 指标库类型树 -->\n    <SysCommonTree\n      treeClass=\"left-tree-layout\"\n      title=\"指标库类型\"\n      treeType=\"base_index_storehouse_type\"\n      :toolbar=\"true\"\n      :search=\"true\"\n      @select=\"handleSelect\"\n      @before-delete=\"handleBeforeDelete\"\n      @after-save=\"handleAfterSave\"\n    />\n    <!-- 数据表格 -->\n    <div class=\"right-table-layout\">\n      <BasicTable\n        @register=\"registerTable\"\n        @resize-column=\"handleResizeColumn\"\n        @row-db-click=\"(record) => handleView(record)\"\n        class=\"fix-basic-table\"\n        @selection-change=\"handleSelectionChange\"\n      >\n        <template #toolbar>\n          <a-button type=\"primary\" :preIcon=\"IconEnum.ADD\" @click=\"handleCreate\">{{\n            t('common.action.create')\n          }}</a-button>\n          <a-button\n            :disabled=\"disabledBtn\"\n            type=\"primary\"\n            :preIcon=\"IconEnum.EDIT\"\n            @click=\"handleUpdate\"\n            >{{ t('common.action.update') }}</a-button\n          >\n          <a-button\n            :disabled=\"disabledBtn\"\n            class=\"red-btn\"\n            :preIcon=\"IconEnum.DELETE\"\n            @click=\"handleDelete\"\n            >{{ t('common.delText') }}</a-button\n          >\n          <a-button\n            :disabled=\"disabledBtn\"\n            class=\"green-btn\"\n            :preIcon=\"IconEnum.ENABLE\"\n            @click=\"handleEnable\"\n            >{{ '启用' }}</a-button\n          >\n          <a-button\n            :disabled=\"disabledBtn\"\n            class=\"grey-btn\"\n            :preIcon=\"IconEnum.DISABLE\"\n            @click=\"handleDisable\"\n            >{{ '禁用' }}</a-button\n          >\n          <a-dropdown>\n            <template #overlay>\n              <a-menu @click=\"handleClickMenu\">\n                <a-menu-item key=\"downloadTemplate\">下载模板</a-menu-item>\n                <a-menu-item key=\"import\">\n                  <a-upload\n                    name=\"file\"\n                    :showUploadList=\"false\"\n                    :headers=\"headers\"\n                    accept=\".xls,.xlsx\"\n                    :before-upload=\"beforeUpload\"\n                    @change=\"handleChange\"\n                    :action=\"IndexStorehouseApi.importExcelUrl\"\n                  >\n                    {{ '导入数据' }}\n                  </a-upload>\n                </a-menu-item>\n              </a-menu>\n            </template>\n            <a-button class=\"yellow-btn\"> Excel导入 </a-button>\n          </a-dropdown>\n        </template>\n        <template #bodyCell=\"{ column, text }\">\n          <template v-if=\"column.dataIndex === 'status'\">\n            <span style=\"color: #19be6b\" v-if=\"text == 1\">启用</span>\n            <span style=\"color: red\" v-if=\"text == 0\">禁用</span>\n          </template>\n        </template>\n      </BasicTable>\n    </div>\n\n    <DetailModal @register=\"registerDetailModal\" @success=\"handleSuccess\" />\n\n    <Dialog\n      v-model:visible=\"fileModalOpen\"\n      title=\"导入中请稍后...\"\n      :width=\"460\"\n      :height=\"100\"\n      :showBtm=\"false\"\n      smode=\"normal\"\n    >\n      <a-progress :percent=\"percent\" />\n    </Dialog>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { reactive, ref } from 'vue';\n  import { IconEnum } from '@/enums/appEnum';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { useMessage } from '@/hooks/web/useMessage';\n  import type { UploadProps } from 'ant-design-vue';\n  import { Upload } from 'ant-design-vue';\n  import { useModal } from '/@/components/Modal';\n  import { BasicTable, useTable, SorterResult } from '/@/components/Table';\n  import Dialog from '@/components/Framework/Modal/Dialog.vue';\n  import { PageWrapper } from '/@/components/Page';\n  import SysCommonTree from '@/views/system/configuration/commontree/SysCommonTree.vue';\n  import { columns, searchForm } from './indexStorehouse.data';\n  import DetailModal from './DetailModal.vue';\n  import * as IndexStorehouseApi from '@/api/baseset/bi/indexstorehouse';\n  import { getToken } from '/@/utils/auth';\n  import { exportExcelFile } from '@/utils/file/download';\n\n  const { t } = useI18n();\n  const message = useMessage();\n  const searchInfo = reactive<any>({});\n  const checkedKeys = ref<Array<string | number>>([]);\n  const selectTreeNode = reactive<any>({});\n  const indexStorehouseData = ref<Array<any>>([]);\n  const headers = {\n    Authorization: `Bearer ${getToken()}`,\n    // version: '6.6.6',\n  };\n  const disabledBtn = ref<boolean>(true);\n  const fileModalOpen = ref<boolean>(false);\n  const percent = ref<number>(0);\n\n  const getParam = () => {\n    const form = getForm();\n    const fieldsValue = form.getFieldsValue();\n    fieldsValue.fullId = selectTreeNode.fullId;\n    const paginationRef = getPaginationRef() as any;\n    fieldsValue.pageNo = paginationRef.current;\n    fieldsValue.pageSize = paginationRef.pageSize;\n    return { ...fieldsValue, ...searchInfo };\n  };\n\n  const getPageByParam = async () => {\n    const param = getParam();\n    indexStorehouseData.value = [];\n    const data = await IndexStorehouseApi.getPage(param);\n    indexStorehouseData.value = data.list;\n    return data;\n  };\n\n  const modalOptions = { visible: true };\n  const [registerDetailModal, { openModal }] = useModal();\n\n  const [\n    registerTable,\n    { getSelectRows, getForm, getPaginationRef, clearSelectedRowKeys, reload },\n  ] = useTable({\n    title: '指标列表',\n    api: getPageByParam,\n    columns: columns,\n    useSearchForm: true,\n    formConfig: searchForm,\n    showTableSetting: true,\n    bordered: true,\n    rowSelection: {\n      type: 'radio',\n    },\n    sortFn: (sortInfo: SorterResult) => {\n      const sortOrder = sortInfo.order?.replace('end', '');\n      searchInfo.sortOrder = sortOrder;\n      searchInfo.sortField = sortOrder ? sortInfo.field : undefined;\n    },\n  });\n\n  // 左侧树状菜单选中事件\n  async function handleSelect(node) {\n    selectTreeNode.id = null;\n    selectTreeNode.name = null;\n    selectTreeNode.fullId = null;\n    if (node && node.parentId !== 'root') {\n      selectTreeNode.id = node.id;\n      selectTreeNode.name = node.name;\n      selectTreeNode.fullId = node.fullId;\n    }\n    reloadTable();\n  }\n\n  const handleAfterSave = (node) => {\n    if (node.id) {\n      selectTreeNode.name = node.name;\n      reloadTable();\n    }\n  };\n\n  function handleBeforeDelete(node, callback) {\n    let callbackStatus = true;\n    if (indexStorehouseData.value.length > 0) {\n      callbackStatus = false;\n      message.error('该指标类型节点存在指标数据，不能删除');\n    }\n    callback(callbackStatus);\n  }\n\n  function handleResizeColumn(w, col) {\n    col.width = w;\n  }\n\n  // 添加指标库设置\n  function handleCreate() {\n    if (!selectTreeNode.id) {\n      message.error('请选择指标库类型');\n      return;\n    }\n    openModal(modalOptions, {\n      isUpdate: false,\n      record: {\n        id: null,\n        folderId: selectTreeNode.id,\n        indexType: selectTreeNode.name,\n        isReadOnly: false,\n      },\n    });\n  }\n\n  function checkSelectData() {\n    const rows = getSelectRows();\n    if (rows.length == 0 || checkedKeys.value.length > 1) {\n      message.error('请选择一行数据');\n      return false;\n    }\n    return rows[0];\n  }\n\n  // 修改指标库设置\n  function handleUpdate() {\n    const record = checkSelectData();\n    if (!record) {\n      return;\n    }\n    openModal(modalOptions, {\n      isUpdate: true,\n      record: {\n        id: record.id,\n        isReadOnly: false,\n      },\n    });\n  }\n\n  function handleView(record: any) {\n    openModal(modalOptions, {\n      isUpdate: true,\n      record: {\n        id: record.id,\n        isReadOnly: true,\n      },\n    });\n  }\n\n  // 删除指标库设置\n  async function handleDelete() {\n    const record = checkSelectData();\n    if (!record) {\n      return;\n    }\n    await message.delConfirm();\n    await IndexStorehouseApi.deleteData(record.id);\n    message.success(t('common.delSuccessText'));\n    reloadTable();\n  }\n\n  const reloadTable = () => {\n    clearSelectedRowKeys();\n    reload();\n  };\n\n  // 启用指标库设置\n  function handleEnable() {\n    updateStatus(1, '已启用');\n  }\n\n  // 禁用指标库设置\n  function handleDisable() {\n    updateStatus(0, '已禁用');\n  }\n\n  function updateStatus(status, msg) {\n    const record = checkSelectData();\n    if (!record) {\n      return;\n    }\n    IndexStorehouseApi.updateStatus(record.id, status).then(() => {\n      message.success(msg);\n      reloadTable();\n    });\n  }\n\n  function handleSuccess() {\n    reloadTable();\n  }\n\n  async function handleClickMenu({ key }) {\n    if (key === 'downloadTemplate') {\n      const query = { filename: '指标模板.xls' };\n      await IndexStorehouseApi.exportExcelTemplate(query).then((res) => {\n        exportExcelFile(res?.data, query.filename);\n      });\n      message.success(t('common.exportSuccessText'));\n    }\n  }\n\n  const beforeUpload: UploadProps['beforeUpload'] = (file) => {\n    // .xls  application/vnd.ms-excel\n    // .xlsx application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\n    const isExcel =\n      file.type === 'application/vnd.ms-excel' ||\n      file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n    if (!isExcel) {\n      message.error(`${file.name} 不是Excel文件`);\n    }\n    return isExcel || Upload.LIST_IGNORE;\n  };\n\n  const currentTime = ref<number>(0);\n  const totalTime = ref<number>(Math.floor(Math.random() * 28) + 3);\n  const calcProgress = (file) => {\n    let intervalId;\n    // 上传中\n    if (file.status === 'uploading' && file.percent === 0) {\n      fileModalOpen.value = true;\n      currentTime.value = 0;\n      percent.value = 0;\n      intervalId = setInterval(() => {\n        if (currentTime.value < totalTime.value - 1) {\n          currentTime.value++;\n          percent.value = parseFloat(((currentTime.value / totalTime.value) * 100).toFixed(0));\n        } else if (percent.value < 99) {\n          percent.value++;\n        }\n      }, 1000);\n    }\n    if (file.status === 'uploading' && file.percent === 100) {\n      const uploadTime = parseInt(totalTime.value * 0.6);\n      if (uploadTime > currentTime.value) {\n        currentTime.value = uploadTime;\n      }\n    }\n    // 上传完成\n    if (file.status === 'done') {\n      if (intervalId) {\n        clearInterval(intervalId);\n      }\n      if (file.response?.code != 0) {\n        fileModalOpen.value = false;\n        return;\n      }\n      percent.value = 100;\n      setTimeout(() => {\n        fileModalOpen.value = false;\n      }, 1000);\n    } else if (file.status === 'error') {\n      if (intervalId) {\n        clearInterval(intervalId);\n      }\n      fileModalOpen.value = false;\n    }\n  };\n\n  const handleChange = (list) => {\n    const file = list.file;\n    console.log('file', file);\n    calcProgress(file);\n    if (file.status === 'done') {\n      if (file.response?.code != 0 && file.response?.msg) {\n        message.error(file.response?.msg);\n        return;\n      }\n      setTimeout(() => {\n        message.success('导入数据成功');\n        reloadTable();\n      }, 1000);\n    } else if (file.status === 'error') {\n      message.error('导入数据失败');\n    }\n  };\n\n  function handleSelectionChange({ rows }) {\n    disabledBtn.value = rows.length === 0;\n  }\n</script>\n<style lang=\"less\" scoped>\n  @import '/@/design/biz/bizList.less';\n</style>\n"],"names":["t","useI18n","message","useMessage","searchInfo","reactive","checkedKeys","ref","selectTreeNode","indexStorehouseData","headers","getToken","disabledBtn","fileModalOpen","percent","getParam","fieldsValue","getForm","paginationRef","getPaginationRef","__spreadValues","getPageByParam","__async","param","data","IndexStorehouseApi.getPage","modalOptions","registerDetailModal","openModal","useModal","registerTable","getSelectRows","clearSelectedRowKeys","reload","useTable","columns","searchForm","sortInfo","sortOrder","_a","handleSelect","node","reloadTable","handleAfterSave","handleBeforeDelete","callback","callbackStatus","handleResizeColumn","w","col","handleCreate","checkSelectData","rows","handleUpdate","record","handleView","handleDelete","IndexStorehouseApi.deleteData","handleEnable","updateStatus","handleDisable","status","msg","IndexStorehouseApi.updateStatus","handleSuccess","handleClickMenu","_0","key","query","IndexStorehouseApi.exportExcelTemplate","res","exportExcelFile","beforeUpload","file","isExcel","Upload","currentTime","totalTime","calcProgress","intervalId","uploadTime","handleChange","list","_b","_c","handleSelectionChange"],"mappings":"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"}