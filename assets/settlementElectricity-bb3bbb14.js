var r=(k,S,c)=>new Promise((C,h)=>{var t=i=>{try{l(c.next(i))}catch(m){h(m)}},p=i=>{try{l(c.throw(i))}catch(m){h(m)}},l=i=>i.done?C(i.value):Promise.resolve(i.value).then(t,p);l((c=c.apply(k,S)).next())});import{B as X}from"./BasicTable-0434a334.js";import{T as $}from"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import"./index-085d06c7.js";import{u as q}from"./useTable-109483b3.js";import{a2 as w}from"./antd-15ac76ed.js";import{au as G,b as U,a7 as Z,av as _,ax as ee,az as te,bQ as ae,bR as ne,aA as se,a0 as oe,_ as le}from"./index.js";import{P as ie}from"./index-20519caf.js";import{C as re}from"./CommonTree-c4ed7838.js";import"./index-74ac3212.js";import{g as B,a as ue,f,b as K,e as de,c as ce}from"./settlementElectricity-079df1e5.js";import{d as pe,r as me,k as s,ax as ve,o as fe,al as Ie,Z as L,_ as ge,f as g,aa as b,$ as be,u as o,E as N,a9 as he,ac as xe,J as ye}from"./vue-71d1abb3.js";import{j as we}from"./Export2Excel-389a8fc9.js";import"./useForm-dea3ed18.js";import"./uniqBy-92d3bc7f.js";import"./index-316f6ffb.js";import"./useWindowSizeFn-13b1b8a2.js";import"./index-f4fc48e6.js";import"./useTabs-2b062e85.js";import"./download-03e71dd5.js";import"./index-5d49b7a7.js";import"./SearchBox-22bb02d6.js";import"./UploadBox-636ecf02.js";import"./Dialog-0a006d82.js";import"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import"./OrganDialog-dd1023ce.js";import"./sortable.esm-4ae27e0b.js";import"./dict-c04c0dd8.js";import"./useContentViewHeight-7f845167.js";import"./index-3801a970.js";import"./useRender-21ce56fb.js";const _e={class:"right-table-layout"},Se=pe({__name:"settlementElectricity",setup(k){const{createConfirm:S}=G(),{t:c}=U(),C=me({}),h=s([]),t=s({}),p=s({}),l=s([]);s([]);const i=B();ve();const m=s([]),R=()=>r(this,null,function*(){let e=yield ce(t.value);return m.value=e.result,e.result}),M={showAdvancedButton:!1,baseColProps:{span:8},labelWidth:120,autoAdvancedLine:1,schemas:[{field:"billCode",component:"Input",label:"单据编号"},{field:"[startDate, endDate]",label:" 结算周期起止",component:"RangePicker",componentProps:{format:"YYYY-MM-DD",valueFormat:"YYYY-MM-DD",placeholder:["开始日期","结束日期"]}},{field:"status",label:"审批状态",component:"DictSelectBox",componentProps:{type:"bpm_process_instance_result"}}]},[F,{reload:x,getPaginationRef:z}]=q({title:"结算电量列表",api:()=>r(this,null,function*(){const e=z();return t.value.pageNo=e.current,t.value.pageSize=e.pageSize,yield R()}),columns:i,useSearchForm:!0,formConfig:M,showTableSetting:!0,bordered:!0,rowKey:"id",pagination:{defaultPageSize:20,pageSize:20,showSizeChanger:!0,showQuickJumper:!0},rowSelection:{type:"radio",onChange:Y},handleSearchInfoFn(e){return e.startDate!=null?t.value.startDate=e.startDate+" 00:00:00":t.value.startDate=null,e.endDate!=null?t.value.endDate=e.endDate+" 00:00:00":t.value.endDate=null,t.value.status=e.status,t.value.billCode=e.billCode,e},sortFn:e=>{e.order?(t.value.sortField=e.field,t.value.sortOrder=e.order.replace("end","")):(t.value.sortField=null,t.value.sortOrder=null)}});let D=s("");function Y(e,a){a.length>0?(l.value=[e[0]],D.value=e[0]):(l.value=[],D.value="")}function A(){return r(this,null,function*(){const e=yield ue({});h.value=e.result,x()})}function V(){if(t.value.periodId==null){w.error("请先选择电站分期。");return}t.value.nodeKindId=="station"&&O(),t.value.nodeKindId=="period"&&O(),ee("/po/elec/settlementelec/setElecCreate","添加结算电量",ye(f))}function T(e){e.status==0||e.status==1,te(e.id)}const j=e=>r(this,null,function*(){const a=yield K({id:e.id}),{value:v}=yield ae.prompt("请输入取消原因","取消流程",{confirmButtonText:c("common.okText"),cancelButtonText:c("common.cancelText"),inputPattern:/^[\s\S]*.*\S[\s\S]*$/,inputErrorMessage:"取消原因不能为空"});yield ne(a.result.processInstanceId,v),w.success("已取消"),x()});function H(){return r(this,null,function*(){if(l.value.length!=1)return w.info("请选择一条数据."),!1;const e=yield K({id:l.value[0]});S({title:"提示",iconType:"warning",content:"确定要删除选中记录？",onOk(){return r(this,null,function*(){if(e.result.status!=0){w.error("非草稿状态不能删除。");return}yield se(e.result.processInstanceId),w.success("已删除。"),l.value=[],x()})}})})}function O(){p.value.stationId}function J(e={}){t.value.stationId=null,t.value.stationName=null,t.value.periodName=null,t.value.periodId=null,t.value.nodeKindId=null,p.value.nodeKindId=null,t.value.searchId=null,t.value.stationOrganId=null,t.value.stationOrganName=null,e!=null&&(t.value.stationOrganId=e.organId,t.value.stationOrganName=e.organName,e.nodeKindId=="station"&&(t.value.stationId=e.powerStationId,t.value.stationName=e.name,p.value.stationId=e.powerStationId),e.nodeKindId=="period"&&(t.value.stationId=e.powerStationId,t.value.stationName=e.orgName,t.value.periodName=e.powerStationPeriodName,t.value.periodId=e.powerStationPeriodId,p.value.stationId=e.powerStationId,f.stationId=t.value.stationId,f.stationName=t.value.stationName,f.periodName=t.value.periodName,f.periodId=t.value.periodId,f.stationOrganId=t.value.stationOrganId,f.stationOrganName=t.value.stationOrganName),t.value.nodeKindId=e.nodeKindId,p.value.nodeKindId=e.nodeKindId,t.value.searchId=e.id),x()}function Q(){return r(this,null,function*(){S({title:"导出",iconType:"warning",content:"确定要导出所有记录？",onOk(){return r(this,null,function*(){const a=s({index:"序号"}),v=B(),u=s([]),I=s([]);v.forEach(n=>{n.dataIndex!=="id"&&(n.dataIndex==="stationOrganName"&&oe().isMultiOrganization||n.dataIndex!=="stationOrganName")&&(a.value[n.dataIndex]=n.title,I.value.push(n.dataIndex))});let y=yield de(t.value);m.value=y.result,m.value.forEach(function(n,W){let d="";switch(n.status){case 0:d="草稿";break;case 1:d="处理中";break;case 2:d="通过";break;case 3:d="不通过";break;case 4:d="已取消";break;case 5:d="已终止";break;case 6:d="退回/驳回";break}let P=s({index:W+1});I.value.forEach(E=>{P.value[E]=E==="status"?d:n[E]}),u.value.push(P.value)}),we({data:u.value,header:a.value,filename:"结算电量.xlsx"})})}})})}return fe(()=>{A(),Z.getInstance().listen("settlementElectricity",function(){setTimeout(()=>{x()},500)})}),(e,a)=>{const v=Ie("a-button");return L(),ge("div",null,[g(o(ie),{dense:"",contentFullHeight:"",fixedHeight:"",contentClass:"flex",style:{position:"relative"}},{default:b(()=>[g(re,{title:"电站组织",onSelect:J,value:h.value,class:"left-tree-layout",toolbar:!0,canEdit:!1,canAdd:!1,canDelete:!1,isShowOperationBtns:!1,fieldNames:{key:"id",title:"name"}},null,8,["value"]),be("div",_e,[g(o(X),{class:"fix-basic-table",onRegister:o(F),searchInfo:C,onResizeColumn:a[0]||(a[0]=(u,I)=>I.width=u),onRowDbClick:a[1]||(a[1]=u=>T(u))},{toolbar:b(()=>[g(v,{type:"primary",preIcon:o(_).ADD,onClick:V},{default:b(()=>[N("添加")]),_:1},8,["preIcon"]),g(v,{class:"red-btn",disabled:o(D)=="",preIcon:o(_).DELETE,onClick:H},{default:b(()=>[N("删除")]),_:1},8,["disabled","preIcon"]),g(v,{class:"yellow-btn",preIcon:o(_).EXPORT,onClick:Q},{default:b(()=>[N("导出")]),_:1},8,["preIcon"])]),bodyCell:b(({column:u,text:I,record:y})=>[u.key==="action"?(L(),he(o($),{key:0,actions:[{icon:o(_).LOG,label:"进度",onClick:T.bind(null,y)},{icon:o(_).DELETE,danger:!0,label:"取消",ifShow:()=>y.status==0,onClick:j.bind(null,y)}]},null,8,["actions"])):xe("",!0)]),_:1},8,["onRegister","searchInfo"])])]),_:1})])}}});const at=le(Se,[["__scopeId","data-v-20c6e6a1"]]);export{at as default};
//# sourceMappingURL=settlementElectricity-bb3bbb14.js.map
