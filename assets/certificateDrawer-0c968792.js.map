{"version":3,"file":"certificateDrawer-0c968792.js","sources":["../../src/views/po/integrated/personcertificate/certificateDrawer.vue"],"sourcesContent":["<template>\n  <PageWrapper\n    :detail=\"true\"\n    dense\n    contentFullHeight\n    fixedHeight\n    contentClass=\"fix-detail-page\"\n    style=\"position: relative\"\n  >\n    <div class=\"load\">\n      <a-spin :spinning=\"formState.spinning\" tip=\"Loading...\">\n        <div class=\"process-box\">\n          <div class=\"header-box\">\n            <div class=\"header-left\">人员持证</div>\n            <div class=\"header-right\">\n              <a-button style=\"margin-right: 10px\" @click=\"handleCancel\">{{\n                t('common.cancelText')\n              }}</a-button>\n              <a-button\n                type=\"primary\"\n                @click=\"saveHandlePersonCertificate\"\n                :loading=\"isLoading\"\n                :disabled=\"disabledInput\"\n              >\n                {{ t('common.saveText') }}</a-button\n              >\n            </div>\n          </div>\n\n          <div class=\"content\">\n            <a-form ref=\"formRef\" :model=\"formState\" labelAlign=\"right\" autocomplete=\"off\">\n              <a-card title=\"基本信息\" :bordered=\"false\">\n                <a-row :gutter=\"24\">\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"stationName\"\n                      label=\"电站名称\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: false }]\"\n                    >\n                      <a-input disabled v-model:value=\"formState.stationName\" />\n                      <a-input disabled v-model:value=\"formState.id\" v-if=\"false\" />\n                      <a-input disabled v-model:value=\"formState.stationId\" v-if=\"false\" />\n                      <a-input disabled v-model:value=\"formState.stationOrganId\" v-if=\"false\" />\n                      <a-input disabled v-model:value=\"formState.stationOrganName\" v-if=\"false\" />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"person\"\n                      label=\"姓名\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择姓名' }]\"\n                    >\n                      <a-select\n                        v-model:value=\"formState.person\"\n                        show-search\n                        allow-clear\n                        style=\"width: 100%\"\n                        :options=\"stationPerson\"\n                        @change=\"handleChangePerform\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"sex\"\n                      label=\"性别\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择性别' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.sex\"\n                        :type=\"`system_user_sex`\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"24\">\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"status\"\n                      label=\"状态\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择状态' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.status\"\n                        :type=\"`personnelStatus`\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"postion\"\n                      label=\"岗位\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择岗位' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.postion\"\n                        :type=\"`personPost`\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"birthday\"\n                      label=\"出生日期\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择出生日期' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.birthday\"\n                        format=\"YYYY-MM-DD\"\n                        value-format=\"YYYY-MM-DD\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                        :disabled-date=\"disabledDate\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"24\">\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"education\"\n                      label=\"学历\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择学历' }]\"\n                    >\n                      <DictSelectBox\n                        v-model:value=\"formState.education\"\n                        :type=\"`degree`\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"phone\"\n                      label=\"电话\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请输入电话号码' }]\"\n                    >\n                      <a-input\n                        v-model:value=\"formState.phone\"\n                        placeholder=\"请输入电话号码\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"email\"\n                      label=\"邮箱\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请输入邮箱' }]\"\n                    >\n                      <a-input\n                        v-model:value=\"formState.email\"\n                        placeholder=\"请输入邮箱\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n\n                <a-row :gutter=\"24\">\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"joinDate\"\n                      label=\"入职时间\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: true, message: '请选择入职时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.joinDate\"\n                        format=\"YYYY-MM-DD\"\n                        value-format=\"YYYY-MM-DD\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                        :disabled-date=\"disabledDate\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                  <a-col v-show=\"true\" :span=\"8\">\n                    <a-form-item\n                      name=\"departDate\"\n                      label=\"离职时间\"\n                      :labelCol=\"{ span: 6 }\"\n                      :rules=\"[{ required: false, message: '请选择离职时间' }]\"\n                    >\n                      <a-date-picker\n                        v-model:value=\"formState.departDate\"\n                        format=\"YYYY-MM-DD\"\n                        value-format=\"YYYY-MM-DD\"\n                        :style=\"`width: 100%`\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </a-form-item>\n                  </a-col>\n                </a-row>\n              </a-card>\n\n              <a-card :bordered=\"false\">\n                <BasicTable @register=\"registerTable\" title=\"证书信息\">\n                  <template #toolbar>\n                    <a-button\n                      type=\"primary\"\n                      :preIcon=\"IconEnum.ADD\"\n                      @click=\"handleAddItem\"\n                      :disabled=\"disabledInput\"\n                    >\n                      {{ t('common.action.create') }}\n                    </a-button>\n                  </template>\n                  <template #bodyCell=\"{ column, record }\">\n                    <template v-if=\"column.dataIndex === 'certificateType'\">\n                      <DictSelectBox\n                        :type=\"`certificate`\"\n                        v-model:value=\"record[column.dataIndex]\"\n                        style=\"width: 100%\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </template>\n                    <template v-if=\"column.dataIndex === 'certificateName'\">\n                      <a-input\n                        v-model:value=\"record[column.dataIndex]\"\n                        :maxlenth=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </template>\n                    <template v-if=\"column.dataIndex === 'issuingAuthority'\">\n                      <a-input\n                        v-model:value=\"record[column.dataIndex]\"\n                        :maxlenth=\"1000\"\n                        :disabled=\"disabledInput\"\n                      />\n                    </template>\n\n                    <template v-if=\"column.dataIndex === 'bizFileId'\">\n                      <UploadBox\n                        :width=\"800\"\n                        :height=\"550\"\n                        :maxCount=\"20\"\n                        :maxSize=\"100 * 1024 * 1024\"\n                        :application=\"`po`\"\n                        :module=\"`supervisiondtl`\"\n                        :vmode=\"formState.type != 'view' ? `box` : `view`\"\n                        :bizId=\"record[column.dataIndex]\"\n                      />\n                    </template>\n\n                    <template v-if=\"column.dataIndex === 'action'\">\n                      <TableAction\n                        :actions=\"[\n                          {\n                            tooltip: '删除',\n                            color: 'error',\n                            icon: 'ant-design:delete-outlined',\n                            ifShow: !disabledInput,\n                            onClick: handleDeleteItem.bind(null, record),\n                          },\n                        ]\"\n                      />\n                    </template>\n                  </template>\n                </BasicTable>\n              </a-card>\n            </a-form>\n          </div>\n        </div>\n      </a-spin>\n    </div>\n  </PageWrapper>\n</template>\n<script lang=\"ts\" setup>\n  import { reactive, ref, onMounted, UnwrapRef, unref } from 'vue';\n  import { useI18n } from '@/hooks/web/useI18n';\n  import { IconEnum } from '@/enums/appEnum';\n  import { FormInstance, SelectProps, message } from 'ant-design-vue';\n  import DictSelectBox from '@/components/Framework/Combox/DictSelectBox.vue';\n  import { useMessage } from '/@/hooks/web/useMessage';\n  import { BasicTable, useTable, TableAction, EditRecordRow } from '/@/components/Table';\n  import { useRouter } from 'vue-router';\n  import { assign } from 'lodash-es';\n  import {\n    savePersoncertificate,\n    getStationPersonList,\n    dtlColumns,\n    getPersoncertificateDtlList,\n    getPersoncertificate,\n  } from './data';\n  import { trim } from 'xe-utils';\n  import dayjs, { Dayjs } from 'dayjs';\n  import UploadBox from '@/components/Framework/Combox/UploadBox.vue';\n  import { buildShortUUID } from '@/utils/uuid';\n  import { addTabPage, closeCurrentTab } from '@/utils/route';\n  import { MsgManager } from '@/message/MsgManager';\n  // import PrintButton from '/@/components/Framework/Button/PrintButton.vue';\n  import { PageWrapper } from '/@/components/Page';\n\n  const { t } = useI18n();\n  const router = useRouter();\n  const { currentRoute } = router;\n  const route = unref(currentRoute);\n  const query = route.query;\n  const disabledInput = ref<boolean>(true);\n  const billTitleOption = reactive<any>({});\n  billTitleOption.title = '人员持证';\n  billTitleOption.infoItems = [];\n\n  const formState: UnwrapRef<any> = reactive({});\n  const stationPerson = ref<SelectProps['options']>([]) as any;\n  const isLoading = ref(false);\n  const formRef = ref<FormInstance>();\n  const { createMessage } = useMessage();\n\n  const disabledDate = (current: Dayjs) => {\n    // Can not select days before today and today\n    return current && current >= dayjs().endOf('day');\n  };\n\n  //代码启动\n  onMounted(async () => {\n    assign(formState, query);\n    if (query.id) {\n      const res = await getPersoncertificate({ id: query.id });\n      if (res.result) {\n        assign(formState, res.result);\n      }\n    }\n    disabledInput.value = false;\n    formState.spinning = false;\n\n    if (query.type) {\n      disabledInput.value = true;\n    }\n    getStationPerson();\n  });\n\n  //获取当前电站人员列表\n  function getStationPerson() {\n    if (formState.stationId != '' && formState.stationId != null) {\n      getStationPersonList('?stationId=' + formState.stationId).then((res) => {\n        if (res && res.length > 0) {\n          res.forEach((item) => {\n            stationPerson.value.push({ value: item.name, lable: item.userId });\n          });\n        }\n      });\n    }\n  }\n\n  //人员选择事件\n  function handleChangePerform(val: string, option) {\n    formState.personId = option.lable;\n  }\n\n  //明细表格数据请求\n  const getPersoncertificateDtlParam = async () => {\n    let param = { personCertificateBizId: formState.id };\n    let dataObj = [];\n    if (formState.id != undefined) {\n      dataObj = await getPersoncertificateDtlList(param);\n    }\n    return dataObj;\n  };\n\n  const [registerTable, { getDataSource }] = useTable({\n    api: getPersoncertificateDtlParam,\n    columns: dtlColumns,\n    pagination: false,\n    striped: false,\n    useSearchForm: false,\n    showTableSetting: false,\n    bordered: true,\n    showIndexColumn: true,\n    canResize: true,\n    actionColumn: {\n      width: 100,\n      title: t('common.operate'),\n      dataIndex: 'action',\n      fixed: 'right',\n    },\n  });\n\n  //添加行\n  function handleAddItem() {\n    const addRow: EditRecordRow = {};\n    const data = getDataSource();\n    data.push(addRowOption(addRow));\n  }\n\n  function addRowOption(addRow: EditRecordRow) {\n    addRow.editable = true;\n    addRow.isNew = true;\n    addRow.key = `${Date.now()}`;\n    addRow.bizFileId = buildShortUUID();\n    return addRow;\n  }\n\n  //编辑行\n  function handleDeleteItem(record) {\n    const data = getDataSource();\n    let index = data.indexOf(record);\n    if (index !== -1) {\n      data.splice(index, 1);\n    }\n  }\n\n  // 取消按钮\n  function handleCancel() {\n    // router.push('/po/integrated/personcertificate');\n    addTabPage('/po/integrated/personcertificate');\n  }\n\n  //保存\n  function saveHandlePersonCertificate() {\n    formState.spinning = true;\n    try {\n      formRef.value.validateFields().then(() => {\n        formState.detail = getDataSource();\n        if (getDataSource().length == 0) {\n          message.error('证书明细列表不能为空。');\n          formState.spinning = false;\n          return;\n        }\n        validateDetails(formState.detail, {\n          certificateType: '证书类型',\n          certificateName: '证书名称',\n          issuingAuthority: '颁证机构',\n        });\n\n        savePersoncertificate(formState).then((data) => {\n          formState.id = data;\n          createMessage.success('保存成功');\n          // router.push('/po/integrated/personcertificate');\n          // addTabPage('/po/integrated/personcertificate');\n          MsgManager.getInstance().sendMsg('person-certificate', {});\n          closeCurrentTab();\n        });\n      });\n    } catch (error) {\n      console.log('error', error);\n    } finally {\n      formState.spinning = false;\n    }\n  }\n\n  function validateDetails(data, validateFields) {\n    for (let i = 0; i < data.length; i++) {\n      const item = data[i];\n      for (const key in validateFields) {\n        if (!trim(item[key])) {\n          const errorMessage = validateFields[key] + '不能为空';\n          message.error(errorMessage);\n          formState.spinning = false;\n          throw new Error(errorMessage);\n        }\n      }\n    }\n  }\n</script>\n\n<style lang=\"less\" scoped>\n  .fix-detail-page {\n    :deep(&.vben-page-wrapper-content.detail-content) {\n      margin: 0;\n    }\n  }\n\n  .process-box {\n    :deep(.vben-basic-table-header__toolbar > button.ant-btn:last-child) {\n      margin-right: 0;\n    }\n\n    & > .content {\n      padding-bottom: 10px;\n    }\n  }\n</style>\n"],"names":["t","useI18n","router","useRouter","currentRoute","query","unref","disabledInput","ref","billTitleOption","reactive","formState","stationPerson","isLoading","formRef","createMessage","useMessage","disabledDate","current","dayjs","onMounted","__async","assign","res","getPersoncertificate","getStationPerson","getStationPersonList","item","handleChangePerform","val","option","getPersoncertificateDtlParam","param","dataObj","getPersoncertificateDtlList","registerTable","getDataSource","useTable","dtlColumns","handleAddItem","addRow","addRowOption","buildShortUUID","handleDeleteItem","record","data","index","handleCancel","addTabPage","saveHandlePersonCertificate","message","validateDetails","savePersoncertificate","MsgManager","closeCurrentTab","error","validateFields","i","key","trim","errorMessage"],"mappings":"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"}