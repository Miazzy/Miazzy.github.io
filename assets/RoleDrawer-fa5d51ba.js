var re=Object.defineProperty,oe=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var le=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var A=(e,a,o)=>a in e?re(e,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[a]=o,N=(e,a)=>{for(var o in a||(a={}))le.call(a,o)&&A(e,o,a[o]);if(K)for(var o of K(a))ie.call(a,o)&&A(e,o,a[o]);return e},F=(e,a)=>oe(e,ne(a));var S=(e,a,o)=>new Promise((v,_)=>{var r=d=>{try{w(o.next(d))}catch(p){_(p)}},D=d=>{try{w(o.throw(d))}catch(p){_(p)}},w=d=>d.done?v(d.value):Promise.resolve(d.value).then(r,D);w((o=o.apply(e,a)).next())});import{a5 as c,au as j,b as ce,_ as ue}from"./index.js";import{u as de,B as pe}from"./useForm-dea3ed18.js";import"./BasicForm.vue_vue_type_style_index_0_lang-1ba7be9e.js";import{a as me,B as fe}from"./index-fda2d66c.js";import{B as he}from"./index-3801a970.js";import{_ as ge}from"./DictSelectBox.vue_vue_type_script_setup_true_lang-e03e9fe8.js";import{f as ve}from"./index-b4b13d0a.js";import{g as L}from"./index-33af41d1.js";import{g as ye}from"./data-1198e351.js";import{n as Se,d as we,k as i,r as U,Z as _e,a9 as De,aa as z,f as C,u as g,a5 as Ie,a7 as be}from"./vue-71d1abb3.js";import{b7 as Re}from"./antd-15ac76ed.js";import{f as Te}from"./index-5d738211.js";const ke=e=>c.post({url:"/system/role/create",params:e},{}),Be=e=>c.put({url:"/system/role/update",params:e},{}),Xe=e=>e.id?Be(e):ke(e),Oe=(e,a)=>c.put({url:`/system/role/updateStatus?id=${e}&status=${a}`},{}),Ye=e=>c.put({url:"/system/role/updateBatchSort",params:e},{}),et=e=>c.delete({url:`/system/role/delete?id=${e}`},{}),tt=e=>c.get({url:`/system/role/get?id=${e}`},{isOnlyResult:!0}),at=(e="")=>c.get({url:`/system/role/getNextSort?parentId=${e}`},{isOnlyResult:!0}),st=e=>c.get({url:"/system/role/tree",params:e},{isOnlyResult:!0}),rt=e=>c.get({url:"/system/role/page",params:e},{isOnlyResult:!0}),xe=e=>c.post({url:"/system/role/permission/createBatch",params:e},{}),$e=e=>c.post({url:"/system/role/authorize/createBatch",params:e},{}),ze=e=>c.get({url:`/system/role/permission/list?roleId=${e}`},{isOnlyResult:!0}),Ce=(e,a)=>c.get({url:`/system/role/authorize/list?roleId=${e}&authKind=${a}`},{isOnlyResult:!0}),Pe=e=>c.post({url:"/system/role/data-permission/create",params:e},{}),Ke=e=>c.get({url:`/system/role/data-permission/get?roleId=${e}`},{isOnlyResult:!0}),ot=[{title:"编码",dataIndex:"code",width:120,resizable:!0,sorter:!0},{title:"名称",dataIndex:"name",headAlign:"center",align:"left",width:180,resizable:!0,sorter:!0},{title:"状态",dataIndex:"status",width:80,resizable:!0,sorter:!0,customRender:({record:e})=>(Reflect.has(e,"pendingStatus")||(e.pendingStatus=!1),Se(Re,{checked:e.status===1,checkedChildren:"禁用",unCheckedChildren:"启用",loading:e.pendingStatus,onChange:a=>S(void 0,null,function*(){e.pendingStatus=!0;const o=a?1:0,v=j();Oe(e.id,o).then(()=>{e.status=o,v.success("已成功修改角色状态")}).catch(()=>{v.error("修改角色状态失败")}).finally(()=>{e.pendingStatus=!1})})}))},{title:"节点类别",dataIndex:"nodeKind",width:100,resizable:!0,sorter:!0,customRender:({record:e})=>e.nodeKindText},{title:"排序",dataIndex:"sort",width:100,resizable:!0,sorter:!0},{title:"描述",dataIndex:"description",headAlign:"center",align:"left",width:220,resizable:!0}],nt={baseColProps:{span:8},labelWidth:120,autoAdvancedLine:1,schemas:[{label:"名称",field:"name",component:"Input"},{label:"状态",field:"status",component:"DictSelectBox",componentProps:{type:"enable_or_disable"}}]},Ae=e=>e==="dataPermission"?[{field:"dataScope",label:"数据范围",slot:"dataScope",component:"DictSelectBox",dynamicRules:({values:a})=>Object.prototype.hasOwnProperty.call(a,"dataScope")?[{required:!1}]:[]},{label:"数据权限",field:"menu",slot:"menu",component:"ApiTree",show:({values:a})=>a.dataScope=="2"||a.dataScope=="6",dynamicRules:({values:a})=>Object.prototype.hasOwnProperty.call(a,"dataScope")?a.dataScope=="2"||a.dataScope=="6"?[{required:!0,message:"请选择数据权限"}]:[{required:!1}]:[]}]:[{label:" ",field:"menu",slot:"menu",component:"ApiTree"}],Ne=we({__name:"RoleDrawer",emits:["success","register"],setup(e,{emit:a}){const{t:o}=ce(),v=j(),_=i(),r=U({id:"",type:"",roleId:""}),D=i(""),w=i(""),d=i(!0),p=i([]),f=i([]),I=i([]),b=i([]),h=i([]),T=i([]),k=i([]),B=U({menu:[],org:[],pos:[],dataPermission:[]}),R=i(!0),O=i(),x=i(),[q,{setProps:E,validate:M,resetFields:V,setFieldsValue:W}]=de({labelWidth:x,baseColProps:{span:24},showActionButtonGroup:!1}),G=t=>S(this,null,function*(){let s=[];if(t==="menu")s=(yield ve({disableNonPermissionNode:!0,status:1})).result;else if(t==="org")s=yield L({orgKindIds:"ogn,dpt,pos,psm",showPosition:!0});else if(t==="pos")s=(yield ye({pageNo:1,pageSize:200,orgKindId:"pos"})).list;else if(y(t)){s=yield L({orgKindIds:"ogn,dpt",showPosition:!1}),T.value=s;const l=(yield Te({})).result;k.value=l}const n=s;return h.value=n,n}),H=(t,s,n)=>S(this,null,function*(){if(y(t)){const u=n.dataScopeOrgIds;f.value=u,n.dataScope=="2"?(h.value=T.value,I.value=u):n.dataScope=="6"&&(h.value=k.value,b.value=u),setTimeout(()=>{p.value=u},500);return}let l=[];t==="menu"?l=yield ze(s):l=yield Ce(s,t);const m=[];l.forEach(u=>{const se=t==="menu"?u.permissionId:u.authId;m.push(se)}),p.value=m,f.value=l}),Z=t=>{w.value=t==="menu"?"权限树":t==="org"?"组织树":t==="pos"?"标准岗树":""},J=t=>{O.value="",x.value=null,y(t)&&(O.value="data-auth-tree",x.value=80)},[Q,{setDrawerProps:$,closeDrawer:X}]=me(t=>S(this,null,function*(){if(E({schemas:Ae(t.record.type)}),V(),$({confirmLoading:!1}),D.value=t.record.title,r.type=t.record.type,r.roleId=t.record.roleId,J(r.type),I.value=[],b.value=[],Z(r.type),B[r.type].length===0){h.value=[];const n=yield G(r.type);B[r.type]=n}else y(r.type)||(h.value=B[r.type]);let s={};if(r.id="",y(r.type)){const n=yield Ke(t.record.roleId);n&&(s=n),r.id=s==null?void 0:s.id}R.value=s.dataScope=="2",yield H(r.type,t.record.roleId,s),d.value=!!(t!=null&&t.isUpdate),g(d)&&W(F(N({},t.record),{dataScope:s==null?void 0:s.dataScope}))})),y=t=>t==="dataPermission",P=i([]),Y=(t,s)=>{P.value=s.checkedNodes,f.value.length>0&&(f.value=[])},ee=t=>{R.value=!1,t=="2"?(R.value=!0,h.value=T.value,p.value=I.value,f.value=I.value):t=="6"&&(h.value=k.value,p.value=b.value,f.value=b.value)},te=t=>S(this,null,function*(){var m;let s=[];const n=r.type==="menu";if(((m=f.value)==null?void 0:m.length)>0?s=g(f):g(P).forEach(u=>{n&&u.nodeKind==="permission"?s.push({permissionId:u.id}):y(r.type)?s.push(u.id):n||s.push({authId:u.id})}),y(r.type)){yield Pe({id:r.id,roleId:r.roleId,dataScope:t.dataScope,dataScopeOrgIds:t.dataScope=="2"||t.dataScope=="6"?s:[]}),v.success(o("common.saveSuccessText"));return}const l={roleId:r.roleId,list:s};n?yield xe(l):(l.authKind=r.type,yield $e(l)),v.success(o("common.saveSuccessText"))});function ae(){return S(this,null,function*(){try{const t=yield M();$({confirmLoading:!0}),yield te(t),X(),a("success")}finally{$({confirmLoading:!1})}})}return(t,s)=>(_e(),De(g(fe),be(t.$attrs,{onRegister:g(Q),showFooter:"",title:D.value,width:"920px",onOk:ae}),{default:z(()=>[C(g(pe),{onRegister:g(q)},{dataScope:z(({model:n,field:l})=>[C(ge,{value:n[l],"onUpdate:value":m=>n[l]=m,type:"system_data_scope",onChange:ee},null,8,["value","onUpdate:value"])]),menu:z(({model:n,field:l})=>[C(g(he),{ref_key:"treeRef",ref:_,class:Ie(O.value),value:n[l],"onUpdate:value":m=>n[l]=m,checkedKeys:p.value,title:w.value,treeData:h.value,fieldNames:{key:"id",title:"name"},checkable:"",toolbar:!0,search:"",expandOnSearch:!0,canAdd:!1,canEdit:!1,canDelete:!1,isShowOperationBtns:!0,checkStrictly:R.value,onCheck:Y},null,8,["class","value","onUpdate:value","checkedKeys","title","treeData","checkStrictly"])]),_:1},8,["onRegister"])]),_:1},16,["onRegister","title"]))}});const Fe=ue(Ne,[["__scopeId","data-v-c5e85018"]]),lt=Object.freeze(Object.defineProperty({__proto__:null,default:Fe},Symbol.toStringTag,{value:"Module"}));export{Fe as R,st as a,Xe as b,ot as c,at as d,tt as e,et as f,rt as g,Ye as h,lt as i,nt as s,Oe as u};
//# sourceMappingURL=RoleDrawer-fa5d51ba.js.map
